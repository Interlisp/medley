#*******************************************************************************
# doHCFILES.yml
#
# Interlisp workflow to run HCFILES.  HCFILES prints out PDF files for all of the
# files in the Medley directory and posts them on interlisp.org.
#  
# This workflow is designed to run in the "src" repo - which is clone of the Medley
# repo in which the HCFILES are created.  HCFILES is done in a clone so as the
# generated PDF files don't "pollute" the working Medley repo.
#
# HCFILES pdf output is posted on interlisp.org via github pages on the src directory.
#
# This workflow is designed to be kickjed off by the buildReleaseInclDocker
# workflow running in the Medley repo, once the release has been completed successfully
#
# Copyright 2024 by Interlisp.org
#
# ******************************************************************************

name: Run HCFILES

# Run this workflow on ...
on:
  workflow_dispatch:
    inputs:
      draft:
        description: "Mark this as a draft release"
        type: choice
        options:
        - 'false'
        - 'true'
      force:
        description: "Force build even if build already successfully completed for this commit"
        type: choice
        options:
        - 'false'
        - 'true'

defaults:
  run:
    shell: bash

jobs:

  run_HCFILES:

    runs-on: ubuntu-latest

    steps:

      - name: Update src repo
        run: gh repo sync ${{ github.repository_owner }}/src --branch master --source ${{ github.repository_owner }}/medley
        env:
          GITHUB_TOKEN: ${{ secrets.MU_TOKEN }}

      - name: Checkout updated src repo
        uses: actions/checkout@v4

      - name: (Re)create gh-pages branch
        run: |
           git fetch origin gh-pages
           git branch -D gh-pages
           git checkout -b gh-pages
           git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.MU_TOKEN }}

      - name: Checkout notecards
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/notecards
          path: ./notecards

      - name: Checkout loops
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/loops
          path: ./loops

      - name: Checkout test
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/test
          path: ./test

      - name: Cleanup .git for notecards, loops, test
        run: rm -rf ./notecards/.git ./loops/.git ./test/.git

      - name: Download Maiko
        run: |
          gh release download --output /tmp/maiko.tgz \
                              --repo ${{ github.repository_owner }}/maiko \
                              --pattern '*-linux.x86_64.tgz'
          tar -xzf /tmp/maiko.tgz"
        env:
          GITHUB_TOKEN: ${{ secrets.MU_TOKEN }}

      - name: Install vnc
        run: sudo apt-get update && sudo apt-get install -y tightvncserver

      - name: Build full.sysout
        run: |
          Xvnc -geometry 1280x720 :0 &
          export DISPLAY=":0"
          scripts/loadup-all.sh -apps

      - name: Run HCFILES
        run: |
          export DISPLAY=":0"
          scripts/do_hcfiles.sh

      - name: Commit and push created pdf files
        uses: EndBug/add-and-commit@v9
        with:
          add: '.'
          message: 'HCFILES for new release'
          committer_name: 'Github Action'
          committer_email: 'github_actions@interlisp.org'


