(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED "21-Nov-2024 23:50:21" {WMEDLEY}<internal>TEDIT-DEBUG.;74 129912 

      :EDIT-BY rmk

      :CHANGES-TO (FNS IPCC CHECKLINES)
                  (MACROS DEBUGOUTPUT)

      :PREVIOUS-DATE "20-Nov-2024 00:33:02" {WMEDLEY}<internal>TEDIT-DEBUG.;69)


(PRETTYCOMPRINT TEDIT-DEBUGCOMS)

(RPAQQ TEDIT-DEBUGCOMS
       [
        (* ;; "This is an internal/ file containing a hodge-podge of functions for use in Tedit debugging.  To start working on TEDIT, (LOAD 'TEDIT-DEBUG.LCOM) and then run (TEDIT--DEBUG).  That will load TEDIT-EXPORTS.ALL and EXPORTS.ALL, load the fuller database if available, and analyze the functions on TEDITFILES.  And leave you connected to {MEDLEYDIR}/library/tedit/.")

        
        (* ;; "This has functions for accessing,showing, inspecting and manipulating a variety of internal Tedit data structures (textobj, piece, line, selection, thisline), and other random bits of code.  It has grown as different issues have been addressed, at some point it should be cleaned up and documented.")

        
        (* ;; 
  "This is stored in internal/ so that it remains compatible with the commits/branches/PRs/releases.")

        (FNS MH)
        (VARS (\TEDIT.THELPFLG T))
        (COMS (FNS GTO GTS GTW)
              (INITVARS (LASTTEXTSTREAM NIL)))
        (FNS TRELMOVE TSCROLL)
        (FNS ITS TRY PRINTSPEC TEDITCLOSEW PARALASTWITHOUTEOL FIXPARALAST)
        (FNS GETEDITPROPS)
        (FNS MTEST TRYMENU PTMENU SHOWMENUPROPS IMB)
        (FNS SP SSP SPL SCL SPPRINT SPPRINT.CHAR SPPRINT.OBJ SHOWPIECEBYTES CHECKPLENGTHS SBT 
             COPYPCHAIN)
        (FNS POSLINE)
        (FNS PRESPLIT)
        (FNS NTHPIECE NPIECES NTHPIECECHAR SELPIECE PIECENUM INSPECTPIECES PCBYTES FILEBYTES TFBYTES)
        (FNS IPANES)
        (FNS STL ALLTL ITL NTHCHARSLOT)
                                                             (* ; "THISLINE")
        (FNS PLCHAIN PRINTLINE ILINES SL SL.GETLINES SLL SHOWLINE CHECKLINES COLLECTLINES NTHLINE 
             HEIGHT LINEBOTS SPLINES)
        (FNS ISELS ISEL IHIST IPCTB IPC IPCC IPC.DECODEARGS GSEL)
        (FNS SPF SPF1)
                                                             (* ; "Page frames")
        (FNS SLF SLF.FATPLEN)
                                                             (* ; "Show looks file")
        (FNS SELTEDIT)
                                                             (* ; "New editor on an old selection")
        (COMS                                                (* ; "Bravo")
              (FNS PPARA PRUN ADDLINEPOSITIONS SBR SBC))
        (INITVARS (LASTTS NIL))
        (VARS (OK.TO.MODIFY.FNS T))
        (FNS DFOV FINDFILEVERSION OLDWI DFOV.OLDEST COMP DFR)
        (FNS DFGV GDIRECTORIES)
        (COMS (FNS TTEST LTEST INSP THC)
              (INITVARS (LASTTTESTFILE))
              (VARS * TTESTREGIONS))
        (COMS (FNS SHOWSAFE)
              (INITVARS SAFESHOW SAFEHELP))
        (VARS VTDIR VTF TF)
        (FNS DFV VSEE)
        (FNS PTT)
                                                             (* ; "Plain text")
        (FNS CONCATFILES)
        (MACROS DEBUGOUTPUT)
        (FNS TEDIT-DEBUG)
        (FNS TRENAME)
        (DECLARE%: DONTEVAL@LOAD DOEVAL@COMPILE DONTCOPY COMPILERVARS (ADDVARS (NLAMA VSEE DFGV DFOV)
                                                                             (NLAML DFV DFR)
                                                                             (LAMA])



(* ;; 
"This is an internal/ file containing a hodge-podge of functions for use in Tedit debugging.  To start working on TEDIT, (LOAD 'TEDIT-DEBUG.LCOM) and then run (TEDIT--DEBUG).  That will load TEDIT-EXPORTS.ALL and EXPORTS.ALL, load the fuller database if available, and analyze the functions on TEDITFILES.  And leave you connected to {MEDLEYDIR}/library/tedit/."
)




(* ;; 
"This has functions for accessing,showing, inspecting and manipulating a variety of internal Tedit data structures (textobj, piece, line, selection, thisline), and other random bits of code.  It has grown as different issues have been addressed, at some point it should be cleaned up and documented."
)




(* ;; 
"This is stored in internal/ so that it remains compatible with the commits/branches/PRs/releases.")

(DEFINEQ

(MH
  [LAMBDA (MESS1 MESS2 SKIP N)                               (* ; "Edited 31-Jul-2024 21:41 by rmk")

    (* ;; "Call HELP after waiting a bit")

    (CL:UNLESS SKIP
        (DISMISS (OR N 500))
        (HELP MESS1 MESS2))])
)

(RPAQQ \TEDIT.THELPFLG T)
(DEFINEQ

(GTO
  [LAMBDA (ARG NOERROR)                                      (* ; "Edited  9-Aug-2024 13:14 by rmk")
    (LET ((TSTREAM (GTS ARG NOERROR)))
         (CL:WHEN TSTREAM
             (fetch (TEXTSTREAM TEXTOBJ) of TSTREAM))])

(GTS
  [LAMBDA (ARG NOERROR)                                      (* ; "Edited  4-Oct-2024 22:13 by rmk")
                                                             (* ; "Edited 21-Sep-2024 21:51 by rmk")
                                                             (* ; "Edited 11-Aug-2024 21:53 by rmk")
    (CL:UNLESS (AND (TEXTSTREAM LASTTEXTSTREAM T)
                    (OPENWP (\TEDIT.PRIMARYPANE LASTTEXTSTREAM)))
           (SETQ LASTTEXTSTREAM NIL))
    (LET ((TSTREAM (TEXTSTREAM (OR ARG (WHICHW))
                          T)))
         (if TSTREAM
             then (if (EQ TSTREAM LASTTEXTSTREAM)
                    elseif (NULL LASTTEXTSTREAM)
                      then (SETQ LASTTEXTSTREAM TSTREAM)
                    elseif (AND (NOT (OR (type? TEXTOBJ ARG)
                                         (STREAMP ARG)))
                                (EQ 'Y (ASKUSER NIL 'Y "  Switch default textstream? ")))
                      then (SETQ LASTTEXTSTREAM TSTREAM))
                  TSTREAM
           elseif (AND (NULL ARG)
                       LASTTEXTSTREAM)
           elseif NOERROR
             then NIL
           else (TEXTSTREAM ARG])

(GTW
  [LAMBDA (ARG)                                              (* ; "Edited  5-Nov-2024 13:50 by rmk")
    (\TEDIT.PRIMARYPANE (GTO ARG])
)

(RPAQ? LASTTEXTSTREAM NIL)
(DEFINEQ

(TRELMOVE
  [LAMBDA (DY ARG)                                           (* ; "Edited  5-Nov-2024 15:29 by rmk")
    (RELMOVEW (GTW ARG)
           (create POSITION
                  XCOORD _ 0
                  YCOORD _ DY])

(TSCROLL
  [LAMBDA (DY ARG)                                           (* ; "Edited  5-Nov-2024 15:30 by rmk")
    (SCROLLW (GTW ARG)
           0 DY])
)
(DEFINEQ

(ITS
  [LAMBDA (TS KEEPOPEN NPIECES)                              (* ; "Edited 26-Nov-2023 20:46 by rmk")
                                                             (* ; "Edited 31-Oct-2023 19:44 by rmk")
                                                             (* ; "Edited 21-Oct-2023 17:04 by rmk")
                                                             (* ; "Edited  9-Oct-2022 13:01 by rmk")
                                                             (* ; "Edited 14-Sep-2022 08:33 by rmk")

    (* ;; "Inspect the key components of a Text stream TS")

    (SETQ TS (GTS (OR TS (AND (BOUNDP 'LASTTTS)
                              LASTTS))
                  TS))
    (SETQ LASTTS TS)
    (CL:UNLESS KEEPOPEN (CLOSEI))
    [LET (R)
         [INSPECT (FETCH PCTB OF (TEXTOBJ TS))
                'LIST
                (CL:UNLESS KEEPOPEN
                    (SETQ R (CREATEREGION 5 5 240 316)))]
         [INSPECT TS 'TEXTSTREAM (CL:UNLESS KEEPOPEN
                                     (CREATEPOSITION 5 (IPLUS 5 (FETCH (REGION TOP) OF R))))]
         (INSPECT TS NIL (CL:UNLESS KEEPOPEN (CREATEREGION 300 5 360 628)))
         (INSPECT (TEXTOBJ TS)
                NIL
                (CL:UNLESS KEEPOPEN
                    (CREATEREGION (IPLUS 5 660)
                           5 315 628))]
    (SP TS (OR NPIECES 10))
    TS])

(TRY
  [LAMBDA (FILE VAR KEEPOPEN)                                (* ; "Edited 17-Mar-2024 12:57 by rmk")
                                                             (* ; "Edited  5-Sep-2022 18:48 by rmk")
                                                             (* ; "Edited  1-Sep-2022 22:43 by rmk")
                                                             (* ; "Edited 10-Aug-2022 13:12 by rmk")
                                                             (* ; "Edited  1-Aug-2022 21:30 by rmk")
    (CL:UNLESS VAR
        (SETQ VAR 'TSTR))
    (LET [(TSTREAM (AND (BOUNDP VAR)
                        (TEXTSTREAMP (EVAL VAR]
         (CL:WHEN (AND TSTREAM (OPENWP (WFROMDS TSTREAM)))
             (CL:UNLESS KEEPOPEN
                 (CLOSEW (WFROMDS TSTREAM))))
         (SETQ TSTREAM (OPENTEXTSTREAM (SELECTQ FILE
                                           (NIL '{LI}FEW.TXT)
                                           (T '{LI}LOTS.TXT)
                                           FILE)))
         (TEDIT TSTREAM (CREATEREGION 817 900 397 80)
                NIL
                '(LEAVETTY T))
         (SET VAR TSTREAM)
         (PROG1 (ITS TSTREAM KEEPOPEN)
                (\TEDIT.CHECK-BTREE TSTREAM])

(PRINTSPEC
  [LAMBDA (SPEC)                                             (* ; "Edited 14-Aug-2022 22:08 by rmk")
    (FOR I FROM 1 AS S IN (OR SPEC TESTSPEC) DO (PRINTOUT T .I2 I " " .P2 S T])

(TEDITCLOSEW
  [LAMBDA NIL                                                (* ; "Edited  1-Sep-2022 22:52 by rmk")
    (LET ((W (WHICHW)))
         (CL:WHEN (MEMB 'TEDIT.DEACTIVATE.WINDOW (WINDOWPROP W 'CLOSEFN))
             [WINDOWPROP W 'CLOSEFN (REMOVE 'TEDIT.DEACTIVATE.WINDOW (WINDOWPROP W 'CLOSEFN]
             (CLOSEW W))])

(PARALASTWITHOUTEOL
  [LAMBDA (TSTREAM HELP)                                     (* ; "Edited 17-Mar-2024 12:55 by rmk")
                                                             (* ; "Edited 16-Mar-2024 10:06 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:54 by rmk")
                                                             (* ; "Edited 24-Oct-2022 21:07 by rmk")
    (LET ((TEXTOBJ (TEXTOBJ TSTREAM)))
         (for PC inpieces (\TEDIT.FIRSTPIECE TEXTOBJ) when (PPARALAST PC)
            unless (MEMB (NTHPIECECHAR PC -1)
                         (CHARCODE (EOL CR LF))) do (SPPRINT PC NIL TEXTOBJ)
                                                    (CL:WHEN HELP
                                                        (HELP PC (\TEDIT.PCTOCH PC TEXTOBJ)))])

(FIXPARALAST
  [LAMBDA (TSTREAM HELP)                                     (* ; "Edited 16-Mar-2024 10:06 by rmk")
                                                             (* ; "Edited 24-Oct-2022 21:59 by rmk")
    (for (PC _ (\TEDIT.FIRSTPIECE (TEXTOBJ TSTREAM))) by (NEXTPIECE PC) while PC
       when (PPARALAST PC) unless (MEMB (NTHPIECECHAR PC -1)
                                        (CHARCODE (EOL CR LF)))
       do (replace (PIECE PPARALAST) of PC with NIL])
)
(DEFINEQ

(GETEDITPROPS
  [LAMBDA (TEXTOBJ)                                          (* ; "Edited 22-Sep-2023 21:53 by rmk")
    (GETTOBJ TEXTOBJ EDITPROPS])
)
(DEFINEQ

(MTEST
  [LAMBDA NIL                                                (* ; "Edited  9-Apr-2023 15:23 by rmk")
    (LET [(TSTR (TTEST 'JUST2]
         (SETQ TOBJ (TEXTOBJ TSTR))
         (SETQ TW (WFROMDS TSTR))
         [SETQ MW (OR (\TEDIT.EXPANDEDPARA.MENU TSTR)
                      (find W in (WINDOWPROP TW 'ATTACHEDWINDOWS)
                         suchthat (STREQUAL "Paragraph-Looks Menu" (WINDOWPROP W 'TEDITMENU]
         (SETQ MTO (TEXTOBJ MW))
         (SETQ MSEL (FETCH SEL OF MTO))
         (SETQ MTSTR (TEXTSTREAM MTO])

(TRYMENU
  [LAMBDA (SPEC)                                             (* ; "Edited 19-Aug-2022 21:56 by rmk")
                                                             (* ; "Edited 17-Aug-2022 14:46 by rmk")
    (CLOSEI)
    (MYTEDITMENU (OR SPEC TESTSPEC])

(PTMENU
  [LAMBDA (MENUDESC)                                         (* ; "Edited 18-Aug-2022 08:28 by rmk")
    (FOR I (CH# _ 1) FROM 1 AS DESC IN MENUDESC
       DO (PRINTOUT T .I3 I " " .I4 CH# " " .P2 DESC T)
          (ADD CH# (SELECTQ (CAR DESC)
                       (MB.TEXT (NCHARS (CADR DESC)))
                       (MB.INSERT 4)
                       1])

(SHOWMENUPROPS
  [LAMBDA (TSTREAM)                                          (* ; "Edited 29-Sep-2024 14:44 by rmk")
                                                             (* ; "Edited 29-Jul-2024 12:27 by rmk")
    (for PC PROP OBJ inpieces (\TEDIT.FIRSTPIECE (GTO TSTREAM))
       when [AND (EQ OBJECT.PTYPE (PTYPE PC))
                 (SETQ PROP (IMAGEOBJPROP (SETQ OBJ (PCONTENTS PC))
                                   'IDENTIFER] collect (LIST PROP (IMAGEOBJPROP OBJ 'IMAGECLASSNAME])

(IMB
  [LAMBDA (KEY ARG)                                          (* ; "Edited 22-Aug-2024 16:34 by rmk")
                                                             (* ; "Edited 21-Aug-2024 10:00 by rmk")
                                                             (* ; "Edited  8-Aug-2024 09:08 by rmk")
                                                             (* ; "Edited  4-Aug-2024 09:05 by rmk")

    (* ;; "Inspect the menu button for KEY")

    (LET [(OBJ (MB.FIND KEY (GTO ARG)
                      'OBJECT]
         (CL:IF OBJ (INSPECT OBJ NIL NIL KEY])
)
(DEFINEQ

(SP
  [LAMBDA (PC NP OFILE TOBJ FONT NOCR)                       (* ; "Edited  9-Sep-2024 14:53 by rmk")
                                                             (* ; "Edited  1-Sep-2024 00:05 by rmk")
                                                             (* ; "Edited 11-Aug-2024 21:06 by rmk")
                                                             (* ; "Edited 15-Jun-2024 11:52 by rmk")
                                                             (* ; "Edited 21-May-2024 11:29 by rmk")
                                                             (* ; "Edited 13-May-2024 12:16 by rmk")
                                                             (* ; "Edited  5-May-2024 12:56 by rmk")
                                                             (* ; "Edited 29-Apr-2024 12:46 by rmk")
                                                             (* ; "Edited 17-Mar-2024 12:58 by rmk")
                                                             (* ; "Edited 16-Mar-2024 10:07 by rmk")
                                                             (* ; "Edited 11-Jan-2024 22:19 by rmk")
                                                             (* ; "Edited  3-Jan-2024 00:41 by rmk")
                                                             (* ; "Edited 27-Dec-2023 13:02 by rmk")
                                                             (* ; "Edited 25-Nov-2023 10:49 by rmk")
                                                             (* ; "Edited 23-Nov-2023 11:47 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:56 by rmk")

    (* ;; "PC is the starting piece, NP is the number of pieces including it.")

    (* ;; "OFILE=T or TEDIT means Tedit stream.  NIL means primary output (usually T)")

    (LET ((TEXTOBJ (CL:IF (type? TEXTOBJ PC)
                       PC
                       (GTO TOBJ)))
          WTYPE)
         (CL:WHEN (AND NP (LITATOM NP)
                       (NULL OFILE))
             (SETQ WTYPE (CL:IF (EQ NP T)
                             'SP
                             NP))
             (SETQ NP NIL))
         [if (type? PIECE PC)
           elseif (NULL PC)
             then [SETQ PC (\TEDIT.FIRSTPIECE (OR TEXTOBJ (GTO]
           elseif [AND (FIXP PC)
                       (OR TEXTOBJ (AND TOBJ (SETQ TEXTOBJ (GTO]
             then (SETQ PC (NTHPIECE TEXTOBJ PC))
           elseif (type? SELECTION PC)
             then (CL:UNLESS TEXTOBJ
                      (SETQ TEXTOBJ (TEXTOBJ PC)))
                  (SETQ PC (\TEDIT.CHTOPC (GETSEL PC CH#)
                                  TEXTOBJ))
           elseif (AND (EQ T PC)
                       TEXTOBJ)
             then (SETQ PC (\TEDIT.CHTOPC (GETSEL (TEXTSEL TEXTOBJ)
                                                 CH#)
                                  TEXTOBJ))
           elseif (OR (EQ PC TEXTOBJ)
                      (SETQ TEXTOBJ (GTO PC T)))
             then (SETQ PC (\TEDIT.FIRSTPIECE TEXTOBJ))
           elseif (type? LINEDESCRIPTOR (CAR (MKLIST PC)))
             then 
                  (* ;; "Assume it's from the current TEXTOBJ")

                  (SETQ PC (\TEDIT.CHTOPC (GETLD (CAR (MKLIST PC))
                                                 LCHAR1)
                                  (GTO TEXTOBJ]
         (CL:UNLESS (SMALLP NP)
             (SETQ NP (CL:IF NP
                          20
                          MAX.SMALLP)))
         (DEBUGOUTPUT OFILE WTYPE (DSPFONT (OR FONT '(TERMINAL 8))
                                         OFILE)
                (for P PFILES inpieces PC as I from 1 to NP
                   do 
                      (* ;; "Put the fileptrs back where they were.")

                      (CL:WHEN (AND (MEMB (PTYPE PC)
                                          FILE.PTYPES)
                                    (NOT (MEMB (PCONTENTS PC)
                                               PFILES)))
                          (CL:UNLESS (GETSTREAM (PCONTENTS PC)
                                            'INPUT T)
                                 (\TEDIT.REOPEN.STREAM TEXTOBJ))
                          [RESETSAVE (GETFILEPTR (PCONTENTS PC))
                                 `(PROGN (SETFILEPTR ,(PCONTENTS PC)
                                                OLDVALUE])
                      (PRINTOUT OFILE .I3 I "/")
                      (SPPRINT P OFILE TEXTOBJ NOCR))
                (TERPRI OFILE))
         PC])

(SSP
  [LAMBDA (SELPIECES NP OFILE TEXTOBJ)                       (* ; "Edited  3-Mar-2024 12:58 by rmk")
                                                             (* ; "Edited 12-Feb-2024 12:33 by rmk")
                                                             (* ; "Edited 22-Nov-2023 20:23 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:52 by rmk")
                                                             (* ; "Edited  9-May-2023 13:50 by rmk")
                                                             (* ; "Edited  7-May-2023 20:47 by rmk")

    (* ;; "Prints up to NP pieces from SELPIECES.")

    (SETQ TEXTOBJ (GTO TEXTOBJ))
    (CL:UNLESS NP (SETQ NP 50))
    (DEBUGOUTPUT OFILE (CL:UNLESS OFILE 'SSP)
           (for PC inselpieces SELPIECES as I from 1 to NP do (PRINTOUT OFILE .I3 I "/")
                                                              (SPPRINT PC OFILE TEXTOBJ)))
    SELPIECES])

(SPL
  [LAMBDA (PC)                                               (* ; "Edited 11-Apr-2023 11:42 by rmk")
    (CL:WHEN (FIXP PC)
        (SETQ PC (NTHPIECE (GTO)
                        PC)))
    (INSPECT (PPARALOOKS PC])

(SCL
  [LAMBDA (PC TOBJ)                                          (* ; "Edited  4-Oct-2024 13:33 by rmk")

    (* ;; "Inspect the character looks of a piece")
                                                             (* ; "Edited 11-Apr-2023 11:42 by rmk")
    (LET ((DECODED (IPC.DECODEARGS PC TOBJ)))
         (SETQ PC (POP DECODED))
         (INSPECT (PLOOKS PC)
                NIL NIL (CONCAT PC " " (POP DECODED])

(SPPRINT
  [LAMBDA (P OSTREAM TEXTOBJ NOCR)                           (* ; "Edited  5-Aug-2024 00:30 by rmk")
                                                             (* ; "Edited  5-May-2024 12:55 by rmk")
                                                             (* ; "Edited 23-Apr-2024 08:54 by rmk")
                                                             (* ; "Edited 17-Mar-2024 12:58 by rmk")
                                                             (* ; "Edited 22-Jan-2024 20:52 by rmk")
                                                             (* ; "Edited 13-Jan-2024 23:54 by rmk")
                                                             (* ; "Edited 28-Dec-2023 21:21 by rmk")
                                                             (* ; "Edited 26-Dec-2023 09:00 by rmk")
                                                             (* ; "Edited 23-Dec-2023 16:55 by rmk")
                                                             (* ; "Edited  7-Dec-2023 15:55 by rmk")
                                                             (* ; "Edited  9-Nov-2023 17:04 by rmk")
                                                             (* ; "Edited 24-Oct-2022 17:13 by rmk")
                                                             (* ; "Edited  8-Aug-2022 15:36 by rmk")
                                                             (* ; 
                                   "TMAX image objects want TEXTOBJ context, although they shouldn't")
    (DECLARE (SPECVARS TEXTOBJ))
    (CL:WHEN (FIXP P)
        (SETQ P (\TEDIT.CHTOPC P TEXTOBJ)))

    (* ;; "Prints a summary of PC on OSTREAM.  If PC is acharno and TEXTOBJ is provided, maps the CHNO to its pc.")

    (COND
       ((PCONTENTS P)
        (LET ((POS (POSITION OSTREAM))
              (PLEN (PLEN P))
              (PCONTENTS (PCONTENTS P))
              (PTYPE (PTYPE P))
              (CHNO (CL:IF (FGETPC P PTREENODE)
                        (\TEDIT.PCTOCH P TEXTOBJ)
                        1))
              (FONT (DSPFONT NIL OSTREAM))
              (PARALOOKS (PPARALOOKS P)))
             (CL:WHEN (AND (STREAMP PCONTENTS)
                           (NOT (\GETSTREAM PCONTENTS 'INPUT T)))
                 (SETQ PCONTENTS (\TEDIT.REOPEN.STREAM TEXTOBJ PCONTENTS)))
             (PRINTOUT OSTREAM .TAB0 POS .I3 CHNO " P" (SUBSTRING P (IPLUS 2 (STRPOS "}" P)))
                    .TAB0
                    (IPLUS 22 POS)
                    "  ")
             (CL:WHEN (MEMB PTYPE FILE.PTYPES)
                 (SETFILEPTR PCONTENTS (PFPOS P)))
             (PRINTOUT OSTREAM (SELECTC PTYPE
                                   (THINFILE.PTYPE 
                                        'Thinfile)
                                   (FATFILE1.PTYPE 
                                        "Fatfile1")
                                   (FATFILE2.PTYPE 
                                        'Fatfile2)
                                   (THINSTRING.PTYPE 
                                        'Thinstring)
                                   (FATSTRING.PTYPE 
                                        'Fatstring)
                                   (UTF8.PTYPE 'UFT-8)
                                   (SUBSTREAM.PTYPE 
                                        'Substream)
                                   (OBJECT.PTYPE 'Object)
                                   (LOOKS.PTYPE 'Looks)
                                   NIL)
                    .TAB0
                    (IPLUS POS 35)
                    .I4 PLEN (CL:IF (PPARALAST P)
                                 "*"
                                 "")
                    (CL:IF (type? FMTSPEC PARALOOKS)
                        (if (fetch (FMTSPEC FMTNEWPAGEBEFORE) of PARALOOKS)
                            then (CL:IF (fetch (FMTSPEC FMTNEWPAGEAFTER) of PARALOOKS)
                                     "ba"
                                     "b")
                          elseif (fetch (FMTSPEC FMTNEWPAGEAFTER) of PARALOOKS)
                            then "a"
                          else "")
                        "")
                    .TAB0
                    (IPLUS POS 43))
             (CL:WHEN (EQ OSTREAM T)
                 (DSPFONT '(MODERN 8)
                        OSTREAM))
             [if (EQ PLEN 0)
                 then (PRINTOUT OSTREAM "[Empty piece]" T)
               elseif (EQ OBJECT.PTYPE (PTYPE P))
                 then (PRINTOUT OSTREAM PCONTENTS -3)
                      (SPPRINT.OBJ PCONTENTS OSTREAM (IPLUS POS 43))
               else (CL:WHEN (AND (type? CHARLOOKS (PLOOKS P))
                                  (fetch (CHARLOOKS CLINVISIBLE) of (PLOOKS P)))
                           (PRIN1 "i " OSTREAM))
                    (PRIN1 "%"" OSTREAM)
                    (for I C from 1 to PLEN
                       do (SETQ C (\TEDIT.PIECE.NTHCHARCODE TEXTOBJ P I))
                          (PRIN1 (SELCHARQ C
                                      ((EOL CR) 
                                           "[EOL]")
                                      (LF "[LF]")
                                      (FORM "[FORM]")
                                      (TAB "[TAB]")
                                      (Meta,TAB "[MTAB]")
                                      (Meta,EOL "[MLB]")
                                      (CHARACTER C))
                                 OSTREAM)
                          (CL:WHEN (IEQP I PLEN)
                              (PRIN1 '%" OSTREAM))
                          (CL:WHEN [AND (NOT NOCR)
                                        (MEMB C (CHARCODE (EOL CR LF FORM]
                              (TERPRI OSTREAM)
                              (CL:UNLESS (IEQP I PLEN)
                                  (DSPFONT (PROG1 (DSPFONT FONT OSTREAM)

                                               (* ;; "Add1 for %"")

                                               (TAB (ADD1 42)
                                                    0 OSTREAM))
                                         OSTREAM)))]
             (TERPRI OSTREAM)
             (DSPFONT FONT OSTREAM)))
       (T (PRINTOUT OSTREAM "Piece has no CONTENTS" P T)))
    P])

(SPPRINT.CHAR
  [LAMBDA (C OSTREAM LAST FONT)                              (* ; "Edited  4-Nov-2023 22:51 by rmk")
                                                             (* ; "Edited  8-Aug-2023 18:15 by rmk")
                                                             (* ; "Edited  6-Aug-2023 22:20 by rmk")
    (HELP 'NOTUSED)
    (PRIN1 (SELCHARQ C
                ((EOL CR) 
                     "[EOL]")
                (LF "[LF]")
                (FORM "[FORM]")
                (TAB "[TAB]")
                (Meta,TAB "[MTAB]")
                (CHARACTER C))
           OSTREAM)
    (CL:WHEN LAST
        (PRIN1 '%" OSTREAM))
    (CL:WHEN (MEMB C (CHARCODE (EOL CR LF FORM)))
        (TERPRI OSTREAM)
        (CL:UNLESS LAST
            (DSPFONT (PROG1 (DSPFONT FONT OSTREAM)

                         (* ;; "Add1 for %"")

                         (TAB (ADD1 42)
                              0 OSTREAM))
                   OSTREAM)))])

(SPPRINT.OBJ
  [LAMBDA (OBJ STREAM POS)                                   (* ; "Edited  6-Oct-2024 20:54 by rmk")
                                                             (* ; "Edited 29-Sep-2024 14:45 by rmk")
                                                             (* ; "Edited 29-Aug-2024 10:44 by rmk")
                                                             (* ; "Edited 25-Aug-2024 14:31 by rmk")
                                                             (* ; "Edited 21-Aug-2024 09:36 by rmk")
                                                             (* ; "Edited  5-Aug-2024 00:31 by rmk")
                                                             (* ; "Edited  1-Aug-2024 00:09 by rmk")
                                                             (* ; "Edited 28-Jul-2024 09:47 by rmk")
                                                             (* ; "Edited 26-Jul-2024 13:19 by rmk")
                                                             (* ; "Edited 23-Apr-2024 15:02 by rmk")
                                                             (* ; "Edited 29-Jul-2023 23:36 by rmk")
                                                             (* ; "Edited 16-Jul-2023 15:20 by rmk")
                                                             (* ; "Edited  8-Jul-2023 23:09 by rmk")
                                                             (* ; "Edited 25-Jun-2023 18:27 by rmk")
                                                             (* ; "Edited 28-Sep-2022 11:13 by rmk")
                                                             (* ; "Edited  7-Sep-2022 15:21 by rmk")
    (CL:UNLESS [NLSETQ (SELECTQ (IMAGEOBJPROP OBJ 'DISPLAYFN)
                           (MB.NWAY.DISPLAYFN 
                                (PRINTOUT STREAM (IMAGEOBJPROP OBJ 'IDENTIFIER)
                                       ":" T .TAB (IPLUS POS 2))
                                (for SOBJ in (IMAGEOBJPROP OBJ 'SUBOBJECTS)
                                   do (PRINTOUT STREAM (IMAGEOBJPROP SOBJ 'IDENTIFIER)
                                             " ")))
                           (if (OR (IMAGEOBJPROP OBJ 'IDENTIFIER)
                                   (IMAGEOBJPROP OBJ 'LABEL))
                               then (PRIN1 (OR (IMAGEOBJPROP OBJ 'IDENTIFIER)
                                               (IMAGEOBJPROP OBJ 'LABEL))
                                           STREAM)
                             elseif (IMAGEOBJPROP OBJ 'PREPRINTFN)
                               then (LET ((PPRINT (APPLY* (IMAGEOBJPROP OBJ 'PREPRINTFN)
                                                         OBJ STREAM)))
                                         (CL:WHEN PPRINT (PRIN1 PPRINT STREAM]
           (PRIN1 "**IMAGEOBJECT DISPLAY ERROR**" STREAM])

(SHOWPIECEBYTES
  [LAMBDA (PC TSTREAM)                                       (* ; "Edited 21-Oct-2023 10:45 by rmk")
                                                             (* ; "Edited 11-Oct-2022 13:58 by rmk")
    (CL:WHEN (AND (FIXP PC)
                  (TEXTSTREAM TSTREAM))
        (SETQ PC (NTHPIECE (TEXTSTREAM TSTREAM)
                        PC)))
    (CL:UNLESS (TYPE? PIECE PC)
           (ERROR "NOT A PIECE" PC))
    (CL:UNLESS (MEMB (PTYPE PC)
                     FILE.PTYPES)
           (ERROR "NOT A FILE PIECE TYPE"))
    (LET ((FILE (PCONTENTS PC))
          (FAT (EQ FATFILE2.PTYPE (PTYPE PC)))
          NBYTES)
         (SPPRINT PC T (TEXTOBJ TSTREAM))
         (SETQ NBYTES (CL:IF FAT
                          (UNFOLD (PLEN PC)
                                 2)
                          (PLEN PC)))
         (SETFILEPTR FILE (PFPOS PC))
         (for I from 1 to NBYTES do (PRINTOUT T (BIN FILE)
                                           " "))
         (TERPRI T)
         (SETFILEPTR FILE (PFPOS PC))
         [for I from 1 to (CL:IF FAT
                              (FOLDLO NBYTES 2)
                              NBYTES) do (PRINTOUT T (CHARACTER (CL:IF FAT
                                                                    (\WIN FILE)
                                                                    (BIN FILE))]
         (TERPRI T])

(CHECKPLENGTHS
  [LAMBDA (MSG TOBJ)                                         (* ; "Edited 16-Mar-2024 10:07 by rmk")
                                                             (* ; "Edited 13-Apr-2023 23:11 by rmk")
    (find P inpieces (\TEDIT.FIRSTPIECE (GTO TOBJ)) when (ILESSP (PLEN P)
                                                                0)
       do (HELP (CONCAT "negative" MSG)
                P])

(SBT
  [LAMBDA (DONTCLOSE ARG)                                    (* ; "Edited 13-Jun-2024 22:00 by rmk")
                                                             (* ; "Edited 31-Oct-2023 19:44 by rmk")
                                                             (* ; "Edited 29-May-2023 17:23 by rmk")
                                                             (* ; "Edited 26-May-2023 11:05 by rmk")

    (* ;; "Inspect the BTREE")

    (LET ([W (WINDOWP (GETATOMVAL 'BTW]
          (POS (CREATEPOSITION 50 10)))
         (if DONTCLOSE
             then (CL:WHEN W
                      (SETQ POS (CREATEPOSITION [IPLUS 2 (FETCH (REGION RIGHT)
                                                            OF (WINDOWPROP W 'REGION]
                                       10)))
           else (CLOSEW W))
         (SETATOMVAL 'BTW (INSPECT (fetch PCTB of (GTO ARG))
                                 'LIST POS])

(COPYPCHAIN
  [LAMBDA (PIECES I J)                                       (* ; "Edited 23-Sep-2023 11:38 by rmk")

    (* ;; "Produces a chain of copies of the pieces in PIECES from I to J. The pieces are chained in both directions so a copy can be copied or shortened.")

    (for PC NEWPC [LASTPC _ (NTHPIECE PIECES (IMIN (NPIECES PIECES)
                                                   (OR J (NPIECES PIECES]
       inpieces (NTHPIECE PIECES (IMAX 1 (OR I 1)))
       do (SETQ NEWPC (create PIECE using PC PREVPIECE _ NEWPC)) repeatuntil (EQ PC LASTPC)
       finally (RETURN (for NPC NEXTPC backpieces NEWPC do (SETPC NPC NEXTPIECE NEXTPC)
                                                           (SETQ NEXTPC NPC)
                          finally (RETURN NPC])
)
(DEFINEQ

(POSLINE
  [LAMBDA (FILEPOS INSTREAM OUTSTREAM)                       (* ; "Edited  7-Aug-2023 22:22 by rmk")
                                                             (* ; "Edited  6-Aug-2023 09:16 by rmk")

    (* ;; "Copies the characters in the line containing the byte after FILEPOS (e.g. byte presumably after the one just read) in INSTREAM to OUTSTREAM")

    (RESETLST
        (CL:UNLESS (\GETSTREAM INSTREAM 'INPUT T)
            [RESETSAVE (SETQ INSTREAM (OPENSTREAM INSTREAM 'INPUT))
                   `(PROGN (CLOSEF? OLDVALUE])
        [RESETSAVE (GETFILEPTR INSTREAM)
               `(PROGN (SETFILEPTR ,INSTREAM OLDVALUE]       (* ; "Back up to just read")
        (LET (START END AFTERCR)
             (SETFILEPTR INSTREAM FILEPOS)                   (* ; 
                                                        "If we just read an EOL, go to the next line")
             (SETQ AFTERCR (CL:IF (EQ (CHARCODE EOL)
                                      (\BACKCCODE.EOLC INSTREAM 'ANY))
                               (ADD1 FILEPOS)
                               FILEPOS))
             (SETFILEPTR INSTREAM AFTERCR)
             (SETQ START (DO (SELCHARQ (\BACKCCODE.EOLC INSTREAM 'ANY)
                                  (EOL (\INCCODE.EOLC INSTREAM)
                                       (RETURN (GETFILEPTR INSTREAM)))
                                  (NIL (RETURN 0))
                                  NIL)))
             (SETFILEPTR INSTREAM AFTERCR)
             (SETQ END (DO (SELCHARQ (AND (\PEEKCCODE INSTREAM T)
                                          (\INCCODE.EOLC INSTREAM 'ANY))
                                (EOL (RETURN (GETFILEPTR INSTREAM)))
                                (NIL (RETURN 0))
                                NIL)))
             (PRINTOUT OUTSTREAM .I6 FILEPOS ": ")
             (COPYCHARS INSTREAM OUTSTREAM START FILEPOS)
             (PRIN1 (CHARACTER 128)
                    OUTSTREAM)
             (COPYCHARS INSTREAM OUTSTREAM FILEPOS END)))])
)
(DEFINEQ

(PRESPLIT
  [LAMBDA (N SPREAD)                                         (* ; "Edited 26-May-2023 11:07 by rmk")
    (TTEST)
    (CL:UNLESS N (SETQ N 7))
    (CL:UNLESS SPREAD (SETQ SPREAD 4))
    (LET ((TEXTOBJ (GTO)))
         [for I (POS _ (CL:IF (IGREATERP SPREAD 0)
                           0
                           90)) from 1 to 3 do (TEDIT.INSERT TEXTOBJ (CONCAT I)
                                                      (add POS 4)
                                                      '(FACE BOLD]
         [for I (POS _ 90) from (IDIFFERENCE N 3) to N do (TEDIT.INSERT TEXTOBJ (CONCAT I)
                                                                 (add POS -4)
                                                                 '(FACE BOLD]
         (SP TEXTOBJ)
         (SBT TEXTOBJ])
)
(DEFINEQ

(NTHPIECE
  [LAMBDA (PIECES N)                                         (* ; "Edited 16-Mar-2024 10:07 by rmk")
                                                             (* ; "Edited 16-Sep-2023 12:17 by rmk")
                                                             (* ; "Edited 22-Jun-2023 12:46 by rmk")
                                                             (* ; "Edited 22-May-2023 21:21 by rmk")
                                                             (* ; "Edited  9-Apr-2023 11:36 by rmk")

    (* ;; "N=0 means the previous piece of PIECES (if any).  This might be the dummy empty piece before the firstpiece of a text object.")

    (CL:UNLESS (type? PIECE PIECES)
        (SETQ PIECES (\TEDIT.FIRSTPIECE (GTO PIECES))))
    (if (NULL N)
        then (SETQ N 1)
      elseif (ILESSP N 0)
        then (SETQ N (IPLUS (NPIECES PIECES)
                            N 1)))
    (if (EQ N 0)
        then (PREVPIECE PIECES)
      else (for PC inpieces PIECES as I from 1 when (EQ I N) do (RETURN PC])

(NPIECES
  [LAMBDA (TSTREAM)                                          (* ; "Edited 16-Mar-2024 10:07 by rmk")
                                                             (* ; "Edited  2-Sep-2023 11:02 by rmk")
                                                             (* ; "Edited  6-Apr-2023 23:39 by rmk")
                                                             (* ; "Edited 24-Mar-2023 10:20 by rmk")
                                                             (* ; "Edited 21-Aug-2022 14:47 by rmk")
                                                             (* ; "Edited  8-Aug-2022 08:52 by rmk")
    (for PC inpieces [if (type? PIECE TSTREAM)
                         then TSTREAM
                       else (NEXTPIECE (\TEDIT.FIRSTPIECE (GTO TSTREAM] count T])

(NTHPIECECHAR
  [LAMBDA (PC N)                                             (* ; "Edited 26-Sep-2023 17:48 by rmk")
                                                             (* ; "Edited  8-May-2023 21:25 by rmk")
                                                             (* ; "Edited 24-Oct-2022 21:10 by rmk")

    (* ;; "Gets the Nth CHAR of PC, 0 origin.  The last character is either -1 or (SUB1 PLEN)")

    (LET ((PLEN (PLEN PC))
          (PCONTENTS (PCONTENTS PC)))
         (CL:WHEN (ILESSP N 0)
                (add N PLEN))
         (CL:WHEN (AND (IGEQ N 0)
                       (ILESSP N PLEN))
             (SELECTC (PTYPE PC)
                 (STRING.PTYPES (NTHCHARCODE PCONTENTS N))
                 (THINFILE.PTYPE 
                      (SETFILEPTR PCONTENTS (IPLUS N (fetch (PIECE PFPOS) of PC)))
                      (BIN PCONTENTS))
                 (FATFILE2.PTYPE 
                      (SETFILEPTR PCONTENTS (IPLUS (UNFOLD N 2)
                                                   (fetch (PIECE PFPOS) of PC)))
                      (LOGOR (UNFOLD (BIN PCONTENTS)
                                    256)
                             (BIN PCONTENTS)))
                 (OBJECT.PTYPE PCONTENTS)
                 (SHOULDNT)))])

(SELPIECE
  [LAMBDA (ARG)                                              (* ; "Edited 17-Mar-2024 12:58 by rmk")
                                                             (* ; "Edited 10-Aug-2023 16:57 by rmk")

    (* ;; "Returns the piece containing the first character of the current selection")

    (SETQ ARG (GTO ARG))
    (\TEDIT.CHTOPC (GETSEL (TEXTSEL ARG)
                          CH#)
           ARG])

(PIECENUM
  [LAMBDA (PIECE PIECES)                                     (* ; "Edited 16-Mar-2024 10:07 by rmk")
                                                             (* ; "Edited 16-Sep-2023 09:08 by rmk")

    (* ;; "Returns N if PIECE is the NTH piece of PIECES")

    (CL:UNLESS (type? PIECE PIECE)
           (ERROR "NOT A PIECE" PIECE))
    (CL:UNLESS (type? PIECE PIECES)
        (SETQ PIECES (\TEDIT.FIRSTPIECE (GTO PIECES))))
    (find I from 1 as PC inpieces PIECES suchthat (EQ PC PIECE])

(INSPECTPIECES
  [LAMBDA (PIECE N TAG WHERE)                                (* ; "Edited 16-Mar-2024 10:07 by rmk")
                                                             (* ; "Edited 30-Dec-2023 14:47 by rmk")
                                                             (* ; "Edited  1-Dec-2023 21:34 by rmk")
                                                             (* ; "Edited 27-Nov-2023 12:51 by rmk")
    (CL:UNLESS (type? PIECE PIECE)
        [SETQ PIECE (if (FIXP PIECE)
                        then (NTHPIECE (GTO)
                                    PIECE)
                      elseif (type? SELECTION PIECE)
                        then (SELPIECE PIECE)
                      else (\TEDIT.FIRSTPIECE (GTO PIECE])
    (CL:UNLESS (FIXP N)
        (SETQ WHERE TAG)
        (SETQ TAG N)
        (SETQ N 20))
    (LET (W PIECES)
         (SETQ PIECES (for PC inpieces PIECE as I from 1 to N collect PC))
         (SETQ W (INSPECT/TOP/LEVEL/LIST PIECES))
         (WINDOWPROP W 'TITLE PIECE)
         PIECE])

(PCBYTES
  [LAMBDA (PC)                                               (* ; "Edited 31-Jan-2024 22:32 by rmk")
                                                             (* ; "Edited 23-Jan-2024 12:04 by rmk")
                                                             (* ; "Edited  5-Jan-2024 11:14 by rmk")

    (* ;; "Returns a list of the PFILE bytes for file-piece PC")

    (CL:WHEN (MEMB (PTYPE PC)
                   FILE.PTYPES)
        [LET ((PFILE (PCONTENTS PC)))
             (SETFILEPTR PFILE (PFPOS PC))
             (for I BYTE from 1 to (PBYTELEN PC) collect (SETQ BYTE (BIN PFILE))
                                                       (LIST I (CHARACTER BYTE)
                                                             BYTE
                                                             (SUB1 (GETFILEPTR PFILE])])

(FILEBYTES
  [LAMBDA (FILE START NBYTES)                                (* ; "Edited 15-May-2024 10:44 by rmk")
                                                             (* ; "Edited 23-Jan-2024 12:03 by rmk")
                                                             (* ; "Edited 20-Jan-2024 14:13 by rmk")

    (* ;; "CHARS means return CHARACTER of bytes, since we don't know whether START respects FILES external format alignments.")

    (CL:WHEN (GTO FILE T)
        (SETQ FILE (SELPIECE FILE)))
    (CL:WHEN (type? PIECE FILE)
        (CL:WHEN (MEMB (PTYPE FILE)
                       FILE.PTYPES)
            (CL:UNLESS START
                (SETQ START (PFPOS FILE)))
            (SETQ FILE (PCONTENTS FILE))))
    (CL:UNLESS START (SETQ START 0))
    (CL:UNLESS NBYTES (SETQ NBYTES 40))
    (CL:WITH-OPEN-FILE (STREAM FILE :DIRECTION :INPUT)
           (SETFILEPTR STREAM START)
           (SETQ NBYTES (IMIN NBYTES (IDIFFERENCE (GETEOFPTR STREAM)
                                            START)))
           (FOR I B FROM START AS J FROM 1 TO NBYTES COLLECT (SETQ B (BIN STREAM)) 

                                          (* ;; "Do CHARACTER of the byte, since we don't know whether START respected FILE's external-format character alignment.")

                                                           (LIST I B (CHARACTER B])

(TFBYTES
  [LAMBDA (FILE START NBYTES)                                (* ; "Edited 23-Sep-2024 11:40 by rmk")
    (SETQ FILE (FINDFILE FILE))
    (TEVAL (for B in (FILEBYTES FILE START NBYTES) first (DSPFONT DEFAULTFONT T)
              do (printout T .I6 (CAR B)
                        "  " .I3 (CADR B)
                        "  " .FONT '(MODERN 8)
                        (SELCHARQ (CADR B)
                             (EOL 'EOL)
                             (LF 'LF)
                             (CR 'CR)
                             (SPACE "SP")
                             (CADDR B))
                        .FONT DEFAULTFONT T)
                 T)
           'FILEBYTES
           (CONCAT "Bytes from " FILE])
)
(DEFINEQ

(IPANES
  [LAMBDA (ARG TAG WHERE)                                    (* ; "Edited 28-Jun-2024 21:21 by rmk")
    (INSPECT/ALIST (for P inpanes (GTO ARG) collect (CONS P (PANEPROPS P)))
           WHERE TAG])
)
(DEFINEQ

(STL
  [LAMBDA (THISLINE LASTCS LCHAR1 OFILE)                     (* ; "Edited 22-Aug-2024 23:51 by rmk")
                                                             (* ; "Edited  4-Aug-2024 12:08 by rmk")
                                                             (* ; "Edited 31-Jul-2024 19:55 by rmk")
                                                             (* ; "Edited 29-Jul-2024 09:20 by rmk")
                                                             (* ; "Edited  1-Feb-2024 17:00 by rmk")
                                                             (* ; "Edited 25-Nov-2023 10:50 by rmk")
                                                             (* ; "Edited 23-Nov-2023 11:41 by rmk")
                                                             (* ; "Edited 23-Mar-2023 23:00 by rmk")

    (* ;; "Debugging tool while \FORMATLINE is creating THISLINE, or when it's done.  During creation the NEXTAVAILABLECHARSLOT is at the very end, so bad slots are visible.  When complete, they shouldn't appear.")

    (* ;; "If OFILE isn't given, this goes to a textstream")

    (DECLARE (USEDFREE PREVSP CHARSLOT))
    (CL:UNLESS (type? THISLINE THISLINE)
        (CL:WHEN (EQ THISLINE T)
            (SETQ THISLINE NIL)
            (SETQ LASTCS CHARSLOT))
        (SETQ THISLINE (fetch (TEXTOBJ THISLINE) of (GTO THISLINE))))
    (\DTEST THISLINE 'THISLINE)
    (DEBUGOUTPUT OFILE (CL:IF OFILE
                           NIL
                           'STL)
           (for CSLOT EXPANDSPACES CHNO TX LENGTH CHAR CHARW (SPACEFACTOR _ (FETCH TLSPACEFACTOR
                                                                               OF THISLINE))
                (FIRSTSPACESLOT _ (fetch TLFIRSTSPACE of THISLINE))
                (LINE _ (fetch (THISLINE DESC) of THISLINE))
                (NSPACES _ 0)
                (NCHARS _ 0)
                (SPACETOTAL _ 0)
                (PSP _ (AND (BOUNDP 'PREVSP)
                            (NEQ PREVSP (GETATOMVAL 'PREVSP))
                            PREVSP)) incharslots THISLINE as NSLOTS from 0
              first (if (NULL LINE)
                        then (printout OFILE THISLINE ":" T 5 
                                    "No line parameters, start at CHNO = 1 LX1 = 0" T)
                             (SETQ CHNO 1)
                             (SETQ TX 0)
                      elseif (type? LINEDESCRIPTOR LINE)
                        then (SETQ CHNO (GETLD LINE LCHAR1))
                             (SETQ TX (GETLD LINE LX1))
                             (printout OFILE THISLINE " for " LINE ":" T 5 "Start at CHNO = " CHNO 
                                    " LX1 = " TX ", LXLIM = " (GETLD LINE LXLIM)
                                    T))
                    (CL:WHEN LCHAR1
                        (SETQ CHNO (OR LCHAR1 1)))
                    (SETQ LENGTH TX)
                    (printout OFILE 29 "XLIM" T) eachtime (SETQ CHAR (CHAR CSLOT))
                                                       (SETQ CHARW (CHARW CSLOT))
                                                       (CL:UNLESS (CHARSLOTP CSLOT THISLINE)
                                                              (HELP "THISLINE RUNS OFF THE EDGE" 
                                                                    THISLINE))
              repeatuntil [OR (EQ CSLOT (OR LASTCS (LASTCHARSLOT THISLINE]
              do (printout OFILE .I4 NSLOTS)
                 [if (IMAGEOBJP CHAR)
                     then (add NCHARS 1)
                          (printout OFILE " " .I5 CHNO ": ")
                          (add TX CHARW)
                          (printout OFILE "Imobj" .FR 28 CHARW " " .I4 TX 35 CSLOT " " CHAR " ")
                          (SPPRINT.OBJ CHAR OFILE)
                          (add LENGTH CHARW)
                          (ADD CHNO 1)
                   elseif (SMALLP CHAR)
                     then (add NCHARS 1)
                          (printout OFILE " " .I5 CHNO ": ")
                          (printout OFILE .I3 CHAR " "
                                 (SELCHARQ CHAR
                                      ((EOL CR LF) 
                                           (add TX CHARW)
                                           (add LENGTH CHARW)
                                           "EOL")
                                      (FORM "FORM")
                                      (SPACE (CL:WHEN (EQ CSLOT FIRSTSPACESLOT)
                                                    (SETQ EXPANDSPACES T))
                                             (if EXPANDSPACES
                                                 then (add LENGTH (SCALEUP SPACEFACTOR CHARW))
                                                      (add TX (SCALEUP SPACEFACTOR CHARW))
                                               else (add LENGTH CHARW)
                                                    (add TX CHARW))
                                             (ADD NSPACES 1)
                                             " ")
                                      (TAB (add LENGTH CHARW)
                                           (add TX CHARW)
                                           "TAB")
                                      (Meta,TAB (add LENGTH CHARW)
                                                (add TX CHARW)
                                                "MTAB")
                                      (PROGN (add LENGTH CHARW)
                                             (add TX CHARW)
                                             (CHARACTER CHAR)))
                                 .FR 28 CHARW " " .I4 TX 35 CSLOT)
                          (ADD CHNO 1)
                   elseif [AND [OR (CHARSLOTP CHAR THISLINE)
                                   (AND (NULL CHAR)
                                        (NOT (TYPE? CHARLOOKS CHARW]
                               (OR (EQ CSLOT PSP)
                                   (find CS incharslots (NEXTCHARSLOT CSLOT)
                                      while (CHARSLOTP CS THISLINE) suchthat (EQ CSLOT CHAR]
                     then                                    (* ; "Presumably a PREVSP")
                          (ADD NSPACES 1)
                          (printout OFILE " " .I5 CHNO ":")
                          (ADD LENGTH CHARW)
                          (ADD TX CHARW)
                          (PRINTOUT OFILE " " (OR CHAR "[ENDSP]")
                                 .FR 28 CHARW " " .I4 TX 35 CSLOT)
                          (ADD CHNO 1)
                   elseif (SMALLP CHARW)
                     then (if (EQ CSLOT FIRSTSPACESLOT)
                              then (PRINTOUT OFILE "First space")
                            else (PRINTOUT OFILE .FR 11 "Invis" .FR 38 CHARW)
                                 (add CHNO CHARW))
                   elseif (type? CHARLOOKS CHARW)
                     then (printout OFILE 7 CHARW 35 CSLOT)
                   else (printout OFILE " BAD CHARSLOT " 28 CSLOT " CHAR = " CHAR " CHARW = " CHARW T
                               )
                        (TERPRI OFILE)
                        (GO $$OUT)
                        (AND NIL (CL:UNLESS (EQ 'Y (ASKUSER NIL NIL "Bad charslot, continue? "))
                                     (TERPRI OFILE)
                                     (GO $$OUT))]
                 (TERPRI OFILE)
              finally (printout OFILE NSLOTS " slots" -2 NCHARS " characters" -2 NSPACES " spaces" -2
                             "next avail = " (fetch (THISLINE NEXTAVAILABLECHARSLOT) of THISLINE)
                             T)
                    (printout OFILE "line length = " LENGTH -3 "right margin = "
                           (AND LINE (GETLD LINE RIGHTMARGIN))
                           -3 "X limit = " (AND LINE (GETLD (fetch (THISLINE DESC) of THISLINE)
                                                            LXLIM))
                           T)
                    (printout OFILE "first expanded space = " FIRSTSPACESLOT -3 "space factor = "
                           (CL:WHEN SPACEFACTOR (printout OFILE .F2.3 SPACEFACTOR))
                           T])

(ALLTL
  [LAMBDA (THISLINE N)                                       (* ; "Edited 13-Mar-2023 15:12 by rmk")
                                                             (* ; "Edited 10-Mar-2023 11:03 by rmk")

    (* ;; "This shows the whole THISLINE, no matter what the final slot eventually might be")

    (DECLARE (USEDFREE TEXTOBJ))
    (CL:UNLESS THISLINE
        (SETQ THISLINE (fetch (TEXTOBJ THISLINE) of (GTO THISLINE))))
    (CL:UNLESS (FIXP N)
           (SETQ N MAX.SMALLP))
    (for (CHARSLOT _ (FIRSTCHARSLOT THISLINE))
         (LASTSLOT _ (LASTCHARSLOT THISLINE))
         CHAR CHARW by (NEXTCHARSLOT CHARSLOT) as I from 0 to (SUB1 N) repeatuntil (EQ CHARSLOT 
                                                                                       LASTSLOT)
       do (SETQ CHAR (CHAR CHARSLOT))
          (SETQ CHARW (CHARW CHARSLOT))
          (PRINTOUT T .I3 I " " CHARSLOT)
          (if (SMALLP CHAR)
              then (PRINTOUT T .FR 20 CHAR " " (CHARACTER CHAR)
                          " " CHARW T)
            elseif CHAR
              then (PRINTOUT T " " CHAR " " CHARW T)
            else (PRINTOUT T .FR 20 CHAR " " " " " " CHARW T])

(ITL
  [LAMBDA (THISLINE)                                         (* ; "Edited 29-Jul-2024 09:42 by rmk")

    (* ;; "Inspect THISLINE")

    (CL:UNLESS (type? THISLINE THISLINE)
        (CL:WHEN (EQ THISLINE T)
            (SETQ THISLINE NIL)
            (SETQ LASTCS CHARSLOT))
        (SETQ THISLINE (fetch (TEXTOBJ THISLINE) of (GTO THISLINE))))
    (INSPECT THISLINE)
    THISLINE])

(NTHCHARSLOT
  [LAMBDA (THISLINE SLOTN)                                   (* ; "Edited 13-Mar-2023 15:12 by rmk")
                                                             (* ; "Edited  8-Mar-2023 13:22 by rmk")
    (CL:UNLESS (TYPE? THISLINE THISLINE)
        (SETQ THISLINE (FETCH THISLINE of (GTO THISLINE))))
    (find CHARSLOT incharslots THISLINE as I from 1 suchthat (EQ I SLOTN])
)



(* ; "THISLINE")

(DEFINEQ

(PLCHAIN
  [LAMBDA (LN TSTREAM)                                       (* ; "Edited 25-Apr-2024 00:04 by rmk")
                                                             (* ; "Edited 14-Sep-2022 16:07 by rmk")
                                                             (* ; "Edited 29-May-91 18:20 by jds")
    (PRINTLINE LN TSTREAM)
    (COND
       ((fetch (LINEDESCRIPTOR NEXTLINE) of LN)
        (PLCHAIN (fetch (LINEDESCRIPTOR NEXTLINE) of LN)
               TSTREAM])

(PRINTLINE
  [LAMBDA (LN TSTREAM)                                       (* ; "Edited 17-Nov-2024 15:56 by rmk")
                                                             (* ; "Edited 26-Oct-2024 11:20 by rmk")
                                                             (* ; "Edited 24-Oct-2024 20:25 by rmk")
                                                             (* ; "Edited 10-May-2024 00:26 by rmk")
                                                             (* ; "Edited 25-Apr-2024 00:09 by rmk")
                                                             (* ; "Edited 17-Mar-2024 17:18 by rmk")
                                                             (* ; "Edited  2-Dec-2023 23:11 by rmk")
                                                             (* ; "Edited 26-Mar-2023 11:46 by rmk")
                                                             (* ; "Edited 29-Sep-2022 08:43 by rmk")
                                                             (* ; "Edited  8-Sep-2022 23:41 by rmk")
                                                             (* ; "Edited 29-May-91 18:20 by jds")
                                                             (* ; 
                                                  "Print out a line descriptor in a reasonable form.")
    (printout T "-----" T LN "  Bot: " (GETLD LN YBOT)
           "  Base: "
           (GETLD LN YBASE)
           "  Height: "
           (GETLD LN LHEIGHT)
           "  Ascent: "
           (GETLD LN LASCENT)
           "  Descent: "
           (GETLD LN LDESCENT)
           T "Char1: " (GETLD LN LCHAR1)
           "  Lim: "
           (GETLD LN LCHARLAST))
    (COND
       ((GETLD LN FORCED-END)
        (PRIN1 "  Forced-end" T)))
    (COND
       ((GETLD LN LHASPROT)
        (PRIN1 "  [Protected text]" T)))
    (PRIN1 ".
")
    (printout T "RMar: " (GETLD LN RIGHTMARGIN)
           "  XLim: "
           (GETLD LN LXLIM)
           T "Prev:  " (GETLD LN PREVLINE)
           T "Next:  " (GETLD LN NEXTLINE)
           T)
    (LET ((TEXTOBJ (TEXTOBJ TSTREAM)))
         (COND
            ((AND (IGEQ (fetch (LINEDESCRIPTOR LCHAR1) of LN)
                        1)
                  (ILEQ (GETLD LN LCHAR1)
                        (GETTOBJ TEXTOBJ TEXTLEN)))          (* ; "The line is real -- print it.")
             (PRIN1 "|" T)
             [bind CH first (\TEDIT.TEXTSETFILEPTR TSTREAM (SUB1 (GETLD LN LCHAR1))) for CHNO
                from (GETLD LN LCHAR1) to (IMIN (GETTOBJ TEXTOBJ TEXTLEN)
                                                (GETLD LN LCHARLAST))
                do (SETQ CH (BIN TSTREAM))
                   (COND
                      ((SMALLP CH)
                       (PRIN1 (CHARACTER CH)
                              T))
                      (T (PRINT CH T]
             (PRINTOUT T "|" T])

(ILINES
  [LAMBDA (LINES TAG WHERE)                                  (* ; "Edited 28-Jun-2024 15:22 by rmk")
                                                             (* ; "Edited 25-Jun-2024 11:59 by rmk")
                                                             (* ; "Edited 27-Apr-2024 13:48 by rmk")
                                                             (* ; "Edited 27-Nov-2023 12:52 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:22 by rmk")
                                                             (* ; "Edited  9-May-2023 15:45 by rmk")
                                                             (* ; "Edited 28-Mar-2023 22:02 by rmk")
                                                             (* ; "Edited 25-Mar-2023 15:26 by rmk")
                                                             (* ; "Edited 22-Feb-2023 11:08 by rmk")
                                                             (* ; "Edited 21-Feb-2023 00:11 by rmk")
                                                             (* ; "Edited  9-Oct-2022 08:36 by rmk")
    (DECLARE (USEDFREE TEXTOBJ))                             (* ; "Edited 17-Sep-2022 11:50 by rmk")
    (if (type? SELECTION LINES)
        then [LET (WINDOW)
                  (CL:WHEN (type? LINEDESCRIPTOR (CAR (fetch L1 of LINES)))
                      (SETQ WINDOW (ILINES (fetch L1 of LINES)
                                          'L2)))
                  (CL:WHEN (type? LINEDESCRIPTOR (CAR (fetch LN of LINES)))
                      (if WINDOW
                          then (ATTACHWINDOW (ILINES (fetch LN of LINES)
                                                    'LN)
                                      WINDOW
                                      'RIGHT
                                      'TOP)
                        else (ILINES (fetch LN of LINES)
                                    'LN)))]
      else [SETQ LINES (if (type? LINEDESCRIPTOR LINES)
                           then LINES
                         elseif (type? LINEDESCRIPTOR (CAR (LISTP LINES)))
                           then (CAR LINES)
                         else (PANEPREFIX (\TEDIT.PRIMARYPANE (GTO LINES]
           (INSPECT/TOP/LEVEL/LIST (COLLECTLINES LINES)
                  WHERE TAG])

(SL
  [LAMBDA (FIRSTLINE LASTLINE PANE TOBJ OFILE)               (* ; "Edited 18-Nov-2024 21:28 by rmk")
                                                             (* ; "Edited  9-Nov-2024 23:22 by rmk")
                                                             (* ; "Edited 28-Oct-2024 22:25 by rmk")
                                                             (* ; "Edited 27-Oct-2024 18:38 by rmk")
                                                             (* ; "Edited 25-Oct-2024 22:25 by rmk")
                                                             (* ; "Edited 21-Oct-2024 23:08 by rmk")

    (* ;; "Shows a selection of the lines backing the display in PANE")

    (LET (LINES WTYPE PNO)
         (CL:UNLESS OFILE
             (CL:WHEN (EQ LASTLINE T)
                 (SETQ WTYPE 'SL)
                 (SETQ LASTLINE NIL)))
         (SETQ LINES (SL.GETLINES FIRSTLINE LASTLINE PANE TOBJ))
         (SETQ FIRSTLINE (pop LINES))
         (SETQ LASTLINE (pop LINES))
         (SETQ TOBJ (pop LINES))
         (SETQ PANE (pop LINES))
         (SETQ PNO (pop LINES))
         (DEBUGOUTPUT OFILE WTYPE (PRINTOUT OFILE .FONT '(TERMINAL 8)
                                         "Pane " PNO " = " PANE T)
                (PRINTOUT OFILE .FONT '(TERMINAL 8)
                       15 "HT" -3 "BOT" 27 .FONT '(TERMINAL 8 BOLD)
                       "C1" 36 "CN" .FONT '(TERMINAL 8)
                       40 "LN/*=PLST" T)
                (for L inlines FIRSTLINE do (SHOWLINE L OFILE TOBJ) repeatuntil (EQ L LASTLINE)
                   finally (CL:WHEN (EQ LASTLINE (PANEBOTTOMLINE PANE))
                               (SHOWLINE (PANESUFFIX PANE)
                                      OFILE TOBJ)))
                (TERPRI OFILE))
         LINES])

(SL.GETLINES
  [LAMBDA (FIRSTLINE LASTLINE PANE TOBJ)                     (* ; "Edited 28-Oct-2024 22:24 by rmk")
                                                             (* ; "Edited 21-Oct-2024 23:10 by rmk")
                                                             (* ; "Edited  9-Sep-2024 14:25 by rmk")
                                                             (* ; "Edited  7-Sep-2024 21:44 by rmk")
                                                             (* ; "Edited  1-Sep-2024 23:21 by rmk")

    (* ;; "A selection goes to its L1, NIL goes to the first line of PANE, T goes to the first line of TEXTOBJ's SEL.")

    (* ;; "If FIRSTLINE is already a line.")

    (* ;; "LASTLINE also coerces a selection to its LN, but it can be a number of lines.")

    (LET [TEXTOBJ SEL PANEPREFIX (PNO PANE)
                (NLINES (OR (FIXP LASTLINE)
                            (CL:IF (type? LINEDESCRIPTOR FIRSTLINE)
                                1
                                100)]
         [SETQ TEXTOBJ (if (type? TEXTOBJ FIRSTLINE)
                           then (PROG1 FIRSTLINE (SETQ FIRSTLINE NIL))
                         elseif (GTO TOBJ T)
                         elseif (GTO FIRSTLINE T)
                           then (PROG1 (GTO FIRSTLINE)
                                       (SETQ FIRSTLINE NIL]
         (SETQ PANE (if (WINDOWP PANE)
                      elseif (AND (FIXP PANE)
                                  (find P inpanes TEXTOBJ as I from 1 suchthat (EQ I PANE)))
                      else (SETQ PNO 1)
                           (\TEDIT.PRIMARYPANE TEXTOBJ)))
         (CL:UNLESS (type? LINEDESCRIPTOR FIRSTLINE)
             [SETQ FIRSTLINE (if (AND (type? SELECTION FIRSTLINE)
                                      (FGETSEL FIRSTLINE SET))
                                 then (SETQ SEL FIRSTLINE)   (* ; "For lastline")
                                      (\TEDIT.SEL.L1 SEL PANE TEXTOBJ)
                               elseif (NULL FIRSTLINE)
                                 then (PANEPREFIX PANE)
                               elseif (AND (EQ FIRSTLINE T)
                                           (FGETSEL (TEXTSEL TEXTOBJ)
                                                  SET))
                                 then (SETQ SEL (TEXTSEL TEXTOBJ))
                                      (SETQ FIRSTLINE (\TEDIT.SEL.L1 SEL PANE TEXTOBJ])
         (CL:WHEN FIRSTLINE
             (CL:UNLESS (type? LINEDESCRIPTOR LASTLINE)
                 [SETQ LASTLINE (if SEL
                                    then (\TEDIT.SEL.LN SEL PANE TEXTOBJ)
                                  else (find L inlines FIRSTLINE as I from 1
                                          suchthat (OR (NULL (FGETLD L NEXTLINE))
                                                       (EQ I NLINES]))
         (LIST FIRSTLINE LASTLINE TEXTOBJ PANE (OR PNO 1])

(SLL
  [LAMBDA (LINELIST FILE TEXTOBJ)                            (* ; "Edited  2-Jul-2023 23:48 by rmk")

    (* ;; "Show a list of lines.")

    (SETQ TEXTOBJ (GTO TEXTOBJ))
    (RESETLST
        [RESETSAVE (DSPFONT '(TERMINAL 8)
                          FILE)
               '(PROGN (DSPFONT OLDVALUE FILE]
        (for L inside LINELIST do (if (LISTP L)
                                      then (PRINTOUT FILE T "SUBLIST:" T)
                                           (SLL L FILE TEXTOBJ)
                                    elseif L
                                      then (SHOWLINE L FILE TEXTOBJ)
                                    else (PRINTOUT FILE "(NIL LINE)" T))))])

(SHOWLINE
  [LAMBDA (LINE FILE TEXTOBJ)                                (* ; "Edited 20-Nov-2024 00:31 by rmk")
                                                             (* ; "Edited 17-Nov-2024 15:56 by rmk")
                                                             (* ; "Edited  9-Nov-2024 10:37 by rmk")
                                                             (* ; "Edited  1-Sep-2024 16:49 by rmk")
                                                             (* ; "Edited 10-May-2024 00:27 by rmk")
                                                             (* ; "Edited  2-Dec-2023 23:07 by rmk")
                                                             (* ; "Edited 29-Sep-2023 12:37 by rmk")
                                                             (* ; "Edited 26-Sep-2023 17:22 by rmk")
                                                             (* ; "Edited 15-Jul-2023 21:19 by rmk")
                                                             (* ; "Edited  2-Jul-2023 23:55 by rmk")
    (LET ((LOC (LOC LINE)))
         (PRINTOUT FILE .FONT '(TERMINAL 8)
                "L"
                (CAR LOC)
                "/"
                (CDR LOC)
                ": " 13 .I4 (GETLD LINE LHEIGHT)
                " " %# (CL:IF (GETLD LINE YBOT)
                           (PRINTOUT NIL .I5 (GETLD LINE YBOT))
                           (PRINTOUT T "---"))
                " " .FONT '(TERMINAL 8 BOLD)
                .I5
                (GETLD LINE LCHAR1)
                " -> " .I5 (GETLD LINE LCHARLAST)
                .FONT
                '(TERMINAL 8)
                " " .I3 (GETLD LINE LNCH)
                (CL:IF (GETLD LINE LSTLN)
                    "*"
                    " ")
                .FONT
                '(TERMINAL 6)
                " ")
         (if (GETLD LINE LDUMMY)
             then (PRINTOUT FILE -8 (CL:IF (GETLD LINE LDUMMY)
                                        "l"
                                        "")
                         "dummy" T)
           else (for CNO C LASTC (TSTREAM _ (TEXTSTREAM TEXTOBJ)) from (GETLD LINE LCHAR1)
                   to (GETLD LINE LCHARLAST) first (SETFILEPTR TSTREAM (SUB1 (GETLD LINE LCHAR1)))
                                                   (PRINTOUT FILE " %"") until (EOFP TSTREAM)
                   do (SETQ C (BIN TSTREAM))                 (* ; 
                                                      "This may read LF if that's what's on the file")
                      (if (SMALLP C)
                          then (SETQ LASTC C)
                               (SELCHARQ C
                                    (TAB (PRIN3 "[TAB]" FILE))
                                    ((EOL CR) 
                                         (PRIN3 "[EOL]" FILE))
                                    (LF (PRIN3 "[LF]" FILE))
                                    (FORM (PRIN3 "[FORM]" FILE))
                                    (meta,EOL (PRIN3 "[MLB]" FILE))
                                    (PRINTCCODE C FILE))
                        elseif (IMAGEOBJP C)
                          then (printout FILE " " C " ")) finally (PRIN3 "%"" FILE)
                                                                (TERPRI FILE)
                                                                (CL:WHEN (GETLD LINE FORCED-END)
                                                                       (TERPRI FILE])

(CHECKLINES
  [LAMBDA (LINE1 LINEN MSG)                                  (* ; "Edited 20-Nov-2024 23:44 by rmk")
                                                             (* ; "Edited 17-Nov-2024 15:56 by rmk")
                                                             (* ; "Edited  9-Nov-2024 10:30 by rmk")
                                                             (* ; "Edited 11-Mar-2023 17:38 by rmk")
    (CL:WHEN LINE1
        (CL:WHEN (EQ 0 (GETLD LINE1 LCHAR1))                 (* ; "Dummy")
            (SETQ LINE1 (GETLD LINE1 NEXTLINE)))
        (for L NEXT inlines LINE1 while (SETQ NEXT (GETLD L NEXTLINE))
           do (CL:UNLESS (IEQP (GETLD L LCHARLIM L)
                               (GETLD NEXT LCHAR1))
                  (CL:WHEN MSG (PRINTOUT T "Line sequence error: " MSG T))
                  (HELP L NEXT))
              (CL:WHEN (AND LINEN (EQ L LINEN))
                     (RETURN))))])

(COLLECTLINES
  [LAMBDA (LINE)                                             (* ; "Edited 25-Mar-2023 15:27 by rmk")
    (for L inlines (CL:IF (LISTP LINE)
                       (CAR LINE)
                       LINE) collect L])

(NTHLINE
  [LAMBDA (LINE N)                                           (* ; "Edited 28-Jun-2024 15:24 by rmk")
                                                             (* ; "Edited 25-Jun-2024 11:59 by rmk")
                                                             (* ; "Edited 27-Apr-2024 13:45 by rmk")
                                                             (* ; "Edited 17-Mar-2024 17:19 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:23 by rmk")
                                                             (* ; "Edited  1-Apr-2023 21:15 by rmk")
    (LET (TOBJ)
         (if (TYPE? LINEDESCRIPTOR LINE)
           else (SETQ TOBJ (GTO LINE))
                (SETQ LINE (GETLD (PANEPREFIX (\TEDIT.PRIMARYPANE TOBJ))
                                  NEXTLINE)))
         (for I from 1 as L in (COLLECTLINES LINE) when (EQ I N) do (RETURN L])

(HEIGHT
  [LAMBDA (LINE)                                             (* ; "Edited 17-Mar-2024 13:03 by rmk")
                                                             (* ; "Edited  1-Apr-2023 12:47 by rmk")
    (for L inlines LINE SUM (GETLD L LHEIGHT])

(LINEBOTS
  [LAMBDA (LINE)                                             (* ; "Edited 28-Jun-2024 15:24 by rmk")
                                                             (* ; "Edited 25-Jun-2024 11:59 by rmk")
                                                             (* ; "Edited 27-Apr-2024 13:48 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:23 by rmk")
                                                             (* ; "Edited 19-Apr-2023 20:50 by rmk")
                                                             (* ; "Edited  1-Apr-2023 21:24 by rmk")
    (CL:UNLESS (type? LINEDESCRIPTOR LINE)
        [SETQ LINE (PANEPREFIX (\TEDIT.PRIMARYPANE (GTO])
    (for L inlines (CAR (MKLIST LINE)) collect (GETLD L YBOT])

(SPLINES
  [LAMBDA (PANE NLINES OFILE)                                (* ; "Edited 28-Jun-2024 22:06 by rmk")
                                                             (* ; "Edited 27-Apr-2024 13:38 by rmk")
                                                             (* ; "Edited 20-Jan-2024 22:56 by rmk")
                                                             (* ; "Edited 22-Nov-2023 12:28 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:24 by rmk")
                                                             (* ; "Edited 13-May-2023 11:56 by rmk")
                                                             (* ; "Edited  8-Apr-2023 17:22 by rmk")
                                                             (* ; "Edited  6-Apr-2023 14:19 by rmk")
    (CL:UNLESS (WINDOWP PANE)
        (SETQ PANE (\TEDIT.PRIMARYPANE (GTO PANE))))
    (SL (PANEPREFIX PANE)
        NLINES PANE OFILE])
)
(DEFINEQ

(ISELS
  [LAMBDA (ARG)                                              (* ; "Edited 16-Feb-2024 23:34 by rmk")
                                                             (* ; "Edited  4-Jun-2023 13:03 by rmk")
                                                             (* ; "Edited 21-May-2023 09:04 by rmk")
                                                             (* ; "Edited 16-May-2023 15:12 by rmk")
                                                             (* ; "Edited 23-Mar-2023 21:19 by rmk")
                                                             (* ; "Edited 19-Mar-2023 22:07 by rmk")
    (LET ((TEXTOBJ (GTO ARG))
          W PARENT CHILDREN SEL)
         [SETQ W (INSPECT (SETQ SEL (TEXTSEL TEXTOBJ]
         (SETQ PARENT W)
         (CL:WHEN (GETSEL (GETTOBJ TEXTOBJ SCRATCHSEL)
                         SET)
             [PUSH CHILDREN (SETQ W (INSPECT (GETTOBJ TEXTOBJ SCRATCHSEL)
                                           NIL
                                           (RELCREATEPOSITION (LIST W 'RIGHT)
                                                  (LIST W 'BOTTOM])
         (CL:WHEN (GETSEL (GETTOBJ TEXTOBJ SCRATCHSEL2)
                         SET)
             [PUSH CHILDREN (SETQ W (INSPECT (GETTOBJ TEXTOBJ SCRATCHSEL2)
                                           NIL
                                           (RELCREATEPOSITION (LIST W 'RIGHT)
                                                  (LIST W 'BOTTOM])
         (CLOSEWITH CHILDREN PARENT)
         (MOVEWITH CHILDREN PARENT)
         SEL])

(ISEL
  [LAMBDA (ARG TAG)                                          (* ; "Edited  3-Oct-2024 14:51 by rmk")
                                                             (* ; "Edited  6-Sep-2024 10:36 by rmk")
                                                             (* ; "Edited  4-Jun-2023 13:02 by rmk")
                                                             (* ; "Edited 27-Apr-2023 10:29 by rmk")
    (LET [(SEL (CL:IF (type? SELECTION ARG)
                   ARG
                   (TEXTSEL (GTO ARG)))]
         (INSPECT SEL NIL NIL TAG)
         SEL])

(IHIST
  [LAMBDA (LAST ARG)                                         (* ; "Edited 21-Jun-2023 14:24 by rmk")
                                                             (* ; "Edited  1-Jun-2023 22:31 by rmk")
                                                             (* ; "Edited 31-May-2023 11:35 by rmk")
                                                             (* ; "Edited  4-May-2023 20:25 by rmk")
    (LET ([EVENTS (MKLIST (fetch (TEXTOBJ TXTHISTORY) of (GTO ARG]
          [UNDONEEVENTS (MKLIST (fetch (TEXTOBJ TXTHISTORYUNDONE) of (GTO ARG]
          HISTW HISTUNDOW HISTUNDOWHERE)
         (CL:WHEN EVENTS
             [SETQ HISTW (if LAST
                             then (INSPECT (CAR EVENTS)
                                         (AND (LIST (CAR EVENTS))
                                              'LIST)
                                         NIL
                                         'HIST)
                           else (INSPECT EVENTS 'LIST NIL 'HIST])
         (CL:WHEN UNDONEEVENTS
             (CL:WHEN HISTW
                 [SETQ HISTUNDOWHERE (RELCREATEPOSITION (LIST HISTW 'RIGHT)
                                            (LIST HISTW 'BOTTOM])
             [SETQ HISTUNDOW (if LAST
                                 then (INSPECT (CAR UNDONEEVENTS)
                                             (AND (LIST (CAR UNDONEEVENTS))
                                                  'LIST)
                                             HISTUNDOWHERE
                                             'HISTUNDO)
                               else (INSPECT UNDONEEVENTS 'LIST HISTUNDOWHERE 'HISTUNDO]
             (CL:WHEN HISTW
                 (CLOSEWITH HISTUNDOW HISTW)
                 (MOVEWITH HISTUNDOW HISTW)))
         (LIST (LENGTH EVENTS)
               (LENGTH UNDONEEVENTS])

(IPCTB
  [LAMBDA (ARG)                                              (* ; "Edited 31-Oct-2023 19:45 by rmk")
                                                             (* ; "Edited  4-May-2023 20:28 by rmk")
    (INSPECT (FETCH (TEXTOBJ PCTB) of (GTO ARG))
           'LIST])

(IPC
  [LAMBDA (PC TOBJ)                                          (* ; "Edited  4-Oct-2024 11:03 by rmk")
                                                             (* ; "Edited 29-Sep-2024 15:03 by rmk")
                                                             (* ; "Edited 22-Aug-2024 23:14 by rmk")
                                                             (* ; "Edited 25-Jul-2024 17:47 by rmk")

    (* ;; "Inspects the piece specified by decoding PC and TOBJ")
                                                             (* ; "Edited  6-Nov-2023 08:03 by rmk")
    (LET (PCWINDOW OBJWINDOW TAG (DECODED (IPC.DECODEARGS PC TOBJ)))
         (SETQ PC (POP DECODED))
         (SETQ TAG (POP DECODED))
         (SETQ PCWINDOW (INSPECT PC NIL NIL TAG))
         (CL:WHEN (POBJ PC)
             (SETQ OBJWINDOW (INSPECT (POBJ PC)
                                    NIL
                                    (RELCREATEPOSITION (LIST PCWINDOW 'RIGHT -2)
                                           (LIST PCWINDOW 'BOTTOM))
                                    TAG))
             (CLOSEWITH OBJWINDOW PCWINDOW)
             (MOVEWITH OBJWINDOW PCWINDOW))
         PC])

(IPCC
  [LAMBDA (PC ARG)                                           (* ; "Edited 21-Nov-2024 23:50 by rmk")
                                                             (* ; "Edited  4-Oct-2024 11:07 by rmk")
                                                             (* ; "Edited 29-Jul-2024 22:45 by rmk")
                                                             (* ; "Edited 26-Jul-2024 13:24 by rmk")
                                                             (* ; "Edited 20-Jul-2024 23:59 by rmk")
                                                             (* ; "Edited  6-Nov-2023 08:03 by rmk")

    (* ;; "Inspect the PCONTENTS of a piece.")

    (LET ((DECODED (IPC.DECODEARGS PC ARG))
          TAG)
         (SETQ PC (POP DECODED))
         (SETQ TAG (POP DECODED))

         (* ;; "Not sure how to expect other types.  File? String?  Maybe a (type value pair ?)")

         (SELECTC (PTYPE PC)
             (OBJECT.PTYPE (INSPECT (PCONTENTS PC)
                                  NIL NIL TAG))
             (PRINTOUT T PC " is not an object piece " T))
         PC])

(IPC.DECODEARGS
  [LAMBDA (PC TOBJ)                                          (* ; "Edited 26-Oct-2024 12:35 by rmk")
                                                             (* ; "Edited  4-Oct-2024 13:32 by rmk")

    (* ;; "Finds the piece specified by decoding PC and TOBJ")

    (LET ((TEXTOBJ (GTO TOBJ T))
          (ID (AND PC (LITATOM PC)
                   PC))
          N)
         (SETQ PC (if (type? PIECE PC)
                      then (CL:WHEN TEXTOBJ
                               [SETQ N (find I from 1 suchthat (EQ PC (NTHPIECE TEXTOBJ I])
                           PC
                    elseif (FIXP PC)
                      then (SETQ N PC)
                           (SETQ PC (NTHPIECE TEXTOBJ PC))
                    elseif (TEXTOBJ PC T)
                      then (SETQ PC (NTHPIECE (TEXTOBJ PC)
                                           TOBJ))
                    elseif [AND ID TEXTOBJ (SETQ N
                                            (find I OBJ from 1 as TPC inpieces (\TEDIT.FIRSTPIECE
                                                                                TEXTOBJ)
                                               suchthat (AND (SETQ OBJ (POBJ TPC))
                                                             (OR (EQ ID (IMAGEOBJPROP OBJ
                                                                               'IDENTIFIER))
                                                                 (EQ ID (IMAGEOBJPROP OBJ
                                                                               'LABEL]
                      then (SETQ PC (NTHPIECE TEXTOBJ N))
                    elseif (AND TEXTOBJ (NULL PC))
                      then (SELPIECE TEXTOBJ)
                    else (ERROR "NOT A PIECE" PC)))
         [SETQ ID (AND (POBJ PC)
                       (OR (IMAGEOBJPROP (POBJ PC)
                                  'IDENTIFIER)
                           (IMAGEOBJPROP (POBJ PC)
                                  'LABEL]
         (LIST PC (CL:IF ID
                      (CONCAT N "-" ID)
                      N)])

(GSEL
  [LAMBDA (WHICH ARG)                                        (* ; "Edited 11-Feb-2024 09:07 by rmk")
                                                             (* ; "Edited 23-May-2023 00:03 by rmk")
    (SELECTQ WHICH
        ((NIL SEL) 
             (fetch (TEXTOBJ SEL) of (GTO ARG)))
        (SCRATCH (fetch (TEXTOBJ SCRATCHSEL) of (GTO ARG)))
        (SCRATCH2 (fetch (TEXTOBJ SCRATCHSEL2) of (GTO ARG)))
        (T (for S in (\TEDIT.COLLECTSELS (GTO ARG)) when (GETSEL S SET) collect S))
        (fetch (TEXTOBJ SEL) of (GTO ARG])
)
(DEFINEQ

(SPF
  [LAMBDA (ARG TITLE OFILE)                                  (* ; "Edited 30-Aug-2024 21:25 by rmk")
                                                             (* ; "Edited 15-Aug-2024 22:39 by rmk")
                                                             (* ; "Edited 13-Aug-2024 10:45 by rmk")
                                                             (* ; "Edited 11-Jul-2024 10:34 by rmk")
                                                             (* ; "Edited 19-Jan-2024 22:32 by rmk")
                                                             (* ; "Edited  6-Nov-2023 21:24 by rmk")

    (* ;; 
    "PAGEFRAMES can be one or more PAGEREGIONs.  ARG can be a TEXTOBJ or one of the PAGEREGIONS.")

    (LET (TEXTOBJ PAGEREGIONS)
         (if (AND ARG (for PF inside ARG always (type? PAGEREGION PF)))
             then (SETQ PAGEREGIONS ARG)
           else (SETQ TEXTOBJ (GTO ARG))
                (CL:WHEN (FGETTOBJ TEXTOBJ MENUFLG)
                    (SETQ TEXTOBJ (TEXTOBJ (\TEDIT.MAINW TEXTOBJ))))
                (SETQ PAGEREGIONS (GETTOBJ TEXTOBJ TXTPAGEFRAMES)))
         (SETQ TITLE (CONCAT "Page regions for " (OR TITLE TEXTOBJ PAGEREGIONS)))
         (DEBUGOUTPUT OFILE 'SPF (PRINTOUT OFILE .FONT '(TERMINAL 8 BOLD)
                                        TITLE .FONT '(TERMINAL 8)
                                        T)
                (for TYPE PF (FIRSTPF _ (TEDIT.GET.PAGEFORMAT PAGEREGIONS 'FIRST/DEFAULT))
                   in '(FIRST/DEFAULT LEFT RIGHT)
                   collect (SETQ PF (TEDIT.GET.PAGEFORMAT PAGEREGIONS TYPE))
                         (PRINTOUT OFILE T .FONT '(TERMINAL 8 BOLD)
                                (L-CASE TYPE T)
                                " region " PF .FONT '(TERMINAL 8))
                         (if (AND (EQ PF FIRSTPF)
                                  (NEQ TYPE 'FIRST/DEFAULT))
                             then (PRINTOUT OFILE " defaults to first" T)
                           else (TERPRI OFILE)
                                (PRINTDEF (SPF1 PF)
                                       NIL NIL NIL NIL OFILE))
                         (TERPRI OFILE)
                         PF])

(SPF1
  [LAMBDA (PAGEREGION)                                       (* ; "Edited 30-Aug-2024 15:24 by rmk")
                                                             (* ; "Edited  6-Nov-2023 22:39 by rmk")
    `(,(fetch REGIONFILLMETHOD OF PAGEREGION)
      (LOCALINFO ,(fetch REGIONLOCALINFO of PAGEREGION))
      (TYPE ,(fetch (PAGEREGION REGIONTYPE) of PAGEREGION))
      ,(fetch REGIONSPEC of PAGEREGION)
      ,@(for PAGEREGION inside (fetch REGIONSUBBOXES of PAGEREGION) collect (SPF1 PAGEREGION])
)



(* ; "Page frames")

(DEFINEQ

(SLF
  [LAMBDA (FORMATSTREAM OUTFILE TITLE SHOWPAGEFRAMES)        (* ; "Edited 14-Jan-2024 13:14 by rmk")
                                                             (* ; "Edited 19-Dec-2023 10:20 by rmk")
                                                             (* ; "Edited 28-Aug-2023 21:58 by rmk")
                                                             (* ; "Edited 26-Aug-2023 20:07 by rmk")

    (* ;; "Shows the information in a FORMATSTREAM or the format part of a formatted Tedit file.")

    (RESETLST
        (CL:UNLESS (GETSTREAM FORMATSTREAM 'INPUT T)
            [RESETSAVE (SETQ FORMATSTREAM (OPENSTREAM FORMATSTREAM 'INPUT))
                   '(PROGN (CLOSEF? OLDVALUE])
        [RESETSAVE (GETFILEPTR FORMATSTREAM)
               '(PROGN (SETFILEPTR FORMATSTREAM OLDVALUE]
        [SELECTQ OUTFILE
            (T)
            ((NIL TEDIT) 
                 (SETQ OUTFILE (OPENTEXTSTREAM)))
            (RESETSAVE (SETQ OUTFILE (OPENSTREAM OUTFILE 'OUTPUT 'NEW))
                   `(PROGN (CLOSEF? OUTFILE OLDVALUE)
                           (AND (EQ RESETSTATE 'ERROR)
                                (DELFILE OLDVALUE]
        (SETFILEPTR FORMATSTREAM 0)                          (* ; 
                                             "If a complete file, sets to the beginning of the looks")
        (LET [(PCCOUNT (OR (CADR (\TEDIT.GET.TRAILER FORMATSTREAM))
                           (\WIN FORMATSTREAM]
             (for PCNO BYTELEN LTYPE LOOKSMAP PLOOKSMAP LASTCHARLOOKNO (PFPOS _ 0)
                  (CHNO _ 0)
                  (TEXTPCNO _ 0)
                  (START _ (GETFILEPTR FORMATSTREAM))
                  (TYPETAB _ 13)
                  (FPOSTAB _ 28)
                  (BYTESTAB _ 38) from 1 to PCCOUNT
                first (PRINTOUT OUTFILE "Starting FILEPTR = " START "   " "PCCOUNT = " PCCOUNT T)
                do (SETQ BYTELEN (\DWIN FORMATSTREAM))
                   (SETQ LTYPE (\WIN FORMATSTREAM))
                   (if (EQ \PieceDescriptorPARA LTYPE)
                       then (TERPRI OUTFILE)
                     else (PRINTOUT OUTFILE .I5 (IDIFFERENCE (GETFILEPTR FORMATSTREAM)
                                                       START)
                                 "|" PCNO))
                   (SELECTC LTYPE
                       (\PieceDescriptorPARA 
                            (LET ((PLOOKNO (\WIN FORMATSTREAM))
                                  PLOOK)
                                 (SETQ PLOOK (ELT PARAMAP PLOOKNO))
                                 (PRINTOUT OUTFILE .TAB TYPETAB "Paragraph looks " PLOOKNO ": "
                                        (SUBSTRING PLOOK (ADD1 (STRPOS ":" PLOOK 6))
                                               -2)
                                        T)))
                       (\PieceDescriptorLOOKS 
                            (LET ((FLAGS (BIN FORMATSTREAM))
                                  LOOKNO FAT CLOOK)
                                 (SETQ FAT (EQ 2 (LOGAND FLAGS 2)))
                                 (SETQ LOOKNO (\WIN FORMATSTREAM))
                                 (SETQ CLOOK (ELT LOOKSMAP LOOKNO))
                                 (SETQ LASTCHARLOOKNO LOOKNO)
                                 (ADD TEXTPCNO 1)
                                 (PRINTOUT OUTFILE .TAB TYPETAB "Char piece #" TEXTPCNO " " .I3 PFPOS
                                        "-" (CL:IF FAT
                                                (SLF.FATPLEN FORMATSTREAM PFPOS BYTELEN)
                                                BYTELEN)
                                        (CL:IF FAT
                                            " fat"
                                            "    ")
                                        .TAB BYTESTAB .I4 BYTELEN " bytes")
                                 (CL:IF (EQ 1 (LOGAND FLAGS 1))
                                     " New"
                                     "")
                                 (PRINTOUT OUTFILE "  " "Looks " LOOKNO ": ")
                                 (PRIN3 (CAR (\TEDIT.CHARLOOKS.DEFPRINT CLOOK NIL NIL T))
                                        OUTFILE)
                                 (TERPRI OUTFILE)
                                 (ADD PFPOS BYTELEN)))
                       (\PieceDescriptorOBJECT 
                            (ADD TEXTPCNO 1)
                            (PRINTOUT OUTFILE .TAB TYPETAB "Objt piece " TEXTPCNO " " PFPOS "-1" -1 
                                   .I4 BYTELEN)
                            (PRINTOUT OUTFILE " " (\ATMIN FORMATSTREAM)
                                   " ")
                            (LET (CLOOK INDEX)
                                 (SELECTQ (BIN FORMATSTREAM)
                                     (0 (SETQ CLOOK (ELT LOOKSMAP LASTCHARLOOKNO))
                                        (PRINTOUT OUTFILE "Previous looks " LASTCHARLOOKNO " "))
                                     (1 (SETQ CLOOK (\TEDIT.GET.SINGLE.CHARLOOKS FORMATSTREAM))
                                        (PRINTOUT OUTFILE "Inline looks "))
                                     (SHOULDNT))
                                 (PRIN3 (CAR (\TEDIT.CHARLOOKS.DEFPRINT CLOOK NIL NIL T))
                                        OUTFILE)
                                 (TERPRI OUTFILE))
                            (ADD PFPOS BYTELEN))
                       (\PieceDescriptorPAGEFRAME 
                            (LET ((PFS (READ FORMATSTREAM)))
                                 (PRINTOUT OUTFILE .TAB TYPETAB "Pageframes")
                                 (if SHOWPAGEFRAMES
                                     then (PRINTOUT OUTFILE .TAB (IPLUS TYPETAB 4)
                                                 .PPV PFS)
                                   else (PRINTOUT OUTFILE "..." T))
                                 (TERPRI OUTFILE)))
                       (\PieceDescriptorCHARLOOKSLIST 
                            (PRINTOUT OUTFILE .TAB TYPETAB "Charlooks list")
                            (add PCNO -1)                    (* ; "Lists don't count in this format")
                            (LET ((CHARLOOKLIST (\TEDIT.GET.CHARLOOKS.LIST FORMATSTREAM)))
                                 (SETQ LOOKSMAP (ARRAY (LENGTH CHARLOOKLIST)))
                                 (for I from 1 as CSLOOKS IN CHARLOOKLIST
                                    do (PRINTOUT OUTFILE .TAB (IPLUS TYPETAB 2)
                                              .I2 I ": " (CL:IF (type? FONTCLASS (fetch (CHARLOOKS
                                                                                         CLFONT)
                                                                                    of CSLOOKS))
                                                             (fetch (FONTCLASS FONTCLASSNAME)
                                                                of (fetch (CHARLOOKS CLFONT)
                                                                      of CSLOOKS))
                                                             CSLOOKS)
                                              T)
                                       (SETA LOOKSMAP I CSLOOKS))))
                       (\PieceDescriptorPARALOOKSLIST 
                            (PRINTOUT OUTFILE .TAB TYPETAB "Paralooks list")
                            (add PCNO -1)                    (* ; "Lists don't count in this format")
                            (LET ((PARALOOKS (\TEDIT.GET.PARALOOKS.LIST FORMATSTREAM)))
                                 (SETQ PARAMAP (ARRAY (LENGTH PARALOOKS)))
                                 (for I from 1 as PLOOKS in PARALOOKS
                                    do (PRINTOUT OUTFILE .TAB (IPLUS TYPETAB 2)
                                              .I2 I ": " PLOOKS T)
                                       (SETA PARAMAP I PLOOKS))
                                 (TERPRI OUTFILE)))
                       "Unknown type")))
        (if (TEXTSTREAMP OUTFILE)
            then 
                 (* ;; "Don't return the text stream, let it be collected when the window closes")

                 (TEDIT OUTFILE [CREATEW NIL (OR TITLE (CONCAT "SLF for " (FULLNAME FORMATSTREAM]
                        NIL
                        `(READONLY T))
                 NIL
          else OUTFILE))])

(SLF.FATPLEN
  [LAMBDA (LOOKSFILE PFPOS BYTELEN)                          (* ; "Edited 28-Aug-2023 22:03 by rmk")

    (* ;; "Calculates the eventual PLEN given that there is an XCCS fat charlooks piece of BYTELEN bytes starting at PFPOS")

    (LET ((ORIGPTR (GETFILEPTR LOOKSFILE)))
         (SETFILEPTR LOOKSFILE PFPOS)
         (PROG1 (if (EQ NSCHARSETSHIFT (BIN LOOKSFILE))
                    then (SELECTC (BIN LOOKSFILE)
                             (0 (ADD BYTELEN -2))
                             (NSCHARSETSHIFT 
                                  (BIN LOOKSFILE)
                                  (FOLDLO (IDIFFERENCE BYTELEN 3)
                                         2))
                             (ADD BYTELEN -2))
                  else (FOLDLO BYTELEN 2))
                (SETFILEPTR LOOKSFILE ORIGPTR])
)



(* ; "Show looks file")

(DEFINEQ

(SELTEDIT
  [LAMBDA (SRC START LEN)                                    (* ; "Edited 15-May-2024 15:40 by rmk")

    (* ;; "This brings up a Tedit that contains the contents of a selection in the SRC Tedit, to help in focusing on a specific problem.")

    [SETQ SRC (GTS (CL:IF (NEQ SRC T)
                       (OR SRC (AND (BOUNDP 'SOURCE)
                                    SOURCE)))]
    (LET [(TARG (TEXTSTREAM (TEDIT NIL 'SELTEDIT NIL `(LEAVETTY T]
         (CL:UNLESS START
             (SETQ START (fetch CH# of (TEDIT.GETSEL SRC)))
             (CL:UNLESS LEN
                 (SETQ LEN (fetch DCH of (TEDIT.GETSEL SRC)))))
         (CL:UNLESS LEN (SETQ LEN 10))
         (TEDIT.COPY (TEDIT.SETSEL SRC START LEN)
                (TEDIT.GETSEL TARG))
         (TEXTPROP TARG 'DIRTY NIL)
         (SP TARG)
         (SETQ SOURCE SRC)
         (SETQ TARGET TARG])
)



(* ; "New editor on an old selection")




(* ; "Bravo")

(DEFINEQ

(PPARA
  [LAMBDA (PARA BSTR)                                        (* ; "Edited  8-Aug-2023 17:00 by rmk")
    (CL:UNLESS BSTR (SETQ BSTR BSTREAM))
    (RESETLST
        [RESETSAVE (GETFILEPTR BSTR)
               `(PROGN (SETFILEPTR ,BSTR OLDVALUE]
        (PRINTOUT T "FILEPOS = " (GETFILEPTR BSTR)
               T)
        (for R in (fetch (PARA RUNS) of PARA) do (PRUN R BSTR)))])

(PRUN
  [LAMBDA (RUN BSTR)                                         (* ; "Edited 22-Aug-2023 10:59 by rmk")
                                                             (* ; "Edited  8-Aug-2023 16:47 by rmk")

    (* ;; "Shows the characters in RUN, with font information")

    (CL:UNLESS BSTR (SETQ BSTR BSTREAM))
    (RESETLST
        [RESETSAVE (GETFILEPTR BSTR)
               `(PROGN (SETFILEPTR ,BSTR OLDVALUE]
        (PRINTOUT T .I5 (fetch (RUN RUNSTART) of RUN)
               "/"
               (fetch (RUN RUNLENGTH) of RUN)
               ": " 11)
        (SETFILEPTR BSTR (fetch (RUN RUNSTART) of RUN))
        (for I from 1 to (fetch (RUN RUNLENGTH) of RUN) do (SBC (BIN BSTR)
                                                                BSTR T))
        (LET (FONT (CL (fetch (RUN RUNLOOKS) of RUN)))
             (SETQ FONT (fetch (CHARLOOKS CLFONT) of CL))
             (TAB 13 NIL T)
             (if FONT
                 then (for X in (FONTUNPARSE FONT)
                         do (if (MEMB X '(MEDIUM BOLD ITALIC REGULAR))
                                then (PRIN1 (NTHCHAR X 1)
                                            T)
                              elseif (NUMBERP X)
                                then (PRINTOUT T " " X " ")
                              else (PRIN1 X T)))
                      (TERPRI T)
               else (PRINTOUT T (fetch (CHARLOOKS CLNAME) of CL)
                           " "
                           (fetch (CHARLOOKS CLSIZE) of CL)
                           " "
                           (CL:IF (fetch (CHARLOOKS CLBOLD) of CL)
                               "B"
                               "M")
                           (CL:IF (fetch (CHARLOOKS CLITAL) of CL)
                               "I"
                               "R")
                           T)))
        RUN)])

(ADDLINEPOSITIONS
  [LAMBDA (FILE)                                             (* ; "Edited 22-Aug-2023 11:06 by rmk")
                                                             (* ; "Edited 13-Aug-2023 19:07 by rmk")
                                                             (* ; "Edited 11-Aug-2023 08:30 by rmk")
                                                             (* ; "Edited  8-Aug-2023 22:17 by rmk")

    (* ;; "Makes a copy of FILE except that each each CR is followed by the fileptr of the next byte, and and ^z and \ are also marked with the file position of the nexxt character.  This helps in decoding Bravo files.")

    (CL:WITH-OPEN-FILE (INSTREAM FILE :DIRECTION :INPUT)
           (STREAMPROP INSTREAM 'ENDOFSTREAMOP (FUNCTION NILL))
           (CL:WITH-OPEN-FILE (OUTSTREAM (PACKFILENAME 'EXTENSION 'POS 'VERSION NIL 'BODY
                                                (FULLNAME INSTREAM))
                                     :DIRECTION :OUTPUT :IF-EXISTS :NEW-VERSION)
                  (LINELENGTH MAX.SMALLP OUTSTREAM)
                  (bind B first (PRINTOUT OUTSTREAM .I6 0 ": ") while (SETQ B (BIN INSTREAM))
                     do 
                        (* ;; "Line endings are marked, then executed.  Tabs are replaced")

                        (SBC B INSTREAM OUTSTREAM T))
                  (FULLNAME OUTSTREAM])

(SBR
  [LAMBDA (RUN)                                              (* ; "Edited 22-Aug-2023 11:07 by rmk")

    (* ;; "Show Bravo run")

    (LET ((ORIGPTR (GETFILEPTR BSTREAM)))
         (SETFILEPTR BSTREAM (fetch (RUN RUNSTART) of RUN))
         (printout T (fetch (RUN RUNSTART) of RUN)
                "/"
                (fetch (RUN RUNLENGTH) of RUN)
                ": ")
         (for I from 1 to (fetch (RUN RUNLENGTH) of RUN) do (SBC (BIN BSTREAM)
                                                                 BSTREAM T))
         (SETFILEPTR BSTREAM ORIGPTR)
         RUN])

(SBC
  [LAMBDA (BYTE INSTREAM OUTSTREAM SPACELINES)               (* ; "Edited 22-Aug-2023 12:12 by rmk")

    (* ;; "Show Bravo char-byte")

    (SELCHARQ BYTE
         (CR (PRINTOUT OUTSTREAM "[CR]")
             (if SPACELINES
                 then (PRINTOUT OUTSTREAM T T .I6 (GETFILEPTR INSTREAM)
                             ": ")
               else (PRINTOUT OUTSTREAM "[" (GETFILEPTR INSTREAM)
                           "]")))
         (LF (PRINTOUT OUTSTREAM "[LF]")
             (if SPACELINES
                 then (PRINTOUT OUTSTREAM T T .I6 (GETFILEPTR INSTREAM)
                             ": ")
               else (PRINTOUT OUTSTREAM "[" (GETFILEPTR INSTREAM)
                           "]")))
         (FORM (PRINTOUT OUTSTREAM "[FORM]")
               (if SPACELINES
                   then (PRINTOUT OUTSTREAM T T .I6 (GETFILEPTR INSTREAM)
                               ": ")
                 else (PRINTOUT OUTSTREAM "[" (GETFILEPTR INSTREAM)
                             "]")))
         (TAB (PRINTOUT OUTSTREAM "[TAB]"))
         (^Z (BOUT OUTSTREAM (CHARCODE ^Z))                  (* ; "Comes out black")
             (if SPACELINES
                 then (PRINTOUT OUTSTREAM T .I6 (GETFILEPTR INSTREAM)
                             ": " -5)
               else (PRINTOUT OUTSTREAM "[" (GETFILEPTR INSTREAM)
                           "]")))
         (\ (PRINTOUT OUTSTREAM (CHARACTER (CHARCODE \))
                   "["
                   (GETFILEPTR INSTREAM)
                   "]"))
         (BOUT OUTSTREAM BYTE])
)

(RPAQ? LASTTS NIL)

(RPAQQ OK.TO.MODIFY.FNS T)
(DEFINEQ

(DFOV
  [NLAMBDA ARGS                                              (* ; "Edited  4-Oct-2024 22:17 by rmk")
                                                             (* ; "Edited 12-Jan-2024 00:30 by rmk")
                                                             (* ; "Edited 15-Dec-2023 12:36 by rmk")
                                                             (* ; "Edited 13-Aug-2023 14:09 by rmk")

    (* ;; "Brings in a function from an earlier version, for comparison. If FILE is a version number, it uses WHEREIS")

    (SETQ ARGS (NLAMBDA.ARGS ARGS))
    (PROG ((FN (POP ARGS))
           (FNFILE (POP ARGS))
           (VERSION (POP ARGS))
           (DIRLIST (POP ARGS))
           ALTFNS VFNFILE FILEPKGFLG VFN DEF HOST)
          (CL:WHEN (FIXP FNFILE)
              (SETQ VERSION FNFILE)
              (SETQ FNFILE NIL))
          [if (AND FNFILE (MEMB FNFILE (WHEREIS FN 'FNS T)))
            elseif (SETQ FNFILE (CAR (WHEREIS FN 'FNS T)))
            else (CL:WHEN (EQ (CHARCODE /)
                              (CHCON1 FN))
                     (push ALTFNS (SUBATOM FN 2)))
                 (CL:WHEN (STRPOS "\TEDIT." FN NIL NIL T)
                     [push ALTFNS (SUBATOM FN (ADD1 (CONSTANT (NCHARS "\TEDIT"])
                 (CL:WHEN (STRPOS "TEDIT." FN NIL NIL T)
                     (push ALTFNS (PACK* "\" FN)))
                 (push ALTFNS (PACK* "\TEDIT." FN))
                 (for AF FILES in ALTFNS when (SETQ FILES (CAR (WHEREIS AF 'FNS T)))
                    collect (LIST AF (CAR FILES))
                    finally (if (CDR $$VAL)
                                then (PRINTOUT T "Possible names/files for " FN ", be more specific"
                                            T)
                              elseif $$VAL
                                then (SETQ FN (CAAR $$VAL))
                                     (SETQ FNFILE (CADAR $$VAL))
                              elseif FNFILE
                                then (PRINTOUT T FN " not found on " FNFILE T)
                              else (PRINTOUT T FN " not found" T]
          (CL:UNLESS FNFILE (RETURN))
          (CL:UNLESS (SETQ VFNFILE (FINDFILEVERSION FNFILE VERSION DIRLIST))
              (PRINTOUT T "Version " VERSION " of " FNFILE " not found" T)
              (RETURN))
          (if (SETQ DEF (GETDEF FN NIL VFNFILE 'NOERROR))
              then (CL:WHEN [EQ 'WMEDLEY (SETQ HOST (FILENAMEFIELD VFNFILE 'HOST]
                          (SETQ HOST NIL))
                   (SETQ VFN (PACK* (CL:IF HOST
                                        (PACK* "{" HOST "}" FN)
                                        FN)
                                    ";"
                                    (FILENAMEFIELD VFNFILE 'VERSION)
                                    (CL:IF (MEMB VERSION '(F FIRST 1))
                                        " (F)"
                                        "")))
                   (if DEF
                       then (PRINTOUT T "Editing " FN " from " VFNFILE T)
                            (PUTD VFN DEF)
                            (ADDTOFILE VFN 'FNS NIL)         (* ; "Forget it")
                            (EDITDEF VFN 'FNS NIL NIL '(:DONTWAIT))
                     else (PRINTOUT T FN " not found on " VFNFILE)
                          NIL)
            else (PRINTOUT T "Can't find old version of " FN " on " VFNFILE T])

(FINDFILEVERSION
  [LAMBDA (FILE VERSION DIRLIST)                             (* ; "Edited  4-Oct-2024 15:23 by rmk")

    (* ;; "Returns the version of FILE in DIRLIST that correspond to the relativer version specifier VERSION.  Negative version count backwrd from the newest (=1), positive count forward  from the oldest . F or FIRST are equivalent to -1 (= oldest).")

    (LET (FILES)
         (SELECTQ VERSION
             ((F FIRST) 
                  (SETQ VERSION 1))
             (NIL (SETQ VERSION -1))
             NIL)
         (if (EQ VERSION -1)
             then (FINDFILE FILE T DIRLIST)
           else [SETQ FILES (FILDIR (PACKFILENAME 'VERSION '* 'BODY (FINDFILE FILE T DIRLIST]
                (CAR (if (ILESSP VERSION 0)
                         then 
                              (* ;; "-2 is the second newest version")

                              (NTH FILES (IMINUS VERSION))
                       else 
                            (* ;; "2 is the second oldest")

                            (NTH (DREVERSE FILES)
                                 VERSION])

(OLDWI
  [LAMBDA (FN)                                               (* ; "Edited 16-May-2023 12:02 by rmk")
    (for F COMS in TEDITFILES when (AND (SETQ F (DFOV.OLDEST F))
                                        (INFILECOMS? FN NIL (GETDEF (FILECOMS F)
                                                                   'VARS F))) collect F])

(DFOV.OLDEST
  [LAMBDA (FILE DIRLIST)                                     (* ; "Edited 15-Dec-2023 12:22 by rmk")
                                                             (* ; "Edited 13-Aug-2023 07:30 by rmk")
                                                             (* ; "Edited 16-May-2023 11:07 by rmk")
    (CAR (LAST (FILDIR (PACKFILENAME 'VERSION '* 'BODY (FINDFILE FILE T DIRLIST])

(COMP
  [LAMBDA (FN)                                               (* ; "Edited  5-Feb-2023 20:14 by rmk")
    (COMPAREDEFS FN 'FNS (LIST 'SAVE (CAR (REMOVE 'SAVE (WHEREIS FN 'FNS T])

(DFR
  [NLAMBDA (FN FILE)                                         (* ; "Edited 12-Mar-2023 13:18 by rmk")
                                                             (* ; "Edited 10-Sep-2022 16:15 by rmk")
                                                             (* ; "Edited  6-Sep-2022 23:35 by rmk")
                                                             (* ; "Edited  4-Sep-2022 20:57 by rmk")
                                                             (* ; "Edited  9-Aug-2022 22:37 by rmk")
                                                             (* ; "Edited  8-Aug-2022 16:17 by rmk")
                                                             (* ; "Edited  7-Aug-2022 00:08 by rmk")

    (* ;; "Gets the definition from the release")

    (CL:UNLESS FILE
        (SETQ FILE (CAR (WHEREIS FN 'FNS T))))
    (CL:UNLESS FILE (ERROR FN " not found"))
    (SETQ FILE (FINDFILE FILE T))
    (CL:UNLESS FILE (ERROR FN " not found"))
    (LET [FILEPKGFLG (FNR (PACK* FN '-R]
         (COPYDEF FN FNR 'FNS (PACKFILENAME 'HOST '{RMEDLEY} 'VERSION NIL 'BODY FILE))
         (EDITDEF.FNS FNR NIL '(:DONTWAIT])
)
(DEFINEQ

(DFGV
  [NLAMBDA ARGS                                              (* ; "Edited 15-Dec-2023 12:26 by rmk")
                                                             (* ; "Edited 13-Aug-2023 14:09 by rmk")

    (* ;; "Brings in a function from an earlier version on {MEDLEY}, for comparison. FILE can be a version number, it uses WHEREIS")

    (APPLY (FUNCTION DFOV)
           (LIST (POP ARGS)
                 (POP ARGS)
                 (POP ARGS)
                 (GDIRECTORIES])

(GDIRECTORIES
  [LAMBDA NIL                                                (* ; "Edited 15-Dec-2023 12:19 by rmk")
    (for D in DIRECTORIES when (EQ 'WMEDLEY (FILENAMEFIELD D 'HOST)) collect (PACKFILENAME
                                                                              'HOST
                                                                              '{MEDLEY}
                                                                              'BODY D])
)
(DEFINEQ

(TTEST
  [LAMBDA (FILE REGION OPENONLY AFTERFORMS DONTQUIT READONLY)(* ; "Edited 27-Sep-2024 11:18 by rmk")
                                                             (* ; "Edited  5-May-2024 21:55 by rmk")
                                                             (* ; "Edited 29-Nov-2023 10:50 by rmk")
                                                             (* ; "Edited 23-Nov-2023 14:28 by rmk")
                                                             (* ; "Edited 22-Oct-2023 00:07 by rmk")
                                                             (* ; "Edited  9-Sep-2023 17:21 by rmk")
                                                             (* ; "Edited  8-Sep-2023 00:16 by rmk")
                                                             (* ; "Edited 19-Aug-2023 10:57 by rmk")
                                                             (* ; "Edited 17-Jul-2023 18:01 by rmk")
                                                             (* ; "Edited 15-Jul-2023 21:05 by rmk")

    (* ;; "FILE NIL gets the last file.")

    (* ;; "Region NIL defaults to last region, T always gets a new one.  If we are reusing the region, we also close the previous file and kill its process.")

    (* ;; "OPENONLY creates the text stream, doesn't create the window or process")

    [if (NULL REGION)
        then [SETQ REGION (REGIONP (EVALV 'LASTTEXTSTREAMREGION]
      elseif (AND (LITATOM REGION)
                  (REGIONP (EVALV REGION)))
        then (SETQ REGION (COPY (EVALV REGION]
    (IF FILE
        THEN [LET ((SUBDIR (LISTGET (UNPACKFILENAME.STRING FILE)
                                  'SUBDIRECTORY))
                   (TESTDIR '{TTESTS}))
                  (CL:WHEN SUBDIR
                      (SETQ TESTDIR (CONCAT TESTDIR "/" SUBDIR))
                      (SETQ FILE (ROOTFILENAME FILE)))
                  (CL:UNLESS (STRINGP FILE)
                      (SETQ FILE (OR (FINDFILE-WITH-EXTENSIONS FILE (CONS (PSEUDOFILENAME
                                                                           (DIRECTORYNAME T))
                                                                          (CONS TESTDIR DIRECTORIES))
                                            '(TEDIT TXT NIL))
                                     (ERROR "FILE NOT FOUND" FILE))))]
             (SETQ LASTTESTFILE FILE)
      elseif (AND (BOUNDP 'LASTTESTFILE)
                  LASTTESTFILE)
        then (SETQ FILE (OR (STRINGP LASTTESTFILE)
                            (PACKFILENAME 'VERSION NIL 'BODY LASTTESTFILE)))
      else (ERROR "NO FILE SPECIFIED"))
    (CL:WHEN (STRINGP FILE)
        (SETQ FILE (OPENSTRINGSTREAM FILE)))
    (LET (TEXTSTREAM TEXTOBJ)
         (DECLARE (SPECVARS TEXTSTREAM TEXTOBJ))
         (CL:WHEN (AND (BOUNDP 'LASTTESTSTREAM)
                       (TEXTSTREAMP LASTTESTSTREAM))
             (CL:UNLESS DONTQUIT
                 (SETTOBJ (TEXTOBJ LASTTESTSTREAM)
                        \DIRTY NIL)
                 (TEDIT.QUIT LASTTESTSTREAM)))
         [SETQ TEXTSTREAM (if OPENONLY
                              then [OPENTEXTSTREAM FILE NIL NIL NIL (CL:WHEN READONLY
                                                                        '(READONLY T))]
                            else (if (REGIONP REGION)
                                     then (SETQ REGION (COPY REGION))
                                   elseif REGION
                                   else (SETQ REGION 'TTEST))
                                 (TEXTSTREAM (TEDIT FILE (COPY REGION)
                                                    NIL
                                                    `(LEAVETTY T ,@(CL:WHEN READONLY
                                                                       `(READONLY T))]
         (SETQ LASTTESTSTREAM TEXTSTREAM)
         (SETQ LASTTEXTSTREAMREGION (REGIONP REGION))
         (SETQ TEXTOBJ (TEXTOBJ TEXTSTREAM))
         (CL:WHEN AFTERFORMS
             (if (NLISTP AFTERFORMS)
                 then (APPLY* AFTERFORMS)
               elseif (NLISTP (CAR (LISTP AFTERFORMS)))
                 then (EVAL AFTERFORMS)
               elseif (LISTP (CAR AFTERFORMS))
                 then (EVAL (CONS (FUNCTION PROGN)
                                  AFTERFORMS))))
         (SETQ LASTTEXTSTREAM TEXTSTREAM)                    (* ; "for GTS")
         TEXTSTREAM])

(LTEST
  [LAMBDA (FILE SCROLL)                                      (* ; "Edited 28-Jun-2024 15:25 by rmk")
                                                             (* ; "Edited 25-Jun-2024 11:59 by rmk")
                                                             (* ; "Edited 27-Apr-2024 13:50 by rmk")
                                                             (* ; "Edited 17-Mar-2024 13:04 by rmk")
                                                             (* ; "Edited 21-Oct-2023 10:24 by rmk")
                                                             (* ; "Edited 17-May-2023 09:48 by rmk")
                                                             (* ; "Edited 13-May-2023 21:34 by rmk")

    (* ;; "Line reformatting with inserts and deletes")

    (LET (LPC)
         (CL:WHEN (NUMBERP FILE)
             (SETQ SCROLL FILE)
             (SETQ FILE NIL))
         (TTEST FILE)
         (CL:WHEN SCROLL
             (SCROLLW (WFROMDS (TEXTSTREAM (GTO)))
                    0 SCROLL))
         (SETQ LPC (\TEDIT.CHTOPC (GETLD (GETLD (PANEPREFIX (\TEDIT.PRIMARYPANE (GTO)))
                                                NEXTLINE)
                                         LCHAR1)
                          (GTO)))
         (SP LPC)
         (SPLINES])

(INSP
  [LAMBDA (DONTCLOSE TOBJ)                                   (* ; "Edited 31-Oct-2023 19:45 by rmk")
                                                             (* ; "Edited 20-Apr-2023 08:10 by rmk")
                                                             (* ; "Edited 19-Apr-2023 08:00 by rmk")
                                                             (* ; "Edited 13-Apr-2023 09:44 by rmk")
    (SETQ TOBJ (GTO TOBJ))
    (CL:UNLESS DONTCLOSE (CLOSEI))
    (SP TOBJ)
    (AND NIL (INSPECT (FETCH PCTB OF TOBJ)
                    'LIST))
    (INSPECT (FETCH SEL OF TOBJ])

(THC
  [LAMBDA (TSTREAM PRINTER TYPE)                             (* ; "Edited 10-Jul-2023 23:00 by rmk")
    (CL:UNLESS TYPE (SETQ TYPE DEFAULTPRINTERTYPE))
    (LET ((TFILE (TXTFILE (GTO TSTREAM)))
          HCFILE)
         (CL:UNLESS PRINTER
             (SETQ HCFILE (OUTFILEP (PACKFILENAME 'EXTENSION TYPE 'VERSION NIL 'NAME
                                           (PACK* (FILENAMEFIELD TFILE 'NAME)
                                                  'W)
                                           'BODY TFILE))))
         (HARDCOPY.SOMEHOW (WFROMDS (TEXTSTREAM (GTO TSTREAM)))
                HCFILE TYPE)
         HCFILE])
)

(RPAQ? LASTTTESTFILE )

(RPAQQ TTESTREGIONS (RBRAVO RHUGE RMID RSMALL RBIG RHIGH))

(RPAQQ RBRAVO (1321 246 561 554))

(RPAQQ RHUGE (865 26 811 957))

(RPAQQ RMID (753 774 531 169))

(RPAQQ RSMALL (858 796 462 81))

(RPAQQ RBIG (900 400 600 358))

(RPAQQ RHIGH (877 880 462 103))
(DEFINEQ

(SHOWSAFE
  [LAMBDA (PIECE TAG HELP FILE TEXTOBJ)                      (* ; "Edited 21-Oct-2023 10:50 by rmk")
                                                             (* ; "Edited  4-Sep-2023 23:31 by rmk")
    (CL:UNLESS FILE (SETQ FILE TTY))
    (CL:WHEN (OR (EQ SAFESHOW T)
                 (EQMEMB TAG SAFESHOW))
        (CL:WHEN TAG (PRINTOUT FILE TAG " "))
        (PRINTOUT FILE (PFPOS PIECE)
               " Left = " BYTESLEFT " Inbuffer = " BYTESLEFTINBUFFER " Prefix = " PREFIXBYTES T)
        (SPPRINT PIECE FILE (GTO TEXTOBJ)))
    (CL:WHEN (OR HELP (EQ SAFEHELP T)
                 (EQMEMB TAG SAFEHELP))
           (HELP PIECE TAG])
)

(RPAQ? SAFESHOW NIL)

(RPAQ? SAFEHELP NIL)

(RPAQQ VTDIR {DSK}<users>kaplan>local>medley3.5>pregit-medley>venuelispcore>library>.)

(RPAQQ VTF {DSK}<users>kaplan>local>medley3.5>pregit-medley>venuelispcore>library>TFBRAVO.)

(RPAQQ TF {WMEDLEY}<library>TEDIT>TEDIT-TFBRAVO.)
(DEFINEQ

(DFV
  [NLAMBDA (FN FILE)                                         (* ; "Edited  2-Aug-2023 12:30 by rmk")
                                                             (* ; "Edited 31-Jul-2023 20:42 by rmk")

    (* ;; "Edit from pregit Venue files, default to TFBRAVO.")

    (CL:UNLESS FILE
        (SETQ FILE 'TFBRAVO))
    (SETQ FILE (PACKFILENAME 'NAME FILE 'BODY VTDIR))
    (LET (VNAME DEF)
         (CL:UNLESS FILE (SETQ FILE))
         (SETQ DEF (GETDEF FN NIL FILE 'NOERROR))
         (if DEF
             then (SETQ VNAME (PACK* FN "-" "Venue"))
                  (PRINTOUT T "Editing " FN " from " FILE T)
                  (PUTDEF VNAME 'FNS DEF)
                  (ADDTOFILE VNAME 'FNS NIL)
                  (EDITDEF VNAME 'FNS NIL NIL '(:DONTWAIT))
           else (PRINTOUT T FN " not found on " FILE)
                NIL])

(VSEE
  [NLAMBDA FILE                                              (* ; "Edited  2-Aug-2023 12:08 by rmk")
    (PFI.MAYBE.SEE.PRETTY (PACKFILENAME 'DIRECTORY VTDIR 'BODY FILE)
           T])
)
(DEFINEQ

(PTT
  [LAMBDA (FILE NOTREADONLY)                                 (* ; "Edited 30-Nov-2023 10:40 by rmk")
                                                             (* ; "Edited 12-Aug-2023 23:27 by rmk")
                                                             (* ; "Edited 11-Aug-2023 08:40 by rmk")

    (* ;; "Plaintext readonly")

    (TEDIT FILE NIL NIL `(UNFORMATTED T READONLY ,(NOT NOTREADONLY])
)



(* ; "Plain text")

(DEFINEQ

(CONCATFILES
  [LAMBDA (FILES OUTFILE)                                    (* ; "Edited 14-Jan-2024 00:12 by rmk")
    (CL:WHEN (AND (STREAMP (CAR (LISTP FILES)))
                  (STREAMP (CDR FILES)))
        (SETQ FILES (LIST (CAR FILES)
                          (CDR FILES))))
    (LET [(OUTSTREAM (OPENSTREAM (OR OUTFILE '{NODIRCORE})
                            'BOTH]
         (for F in FILES do (COPYBYTES F OUTSTREAM 0 (GETEOFPTR F)))
         OUTSTREAM])
)
(DECLARE%: EVAL@COMPILE 

(PUTPROPS DEBUGOUTPUT MACRO
          [ARGS
           `(LET [(OFILE ,(CAR ARGS))
                  (WTYPE ,(CADR ARGS]
                 (RESETLST
                     [if WTYPE
                         then [SETQ OFILE (OPENTEXTSTREAM NIL (REGIONP OFILE)
                                                 NIL NIL '(FONT DEFAULTFONT]
                              [RESETSAVE NIL
                                     `(PROGN (CL:UNLESS RESETSTATE
                                                 [TEDIT OFILE WTYPE NIL
                                                        `(READONLY QUIET LEAVETTY T TITLE
                                                                ,WTYPE])]
                       elseif OFILE
                         then (RESETSAVE (SETQ OFILE (OPENSTREAM OFILE 'OUTPUT 'NEW))
                                     '(PROGN (CLOSEF? OLDVALUE]
                     [RESETSAVE (DSPFONT NIL OFILE)
                            '(PROGN (DSPFONT OLDVALUE OFILE]
                     ,@(CDDR ARGS))])
)
(DEFINEQ

(TEDIT-DEBUG
  [LAMBDA (DONTOVERLOAD)                                     (* ; "Edited  9-Aug-2024 13:20 by rmk")
                                                             (* ; "Edited 16-Jul-2024 12:37 by rmk")
                                                             (* ; "Edited  6-Jul-2024 21:16 by rmk")
                                                             (* ; "Edited 10-Jun-2024 14:21 by rmk")
                                                             (* ; "Edited 19-May-2024 21:32 by rmk")
                                                             (* ; "Edited  6-May-2024 22:13 by rmk")
                                                             (* ; "Edited 22-Apr-2024 23:42 by rmk")
                                                             (* ; "Edited  4-Apr-2024 12:13 by rmk")
                                                             (* ; "Edited 17-Mar-2024 19:46 by rmk")
                                                             (* ; "Edited 15-Mar-2024 15:28 by rmk")
                                                             (* ; "Edited  3-Dec-2023 21:00 by rmk")
                                                             (* ; "Edited 29-Nov-2023 10:49 by rmk")
                                                             (* ; "Edited 24-Nov-2023 12:53 by rmk")
    (CL:WHEN (DIRECTORYNAMEP (MEDLEYDIR "../oldtedit/"))
        (PSEUDOHOST 'OT (MEDLEYDIR "../oldtedit/")))
    (FILESLOAD (NOERROR FROM LOADUPS)
           FULLER.DATABASE)
    (CL:IF DONTOVERLOAD
        (LOAD 'TEDIT-EXPORTS.ALL)
        (EDIT-TEDIT))
    (FILESLOAD (NOERROR FROM {WMEDLEY}/library/tedit/)
           TEDIT-STRESS TEDIT-RENAMES)
    (CL:UNLESS DONTOVERLOAD
        (%. ANALYZE ON (TEDIT-STRESS TEDIT-DEBUG)))
    [SETQ TFILES `(TEDIT-DEBUG TEDIT-STRESS ,@TEDITFILES]
    (CNDIR (PSEUDOFILENAME (MEDLEYDIR "library/tedit")))
    [GIT-PUT-PROJECT-FIELD 'MEDLEY 'EXCLUSIONS `("tedit-tests/" ,@(GIT-GET-PROJECT 'MEDLEY
                                                                         'EXCLUSIONS]
    (FILESLOAD (NOERROR)
           {OT}OTWHEREIS)
    (PRINTOUT T T "Connected to " (PSEUDOFILENAME (MEDLEYDIR "library/tedit"))
           T])
)
(DEFINEQ

(TRENAME
  [LAMBDA (FNS FILES)                                        (* ; "Edited 16-Mar-2024 09:22 by rmk")
    (CL:UNLESS FILES (SETQ FILES TEDITFILES))
    (LET [(MAP (FOR F TRANS INSIDE FNS
                  WHEN (SETQ TRANS (if (EQ (CHARCODE \)
                                           (NTHCHARCODE F 1))
                                       then (CL:UNLESS (STRPOS "TEDIT." F 2 NIL T)
                                                (PACK* "\TEDIT." (SUBSTRING F 2)))
                                     elseif (STRPOS "TEDIT" F NIL NIL T)
                                       then (PACK* "\" F)
                                     else (PACK* "\TEDIT." F))) COLLECT (CONS F TRANS]
         (for M in MAP do (COPYDEF (CAR M)
                                 (CDR M)))
         (for M WH FS in MAP DO [SETQ WH (CAR (WHEREIS (CAR M)
                                                     'FNS]
                                (SETQ FS (%. WHO ON IN FILES CALLS (CAR M)))
                                (CL:WHEN WH (pushnew FS WH))
                                (DSUBLIS MAP (GETD (CDR M)))
                                (MARKASCHANGED (CDR M)
                                       'FNS)
                                (%. ERASE IN (CAR M))
                                (CL:WHEN WH
                                    (DSUBST (CDR M)
                                           (CAR M)
                                           (FILECOMS WH))
                                    (MARKASCHANGED (FILECOMS WH)
                                           'VARS))
                                (%. ANALYZE ON IN FS))
         MAP])
)
(DECLARE%: DONTEVAL@LOAD DOEVAL@COMPILE DONTCOPY COMPILERVARS 

(ADDTOVAR NLAMA VSEE DFGV DFOV)

(ADDTOVAR NLAML DFV DFR)

(ADDTOVAR LAMA )
)
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (4384 4640 (MH 4394 . 4638)) (4672 6335 (GTO 4682 . 4932) (GTS 4934 . 6175) (GTW 6177 . 
6333)) (6368 6791 (TRELMOVE 6378 . 6621) (TSCROLL 6623 . 6789)) (6792 11487 (ITS 6802 . 8221) (TRY 
8223 . 9492) (PRINTSPEC 9494 . 9717) (TEDITCLOSEW 9719 . 10062) (PARALASTWITHOUTEOL 10064 . 10949) (
FIXPARALAST 10951 . 11485)) (11488 11659 (GETEDITPROPS 11498 . 11657)) (11660 14089 (MTEST 11670 . 
12239) (TRYMENU 12241 . 12525) (PTMENU 12527 . 12932) (SHOWMENUPROPS 12934 . 13470) (IMB 13472 . 14087
)) (14090 34703 (SP 14100 . 18836) (SSP 18838 . 19897) (SPL 19899 . 20140) (SCL 20142 . 20600) (
SPPRINT 20602 . 27018) (SPPRINT.CHAR 27020 . 28004) (SPPRINT.OBJ 28006 . 30959) (SHOWPIECEBYTES 30961
 . 32403) (CHECKPLENGTHS 32405 . 32862) (SBT 32864 . 33853) (COPYPCHAIN 33855 . 34701)) (34704 36765 (
POSLINE 34714 . 36763)) (36766 37649 (PRESPLIT 36776 . 37647)) (37650 46176 (NTHPIECE 37660 . 38792) (
NPIECES 38794 . 39659) (NTHPIECECHAR 39661 . 40969) (SELPIECE 40971 . 41413) (PIECENUM 41415 . 41975) 
(INSPECTPIECES 41977 . 43107) (PCBYTES 43109 . 43994) (FILEBYTES 43996 . 45420) (TFBYTES 45422 . 46174
)) (46177 46424 (IPANES 46187 . 46422)) (46425 57073 (STL 46435 . 54947) (ALLTL 54949 . 56202) (ITL 
56204 . 56623) (NTHCHARSLOT 56625 . 57071)) (57099 76842 (PLCHAIN 57109 . 57637) (PRINTLINE 57639 . 
60599) (ILINES 60601 . 63142) (SL 63144 . 65019) (SL.GETLINES 65021 . 68110) (SLL 68112 . 68859) (
SHOWLINE 68861 . 72423) (CHECKLINES 72425 . 73405) (COLLECTLINES 73407 . 73659) (NTHLINE 73661 . 74666
) (HEIGHT 74668 . 74956) (LINEBOTS 74958 . 75809) (SPLINES 75811 . 76840)) (76843 86539 (ISELS 76853
 . 78465) (ISEL 78467 . 79078) (IHIST 79080 . 80984) (IPCTB 80986 . 81294) (IPC 81296 . 82527) (IPCC 
82529 . 83688) (IPC.DECODEARGS 83690 . 85903) (GSEL 85905 . 86537)) (86540 89434 (SPF 86550 . 88849) (
SPF1 88851 . 89432)) (89463 98858 (SLF 89473 . 97995) (SLF.FATPLEN 97997 . 98856)) (98891 99814 (
SELTEDIT 98901 . 99812)) (99884 106042 (PPARA 99894 . 100316) (PRUN 100318 . 102340) (ADDLINEPOSITIONS
 102342 . 103769) (SBR 103771 . 104425) (SBC 104427 . 106040)) (106099 112981 (DFOV 106109 . 109650) (
FINDFILEVERSION 109652 . 110786) (OLDWI 110788 . 111163) (DFOV.OLDEST 111165 . 111590) (COMP 111592 . 
111787) (DFR 111789 . 112979)) (112982 114015 (DFGV 112992 . 113518) (GDIRECTORIES 113520 . 114013)) (
114016 121233 (TTEST 114026 . 118558) (LTEST 118560 . 119925) (INSP 119927 . 120577) (THC 120579 . 
121231)) (121547 122239 (SHOWSAFE 121557 . 122237)) (122536 123627 (DFV 122546 . 123421) (VSEE 123423
 . 123625)) (123628 124082 (PTT 123638 . 124080)) (124110 124611 (CONCATFILES 124120 . 124609)) (
125682 127998 (TEDIT-DEBUG 125692 . 127996)) (127999 129735 (TRENAME 128009 . 129733)))))
STOP
