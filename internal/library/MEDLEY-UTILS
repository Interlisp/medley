(DEFINE-FILE-INFO READTABLE "XCL" PACKAGE "INTERLISP")(FILECREATED "24-Mar-2021 15:45:15" |{DSK}<home>larry>ilisp>medley>internal>library>MEDLEY-UTILS.;2| 8564         |changes| |to:|  (FNS GATHER-INFO MAKE-WHEREIS-HASH)      |previous| |date:| "18-Mar-2021 19:24:10" |{DSK}<home>larry>ilisp>medley>internal>library>MEDLEY-UTILS.;1|)(PRETTYCOMPRINT MEDLEY-UTILSCOMS)(RPAQQ MEDLEY-UTILSCOMS ((FNS GATHER-INFO MEDLEY-FIX-LINKS MEDLEY-FIX-DATES)                             (VARS MEDLEY-FIX-DIRS)                             (FNS MAKE-EXPORTS-ALL MAKE-WHEREIS-HASH)))(DEFINEQ(GATHER-INFO  (LAMBDA (PHASE)                                     (* \; "Edited 24-Mar-2021 15:13 by larry")    (SELECTQ PHASE        (1 (SETQ LOADEDFILES (|for| X |in| LOADEDFILELST |collect| (FILENAMEFIELD                                                                                X                                                                                'NAME)))           (PRINTOUT T " loaded files not in SYSFILES or FILELST: "                  (|for| X |in| LOADEDFILES |when| (NOT (OR (FMEMB X SYSFILES)                                                                        (FMEMB X FILELST)))                     |collect| X)                  T)           (FILESLOAD FILESETS)           (SETQ ALLFILESETSFILES (|for| X |in| FILESETS |join| (APPEND (EVAL X))))           (PRINTOUT T "Files in FILESETS not loaded " (CL:SET-DIFFERENCE ALLFILESETSFILES                                                               LOADEDFILES)                  T)           (SETQ SOURCES (|for| X |in| (DIRECTORY (MEDLEYDIR "sources" "*.*;" T))                            |when| (NOT (MEMB (FILENAMEFIELD X 'EXTENSION)                                                  '(LCOM DFASL TEDIT TXT)))                            |collect| (FILENAMEFIELD X 'NAME)))           (PRINTOUT T "Sources not loaded: " (CL:SET-DIFFERENCE SOURCES (APPEND FILELST SYSFILES                                                                                 ALLFILESETSFILES))                  T))        (2 (SETQ DEFINEDFNS (LET ((DEFD NIL))                                 (MAPATOMS (FUNCTION (CL:LAMBDA (X)                                                            (CL:WHEN (GETD X)                                                                (CL:SETQ DEFD (CONS X DEFD))))))                                 DEFD))           (FOR X IN DEFINEDFNS |when| (CCODEP X)              DO (LET ((Y (PUTPROP X 'CCC (CALLSCCODE X))))                          (FOR REV IN '(BLOCK-CALLED-BY CALLED-BY SPECIAL-BY GLOBAL-BY)                             AS VAL IN Y                             DO (FOR S IN VAL DO (PUTPROP S REV                                                                        (CONS X (GETPROP S REV)))))))           (SETQ CALLEDFNS NIL)           (MAPATOMS (FUNCTION (LAMBDA (X)                                 (IF (AND (NOT (GETD X))                                              (GETPROP X 'CALLED-BY))                                     THEN (CL:PUSH X CALLEDFNS)))))           (PRINTOUT T "Functions called and not defined" CALLEDFNS T))        (3 (FOR X IN SYSFILES              DO (LOAD X 'PROP)                    (PUTPROP X 'CONTENT (READFILE X))                    (FOR EXR IN (GETPROP X 'CONTENT)                       DO (SELECTQ (CAR EXR)                                  (DEFINEQ (FOR DFN IN (CDR EXR)                                              DO (IF (EQUAL (CADR DFN)                                                                    (GETPROP (CAR DFN)                                                                           'EXPR))                                                         THEN (PRINTOUT T (CAR DFN)                                                                         " ")                                                               (PUTPROP (CAR DFN)                                                                      'EXPR                                                                      (CADR DFN))                                                       ELSE (PRINTOUT T (CAR DFN)                                                                       "* "))))                                  NIL)))           (SETQ ALLCONTENT (FOR X IN SYSFILES COLLECT (CONS X (GETPROP X 'CONTENT))))                                                             (* \; " don't edit with SEDIT")           (LET (DUPS)                (FOR X IN SYSFILES                   DO (FOR FN IN (FILEFNSLST X)                             DO (IF (GETPROP FN 'WHEREIS)                                        THEN (NCONC1 (GETPROP FN 'WHEREIS)                                                        X)                                              (OR (FMEMB FN DUPS)                                                  (SETQ DUPS (CONS FN DUPS)))                                      ELSE (PUTPROP FN 'WHEREIS (LIST X)))))                (SETQ DUPFNS DUPS))           (PRINTOUT T "Functions on more than one file: " DUPFNS T)           (PRINTOUT T "Functions compiled but no expr" (SETQ NO-SOURCE                                                         (FOR X IN DEFINEDFNS                                                            WHEN (NOT (GETPROP X 'EXPR))                                                              (* \;                                           " should test for blockcompiled fns and function gensyms")                                                            COLLECT X))                  T))        (4 (FOR X IN SYSFILES DO (MASTERSCOPE `(ANALYZE ON ,X))))        (HELP))))(MEDLEY-FIX-LINKS  (LAMBDA (UNIXPATH)                                  (* \; "Edited 18-Jan-2021 12:01 by larry")    (OR UNIXPATH (SETQ UNIXPATH (UNIX-GETENV "MEDLEYDIR"))        (ERROR "No Directory"))                       (* \; "Edited 18-Jan-2021 11:45 by larry")    (|ShellCommand| (CONCAT "cd " UNIXPATH " && /bin/sh scripts/fixlinks && /bin/sh /tmp/doit"))))(MEDLEY-FIX-DATES  (LAMBDA (DIRS)                                      (* \; "Edited 28-Jan-2021 12:15 by larry")    (|for| X |in| (OR DIRS MEDLEY-FIX-DIRS) |join| (FIX-DIRECTORY-DATES                                                                (MEDLEYDIR (PRINT X T)))))))(RPAQQ MEDLEY-FIX-DIRS ("sources" "library" "lispusers" "internal/library" "greetfiles"                                   "docs>Documentation Tools"))(DEFINEQ(MAKE-EXPORTS-ALL  (LAMBDA NIL                                         (* \; "Edited  9-Mar-2021 16:11 by larry")                                                             (* "Edited May 3, 2018 by Ron Kaplan--relative to MEDLEYDIR/lispcore/.  Don't know why it does the CORE/RENAME")                                                             (*         "Edited Aug 17 94 by Sybalsky -- point it to /king/export/lispcore as the truth directory.")                                                             (*                       "Edited July 5, 1990 by Sybalsky -- point it to Pele as the truth directory.")                                                             (*                                                            "Edited September 29, 1986 by van Melle")    (CNDIR (MEDLEYDIR "sources"))    (LOAD 'FILESETS)    (GATHEREXPORTS EXPORTFILES (MEDLEYDIR "tmp" "exports.all" T))))(MAKE-WHEREIS-HASH  (LAMBDA NIL                                         (* \; "Edited 24-Mar-2021 13:26 by larry")    (LET ((FILING.ENUMERATION.DEPTH 1)          HASHFILE)         (DRIBBLE (MEDLEYDIR "tmp" "whereis.dribble" T))         (SETQ HASHFILE (XCL::WHERE-IS-NOTICE (MEDLEYDIR "tmp" "whereis.hash-tmp" T)                               :FILES                               (|for| X |in| MEDLEY-FIX-DIRS |collect|                                                                     (CONCAT (MEDLEYDIR X)                                                                            "*.;"))                               :HASH-FILE-SIZE 60000 :NEW T))         (RENAMEFILE HASHFILE (MEDLEYDIR "tmp" "whereis.hash" T))         (DRIBBLE)))))(DECLARE\: DONTCOPY  (FILEMAP (NIL (591 6646 (GATHER-INFO 601 . 5949) (MEDLEY-FIX-LINKS 5951 . 6340) (MEDLEY-FIX-DATES 6342 . 6644)) (6804 8541 (MAKE-EXPORTS-ALL 6814 . 7763) (MAKE-WHEREIS-HASH 7765 . 8539)))))STOP