(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED " 7-Aug-2023 13:31:49" {DSK}<home>frank>il>medley>gmedley>internal>loadups>MAKEINIT.;4 54490  

      :CHANGES-TO (FNS MAKEINITGREET)

      :PREVIOUS-DATE " 3-Aug-2023 17:37:51" 
{DSK}<home>frank>il>medley>gmedley>internal>loadups>MAKEINIT.;1)


(PRETTYCOMPRINT MAKEINITCOMS)

(RPAQQ MAKEINITCOMS
       ((COMS 

(* ;;; "From MAKEINITGREET")

              (FNS MAKEINITGREET)
              (FILES (SOURCE)
                     FILESETS)
              (FILES (LOADCOMP)
                     LLARITH LLFLOAT)
              (FILES RENAMEFNS XCL-PACKAGE CMLARRAY-SUPPORT VMEM))
        (COMS 
              (* ;; "From original MAKEINIT")

              (FNS LOADMAKEINIT LOADMKIFILES RELOAD MAKEINIT MKI.START)
              (COMS                                          (* ; 
                                       "reading compiled files and processing well-known expressions")
                    (FNS MKI.PASSFILE SCRATCHARRAY DOFORM CONSTFORMP NOTICECOMS EVALFORMAKEINIT)
                    (FNS I.ADDTOVAR I.DECLARE%: I.DEFINE-FILE-INFO I.FILECREATED I.PUTPROPS I.RPAQ 
                         I.RPAQQ I.RPAQ? I.SETTOPVAL I.NOUNDO)
                    (PROP MKI ADDTOVAR DECLARE%: DEFINE-FILE-INFO FILECREATED PUTPROPS RPAQ RPAQ? 
                          RPAQQ LISPXPRINT PRETTYCOMPRINT * SETTOPVAL SETQQ SETQ /SETTOPVAL))
              (FNS I.ATOMNUMBER I.\ATOMCELL I.FIXUPNUM I.FIXUPPTR I.FIXUPSYM I.WORDSPERNAMEENTRY 
                   I.SETSTKNTOFFSET)
              (COMS                                          (* ; "stuff for MAXC")
                    (FNS MKI.ATOM MKI.IEEE))
              [COMS                                          (* ; 
                    "stuff to maintain symbol values, prop lists during makeinit--all dumped at end.")
                    (FNS MKI.DSET MKI.ADDTO MKI.PUTPROP)
                    (VARS (MKI.ARRAY)
                          (MKI.TVHA (HASHARRAY 400))
                          (MKI.PLHA (HASHARRAY 150))
                          (MKI.ATOMARRAY (HASHARRAY 5000))
                          (INIT.EXT 'SYSOUT]
              (COMS (FNS DUMPVP BOUTZEROS BIN16 BOUT16)
                    (VARS (MKI.FirstDataByte 1024)
                          (MKI.Page0Byte 512)
                          (MKI.DATE (DATE))
                          MKI.CODESTARTOFFSET MKI.SEQUENTIAL PRINTEXPRS))
              (INITVARS (PRINTEXPRS T)
                     (REMOTECOMPILE.EXT COMPILE.EXT))
              (DECLARE%: EVAL@COMPILE (PROP MACRO SETXVAR IEQ)
                     DONTCOPY
                     (FILES (LOADCOMP)
                            MEM)))
        (COMS 
              (* ;; "from DLFIXINIT")

              
              (* ;; " This file is all because the dandelion needed its microcode embedded in the init file, and MAIKO wasn't around. So this is all to make room for microcode we don't need. Except something(?) might expect the %"InterfacePage%" as page 2 of the file, so we're leaving it in place now")

              (FNS DLFIXINIT DLSORTSYSOUTPAGES DLNEXTFP DLLOCKEDPAGEP DLSETLOCKBIT DLCOPYPAGEMAP 
                   DLCOPYVMPAGE DLADDPAGEMAPENTRIES ASSIGNFILEPAGE ASSIGNFILEPAGERANGE DLDUMPSYSOUT 
                   DLDUMPFPTOVP DLDUMPPAGEMAPS DLDUMPVMEMPAGES DLSETBOOTPTR DLDUMPARRAY 
                   DLMARKASDUMPED DLDUMPVMEMPAGE INSTALLDOMINO INSTALLDOMINO.DIRECT INSTALLNEWDOMINO)
              (FILES READSYS)
              (FNS DLPRINTFPTOVP PRINTPRIMARYMAP DLREADPAGEOFWORDS SETDIF)
              (CONSTANTS \NO.PAGE.ASSIGNED)
              (GLOBALVARS DLPRIMARYMAP DLSECONDARYMAP DLLOCKBITS DLLASTDOMINOPAGE DLIFPAGE DLNEXTPM 
                     DLPAGEMAPFP FPTOVP NEWFPFROMOLD VMEMFILE VMEMFILEX))))



(* ;;; "From MAKEINITGREET")

(DEFINEQ

(MAKEINITGREET
  [LAMBDA (SYSOUTFILE DLINITFILE)                          (* ; "Edited  3-Aug-2023 17:37 by frank")
                                                           (* ; "Edited 11-Mar-2021 22:14 by larry")
                                                            (* ; "Edited  5-Dec-2017 15:26 by rmk:")

    (* ;; "")

    (* ;; " Updated Lisp version for big physical memory --bvm |11/3/87")

    (* ;; "")
                                                             (* Versions are Lisp Microcode Bcpl)
    (MEDLEY-INIT-VARS)
    (RESETLST
        (RESETSAVE OK.TO.MODIFY.FNS T)
        (DORENAME 'I)
        (DORENAME 'R)
        (DLFIXINIT (MAKEINIT '(39424 5682 11008)
                          SYSOUTFILE NIL DIRECTORIES DISPLAYFONTDIRECTORIES)
               DLINITFILE))])
)

(FILESLOAD (SOURCE)
       FILESETS)

(FILESLOAD (LOADCOMP)
       LLARITH LLFLOAT)

(FILESLOAD RENAMEFNS XCL-PACKAGE CMLARRAY-SUPPORT VMEM)



(* ;; "From original MAKEINIT")

(DEFINEQ

(LOADMAKEINIT
(LAMBDA (LARGEFLG) (* lmm "31-JUL-81 14:27") (SELECTQ (SYSTEMTYPE) ((D ALTO)) (PROGN (ADDTOVAR DIRECTORIES BLISP) (GCGAG 1000) (COND ((NOT LARGEFLG) (SETSEPR (QUOTE (%| 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26)) 1 FILERDTBL) (MINFS 45000 (QUOTE ARRAYP)) (MINFS 10000 (QUOTE FIXP)) (MINFS 3000 (QUOTE STRING.CHARS)) (MINFS 2000 (QUOTE ATOM.CHARS)))) (MOVD? (QUOTE NILL) (QUOTE MKNUMATOM)) (* ;; "This is a kludge to get around the problem that, while MKATOM is in LLNEW, MKNUMATOM is not, and MKATOM calls MKNUMATOM when given an atom beginning with a digit.  It turns out that MKNUMATOM will always return NIL in the cases called from MAKEINIT because MAKEINIT is merely copying things which it knows are really LITATOM and spelled like it.") (MOVD? (QUOTE *) (QUOTE BLOCKRECORD)) (PUTDQ? FIXSPELL1 (LAMBDA (OLD NEW) (PRINT (LIST OLD (QUOTE ->) NEW) T T))))) (LOADMKIFILES) (SELECTQ (SYSTEMTYPE) ((D ALTO)) (PROGN (MINFS 10000 (QUOTE ALTOPOINTER)) (* ; "doesn't work until after datatype declaration has been loaded") (RECLAIM (QUOTE ARRAYP)) (RECLAIM (QUOTE ATOM.CHARS)) (MINFS 10000 (QUOTE ARRAYP)) (MINFS 5000 (QUOTE LISTP)) (SYSOUT (QUOTE MKI.SAV)))))
)

(LOADMKIFILES
  [LAMBDA NIL                                            (* ; "Edited  7-Feb-2021 17:39 by lmm")
                                                             (* mjs "13-Mar-84 14:41")
    (for X in MAKEINITFILES do (RELOAD (PACKFILENAME 'BODY X 'EXTENSION COMPILE.EXT])

(RELOAD
(LAMBDA (FILE) (* lmm "13-APR-81 21:16") (PROG (DATE FULLFILENAME) RETRY (COND ((ILESSP (OR (GETPROP FILE (QUOTE LOADDATE)) MIN.INTEGER) (SETQ DATE (GETFILEINFO (SETQ FULLFILENAME (OR (FINDFILE FILE T) (GO NOTFOUND))) (QUOTE ICREATIONDATE)))) (LOAD FULLFILENAME T) (PUTPROP FILE (QUOTE LOADDATE) DATE))) (RETURN T) NOTFOUND (COND ((GETP (NAMEFIELD FILE) (QUOTE FILEDATES)) (PRINT (CONS FILE (QUOTE (already loaded))) T) (RETURN))) (ERROR FILE "not found.") (GO RETRY)))
)

(MAKEINIT
  [LAMBDA (VERSIONS TOFILE TYPE LOADUPDIRS FONTDIRS)     (* ; "Edited  7-Feb-2021 17:46 by lmm")
                                                             (* ; "Edited 19-Jul-90 17:26 by jds")
    (LOADMKIFILES)
    (PROG ([TYPELST (OR (LISTP TYPE)
                        (OR (CDR (ASSOC TYPE MAKEINITTYPES))
                            (ERROR TYPE '?]
           FILES SIZEGUESS AFTERINITFILESET EXPRESSIONS)

     (* ;; "TYPELST is a list of the form (type file-list after-init-files init-size-guess)")

          (SETQ FILES (CADR TYPELST))
          (SETQ AFTERINITFILESET (CADDR TYPELST))
          (SETQ SIZEGUESS (CADDDR TYPELST))
          (RESETLST
              [RESETSAVE (OUTPUT (SETQ TOFILE (OPENSTREAM (PACKFILENAME.STRING 'BODY
                                                                 (OR TOFILE (CAR TYPELST)
                                                                     'XXX)
                                                                 'EXTENSION INIT.EXT)
                                                     'OUTPUT
                                                     'NEW 8]
              (RESETSAVE NIL (LIST [FUNCTION (LAMBDA (FL)
                                               (AND (OPENP FL)
                                                    (CLOSEF FL))
                                               (AND RESETSTATE (DELFILE (FULLNAME FL]
                                   TOFILE))
              (PROG ((OUTX TOFILE))
                    (SETQ DIRECTORIES LOADUPDIRS)
                    (MKI.START)
                    (for X in FILES do (MKI.PASSFILE X))

               (* ;; "Generally loads the files in 0LISPSET and 1LISPSET, with 2LISPSET getting loaded immediately after the init starts.")

                    (AND LOADUPDIRS (MKI.DSET 'LOADUPDIRECTORIES LOADUPDIRS))
                    (AND FONTDIRS (MKI.DSET 'DISPLAYFONTDIRECTORIES FONTDIRS))
                    [COND
                       (AFTERINITFILESET                     (* ; "Load stuff that has to be loaded before we can call LOADUP.  Ugly expression here is because FILESLOAD is on MACHINEINDEPENDENT.")
                        [MKI.ADDTO
                         'MAKEINIT.EXPRESSIONS
                         `((MAPC ',(EVAL AFTERINITFILESET)
                                 (FUNCTION (LAMBDA (FILE)
                                             (OR [SOME LOADUPDIRECTORIES
                                                       (FUNCTION (LAMBDA (DIR FL)
                                                                   (COND
                                                                      ((SETQ FL
                                                                        (INFILEP (PACKFILENAME.STRING
                                                                                  'DIRECTORY DIR
                                                                                  'NAME FILE
                                                                                  'EXTENSION 
                                                                                  COMPILE.EXT)))
                                                                       (LOAD FL 'SYSLOAD)
                                                                       T]
                                                 (PRINT (CONS FILE '(not found))
                                                        T]
                        (MKI.ADDTO 'BOOTFILES '(MAKEINIT.EXPRESSIONS]
                    (I.MAKEINITLAST VERSIONS)))
          (RETURN (FULLNAME TOFILE])

(MKI.START
(LAMBDA NIL (* bvm%: "12-Dec-84 15:23") (SETQ RESETPTR) (SETQ RESETPC) (BOUTZEROS MKI.FirstDataByte) (CLRHASH MKI.TVHA) (CLRHASH MKI.PLHA) (CLRHASH MKI.ATOMARRAY) (RESETMEMORY) (SETQ MKI.VALUES (for X in INITVALUES bind Y collect (SET (SETQ Y (PACK* "I." (SUBSTRING (CAR X) 2 -1))) (EVAL (CADR X))) Y)) (SETQ MKI.PTRS (for X in INITPTRS bind Y collect (SET (SETQ Y (PACK* "I." (SUBSTRING (CAR X) 2 -1))) (CADR X)) Y)) (I.MAKEINITFIRST) (MKI.DSET NIL NIL) (MKI.DSET T T) (MKI.DSET (QUOTE MAKEINITDATES) (LIST MKI.DATE (DATE))) (for X in INITCONSTANTS when (NEQ (CAR X) (QUOTE *)) do (I.FSETVAL (CAR X) (COND ((LISTP (CADR X)) (I.VAG2 (CAADR X) (CADR (CADR X)))) (T (I.\COPY (CADR X)))))))
)
)



(* ; "reading compiled files and processing well-known expressions")

(DEFINEQ

(MKI.PASSFILE
  [LAMBDA (FILESET)                                     (* ; "Edited 19-Jul-2021 23:50 by rmk:")

(* ;;; "Read a DCOM file and load its contents into the INIT.")

(* ;;; 
"FILESET can be one of a number, which is a LISPSET number, or a list of file names, or a file name")

    (COND
       [(NUMBERP FILESET)                                    (* ; 
                            "We were given a nLISPSET number.  Pack it up to get the list of files")
        (MKI.PASSFILE (EVALV (PACK* FILESET 'LISPSET]
       ((LISTP FILESET)                                      (* ; 
                                                           "We were given a list of file names")
        (MAPC FILESET (FUNCTION MKI.PASSFILE)))
       (T                                                    (* ; "It's a file name.  Read it in.")
          (INPUT (SETQ FILESET (OPENSTREAM (OR (FINDFILE (PACKFILENAME.STRING 'BODY FILESET
                                                                'EXTENSION REMOTECOMPILE.EXT)
                                                      T)
                                               FILESET)
                                      'INPUT
                                      'OLD 8 MKI.SEQUENTIAL)))
          [MKI.ADDTO 'LOADEDFILELST (LIST (SETQ FILESET (FULLNAME FILESET]
          (PRINT FILESET T T)
          (LET* ((FILEROOT (NAMEFIELD FILESET))
                 [COMSNAMES (LIST (PACK* FILEROOT 'COMS]
                 SKIPVARS MEXPRS X)
                (DECLARE (SPECVARS COMSNAMES SKIPVARS MEXPRS))
                                                             (* ; " used by I.RPAQQ and DOFORM")

(* ;;; "Loop here reading from the dcom file into the init.  ")

                (* ;; "RMK:  Pick off the DEFINE-FILE-INFO first, so we can read the rest of the file.  This is done locally, not in the DOFORM.  The rest of the file is run in the external format that the reader returns.")

                (WITH-READER-ENVIRONMENT (READ-READER-ENVIRONMENT (INPUT)
                                                *OLD-INTERLISP-READ-ENVIRONMENT*)
                    [until (SELECTQ (SETQ X (READ))
                                   ((STOP NIL)               (* ; "End of file")
                                        T)
                                   NIL) do (COND
                                                  ((NLISTP X)

                                               (* ;; "Start of a code object.  Skip the code indicator (assume it says to read with DCODERD) and read the code")

                                                   (IF (NOT (LITATOM (READ)))
                                                       THEN (ERROR "Bad compiled function" X))
                                                   (I.DCODERD X))
                                                  (T         (* ; 
             "It's a form.  go either do it now or add it to the forms to execute inside the init.")
                                                     (DOFORM X)))
                       finally (COND
                                      ((CAR MEXPRS)          (* ; 
                   "There are expressions to be executed in the INIT when it comes up.  Save them.")
                                       (MKI.ADDTO (SETQ FILESET (PACK* FILEROOT ".EXPRESSIONS"))
                                              (CAR MEXPRS))
                                       (MKI.ADDTO 'BOOTFILES (LIST FILESET])
                (CLOSEF (INPUT])

(SCRATCHARRAY
(LAMBDA (NBYTES ALIGN) (* ; "Edited 30-Mar-87 16:20 by bvm:") (COND ((OR (NULL MKI.ARRAY) (IGREATERP NBYTES (ARRAYSIZE MKI.ARRAY))) (* ;; "make sure the scratch array is big enough.  Note that the scratch array is unboxed, not code, since we aren't going to be storing legitimate local code in it (let's not fool the garbage collector too much).") (SETQ MKI.ARRAY (create ARRAYP TYP _ \ST.BYTE BASE _ (\ALLOCBLOCK (FOLDHI NBYTES BYTESPERCELL) UNBOXEDBLOCK.GCT 0 CELLSPERQUAD) LENGTH _ NBYTES ORIG _ 0)))) (for I from 0 to (SUB1 (UNFOLD ALIGN BYTESPERCELL)) do (\BYTESETA MKI.ARRAY I 0)) (* ; "clear the fnheader area") MKI.ARRAY)
)

(DOFORM
(LAMBDA (X NOPROP) (* bvm%: "30-Aug-86 15:36") (* ;;; "Handle a raw form found in a dcom file that's going into a makeinit.") (LET ((FN (GETPROP (CAR X) (QUOTE MKI)))) (if (AND FN (NOT NOPROP)) then (* ; "it's a local command that can be run `renamed' .  Execute it in the local context.") (* ASSERT%: (CALLS I.ADDTOVAR I.DECLARE%: I.DEFINE-FILE-INFO I.DEFLIST I.FILECREATED I.PRETTYDEFMACROS I.PUTPROPS I.RPAQ I.RPAQQ I.SETHASHQ)) (APPLY* FN X) else (* ;; "it's a command that has to be done remotely, since we don't know how to do it from here.  Add it to the collection of init expressions.") (COND (PRINTEXPRS (PRINT X T T))) (SETQ MEXPRS (TCONC MEXPRS X)))))
)

(CONSTFORMP
(LAMBDA (X) (* lmm " 7-MAR-80 08:54") (COND ((LISTP X) (SELECTQ (CAR X) ((QUOTE FUNCTION) X) NIL)) ((LITATOM X) (SELECTQ X (NIL (QUOTE (QUOTE NIL))) (T T) (AND (SETQ X (GETHASH X MKI.TVHA)) (KWOTE (CDR X))))) (T X)))
)

(NOTICECOMS
(LAMBDA (VAL) (* lmm "10-Mar-85 14:51") (for X in VAL when (LISTP X) do (COND ((AND (EQ (CADR X) (QUOTE *)) (LITATOM (CADDR X))) (COND ((EQ (CAR X) (QUOTE COMS)) (push COMSNAMES (CADDR X))) (T (push SKIPVARS (CADDR X))))) (T (SELECTQ (CAR X) ((COMS DECLARE%:) (NOTICECOMS (CDR X))) NIL)))))
)

(EVALFORMAKEINIT
(LAMBDA (FORM) (* bvm%: " 2-NOV-83 15:22") (COND ((LISTP FORM) (SELECTQ (CAR FORM) (MKATOM (COND ((STRINGP (CADR FORM)) (MKATOM (CADR FORM))) (T (HELP)))) (HELP))) ((FIXP FORM) FORM) (T (HELP))))
)
)
(DEFINEQ

(I.ADDTOVAR
(LAMBDA (FORM) (* lmm " 2-DEC-81 23:58") (MKI.ADDTO (CADR FORM) (CDDR FORM))))

(I.DECLARE%:
(LAMBDA (FORM) (* lmm "18-FEB-80 14:04") (PROG ((L FORM) (FLAG T) X FN) LP (COND ((NULL (SETQ L (CDR L))) (RETURN)) ((NLISTP (SETQ X (CAR L))) (SELECTQ X ((EVAL@LOAD DOEVAL@LOAD) (SETQ FLAG T)) (DONTEVAL@LOAD (SETQ FLAG NIL)) NIL)) (T (DOFORM X))) (GO LP)))
)

(I.DEFINE-FILE-INFO
(LAMBDA (FORM) (* bvm%: "30-Aug-86 15:32") (* ;;; "Set reader environment for reading rest of file") (SET-READER-ENVIRONMENT (\DO-DEFINE-FILE-INFO NIL (CDR FORM))))
)

(I.FILECREATED
(LAMBDA (X) (* ; "Edited 12-Jan-88 11:00 by bvm") (* ;; "Form is (FILECREATED date filename . otherstuff)") (COND ((NLISTP (CADDR X)) (* ; "FILENAME a list is for the %"compiled on%" expression") (LET ((NAME (NAMEFIELD (CADDR X)))) (MKI.ADDTO (QUOTE BOOTLOADEDFILES) (LIST NAME)) (MKI.PUTPROP NAME (QUOTE FILEDATES) (LIST (CONS (CADR X) (CADDR X))))))))
)

(I.PUTPROPS
(LAMBDA (FORM) (* lpd%: "29-APR-77 13:22") (MKI.PUTPROP (CADR FORM) (CADDR FORM) (CADDDR FORM))))

(I.RPAQ
(LAMBDA (FORM) (* edited%: "10-Jul-84 14:05") (PROG ((VAL (CADDR FORM)) V) (COND ((SETQ V (CONSTFORMP VAL)) (MKI.DSET (CADR FORM) (EVAL V))) (T (DOFORM (LIST (QUOTE SETTOPVAL) (KWOTE (CADR FORM)) VAL) T)))))
)

(I.RPAQQ
(LAMBDA (FORM) (* lmm "30-APR-80 22:12") (PROG ((ATM (CADR FORM)) (VAL (CADDR FORM))) (COND ((FMEMB ATM COMSNAMES) (NOTICECOMS VAL)) ((FMEMB ATM SKIPVARS)) (T (MKI.DSET ATM VAL)))))
)

(I.RPAQ?
(LAMBDA (FORM) (* lmm " 7-MAR-80 08:36") (PROG ((VAL (CADDR FORM)) V) (COND ((SETQ V (CONSTFORMP VAL)) (MKI.DSET (CADR FORM) (EVAL V))) (T (DOFORM (LIST (QUOTE SETTOPVAL) (KWOTE (CADR FORM)) VAL))))))
)

(I.SETTOPVAL
(LAMBDA (FORM) (* edited%: "10-Jul-84 14:07") (PROG (V) (if (AND (EQ (CAR (LISTP (CADR FORM))) (QUOTE QUOTE)) (SETQ V (CONSTFORMP (CADDR FORM)))) then (MKI.DSET (CADR (CADR FORM)) (EVAL V)) else (DOFORM FORM T))))
)

(I.NOUNDO
(LAMBDA (FORM) (* edited%: "10-Jul-84 14:02") (if (EQ (NTHCHAR (CAR FORM) 1) (QUOTE /)) then (DOFORM (CONS (SUBATOM (CAR FORM) 2 -1) (CDR FORM))) else (SHOULDNT)))
)
)

(PUTPROPS ADDTOVAR MKI I.ADDTOVAR)

(PUTPROPS DECLARE%: MKI I.DECLARE%:)

(PUTPROPS DEFINE-FILE-INFO MKI I.DEFINE-FILE-INFO)

(PUTPROPS FILECREATED MKI I.FILECREATED)

(PUTPROPS PUTPROPS MKI I.PUTPROPS)

(PUTPROPS RPAQ MKI I.RPAQ)

(PUTPROPS RPAQ? MKI I.RPAQ?)

(PUTPROPS RPAQQ MKI I.RPAQQ)

(PUTPROPS LISPXPRINT MKI NILL)

(PUTPROPS PRETTYCOMPRINT MKI NILL)

(PUTPROPS * MKI NILL)

(PUTPROPS SETTOPVAL MKI I.SETTOPVAL)

(PUTPROPS SETQQ MKI I.RPAQQ)

(PUTPROPS SETQ MKI I.RPAQ)

(PUTPROPS /SETTOPVAL MKI I.NOUNDO)
(DEFINEQ

(I.ATOMNUMBER
  [LAMBDA (A)                                 (* ; 
                                                "Edited 27-Oct-92 14:10 by sybalsky:mv:envos")

    (* ;; "Given a symbol, return the symbol's atom #, in the INIT being made.")

    (* ;; 
"NB that this will work only so long as there are no NEW-SYMBOLs in the INIT, because of the LOLOC.")

    (I.LOLOC (COND
                ((LITATOM A)
                 (MKI.ATOM A))
                (T A])

(I.\ATOMCELL
  [LAMBDA (X N)                               (* ; 
                                                "Edited 26-Oct-92 14:24 by sybalsky:mv:envos")
    (LET ((ATOMNO (I.ATOMNUMBER X)))
         (COND
            (NIL 
                 (* ;; "THIS WAS THE PRE-BIGVM CODE:")

                 (LET [(LOC (SELECTC N
                                (10 (I.ATOMNUMBER X))
                                (12 (I.ATOMNUMBER X))
                                (2 (I.ATOMNUMBER X))
                                (8 (I.ATOMNUMBER X))
                                (SHOULDNT]
                      (I.ADDBASE (I.VAG2 N LOC)
                             LOC)))
            [(EQ (LRSH ATOMNO 16)
                 0)                                          (* ; "Xerox Lisp traditional symbol")

             (* ;; 
           "CHANGED 1/30/98 JDS TO VAG2 44... FROM VAG2 8.. BECAUSE ATOMS MOVED (PNPSPACE SHOLE G")

             (LET [(LOC (SELECTC N
                            (10 4)
                            (12 2)
                            (2 6)
                            (8 0)
                            (SHOULDNT]
                  (I.ADDBASE (I.VAG2 \ATOM.HI 0)
                         (IPLUS LOC (ITIMES 10 ATOMNO]
            (T                                               (* ; 
                                       "New symbol that appears after traditional symbol runs out.")
               (LET [(OFFSET (SELECTC N
                                 (10 4)
                                 (12 2)
                                 (2 6)
                                 (8 0)
                                 (SHOULDNT]
                    (I.ADDBASE ATOMNO OFFSET])

(I.FIXUPNUM
  [LAMBDA (CA BN NUM MASK)                                   (* ; "Edited 11-Jul-2022 20:00 by rmk")
                                                             (* ; "Edited 17-Jul-90 14:28 by jds")

    (* ;; "Perform atom-number fixup for a code block.")

    (COND
       ((FMEMB :3-BYTE COMPILER::*TARGET-ARCHITECTURE*)

        (* ;; "If it's on a machine wiht 3 byte atom numbers, treat it as a pointer.")

        (I.FIXUPPTR CA BN NUM))
       (T 
          (* ;; "Otherwise, fill in the two bytes.")

          (\BYTESETA CA (SUB1 BN)
                 (LOGOR (LOGAND (\BYTELT CA (SUB1 BN))
                               (LRSH (LOGXOR MASK 65535)
                                     8))
                        (LOGAND (LRSH (LOGAND NUM MASK)
                                      8)
                               255)))
          (\BYTESETA CA BN (LOGAND NUM 255])

(I.FIXUPPTR
  [LAMBDA (CA BN PTR)                                    (* ; "Edited 22-Jul-90 12:10 by jds")

    (* ;; "Specific for MAXC --- actual ptr is same as simulated ptr")

    (PROG ((LOLOC (I.LOLOC PTR)))
          (\BYTESETA CA (SUB1 BN)
                 (LRSH LOLOC 8))
          (\BYTESETA CA BN (LOGAND LOLOC 255))
          (\BYTESETA CA (IDIFFERENCE BN 2)
                 (LOGOR (\BYTELT CA (IDIFFERENCE BN 2))
                        (I.HILOC PTR])

(I.FIXUPSYM
  [LAMBDA (CA BN NUM MASK)                                   (* ; "Edited 11-Jul-2022 20:00 by rmk")
                                                             (* ; "Edited 23-Jan-91 19:04 by jds")

    (* ;; "Perform SYMBOL fixup for a code block.")

    (COND
       ((FMEMB :3-BYTE COMPILER::*TARGET-ARCHITECTURE*)

        (* ;; "If it's on a machine wiht 3 byte atom numbers, treat it as a pointer.")

        (I.FIXUPPTR CA BN (I.ATOMNUMBER NUM)))
       (T 
          (* ;; "Otherwise, fill in the two bytes.")

          (\BYTESETA CA (SUB1 BN)
                 (LOGOR (LOGAND (\BYTELT CA (SUB1 BN))
                               (LRSH (LOGXOR MASK 65535)
                                     8))
                        (LOGAND (LRSH (LOGAND (I.ATOMNUMBER NUM)
                                             MASK)
                                      8)
                               255)))
          (\BYTESETA CA BN (LOGAND (I.ATOMNUMBER NUM)
                                  255])

(I.WORDSPERNAMEENTRY
  [LAMBDA NIL                                            (* ; "Edited 25-Jan-91 15:35 by jds")

    (* ;; "For MAKEINIT, returns the number of words in a name-table entry.")

    (* ;; "For the old 2-byte atom case, it's 1 word; for 3-byte atoms, 2 words.")

    (* ;; "An %"Entry%" means an entry in each half of the name table (symbol & type/offset).")

    (* ;; "While we're building the INIT, react to either :3-BYTE or :3-BYTE-INIT in the target architecture -- we're automatically CROSSCOMPILING as far as this function is concerned.")

    (COND
       ((FMEMB :3-BYTE COMPILER::*TARGET-ARCHITECTURE*)
        2)
       ((FMEMB :3-BYTE-INIT COMPILER::*TARGET-ARCHITECTURE*)
        2)
       (T 1])

(I.SETSTKNTOFFSET
  [LAMBDA (BASE OFFSET TYPE VAL)                         (* ; "Edited 25-Jan-91 16:00 by jds")

    (* ;; "FOR MAKEINIT:  Set the offset entry for a name-table entry, from the symbol to fill in plus the variable-type marker value SHIFTED LEFT 14 BITS ALREADY.")

    (COND
       ((FMEMB :3-BYTE COMPILER::*TARGET-ARCHITECTURE*)
        (I.FIXUPNUM BASE (IDIFFERENCE OFFSET BYTESPERWORD)
               TYPE)
        (I.FIXUPNUM BASE OFFSET VAL))
       ((FMEMB :3-BYTE-INIT COMPILER::*TARGET-ARCHITECTURE*)
        (I.FIXUPNUM BASE (IDIFFERENCE OFFSET BYTESPERWORD)
               TYPE)
        (I.FIXUPNUM BASE OFFSET VAL))
       (T (I.FIXUPNUM BASE OFFSET (IPLUS TYPE VAL])
)



(* ; "stuff for MAXC")

(DEFINEQ

(MKI.ATOM
(LAMBDA (X) (* lmm "29-JUL-81 22:46") (* ; "for MAXC") (AND X (OR (GETHASH X MKI.ATOMARRAY) (PUTHASH X (COND ((EQ X (QUOTE NOBIND)) PTRNOBIND) (T (I.COPYATOM X))) MKI.ATOMARRAY))))
)

(MKI.IEEE
(LAMBDA (X BOX) (* bvm%: "16-Dec-80 00:44") (* ;; "Converts pdp-10 floating-point number X to IEEE standard for Dolphin, storing (with I.PUTBASE) into BOX.  For MAXC only.") (PROG (MAGNITUDE (SIGN 0) (EXP 0) (FRAC 0)) RETRY (SETQ MAGNITUDE (COND ((MINUSP X) (SETQ SIGN 32768) (IMINUS (OPENR (LOC X)))) (T (OPENR (LOC X))))) (COND ((ZEROP MAGNITUDE) (GO DONE)) ((IEQP (LOGAND MAGNITUDE 67108864) 0) (* ; "unnormalized number???") (SETQ X (FPLUS X 0.0)) (GO RETRY))) (COND ((ILEQ (SETQ EXP (IDIFFERENCE (LRSH MAGNITUDE 27) 2)) 0) (* ;; "Exponent bias is off by 1, plus another 1 because of the implicit high bit.  Thus have to watch for underflow") (ERROR "Unrepresentable floating-point number" X) (SETQ EXP (SETQ SIGN 0)) (* ; "If continued, make it zero") (GO DONE))) (SETQ FRAC (IPLUS (LOGAND (LRSH MAGNITUDE 3) 16777215) (COND ((OR (ILESSP (LOGAND MAGNITUDE 7) 4) (EQ (LOGAND MAGNITUDE 15) 4)) (* ; "Round down") 0) (T 1)))) (COND ((IGREATERP FRAC 16777215) (* ; "Rounding overflowed the high bit") (SETQ FRAC (LRSH FRAC 1)) (* ; "EXP can't overflow, because of bias difference") (SETQ EXP (ADD1 EXP)))) (* ; "FRAC is now a 24-bit fraction with its high bit on") DONE (I.PUTBASE BOX 0 (LOGOR SIGN (LLSH EXP 7) (LOGAND (LRSH FRAC 16) 127))) (I.PUTBASE BOX 1 (LOGAND FRAC 65535))))
)
)



(* ; "stuff to maintain symbol values, prop lists during makeinit--all dumped at end.")

(DEFINEQ

(MKI.DSET
(LAMBDA (A VAL) (* ; "Edited 12-Jan-88 11:03 by bvm") (LET ((LST (GETHASH A MKI.TVHA))) (COND (LST (COND ((NOT (EQUAL VAL (CDR LST))) (EXEC-FORMAT "(Value of ~S changed from ~S to ~S)~%%" A (CDR LST) VAL))) (RPLACD LST VAL)) (T (PUTHASH A (CONS NIL VAL) MKI.TVHA)))))
)

(MKI.ADDTO
(LAMBDA (A VAL) (* lpd%: "29-APR-77 13:20") (PROG ((LST (GETHASH A MKI.TVHA))) (COND (LST (RPLACD LST (UNION VAL (CDR LST)))) (T (PUTHASH A (CONS NIL VAL) MKI.TVHA)))))
)

(MKI.PUTPROP
(LAMBDA (A PROP VAL) (* ; "Edited 12-Jan-88 11:04 by bvm") (LET ((LST (GETHASH A MKI.PLHA))) (COND (LST (COND ((LISTGET LST PROP) (EXEC-FORMAT "(Property ~S of ~S has been changed)~%%" A PROP))) (LISTPUT LST PROP VAL)) (T (PUTHASH A (LIST PROP VAL) MKI.PLHA)))))
)
)

(RPAQQ MKI.ARRAY NIL)

(RPAQ MKI.TVHA (HASHARRAY 400))

(RPAQ MKI.PLHA (HASHARRAY 150))

(RPAQ MKI.ATOMARRAY (HASHARRAY 5000))

(RPAQQ INIT.EXT SYSOUT)
(DEFINEQ

(DUMPVP
(LAMBDA (VP) (* lpd%: "27-APR-77 20:24") (PRIN1 (QUOTE *) T) (WriteoutPage OUTX VP)))

(BOUTZEROS
(LAMBDA (N) (* lmm "16-MAY-81 16:49") (FRPTQ N (\BOUT OUTX 0))))

(BIN16
  [LAMBDA (STREAM)                                       (* edited%: " 2-Apr-85 17:11")
    (LOGOR (LLSH (BIN STREAM)
                 8)
           (BIN STREAM])

(BOUT16
  [LAMBDA (STREAM N)                                     (* edited%: " 2-Apr-85 17:11")
    (BOUT STREAM (LRSH N 8))
    (BOUT STREAM (LOGAND N 255))
    N])
)

(RPAQQ MKI.FirstDataByte 1024)

(RPAQQ MKI.Page0Byte 512)

(RPAQ MKI.DATE (DATE))

(RPAQQ MKI.CODESTARTOFFSET 60)

(RPAQQ MKI.SEQUENTIAL ((SEQUENTIAL T)))

(RPAQQ PRINTEXPRS T)

(RPAQ? PRINTEXPRS T)

(RPAQ? REMOTECOMPILE.EXT COMPILE.EXT)
(DECLARE%: EVAL@COMPILE 

(PUTPROPS SETXVAR MACRO [X `(SETQ.NOREF %, (CADAR X)
                                   %,
                                   (CADR X])

(PUTPROPS IEQ MACRO ((X Y)
                     (IEQP X Y)))
DONTCOPY 

(FILESLOAD (LOADCOMP)
       MEM)
)



(* ;; "from DLFIXINIT")




(* ;; 
" This file is all because the dandelion needed its microcode embedded in the init file, and MAIKO wasn't around. So this is all to make room for microcode we don't need. Except something(?) might expect the %"InterfacePage%" as page 2 of the file, so we're leaving it in place now"
)

(DEFINEQ

(DLFIXINIT
  [LAMBDA (SYSOUTFILE DLBOOTFILE)                        (* ; "Edited  7-Feb-2021 13:49 by lmm")
                                                  (* ; 
                                                "Edited  2-Nov-92 08:16 by sybalsky:mv:envos")
    (PROG ((DBPAGES 3)
           (%#UCODEPAGES 3)
           (%#ADDEDFILEPAGES 0)
           %#OLDFILEPAGES %#NEWFILEPAGES %#FPTOVPPAGES DLFILEX)
          (DECLARE (SPECVARS %#UCODEPAGES NEWFPFROMOLD DBPAGES %#NEWFILEPAGES %#OLDFILEPAGES 
                              %#ADDEDFILEPAGES %#FPTOVPPAGES DLFILEX))
          (READSYS SYSOUTFILE)
          (SETQ %#OLDFILEPAGES (FOLDHI (GETFILEINFO VMEMFILE 'LENGTH)
                                      BYTESPERPAGE))
          (DLCOPYPAGEMAP)
          (SETQ NEWFPFROMOLD (ARRAY %#OLDFILEPAGES 'WORD \NO.PAGE.ASSIGNED 1))
          (DLSORTSYSOUTPAGES)
          (DLDUMPSYSOUT)
          (READSYS)
          (RETURN DLBOOTFILE])

(DLSORTSYSOUTPAGES
  [LAMBDA NIL                                 (* ; 
                                                "Edited  4-Nov-92 15:47 by sybalsky:mv:envos")
    (DECLARE (USEDFREE FPSIZE NEWFPFROMOLD FPTOVPSIZE FPTOVP PGTAB %#FPTOVPPAGES)
           (SPECVARS LASTFP))
    (PROG (LASTFP)
          (ASSIGNFILEPAGE \FP.IFPAGE \VP.IFPAGE (SUB1 \FP.IFPAGE)
                 T)                                          (* ; 
                                        "SUB1 because old FP's are zero-based! See VMEM structures")
          (ASSIGNFILEPAGERANGE \VP.DISPLAY \NP.DISPLAY (DLFPFROMRP \RP.TEMPDISPLAY))
          (ASSIGNFILEPAGERANGE \VP.STACK PAGESPERSEGMENT (DLFPFROMRP \RP.STACK)
                 T)
          (ASSIGNFILEPAGERANGE \VP.TYPETABLE \NP.TYPETABLE (DLFPFROMRP \RP.TYPETABLE))
          (ASSIGNFILEPAGERANGE \VP.GCTABLE \NP.GCTABLE (DLFPFROMRP \RP.GCTABLE))
          (ASSIGNFILEPAGERANGE \VP.GCOVERFLOW \NP.GCOVERFLOW (DLFPFROMRP \RP.GCOVERFLOW))
          (ASSIGNFILEPAGERANGE \VP.FPTOVP %#FPTOVPPAGES (DLFPFROMRP \RP.FPTOVP))
          (replace (IFPAGE FPTOVPStart) of DLIFPAGE with (DLFPFROMRP \RP.FPTOVP))
          (replace (IFPAGE LastDominoFilePage) of DLIFPAGE with (SETQ DLLASTDOMINOPAGE 
                                                                             %#UCODEPAGES))
          [SETQ LASTFP (SUB1 (SETQ DLPAGEMAPFP (DLFPFROMRP \RP.MISCLOCKED]

     (* ;; "Assign next the pagemap pages, since we have to know where they live (some are new) and it is very convenient for them to be contiguous")

          (for J from 0 to (SUB1 \NumPMTpages) do (ASSIGNFILEPAGE (DLNEXTFP)
                                                                         (IPLUS J \VP.PRIMARYMAP)
                                                                         NIL T))
          (replace (IFPAGE filePnPMT0) of DLIFPAGE with DLPAGEMAPFP)
          (replace (IFPAGE filePnPMP0) of DLIFPAGE with (IPLUS DLPAGEMAPFP \NumPMTpages))

     (* ;; "NO LONGER -- 5,,0 TAKEN FOR FPTOVP IN MEDLEY 2.1 -- but we need the decondary page table up thru building things, so assign it:")

          (for J from 0 to (SUB1 (FOLDHI DLNEXTPM WORDSPERPAGE))
             do (ASSIGNFILEPAGE (DLNEXTFP)
                           (IPLUS J \VP.SECONDARYMAP)
                           NIL T))

     (* ;; "Similarly, assign locked page table, which is another structure we rewrite")

          (for J from 0 to (SUB1 \NumLPTPages) do (ASSIGNFILEPAGE (DLNEXTFP)
                                                                         (IPLUS J \VP.LPT)
                                                                         NIL T))

     (* ;; "Finally, assign file pages for everyone we haven't taken care of yet.  First the locked pages, which have to be at the front of the sysout, after the fixed assignments we have already made")

          [for IFLOCKED in '(T NIL)
             do (for VPSEG from 0 to \MAXVMSEGMENT bind PGTAB2
                       when (NEQ (SETQ PGTAB2 (FASTELT PGTAB VPSEG))
                                     PGEMPTY)
                       do (for I from 0 to (SUB1 PAGESPERSEGMENT)
                                 bind (VPBASE _ (UNFOLD VPSEG PAGESPERSEGMENT))
                                       OLDFP when (AND [NOT (ZEROP (SETQ OLDFP (FASTELTN PGTAB2 I
                                                                                          ]
                                                           (EQ (DLLOCKEDPAGEP (IPLUS VPBASE I))
                                                               IFLOCKED)
                                                           (EQ (FASTELTN NEWFPFROMOLD OLDFP)
                                                               \NO.PAGE.ASSIGNED))
                                 do (ASSIGNFILEPAGE (DLNEXTFP)
                                               (IPLUS VPBASE I)
                                               OLDFP IFLOCKED)))
                   (COND
                      (IFLOCKED (replace (IFPAGE LastLockedFilePage) of DLIFPAGE with
                                                                                         LASTFP)
                             (SETQ LASTFP DLLASTDOMINOPAGE]
          (replace (IFPAGE NDirtyPages) of DLIFPAGE with (replace (IFPAGE 
                                                                                         NActivePages
                                                                                         )
                                                                        of DLIFPAGE with
                                                                                        
                                                                                       %#NEWFILEPAGES
                                                                            ])

(DLNEXTFP
  [LAMBDA NIL                                 (* ; 
                                                "Edited  2-Nov-92 12:29 by sybalsky:mv:envos")
    (do (add LASTFP 1) repeatuntil (EQ (FASTELTN FPTOVP (LLSH LASTFP 1))
                                                   \NO.VMEM.PAGE))
    LASTFP])

(DLLOCKEDPAGEP
  [LAMBDA (VP)                                           (* bvm%: " 6-Dec-84 22:25")
    (NEQ 0 (LOGAND (.LOCKEDVPMASK. VP)
                  (FASTELTN DLLOCKBITS (FOLDLO VP BITSPERWORD])

(DLSETLOCKBIT
  [LAMBDA (VP)                                           (* bvm%: " 6-Dec-84 22:26")
    (FASTSETAN DLLOCKBITS (FOLDLO VP BITSPERWORD)
           (LOGOR (.LOCKEDVPMASK. VP)
                  (FASTELTN DLLOCKBITS (FOLDLO VP BITSPERWORD])

(DLCOPYPAGEMAP
  [LAMBDA NIL                                 (* ; 
                                                "Edited  3-Nov-92 15:46 by sybalsky:mv:envos")
    (PROG NIL
          [SETQ DLIFPAGE (DLCOPYVMPAGE \VP.IFPAGE (NCREATE 'VMEMPAGEP]
                                                             (* ; "Install interface page by magic")
          (SETQ DLPRIMARYMAP (ARRAY (UNFOLD \NumPMTpages WORDSPERPAGE)
                                    'WORD 0 0))              (* ; "Primary map table")
          [for J from 0 to (SUB1 \NumPMTpages)
             do (DLCOPYVMPAGE (IPLUS J \VP.PRIMARYMAP)
                           (\ADDBASE (fetch (ARRAYP BASE) of DLPRIMARYMAP)
                                  (UNFOLD J WORDSPERPAGE]
          (SETQ DLNEXTPM (fetch (IFPAGE NxtPMAddr) of DLIFPAGE))
                                                             (* ; 
                                                           "First free offset in secondary map")
          (DLADDPAGEMAPENTRIES \VP.FPTOVP \NP.FPTOVP)
          (COND
             ((NOT (VMPAGEP \VP.DISPLAY))
              (DLADDPAGEMAPENTRIES \VP.DISPLAY \NP.DISPLAY)
              (add %#ADDEDFILEPAGES \NP.DISPLAY)))
          (SETQ %#NEWFILEPAGES (IPLUS (SUB1 %#OLDFILEPAGES)
                                      (SUB1 %#UCODEPAGES)))

     (* ;; "Used to use WORDSPERPAGE, until an FPTOVP entry went from word to cell 11/3/92 JDS:")

          (SETQ %#FPTOVPPAGES (ADD1 (FOLDHI (IPLUS %#NEWFILEPAGES %#ADDEDFILEPAGES)
                                           CELLSPERPAGE)))

     (* ;; "Number of pages of FPTOVP needed -- cover everything in sysout, plus one more possibly needed to cover FPTOVP itself")

          (add %#ADDEDFILEPAGES %#FPTOVPPAGES)
          (add %#NEWFILEPAGES %#ADDEDFILEPAGES)

     (* ;; 
"Make FPTOVP big enough to hold #NEWPAGES, plus a couple of entries as slop, to prevent off-by-1's.")

          (SETQ FPTOVP (ARRAY (+ 16384 (LLSH %#NEWFILEPAGES 1))
                              'WORD \NO.VMEM.PAGE 1))
          (SETQ DLSECONDARYMAP (ARRAY (CEIL DLNEXTPM WORDSPERPAGE)
                                      'WORD 0 0))

     (* ;; "Allocate enough space to accomodate existing secondary map plus anything we added.  Round up to a page boundary")

          (replace (IFPAGE NxtPMAddr) of DLIFPAGE with DLNEXTPM)
                                                             (* ; 
                                        "Store back new DLNEXTPM as updated by DLADDPAGEMAPENTRIES")
          (SETQ DLLOCKBITS (ARRAY (UNFOLD \NumLPTPages WORDSPERPAGE)
                                  'WORD 0 0))                (* ; "Read the locked page table")
          (for J from 0 to (SUB1 \NumLPTPages)
             do (DLCOPYVMPAGE (IPLUS J \VP.LPT)
                           (\ADDBASE (fetch (ARRAYP BASE) of DLLOCKBITS)
                                  (UNFOLD J WORDSPERPAGE])

(DLCOPYVMPAGE
  [LAMBDA (VP BASE)                                      (* bvm%: "14-Dec-84 12:46")
                                                             (* Reads page VP from VMEMFILE into 
                                                           BASE, returning BASE)
    (SETVMPTR (UNFOLD VP WORDSPERPAGE))
    (\BINS VMEMFILEX BASE 0 BYTESPERPAGE)
    BASE])

(DLADDPAGEMAPENTRIES
  [LAMBDA (VP NPAGES)                                    (* bvm%: "27-MAR-83 17:53")
    (to NPAGES do [COND
                             ((IEQ (FASTELTN DLPRIMARYMAP (fetch (VP PRIMARYKEY) of VP))
                                   \EmptyPMTEntry)
                              (COND
                                 ((EVENP DLNEXTPM WORDSPERPAGE)
                                                             (* must add a new page map page)
                                  (add %#ADDEDFILEPAGES 1)))
                              (FASTSETAN DLPRIMARYMAP (fetch (VP PRIMARYKEY) of VP)
                                     DLNEXTPM)
                              (SETQ DLNEXTPM (IPLUS DLNEXTPM \PMblockSize]
                         (add VP 1])

(ASSIGNFILEPAGE
  [LAMBDA (FP VP OLDFP LOCKED)                (* ; 
                                                "Edited  9-Nov-92 14:54 by sybalsky:mv:envos")

    (* ;; "Assign VP to live in FP (and hence a related real page);  OLDFP is where VP lives in the old sysout")

    (COND
       ([NOT (ZEROP (OR OLDFP (SETQ OLDFP (LOGAND (FASTELTN (FASTELT PGTAB (LRSH VP 8))
                                                         (LOGAND VP 255))
                                                 32767]
        (FASTSETAN NEWFPFROMOLD OLDFP FP)))
    (FASTSETAN FPTOVP (ADD1 (LLSH FP 1))
           VP)
    (FASTSETAN FPTOVP (LLSH FP 1)
           0)
    (PROG [(SECONDARY (FASTELTN DLPRIMARYMAP (fetch (VP PRIMARYKEY) of VP]
                                                             (* ; 
                                                           "Update pagemap to point to the new FP")
          (COND
             ((IEQ SECONDARY \EmptyPMTEntry)
              (HELP VP "has no primary map entry"))
             (T (FASTSETAN DLSECONDARYMAP (IPLUS SECONDARY (fetch (VP SECONDARYKEY) of VP))
                       FP)))
          (COND
             (LOCKED (DLSETLOCKBIT VP])

(ASSIGNFILEPAGERANGE
  [LAMBDA (VPSTART NPAGES FPSTART ONLYIFTHERE)           (* bvm%: "25-MAR-83 12:44")
    (for I from 0 to (SUB1 NPAGES) unless [AND ONLYIFTHERE
                                                               (NOT (VMPAGEP (IPLUS VPSTART I]
       do (ASSIGNFILEPAGE (IPLUS FPSTART I)
                     (IPLUS VPSTART I)
                     NIL T])

(DLDUMPSYSOUT
  [LAMBDA NIL                                          (* ; "Edited  7-Feb-2021 20:46 by larry")
                                                             (* ; "Edited  7-Feb-2021 14:28 by lmm")
                                                  (* ; 
                                                "Edited  3-Nov-92 10:50 by sybalsky:mv:envos")
    (PROG [(DLPAGEOFZEROS (NCREATE 'VMEMPAGEP]
          [SETQ DLFILEX (OPENSTREAM DLBOOTFILE 'OUTPUT 'NEW 8 (CONS (LIST 'LENGTH (UNFOLD 
                                                                                       %#NEWFILEPAGES
                                                                                         BYTESPERPAGE
                                                                                         ))
                                                                    '((SEQUENTIAL T)
                                                                      (TYPE BINARY]
          (SETQ DLBOOTFILE (FULLNAME DLFILEX))
          (PROGN (\BOUTS DLFILEX DLPAGEOFZEROS 0 BYTESPERPAGE)
                 (\BOUTS DLFILEX DLIFPAGE 0 BYTESPERPAGE)
                 (\BOUTS DLFILEX DLPAGEOFZEROS 0 BYTESPERPAGE))
          (DLDUMPVMEMPAGES (ADD1 DLLASTDOMINOPAGE)
                 (SUB1 (DLFPFROMRP \RP.FPTOVP)))
          (DLDUMPFPTOVP)
          (DLDUMPVMEMPAGES (IPLUS (DLFPFROMRP \RP.FPTOVP)
                                      %#FPTOVPPAGES)
                 (SUB1 DLPAGEMAPFP))
          (DLDUMPPAGEMAPS)
          (DLDUMPVMEMPAGES (IPLUS DLPAGEMAPFP \NumPMTpages (FOLDHI DLNEXTPM WORDSPERPAGE)
                                      \NumLPTPages)
                 %#NEWFILEPAGES)
          (CLOSEF DLFILEX])

(DLDUMPFPTOVP
  [LAMBDA NIL                                 (* ; 
                                                "Edited  4-Nov-92 13:56 by sybalsky:mv:envos")
    (printout T "[FPTOVP]")

    (* ;; "Filepages are one-based, but FPTOVP in the sysout is zero-based for convenience.  Hence, first entry (page zero) is dummy")

    (\WOUT DLFILEX \NO.VMEM.PAGE)

    (* ;; "With BIG VM, each FPTOVP entry is 2 words, and word 1 (the 1st element of the array) is actually part of the entry for page 0 (which we dumped the other half above).  So we need to dump 2*#pages + 1 elements of the array:")

    (DLDUMPARRAY FPTOVP (ADD1 (LLSH %#NEWFILEPAGES 1)))
    (RPTQ (IDIFFERENCE (UNFOLD %#FPTOVPPAGES WORDSPERPAGE)
                 (LLSH (ADD1 %#NEWFILEPAGES)
                       1))
          (\WOUT DLFILEX \NO.VMEM.PAGE))                     (* ; "Fill out rest of FPTOVP with no such page.  Fill from #pages*2 (it's cells now, not words per FPTOVP entry), out to the end of the FPTOVP pages.")
    NIL])

(DLDUMPPAGEMAPS
  [LAMBDA NIL                                 (* ; 
                                                "Edited  3-Nov-92 10:47 by sybalsky:mv:envos")
    (printout T "[PageMaps]")
    (DLDUMPARRAY DLPRIMARYMAP (UNFOLD \NumPMTpages WORDSPERPAGE))
                                                             (* ; "Dump primary map")
    (DLDUMPARRAY DLSECONDARYMAP (CEIL DLNEXTPM WORDSPERPAGE))
                                                             (* ; "Dump secondary map")
    (DLDUMPARRAY DLLOCKBITS (UNFOLD \NumLPTPages WORDSPERPAGE))
                                                             (* ; "Dump locked page table")
    NIL])

(DLDUMPVMEMPAGES
  [LAMBDA (FIRSTFP LASTFP)                    (* ; 
                                                "Edited  2-Nov-92 12:30 by sybalsky:mv:envos")
    (for FP from FIRSTFP to LASTFP bind VP
       do (COND
                 ((AND (NEQ [SETQ VP (FASTELTN FPTOVP (ADD1 (LLSH FP 1]
                            \NO.VMEM.PAGE)
                       (VMPAGEP VP))
                  (SETVMPTR (UNFOLD VP WORDSPERPAGE))
                  (COPYBYTES VMEMFILE DLFILEX BYTESPERPAGE)
                  (PRIN1 '* T))
                 (T (\BOUTS DLFILEX DLPAGEOFZEROS 0 BYTESPERPAGE)
                    (PRIN1 'x T])

(DLSETBOOTPTR
  [LAMBDA (FP)                                           (* bvm%: "27-MAR-83 17:39")
    (printout T "[" .P2 FP "]")
    (SETFILEPTR DLFILEX (UNFOLD (SUB1 FP)
                               BYTESPERPAGE])

(DLDUMPARRAY
  [LAMBDA (ARR NWORDS)                        (* ; 
                                                "Edited  3-Nov-92 11:52 by sybalsky:mv:envos")

    (* ;; "Dump NWORDS from array ARR, starting with the first byte in the array's contents.")

    (\BOUTS DLFILEX (fetch (ARRAYP BASE) of ARR)
           0
           (UNFOLD NWORDS BYTESPERWORD])

(DLMARKASDUMPED
  [LAMBDA (FIRSTFP NPAGES)                    (* ; 
                                                "Edited  2-Nov-92 12:30 by sybalsky:mv:envos")
    (for I from FIRSTFP to (IPLUS FIRSTFP NPAGES -1) do (FASTSETAN FPTOVP
                                                                               (LLSH I 1)
                                                                               \NO.VMEM.PAGE])

(DLDUMPVMEMPAGE
  [LAMBDA (NEWFP VP LOCKEDP)                             (* bvm%: "28-MAR-83 12:11")
    (COND
       ((VMPAGEP VP)
        (SETVMPTR (UNFOLD VP WORDSPERPAGE))
        [PROG ((DESTINATIONBYTE (UNFOLD (SUB1 NEWFP)
                                       BYTESPERPAGE)))
              (COND
                 ((NOT (IEQP (\GETFILEPTR DLFILEX)
                             DESTINATIONBYTE))
                  (printout T "[" .P2 NEWFP "]")
                  (SETFILEPTR DLFILEX DESTINATIONBYTE]
        (COPYBYTES VMEMFILE DLFILEX BYTESPERPAGE)
        (PRIN1 (COND
                  (LOCKEDP '$)
                  (T '*))
               T))
       (T (PRIN1 'x T])

(INSTALLDOMINO
  [LAMBDA (DBFILE)                                       (* edited%: "14-APR-83 12:00")
    (DLSETBOOTPTR 1)
    (COPYBYTES DBFILE DLFILEX 0 BYTESPERPAGE)
    (DLSETBOOTPTR (ADD1 \FP.IFPAGE))                     (* Skip over InterfacePage)
    (COPYBYTES DBFILE DLFILEX)                               (* Copy rest of Domino)
    (DLSETBOOTPTR DLLASTDOMINOPAGE)
    (SETFILEPTR DBFILE 0)

         (* Copy first DB page into scratch at end of Domino reserved space so that 
       SYSOUT can get it (Dolphin and Dorado smash first page of vmem))

    (COPYBYTES DBFILE DLFILEX 0 BYTESPERPAGE])

(INSTALLDOMINO.DIRECT
  [LAMBDA (DBFILE)                                       (* bvm%: "29-JUL-83 16:16")
    (PROG [(BUFFER (COND
                      ((IGREATERP \#SWAPBUFFERS 1)
                       (RESETSAVE \EMUSWAPBUFFERS (\ADDBASE \EMUSWAPBUFFERS WORDSPERPAGE))
                       (RESETSAVE \#SWAPBUFFERS (SUB1 \#SWAPBUFFERS))
                       \EMUSWAPBUFFERS)
                      (T (RESETSAVE \EMUDISKBUFFERS (\ADDBASE \EMUDISKBUFFERS WORDSPERPAGE))
                         (RESETSAVE \#DISKBUFFERS (SUB1 \#DISKBUFFERS))
                         \EMUDISKBUFFERS]
          (replace ENDOFSTREAMOP of DBFILE with (FUNCTION ZERO))
          (\BINS DBFILE BUFFER 0 BYTESPERPAGE)
          (COND
             ((EQ \MACHINETYPE \DANDELION)
              (\ACTONVMEMFILE 1 BUFFER 1 T)))
          (\BINS DBFILE BUFFER 0 BYTESPERPAGE)               (* Skip over InterfacePage)
          (for I from (ADD1 \FP.IFPAGE) until (\EOFP DBFILE)
             do (\BINS DBFILE BUFFER 0 BYTESPERPAGE)
                   (\ACTONVMEMFILE I BUFFER 1 T))            (* Copy rest of Domino)
      ])

(INSTALLNEWDOMINO
  [LAMBDA (SYSOUTFILE DBFILE)                            (* bvm%: "29-JUL-83 16:08")
    (RESETLST
        (SETQ DBFILE (GETSTREAM (OPENFILE (OR DBFILE (INFILEP '{DSK}DLISPDOMINO.DB)
                                              '{PHYLUM}<LISPCORE>DLION>BASICS>DLISPDOMINO.DB)
                                       'INPUT)
                            'INPUT))
        (RESETSAVE NIL (LIST 'CLOSEF DBFILE))
        (PROG ((DBPAGES (IPLUS (FOLDHI (GETFILEINFO DBFILE 'LENGTH)
                                      BYTESPERPAGE)
                               2))
               %#UCODEPAGES DLFILEX)
              (DECLARE (SPECVARS DLFILEX))
              [COND
                 [SYSOUTFILE [RESETSAVE NIL (LIST 'CLOSEF (SETQ SYSOUTFILE (OPENFILE SYSOUTFILE
                                                                                  'INPUT]
                        (SETQ %#UCODEPAGES (SETQ DLLASTDOMINOPAGE (fetch (IFPAGE 
                                                                                   LastDominoFilePage
                                                                                    )
                                                                     of (\MAPPAGE 1 (GETSTREAM
                                                                                         SYSOUTFILE]
                 ((ASKUSER NIL NIL (LIST "Shall I install" (fetch FULLFILENAME of DBFILE)
                                         "directly into the vmem file"))
                  (SETQ %#UCODEPAGES (SETQ DLLASTDOMINOPAGE (fetch (IFPAGE LastDominoFilePage)
                                                               of \InterfacePage]
              (COND
                 ((ILESSP %#UCODEPAGES DBPAGES)
                  (RETURN "Not enough space for Domino")))
              (COND
                 (SYSOUTFILE (OPENFILE (CLOSEF SYSOUTFILE)
                                    'BOTH)
                        (SETQ DLFILEX (GETSTREAM SYSOUTFILE))
                        (INSTALLDOMINO DBFILE))
                 (T (INSTALLDOMINO.DIRECT DBFILE)))
              (RETURN SYSOUTFILE)))])
)

(FILESLOAD READSYS)
(DEFINEQ

(DLPRINTFPTOVP
  [LAMBDA (STREAM)                                       (* bvm%: "28-MAR-83 12:42")
    (\PRINTFPTOVP (\ADDBASE (fetch (ARRAYP BASE) of FPTOVP)
                         -1)
           (fetch (IFPAGE NActivePages) of DLIFPAGE)
           STREAM])

(PRINTPRIMARYMAP
  [LAMBDA NIL                                            (* bvm%: "28-MAR-83 23:25")
    (for I from 0 to 63
       do (printout T I ":  " 8)
             [for J from 0 to 7 bind PMPE
                do (COND
                          ((EQ [SETQ PMPE (ELT DLPRIMARYMAP (PLUS J (TIMES I 8]
                               65535)
                           (printout T " -----"))
                          (T (printout T .I6.8 PMPE]
             (TERPRI T) unless (for J from 0 to 7
                                      always (EQ (ELT DLPRIMARYMAP (PLUS J (TIMES I 8)))
                                                     65535])

(DLREADPAGEOFWORDS
  [LAMBDA (STREAM)                                       (* bvm%: "29-MAR-83 00:03")
    (to WORDSPERPAGE collect (\WIN STREAM])

(SETDIF
  [LAMBDA (X Y)                                          (* bvm%: "28-MAR-83 15:28")
    (for EL in X collect EL unless (FMEMB EL Y])
)
(DECLARE%: EVAL@COMPILE 

(RPAQQ \NO.PAGE.ASSIGNED 0)


(CONSTANTS \NO.PAGE.ASSIGNED)
)
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS DLPRIMARYMAP DLSECONDARYMAP DLLOCKBITS DLLASTDOMINOPAGE DLIFPAGE DLNEXTPM DLPAGEMAPFP 
       FPTOVP NEWFPFROMOLD VMEMFILE VMEMFILEX)
)
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (3862 4722 (MAKEINITGREET 3872 . 4720)) (4905 11290 (LOADMAKEINIT 4915 . 6118) (
LOADMKIFILES 6120 . 6435) (RELOAD 6437 . 6920) (MAKEINIT 6922 . 10582) (MKI.START 10584 . 11288)) (
11368 17086 (MKI.PASSFILE 11378 . 14988) (SCRATCHARRAY 14990 . 15639) (DOFORM 15641 . 16318) (
CONSTFORMP 16320 . 16554) (NOTICECOMS 16556 . 16864) (EVALFORMAKEINIT 16866 . 17084)) (17087 19207 (
I.ADDTOVAR 17097 . 17191) (I.DECLARE%: 17193 . 17469) (I.DEFINE-FILE-INFO 17471 . 17661) (
I.FILECREATED 17663 . 18037) (I.PUTPROPS 18039 . 18152) (I.RPAQ 18154 . 18375) (I.RPAQQ 18377 . 18573)
 (I.RPAQ? 18575 . 18790) (I.SETTOPVAL 18792 . 19024) (I.NOUNDO 19026 . 19205)) (19843 26059 (
I.ATOMNUMBER 19853 . 20344) (I.\ATOMCELL 20346 . 22099) (I.FIXUPNUM 22101 . 23026) (I.FIXUPPTR 23028
 . 23509) (I.FIXUPSYM 23511 . 24567) (I.WORDSPERNAMEENTRY 24569 . 25324) (I.SETSTKNTOFFSET 25326 . 
26057)) (26091 27599 (MKI.ATOM 26101 . 26297) (MKI.IEEE 26299 . 27597)) (27696 28461 (MKI.DSET 27706
 . 27989) (MKI.ADDTO 27991 . 28176) (MKI.PUTPROP 28178 . 28459)) (28635 29187 (DUMPVP 28645 . 28742) (
BOUTZEROS 28744 . 28823) (BIN16 28825 . 29006) (BOUT16 29008 . 29185)) (30078 52812 (DLFIXINIT 30088
 . 31063) (DLSORTSYSOUTPAGES 31065 . 36191) (DLNEXTFP 36193 . 36530) (DLLOCKEDPAGEP 36532 . 36746) (
DLSETLOCKBIT 36748 . 37010) (DLCOPYPAGEMAP 37012 . 40063) (DLCOPYVMPAGE 40065 . 40455) (
DLADDPAGEMAPENTRIES 40457 . 41272) (ASSIGNFILEPAGE 41274 . 42507) (ASSIGNFILEPAGERANGE 42509 . 42916) 
(DLDUMPSYSOUT 42918 . 44670) (DLDUMPFPTOVP 44672 . 45711) (DLDUMPPAGEMAPS 45713 . 46413) (
DLDUMPVMEMPAGES 46415 . 47071) (DLSETBOOTPTR 47073 . 47303) (DLDUMPARRAY 47305 . 47692) (
DLMARKASDUMPED 47694 . 48147) (DLDUMPVMEMPAGE 48149 . 48837) (INSTALLDOMINO 48839 . 49486) (
INSTALLDOMINO.DIRECT 49488 . 50640) (INSTALLNEWDOMINO 50642 . 52810)) (52834 54191 (DLPRINTFPTOVP 
52844 . 53133) (PRINTPRIMARYMAP 53135 . 53849) (DLREADPAGEOFWORDS 53851 . 54018) (SETDIF 54020 . 54189
)))))
STOP
