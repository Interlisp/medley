;;; File converted on 14-Jun-88 15:01:09 from source array-tester
;;; Original source {qv}<pedersen>lisp>array-tester.;1 created 14-Jun-88 14:57:44

;;; Copyright (c) 1988 by Xerox Corporation



;; array-read and array-write 


(do-test "Opcode ARRAYREAD (MISC3 9), type (unsigned-byte 1)"
       (equal '(1 0 1 0)
              (flet ((array-read-bit (base index)
                            ((il:opcodes il:misc3 9)
                             base 0 index)))
                    (let ((base (il:%make-array-storage 8 0)))
                         (il:\\putbasebyte base 0 160)
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-bit base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type (unsigned-byte 8)"
       (equal '(0 23 255 4)
              (flet ((array-read-byte (base index)
                            ((il:opcodes il:misc3 9)
                             base 3 index)))
                    (let ((base (il:%make-array-storage 4 3)))
                         (do ((i 0 (1+ i))
                              (x '(0 23 255 4)
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbasebyte base i (car x)))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-byte base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type (unsigned-byte 16)"
       (equal '(0 23 255 65535)
              (flet ((array-read-word (base index)
                            ((il:opcodes il:misc3 9)
                             base 4 index)))
                    (let ((base (il:%make-array-storage 4 4)))
                         (do ((i 0 (1+ i))
                              (x '(0 23 255 65535)
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbase base i (car x)))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-word base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type (signed-byte 16)"
       (equal '(0 -23 255 -32768)
              (flet ((array-read-signed-word (base index)
                            ((il:opcodes il:misc3 9)
                             base 20 index)))
                    (let ((base (il:%make-array-storage 4 20)))
                         (do ((i 0 (1+ i))
                              (x '(0 -23 255 -32768)
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbase base i (il:\\loloc (car x))))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-signed-word base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type (signed-byte 32)"
       (equal '(0 -23 65536 -2147483648)
              (flet ((array-read-fixp (base index)
                            ((il:opcodes il:misc3 9)
                             base 22 index)))
                    (let ((base (il:%make-array-storage 4 22)))
                         (do ((i 0 (1+ i))
                              (x '(0 -23 65536 -2147483648)
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbasefixp base (ash i 1)
                                  (car x)))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-fixp base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type single-float"
       (equal '(0.0 -23.0 3.4456E+24 -4.562435E-12)
              (flet ((array-read-floatp (base index)
                            ((il:opcodes il:misc3 9)
                             base 54 index)))
                    (let ((base (il:%make-array-storage 4 54)))
                         (do ((i 0 (1+ i))
                              (x '(0.0 -23.0 3.4456E+24 -4.562435E-12)
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbasefloatp base (ash i 1)
                                  (car x)))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-floatp base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type string-char"
       (equal '(#\a #\b #\c #\A)
              (flet ((array-read-thin-char (base index)
                            ((il:opcodes il:misc3 9)
                             base 67 index)))
                    (let ((base (il:%make-array-storage 4 67)))
                         (do ((i 0 (1+ i))
                              (x '(#\a #\b #\c #\A)
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbasebyte base i (char-code (car x))))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-thin-char base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type fat-string-char"
       (equal '(#\a #\b #\c #\A)
              (flet ((array-read-fat-char (base index)
                            ((il:opcodes il:misc3 9)
                             base 68 index)))
                    (let ((base (il:%make-array-storage 4 68)))
                         (do ((i 0 (1+ i))
                              (x '(#\a #\b #\c #\A)
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbase base i (char-code (car x))))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-fat-char base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type t"
       (equal '(2 #\c 2.3 (a . b))
              (flet ((array-read-pointer (base index)
                            ((il:opcodes il:misc3 9)
                             base 38 index)))
                    (let ((base (il:%make-array-storage 4 38)))
                         (do ((i 0 (1+ i))
                              (x '(2 #\c 2.3 (a . b))
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\rplptr base (ash i 1)
                                  (car x)))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-pointer base i))))))))

(do-test "Opcode ARRAYREAD (MISC3 9), type il:xpointer"
       (equal '(2 #\c 2.3 (a . b))
              (flet ((array-read-xpointer (base index)
                            ((il:opcodes il:misc3 9)
                             base 86 index)))
                    (let ((base (il:%make-array-storage 4 86)))
                         (do ((i 0 (1+ i))
                              (x '(2 #\c 2.3 (a . b))
                                 (cdr x)))
                             ((eq i 4))
                           (il:\\putbaseptr base (ash i 1)
                                  (car x)))
                         (with-collection (dotimes (i 4)
                                              (collect (array-read-xpointer base i))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type (unsigned-byte 1)"
       (equal '(1 0 1 0 (1 0 1 0))
              (flet ((array-write-bit (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 0 index)))
                    (let ((base (il:%make-array-storage 8 0)))
                         (il:\\putbasebyte base 0 160)
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(1 0 1 0)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-bit (car x)
                                                            base i)))
                                (collect (let ((byte (il:\\getbasebyte base 0)))
                                              (list (ldb (byte 1 7)
                                                         byte)
                                                    (ldb (byte 1 6)
                                                         byte)
                                                    (ldb (byte 1 5)
                                                         byte)
                                                    (ldb (byte 1 4)
                                                         byte)))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type (unsigned-byte 8)"
       (equal '(0 23 255 4 (0 23 255 4))
              (flet ((array-write-byte (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 3 index)))
                    (let ((base (il:%make-array-storage 4 3)))
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(0 23 255 4)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-byte (car x)
                                                            base i)))
                                (collect (with-collection (dotimes (i 4)
                                                              (collect (il:\\getbasebyte base i))))))
                         ))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type (unsigned-byte 16)"
       (equal '(0 23 255 65535 (0 23 255 65535))
              (flet ((array-write-word (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 4 index)))
                    (let ((base (il:%make-array-storage 4 4)))
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(0 23 255 65535)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-word (car x)
                                                            base i)))
                                (collect (with-collection (dotimes (i 4)
                                                              (collect (il:\\getbase base i))))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type (signed-byte 16)"
       (equal '(0 -23 255 -32768 (0 -23 255 -32768))
              (flet ((array-write-signed-word (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 20 index)))
                    (let ((base (il:%make-array-storage 4 20)))
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(0 -23 255 -32768)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-signed-word (car x)
                                                            base i)))
                                (collect (with-collection (dotimes (i 4)
                                                              (collect (let ((word (il:\\getbase
                                                                                    base i)))
                                                                            (if (> word 32767)
                                                                                (il:\\vag2 15 word)
                                                                                word)))))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type (signed-byte 32)"
       (equal '(0 -23 65536 -2147483648 (0 -23 65536 -2147483648))
              (flet ((array-write-fixp (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 22 index)))
                    (let ((base (il:%make-array-storage 4 22)))
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(0 -23 65536 -2147483648)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-fixp (car x)
                                                            base i)))
                                (collect (with-collection (dotimes (i 4)
                                                              (collect (il:\\getbasefixp base
                                                                              (ash i 1)))))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type single-float"
       (equal '(0.0 -23.0 3.4456E+24 -4.562435E-12 (0.0 -23.0 3.4456E+24 -4.562435E-12))
              (flet ((array-write-floatp (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 54 index)))
                    (let ((base (il:%make-array-storage 4 54)))
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(0.0 -23.0 3.4456E+24 -4.562435E-12)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-floatp (car x)
                                                            base i)))
                                (collect (with-collection (dotimes (i 4)
                                                              (collect (il:\\getbasefloatp
                                                                        base
                                                                        (ash i 1)))))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type thin-string-char"
       (equal '(#\a #\b #\c #\A (#\a #\b #\c #\A))
              (flet ((array-write-thin-char (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 67 index)))
                    (let ((base (il:%make-array-storage 4 67)))
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(#\a #\b #\c #\A)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-thin-char (car x)
                                                            base i)))
                                (collect (with-collection (dotimes (i 4)
                                                              (collect (code-char (il:\\getbasebyte
                                                                                   base i)))))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type fat-string-char"
       (equal '(#\a #\b #\c #\A (#\a #\b #\c #\A))
              (flet ((array-write-fat-char (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 68 index)))
                    (let ((base (il:%make-array-storage 4 68)))
                         (with-collection (do ((i 0 (1+ i))
                                               (x '(#\a #\b #\c #\A)
                                                  (cdr x)))
                                              ((eq i 4))
                                            (collect (array-write-fat-char (car x)
                                                            base i)))
                                (collect (with-collection (dotimes (i 4)
                                                              (collect (code-char (il:\\getbase
                                                                                   base i)))))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type t"
       (equal '(2*#\c a (a . b)
                  ((2 . 1)
                   (#\c . 1)
                   (a . 1)
                   ((a . b) . 3)))
              (flet ((array-write-pointer (new-value base index)
         (                  ((il:opcodesõil:misc4 7)
                             new-value base 38 index)))
                    (let ((base (il:%make-array-storage 4 38)))
                         (with-collection
                          (do ((i 0 (1+ i))
                               (x (list 2 #\c 'a (cons 'a 'b))
                                  (cdr x)))
                              ((eq i 4))
                            (collect (array-write-pointer (car x)
                                            base i)))
                          (collect (with-collection (dotimes (i 4)
                                                        (collect (cons (il:\\getbaseptr base
                                                                              (ash i 1))
                                                                       (il:\\refcnt
                                                                        (il:\\getbaseptr base
                                                                               (ash i 1)))))))))))))

(do-test "Opcode ARRAYWRITE (MISC4 7), type il:xpointer"
       (equal '(2 #\c a (a . b)
                  ((2 . 1)
                   (#\c . 1)
                   (a . 1)
                   ((a . b) . 2)))
              (flet ((array-write-xpointer (new-value base index)
                            ((il:opcodes il:misc4 7)
                             new-value base 86 index)))
                    (let ((base (il:%make-array-storage 4 86)))
                         (with-collection
                          (do ((i 0 (1+ i))
                               (x (list 2 #\c 'a (cons 'a 'b))
                                  (cdr x)))
                              ((eq i 4))
                            (collect (array-write-xpointer (car x)
                                            base i)))
                          (collect (with-collection (dotimes (i 4)
                                                        (collect (cons (il:\\getbaseptr base
                                                                              (ash i 1))
                                                                       (il:\\refcnt
                                                                        (il:\\getbaseptr base
                                                                               (ash i 1)))))))))))))
