(DEFINE-FILE-INFO READTABLE "XCL" PACKAGE "INTERLISP")
(FILECREATED "27-Oct-88 14:58:37" {ERIS}<TEST>MAIKO>STACKHAX.\;1 3191   )


; Copyright (c) 1988 by I.  All rights reserved.

(PRETTYCOMPRINT STACKHAXCOMS)

(RPAQQ STACKHAXCOMS ((FNS CHECKSTACKSPACE)))
(DEFINEQ

(CHECKSTACKSPACE
  (LAMBDA (N START)                                      (* \; "Edited 27-Oct-88 14:51 by jds")
    (PROG ((SCANPTR (|fetch| |StackBase| |of| |\\InterfacePage|))
           (EASP (|fetch| |EndOfStack| |of| |\\InterfacePage|)))
      SCAN
          (SELECTC (|fetch| (STK FLAGS) |of| SCANPTR)
              (\\STK.FSB (COND
                            ((ZEROP (|fetch| (FSB SIZE) |of| SCANPTR))
                             (HELP "FSB size 0 at " SCANPTR)))
                         (|add| SCANPTR (|fetch| (FSB SIZE) |of| SCANPTR)))
              (\\STK.GUARD (COND
                              ((EQ SCANPTR EASP)             (* \; 
                                           "Guard block not at end of stack, treat as a free block")
                               (RETURN T)))
                           (COND
                              ((ZEROP (|fetch| (FSB SIZE) |of| SCANPTR))
                               (HELP "Guard block size 0 at " SCANPTR)))
                           (|add| SCANPTR (|fetch| (FSB SIZE) |of| SCANPTR))
                                                             (* \; "reached end")
                           )
              (\\STK.FX                                      (* \; "frame extension")
                        (OR (|fetch| (FX CHECKED) |of| SCANPTR)
                            (CL:WARN "FX not CHECKED at ~O." SCANPTR))
                        (COND
                           ((EQUAL (|fetch| (FX NEXTBLOCK) |of| SCANPTR)
                                   SCANPTR)
                            (CL:WARN "FX's NEXTBLOCK points to itself at ~O." SCANPTR)))
                        (SETQ SCANPTR (|fetch| (FX NEXTBLOCK) |of| SCANPTR)))
              (LET ((ORIG SCANPTR))                          (* \; "must be a basic frame")
                   (|until| (|type?| BF SCANPTR)
                      |do| (OR (EQ (|fetch| (STK FLAGS) |of| SCANPTR)
                                       \\STK.NOTFLAG)
                                   T
                                   (CL:WARN "Non-zero flags in a non-BF word at ~O." SCANPTR))
                            (|add| SCANPTR WORDSPERCELL))
                   (OR (COND
                          ((|fetch| (BF RESIDUAL) |of| SCANPTR)
                           (EQ SCANPTR ORIG))
                          (T (AND (|fetch| (BF CHECKED) |of| SCANPTR)
                                  (EQ ORIG (|fetch| (BF IVAR) |of| SCANPTR)))))
                       (CL:WARN "Bad basic frame at ~O." SCANPTR))
                   (|add| SCANPTR WORDSPERCELL)))
      NEXT
          (OR (ILEQ SCANPTR EASP)
              (HELP "SCANPTR got beyond EASP"))
          (GO SCAN))))
)
(PUTPROPS STACKHAX COPYRIGHT ("I" 1988))
(DECLARE\: DONTCOPY
  (FILEMAP (NIL (269 3127 (CHECKSTACKSPACE 279 . 3125)))))
STOP
