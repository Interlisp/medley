(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED "23-Oct-2024 00:04:37" {WMEDLEY}<library>tedit>TEDIT-LOOKS.;336 160437 

      :EDIT-BY rmk

      :CHANGES-TO (FNS \TEDIT.GET.INSERT.CHARLOOKS \TEDIT.CHANGE.CHARLOOKS 
                       \TEDIT.CHANGE.CHARLOOKS.NEW \TEDIT.CHARLOOKS.CHANGE.FONT)

      :PREVIOUS-DATE "21-Oct-2024 00:29:20" {WMEDLEY}<library>tedit>TEDIT-LOOKS.;333)


(PRETTYCOMPRINT TEDIT-LOOKSCOMS)

(RPAQQ TEDIT-LOOKSCOMS
       [
        (* ;; "Support for Character looks (font, italic/bold, sub/superscripting, etc) and paragraph looks (margins, centered/justified, tabs, etc.). Uses compiled create functions in case DWIM is not available at loadup time.")

        (DECLARE%: EVAL@COMPILE DONTCOPY (EXPORT (RECORDS CHARLOOKS FMTSPEC)
                                                (MACROS \WORDSETA)
                                                (MACROS ONOFF)
                                                (MACROS FSETPARA FGETPARA GETPARA SETPARA GETCLOOKS 
                                                       SETCLOOKS FGETCLOOKS FSETCLOOKS)))
        (INITRECORDS CHARLOOKS FMTSPEC PENDINGTAB)
        (FNS \TEDIT.CHARLOOKS.DEFPRINT \TEDIT.FMTSPEC.DEFPRINT)
        [DECLARE%: DONTEVAL@LOAD DOCOPY (VARS (TEDIT.DEFAULT.FMTSPEC (\TEDIT.CREATE.DEFAULT.FMTSPEC))
                                              (TEDIT.TERMSA.FONTS NIL)
                                              (TEDIT.KNOWN.FONTS '((Classic 'CLASSIC)
                                                                   (Modern 'MODERN)
                                                                   (Terminal 'TERMINAL)
                                                                   (Titan 'TITAN)
                                                                   (Gacha 'GACHA)
                                                                   (Helvetica 'HELVETICA)
                                                                   (Times% Roman 'TIMESROMAN]
        (INITVARS (TEDIT.DEFAULT.FOLIO))
        (COMS                                                (* ; 
                                                       "Added by yabu.fx, for SUNLOADUP without DWIM")
              (FNS \TEDIT.CREATE.DEFAULT.FMTSPEC \TEDIT.CREATE.FACE.MENU \TEDIT.CREATE.SIZE.MENU))
        (VARS TEDIT.CHARLOOKS.FEATURES (TEDIT.DEFAULT.FMTSPEC (\TEDIT.CREATE.DEFAULT.FMTSPEC))
              (TEDIT.FACE.MENU (\TEDIT.CREATE.FACE.MENU))
              (TEDIT.SIZE.MENU (\TEDIT.CREATE.SIZE.MENU)))
        (FNS \TEDIT.CHARLOOK.FEATUREP)
        (GLOBALVARS TEDIT.CHARLOOKS.FEATURES TEDIT.CURRENT.FONT TEDIT.CURRENT.CHARLOOKS 
               TEDIT.CURRENT.PARALOOKS TEDIT.KNOWN.FONTS TEDIT.FACE.MENU TEDIT.SIZE.MENU 
               TEDIT.DEFAULT.FONT TEDIT.DEFAULT.FMTSPEC TEDIT.TERMSA.FONTS)
        (ADDVARS (FONTVARS (TEDIT.PROMPT.FONT DEFAULTFONT)
                        (TEDIT.ICON.FONT MENUFONT)))
        (COMS                                                (* ; "Character looks functions")
              (FNS \TEDIT.CHARLOOKS.FROM.FONT \TEDIT.EQCLOOKS \TEDIT.SAMECLOOKS TEDIT.CARETLOOKS 
                   TEDIT.COPY.LOOKS \TEDIT.UNPARSE.CHARLOOKS.LIST \TEDIT.MODIFYLOOKS TEDIT.NEW.FONT 
                   \TEDIT.CARETLOOKS.VERIFY \TEDIT.CARETPIECE \TEDIT.GET.INSERT.CHARLOOKS 
                   \TEDIT.GET.TERMSA.WIDTHS \TEDIT.PARSE.CHARLOOKS.LIST \TEDIT.CHARLOOK.FEATURE)
              (COMS (FNS \TEDIT.TRANSLATE.ASCIICHARS \TEDIT.CONVERT.TO.FORMATTED)
                    (MACROS \TEDIT.TRANSLATE.ASCII.CHARLOOKS))
              (FNS \TEDIT.UNIQUIFY.CHARLOOKS \TEDIT.UNIQUIFY.PARALOOKS \TEDIT.UNIQUIFY.ALL 
                   \TEDIT.FLUSH.UNUSED.LOOKS)
              
              (* ;; "Public entries")

              (FNS TEDIT.LOOKS TEDIT.GET.LOOKS TEDIT.SUBLOOKS TEDIT.FINDLOOKS)
              (FNS \TEDIT.CHANGE.CHARLOOKS \TEDIT.CHANGE.CHARLOOKS.NEW \TEDIT.CHARLOOKS.CHANGE.FONT 
                   \TEDIT.LOOKS \TEDIT.FONTCOPY))
        (COMS                                                (* ; "Paragraph looks functions")
              (FNS \TEDIT.EQFMTSPEC TEDIT.GET.PARALOOKS \TEDIT.PARSE.PARALOOKS.LIST TEDIT.PARALOOKS 
                   \TEDIT.CHANGE.PARALOOKS \TEDIT.CHANGE.PARALOOKS.NEW TEDIT.COPY.PARALOOKS 
                   \TEDIT.PARABOUNDS)
              
              (* ;; "For making paragraph-looks substitutions.")

              (FNS TEDIT.SUBPARALOOKS SAMEPARALOOKS))
        (COMS                                                (* ; "Revision-mark support")
              (FNS \TEDIT.MARK.REVISION))
        (COMS                                                (* ; "Style-sheet support")
              (FNS \TEDIT.APPLY.STYLES \TEDIT.APPLY.PARASTYLES TEDIT.STYLESHEET TEDIT.POP.STYLESHEET
                   TEDIT.PUSH.STYLESHEET TEDIT.ADD.STYLESHEET)
              
              (* ;; "*TEDIT-PARASTYLE-CACHE* is an ALIST of  original char/para looks to styled char/para looks.  It is used to cache stylings, and is reset when the main stylesheet changes, and when we change paragraph looks, given paras that have private char styles.")

              
              (* ;; "*TEDIT-CURRENTPARA-CACHE* is NIL if we're not in a para that has private char styles, or is the FMTSPEC (styled!) for that para, if we are.  Used to decide when we have to flush *TEDIT-PARASTYLE-CACHE* at paragraph boundaries.  Mostly, this'll be NIL and not interesting.")

              
              (* ;; "*TEDIT-STYLESHEET-SAVE-LIST* is a list of points inside TEDIT.STYLES, so we can %"push%" new style sheets on the front, and %"pop%" them off sensibly.  This is the push-stack, in effect.  Used by TEDIT.ADD.STYLESHEET, TEDIT.PUSH.STYLESHEET, and TEDIT.POP.STYLESHEET")

              (INITVARS (TEDIT.STYLES))
              
              (* ;; "RMK 2023: Maybe this should be one of the later ones? Only partly implemented")

              (GLOBALVARS TEDIT.STYLES)
              (INITVARS (*TEDIT-PARASTYLE-CACHE*)
                     (*TEDIT-CURRENTPARA-CACHE*)
                     (*TEDIT-STYLESHEET-SAVE-LIST*))
              (GLOBALVARS *TEDIT-PARASTYLE-CACHE* *TEDIT-CURRENTPARA-CACHE* 
                     *TEDIT-STYLESHEET-SAVE-LIST*))
        (DECLARE%: DONTEVAL@LOAD DOEVAL@COMPILE DONTCOPY COMPILERVARS (ADDVARS (NLAMA)
                                                                             (NLAML)
                                                                             (LAMA 
                                                                              \TEDIT.CHARLOOK.FEATURE
                                                                                   ])



(* ;; 
"Support for Character looks (font, italic/bold, sub/superscripting, etc) and paragraph looks (margins, centered/justified, tabs, etc.). Uses compiled create functions in case DWIM is not available at loadup time."
)

(DECLARE%: EVAL@COMPILE DONTCOPY 
(* "FOLLOWING DEFINITIONS EXPORTED")(DECLARE%: EVAL@COMPILE

(DATATYPE CHARLOOKS (
                     (* ;; "Describes the appearance (%"Looks%") of characters in a TEdit document.")

                     (* ;; "NOTE:  If fields change EQCLOOKS should change too.")

                     CLFONT                                  (* ; 
                                                           "The font descriptor for these characters")
                     CLNAME

                     (* ;; "Name of the font (e.g., HELVETICA) THIS FIELD IS A HINT, OR FOR USE IN CHARLOOKS-BUILDING CODE.  USE FONTPROP TO GET THE RIGHT VALUE FROM CLFONT.")

                     CLSIZE                                  (* ; "Font size, in points")
                     (CLITAL FLAG)                           (* ; 
                                                           "T if the characters are italic, else NIL")
                     (CLBOLD FLAG)                           (* ; 
                                                             "T if the characters are bold, else NIL")
                     (CLULINE FLAG)                          (* ; 
                                                "T if the characters are to be underscored, else NIL")
                     (CLOLINE FLAG)                          (* ; 
                                                 "T if the characters are to be overscored, else NIL")
                     (CLSTRIKE FLAG)                         (* ; 
                                               "T if the characters are to be struck thru, else nil.")
                     CLOFFSET                                (* ; 
                         "A superscripting offset in points (?) else NIL (SUBSCRIPTING IF NEGATIVE.)")
                     (CLSMALLCAP FLAG)                       (* ; "T if small caps, else NIL")
                     (CLINVERTED FLAG)                       (* ; 
                                                 "T if the characters are to be shown white-on-black")
                     (CLPROTECTED FLAG)                      (* ; 
                                                             "T if chars can't be selected, else NIL")
                     (CLINVISIBLE FLAG)                      (* ; 
                                                     "T if TEDIT is to ignore these chars;  else NIL")
                     (CLSELAFTER FLAG)                       (* ; 
                                    "T if TEDIT can put selection after this char (for menu fields).")

                     (* ;; "Was CLSELHERE. ")

                     (CLCANCOPY FLAG)

                     (* ;; "T if this text can be selected for copying, even tho protected (it will become unprotected after the copy;  for Dribble/TTY interface)")

                     (CLUNBREAKABLE FLAG)                    (* ; 
                                                           "Spaces are treated as nonbreaking spaces")
                     CLSTYLE                                 (* ; 
                  "The style to be used in marking these characters;  overridden by the other fields")
                     CLUSERINFO                              (* ; 
                                                  "Any information that an outsider wants to include")
                     CLLEADER                                (* ; 
                                                      "For creating dotted and other kinds of leader")
                     CLRULES

                     (* ;; "For arbitrarily-places horizontal rules.  List of pairs, of (widthinpts  . offsetfrombaselineinpts).  Should be taken account of in ascent/descent calcs.")

                     (CLMARK FLAG)

                     (* ;; "Used for a mark-&-sweep of looks at PUT time -- T means this set of looks really IS in use in the document")

                     (CLSELBEFORE FLAG)                      (* ; 
                                   "T if TEDIT can put selection before this char (for menu fields).")
                     )
                    CLOFFSET _ 0 (INIT (DEFPRINT 'CHARLOOKS (FUNCTION \TEDIT.CHARLOOKS.DEFPRINT))))

(DATATYPE FMTSPEC (
                   (* ;; "Describe the paragraph formatting for a paragraph in a TEdit document.")

                   1STLEFTMAR                                (* ; 
                                                     "Left margin of the first line of the paragraph")
                   LEFTMAR                                   (* ; 
                                              "Left margin of the rest of the lines in the paragraph")
                   RIGHTMAR                                  (* ; "Right margin for the paragraph")
                   LEADBEFORE                                (* ; 
                                                "Leading above the paragraph's first line, in points")
                   LEADAFTER                                 (* ; 
                            "Leading below the paragraph's bottom line, in points.  NOT IMPLEMENTED.")
                   LINELEAD                                  (* ; "Leading between lines, in points.  This space is added BELOW each line in the para when TEDIT.LINELEADING.BELOW, otherwise above, which is how it is documented.")
                   FMTBASETOBASE                             (* ; 
 "The baseline-to-baseline spacing between lines in this paragraph.  THIS OVERRIDES THE LINE LEADING")
                   NIL                                       (* ; 
            "Was TABSPEC: The list of tabs for this paragraph, including CAR for a default tab width")
                   QUAD                                      (* ; 
                                 "How the para is formatted: one of LEFT, RIGHT, CENTERED, JUSTIFIED")
                   FMTSTYLE                                  (* ; 
                                                "The STYLE that controls this paragraph's appearance")
                   FMTCHARSTYLES                             (* ; "The characterstyles that control the appearance of characters in this para (maybe?  may be part of the fmtstyle.)")
                   FMTUSERINFO                               (* ; "Space for a PLIST of user info")
                   FMTSPECIALX                               (* ; 
                                   "A special horizontal location on the printed page for this para.")
                   FMTSPECIALY                               (* ; 
                                              "A special vertical location on the page for this para")
                   (FMTHEADINGKEEP FLAG)                     (* ; 
                                "This para should be kept with the top line or so of the next para..")
                   FMTPARATYPE                               (* ; 
                                             "What kind of para this is: TEXT, PAGEHEADING, whatever")
                   FMTPARASUBTYPE                            (* ; 
                                     "Sub type of the type, e.g., what KIND of page heading this is.")
                   FMTNEWPAGEBEFORE                          (* ; "Start a new box (if T) or back up the page formatting tree to make a new box of the type named in the value -- by going the least distance back up the tree, then back down until you find that kind of box.")
                   FMTNEWPAGEAFTER                           (* ; "Similarly")
                   FMTKEEP                                   (* ; 
                      "For information about how this paragraph is to be kept with other paragraphs.")
                   FMTCOLUMN                                 (* ; 
                                           "For setting up side-by-side paragraphs easily ala BravoX")
                   FMTVERTRULES                              (* ; 
                                                       "For Keeping track of vertical rules in force")
                   (FMTMARK FLAG)                            (* ; "Used to keep track of which PARALOOKSs are really being used -- a mark & collect is done just before a PUT, so that only 'real' PARALOOKSs make it into the file")
                                                             (* ; "Used for a mark&sweep of para looks at PUT time -- T means this looks really IS in use in the document, so it makes sense to save it on the file.")
                   (FMTHARDCOPY FLAG)                        (* ; 
                                         "T if this paragraph is to be displayed in hardcopy-format.")
                   FMTREVISED                                (* ; "T (or perhaps a revision level or revision-mark spec??) if this paragraph is to be marked as changed on output.")
                   FMTHARDCOPYSCALE                          (* ; "The units-per-point (DSPSCALE) of the hardcopy stream that is simulated in hardcopy-display mode (FMTHARDCOPY=T")
                   FMTDEFAULTTAB                             (* ; "Default tab in points)")
                   FMTTABS)                                  (* ; "List of tabs (in points)")
                  (INIT (DEFPRINT 'FMTSPEC (FUNCTION \TEDIT.FMTSPEC.DEFPRINT)))
                  LEADBEFORE _ 0 LEADAFTER _ 0 LINELEAD _ 0)
)

(/DECLAREDATATYPE 'CHARLOOKS
       '(POINTER POINTER POINTER FLAG FLAG FLAG FLAG FLAG POINTER FLAG FLAG FLAG FLAG FLAG FLAG FLAG
               POINTER POINTER POINTER POINTER FLAG FLAG)
       '((CHARLOOKS 0 POINTER)
         (CHARLOOKS 2 POINTER)
         (CHARLOOKS 4 POINTER)
         (CHARLOOKS 4 (FLAGBITS . 0))
         (CHARLOOKS 4 (FLAGBITS . 16))
         (CHARLOOKS 4 (FLAGBITS . 32))
         (CHARLOOKS 4 (FLAGBITS . 48))
         (CHARLOOKS 2 (FLAGBITS . 0))
         (CHARLOOKS 6 POINTER)
         (CHARLOOKS 6 (FLAGBITS . 0))
         (CHARLOOKS 6 (FLAGBITS . 16))
         (CHARLOOKS 6 (FLAGBITS . 32))
         (CHARLOOKS 6 (FLAGBITS . 48))
         (CHARLOOKS 2 (FLAGBITS . 16))
         (CHARLOOKS 2 (FLAGBITS . 32))
         (CHARLOOKS 2 (FLAGBITS . 48))
         (CHARLOOKS 8 POINTER)
         (CHARLOOKS 10 POINTER)
         (CHARLOOKS 12 POINTER)
         (CHARLOOKS 14 POINTER)
         (CHARLOOKS 14 (FLAGBITS . 0))
         (CHARLOOKS 14 (FLAGBITS . 16)))
       '16)

(DEFPRINT 'CHARLOOKS (FUNCTION \TEDIT.CHARLOOKS.DEFPRINT))

(/DECLAREDATATYPE 'FMTSPEC
       '(POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER 
               POINTER POINTER POINTER FLAG POINTER POINTER POINTER POINTER POINTER POINTER POINTER 
               FLAG FLAG POINTER POINTER POINTER POINTER)
       '((FMTSPEC 0 POINTER)
         (FMTSPEC 2 POINTER)
         (FMTSPEC 4 POINTER)
         (FMTSPEC 6 POINTER)
         (FMTSPEC 8 POINTER)
         (FMTSPEC 10 POINTER)
         (FMTSPEC 12 POINTER)
         (FMTSPEC 14 POINTER)
         (FMTSPEC 16 POINTER)
         (FMTSPEC 18 POINTER)
         (FMTSPEC 20 POINTER)
         (FMTSPEC 22 POINTER)
         (FMTSPEC 24 POINTER)
         (FMTSPEC 26 POINTER)
         (FMTSPEC 26 (FLAGBITS . 0))
         (FMTSPEC 28 POINTER)
         (FMTSPEC 30 POINTER)
         (FMTSPEC 32 POINTER)
         (FMTSPEC 34 POINTER)
         (FMTSPEC 36 POINTER)
         (FMTSPEC 38 POINTER)
         (FMTSPEC 40 POINTER)
         (FMTSPEC 40 (FLAGBITS . 0))
         (FMTSPEC 40 (FLAGBITS . 16))
         (FMTSPEC 42 POINTER)
         (FMTSPEC 44 POINTER)
         (FMTSPEC 46 POINTER)
         (FMTSPEC 48 POINTER))
       '50)

(DEFPRINT 'FMTSPEC (FUNCTION \TEDIT.FMTSPEC.DEFPRINT))
(DECLARE%: EVAL@COMPILE 

(PUTPROPS \WORDSETA DMACRO (OPENLAMBDA (A J V)
                             [CHECK (AND (ARRAYP A)
                                         (ZEROP (fetch (ARRAYP ORIG) of A))
                                         (EQ \ST.POS16 (fetch (ARRAYP TYP) of A]
                             (CHECK (IGREATERP (fetch (ARRAYP LENGTH) of A)
                                           J))
                             (\PUTBASE (fetch (ARRAYP BASE) of A)
                                    (IPLUS (fetch (ARRAYP OFFST) of A)
                                           J)
                                    V)))
)
(DECLARE%: EVAL@COMPILE 

(PUTPROPS ONOFF MACRO [OPENLAMBDA (VAL)
                        (COND
                           (VAL 'ON)
                           (T 'OFF])
)
(DECLARE%: EVAL@COMPILE 

(PUTPROPS FSETPARA MACRO ((F FIELD NEWVALUE)
                          (freplace (FMTSPEC FIELD) of F with NEWVALUE)))

(PUTPROPS FGETPARA MACRO ((F FIELD)
                          (ffetch (FMTSPEC FIELD) of F)))

(PUTPROPS GETPARA MACRO ((F FIELD)
                         (fetch (FMTSPEC FIELD) of F)))

(PUTPROPS SETPARA MACRO ((F FIELD NEWVALUE)
                         (replace (FMTSPEC FIELD) of F with NEWVALUE)))

(PUTPROPS GETCLOOKS MACRO ((CL FIELD)
                           (fetch (CHARLOOKS FIELD) of CL)))

(PUTPROPS SETCLOOKS MACRO ((CL FIELD NEWVALUE)
                           (replace (CHARLOOKS FIELD) of CL with NEWVALUE)))

(PUTPROPS FGETCLOOKS MACRO ((CL FIELD)
                            (ffetch (CHARLOOKS FIELD) of CL)))

(PUTPROPS FSETCLOOKS MACRO ((CL FIELD NEWVALUE)
                            (freplace (CHARLOOKS FIELD) of CL with NEWVALUE)))
)

(* "END EXPORTED DEFINITIONS")

)

(/DECLAREDATATYPE 'CHARLOOKS
       '(POINTER POINTER POINTER FLAG FLAG FLAG FLAG FLAG POINTER FLAG FLAG FLAG FLAG FLAG FLAG FLAG
               POINTER POINTER POINTER POINTER FLAG FLAG)
       '((CHARLOOKS 0 POINTER)
         (CHARLOOKS 2 POINTER)
         (CHARLOOKS 4 POINTER)
         (CHARLOOKS 4 (FLAGBITS . 0))
         (CHARLOOKS 4 (FLAGBITS . 16))
         (CHARLOOKS 4 (FLAGBITS . 32))
         (CHARLOOKS 4 (FLAGBITS . 48))
         (CHARLOOKS 2 (FLAGBITS . 0))
         (CHARLOOKS 6 POINTER)
         (CHARLOOKS 6 (FLAGBITS . 0))
         (CHARLOOKS 6 (FLAGBITS . 16))
         (CHARLOOKS 6 (FLAGBITS . 32))
         (CHARLOOKS 6 (FLAGBITS . 48))
         (CHARLOOKS 2 (FLAGBITS . 16))
         (CHARLOOKS 2 (FLAGBITS . 32))
         (CHARLOOKS 2 (FLAGBITS . 48))
         (CHARLOOKS 8 POINTER)
         (CHARLOOKS 10 POINTER)
         (CHARLOOKS 12 POINTER)
         (CHARLOOKS 14 POINTER)
         (CHARLOOKS 14 (FLAGBITS . 0))
         (CHARLOOKS 14 (FLAGBITS . 16)))
       '16)

(DEFPRINT 'CHARLOOKS (FUNCTION \TEDIT.CHARLOOKS.DEFPRINT))

(/DECLAREDATATYPE 'FMTSPEC
       '(POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER POINTER 
               POINTER POINTER POINTER FLAG POINTER POINTER POINTER POINTER POINTER POINTER POINTER 
               FLAG FLAG POINTER POINTER POINTER POINTER)
       '((FMTSPEC 0 POINTER)
         (FMTSPEC 2 POINTER)
         (FMTSPEC 4 POINTER)
         (FMTSPEC 6 POINTER)
         (FMTSPEC 8 POINTER)
         (FMTSPEC 10 POINTER)
         (FMTSPEC 12 POINTER)
         (FMTSPEC 14 POINTER)
         (FMTSPEC 16 POINTER)
         (FMTSPEC 18 POINTER)
         (FMTSPEC 20 POINTER)
         (FMTSPEC 22 POINTER)
         (FMTSPEC 24 POINTER)
         (FMTSPEC 26 POINTER)
         (FMTSPEC 26 (FLAGBITS . 0))
         (FMTSPEC 28 POINTER)
         (FMTSPEC 30 POINTER)
         (FMTSPEC 32 POINTER)
         (FMTSPEC 34 POINTER)
         (FMTSPEC 36 POINTER)
         (FMTSPEC 38 POINTER)
         (FMTSPEC 40 POINTER)
         (FMTSPEC 40 (FLAGBITS . 0))
         (FMTSPEC 40 (FLAGBITS . 16))
         (FMTSPEC 42 POINTER)
         (FMTSPEC 44 POINTER)
         (FMTSPEC 46 POINTER)
         (FMTSPEC 48 POINTER))
       '50)

(DEFPRINT 'FMTSPEC (FUNCTION \TEDIT.FMTSPEC.DEFPRINT))

(/DECLAREDATATYPE 'PENDINGTAB '(POINTER POINTER POINTER POINTER FULLXPOINTER POINTER)
       '((PENDINGTAB 0 POINTER)
         (PENDINGTAB 2 POINTER)
         (PENDINGTAB 4 POINTER)
         (PENDINGTAB 6 POINTER)
         (PENDINGTAB 8 FULLXPOINTER)
         (PENDINGTAB 10 POINTER))
       '12)
(DEFINEQ

(\TEDIT.CHARLOOKS.DEFPRINT
  [LAMBDA (LOOKS STREAM CPL NOLOC)                           (* ; "Edited 26-Aug-2023 11:10 by rmk")

    (* ;; "CPL seems to be a hidden argument passed on calls from \PRINT-USING-DEFPRINT, usually with value 0.  So NOLOC is one beyond that")

    (LET ((LOC (LOC LOOKS))
          (FACE (CONCAT (CL:IF (fetch (CHARLOOKS CLBOLD) of LOOKS)
                            "B"
                            "M")
                       (CL:IF (fetch (CHARLOOKS CLITAL) of LOOKS)
                           "I"
                           "R")))
          INFO)
         (SETQ INFO (CONCAT (L-CASE (fetch (CHARLOOKS CLNAME) of LOOKS)
                                   T)
                           (fetch (CHARLOOKS CLSIZE) of LOOKS)
                           (CL:IF (STREQUAL FACE "MR")
                               ""
                               FACE)))
         (CONS (CL:IF NOLOC
                   INFO
                   (CONCAT "{CL" (CAR LOC)
                          "/"
                          (CDR LOC)
                          ":" INFO "}"))])

(\TEDIT.FMTSPEC.DEFPRINT
  [LAMBDA (FMTSPEC STREAM)                                   (* ; "Edited 26-Aug-2023 11:11 by rmk")
    (LET ((LOC (LOC FMTSPEC)))
         (CONS (CONCAT "{FMT" (CAR LOC)
                      "/"
                      (CDR LOC)
                      ":"
                      (SUBSTRING (fetch (FMTSPEC QUAD) of FMTSPEC)
                             1 2)
                      "-"
                      (fetch (FMTSPEC LEFTMAR) of FMTSPEC)
                      "-"
                      (fetch (FMTSPEC RIGHTMAR) of FMTSPEC)
                      "}"])
)
(DECLARE%: DONTEVAL@LOAD DOCOPY 

(RPAQ TEDIT.DEFAULT.FMTSPEC (\TEDIT.CREATE.DEFAULT.FMTSPEC))

(RPAQQ TEDIT.TERMSA.FONTS NIL)

(RPAQQ TEDIT.KNOWN.FONTS
       ((Classic 'CLASSIC)
        (Modern 'MODERN)
        (Terminal 'TERMINAL)
        (Titan 'TITAN)
        (Gacha 'GACHA)
        (Helvetica 'HELVETICA)
        (Times% Roman 'TIMESROMAN)))
)

(RPAQ? TEDIT.DEFAULT.FOLIO )



(* ; "Added by yabu.fx, for SUNLOADUP without DWIM")

(DEFINEQ

(\TEDIT.CREATE.DEFAULT.FMTSPEC
  [LAMBDA NIL                                                (* ; "Edited  4-Aug-2024 17:13 by rmk")
                                                             (* ; "Edited 28-Jul-2024 12:57 by rmk")
                                                             (* ; "Edited 24-Aug-2023 23:31 by rmk")
    (create FMTSPEC
           QUAD _ 'LEFT
           1STLEFTMAR _ 0
           LEFTMAR _ 0
           RIGHTMAR _ 0
           LEADBEFORE _ 0
           LEADAFTER _ 0
           LINELEAD _ 0
           FMTDEFAULTTAB _ DEFAULTTAB])

(\TEDIT.CREATE.FACE.MENU
  [LAMBDA NIL
    (create MENU
           ITEMS _ '(Bold Italic Bold% Italic Regular)
           CENTERFLG _ T
           TITLE _ "Face:"])

(\TEDIT.CREATE.SIZE.MENU
  [LAMBDA NIL
    (create MENU
           ITEMS _ '(6 7 8 9 10 11 12 14 18 24 30 36)
           CENTERFLG _ T
           MENUROWS _ 4
           TITLE _ "Type Size:"])
)

(RPAQQ TEDIT.CHARLOOKS.FEATURES (BOLD EXPANSION FACE FAMILY FONT INVERTED INVISIBLE ITALIC OFFSET 
                                      OFFSETINCREMENT OVERLINE PROTECTED SELECTPOINT SELAFTER 
                                      SELBEFORE SIZE SIZEINCREMENT SLOPE SMALLCAPS STRIKEOUT STYLE 
                                      SUBSCRIPT SUPERSCRIPT UNBREAKABLE UNDERLINE USERINFO WEIGHT 
                                      OFFSETTYPE))

(RPAQ TEDIT.DEFAULT.FMTSPEC (\TEDIT.CREATE.DEFAULT.FMTSPEC))

(RPAQ TEDIT.FACE.MENU (\TEDIT.CREATE.FACE.MENU))

(RPAQ TEDIT.SIZE.MENU (\TEDIT.CREATE.SIZE.MENU))
(DEFINEQ

(\TEDIT.CHARLOOK.FEATUREP
  [LAMBDA (P)                                                (* ; "Edited 27-Jul-2024 17:33 by rmk")
    (MEMB P TEDIT.CHARLOOKS.FEATURES])
)
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS TEDIT.CHARLOOKS.FEATURES TEDIT.CURRENT.FONT TEDIT.CURRENT.CHARLOOKS 
       TEDIT.CURRENT.PARALOOKS TEDIT.KNOWN.FONTS TEDIT.FACE.MENU TEDIT.SIZE.MENU TEDIT.DEFAULT.FONT 
       TEDIT.DEFAULT.FMTSPEC TEDIT.TERMSA.FONTS)
)

(ADDTOVAR FONTVARS (TEDIT.PROMPT.FONT DEFAULTFONT)
                   (TEDIT.ICON.FONT MENUFONT))



(* ; "Character looks functions")

(DEFINEQ

(\TEDIT.CHARLOOKS.FROM.FONT
  [LAMBDA (FONT)                                             (* ; "Edited 10-Aug-2024 16:15 by rmk")
                                                             (* ; "Edited 15-Oct-2023 18:56 by rmk")
                                                             (* ; "Edited 25-Aug-2023 20:03 by rmk")
                                                             (* ; "Edited 30-May-91 21:45 by jds")

    (* ;; "Create a CHARLOOKS from a font, filling in such fields as can be inferred from the font descriptor.")

    (create CHARLOOKS
           CLFONT _ FONT
           CLNAME _ (FONTPROP FONT 'FAMILY)
           CLBOLD _ [EQ 'BOLD (CAR (FONTPROP FONT 'FACE]
           CLITAL _ [EQ 'ITALIC (CADR (FONTPROP FONT 'FACE]
           CLSIZE _ (FONTPROP FONT 'SIZE])

(\TEDIT.EQCLOOKS
  [LAMBDA (CLOOK1 CLOOK2)                                    (* ; "Edited 18-Oct-2024 22:29 by rmk")
                                                             (* ; "Edited 11-Aug-2024 20:41 by rmk")
                                                             (* ; "Edited 31-Jul-2024 00:05 by rmk")
                                                             (* ; "Edited  1-Dec-2023 19:27 by rmk")
                                                             (* ; "Edited  9-Nov-2023 00:46 by rmk")
                                                             (* ; "Edited 24-Jul-2023 17:18 by rmk")
                                                             (* ; 
                                                        "Edited  1-Jun-93 11:49 by sybalsky:mv:envos")

    (* ;; "Given two sets of CHARLOOKS, are they effectively the same?")

    (OR (EQ CLOOK1 CLOOK2)
        (LET ((FONT1 (FGETCLOOKS CLOOK1 CLFONT))
              (FONT2 (FGETCLOOKS CLOOK2 CLFONT)))
             (AND [OR (EQ FONT1 FONT2)
                      (AND (type? FONTCLASS FONT1)
                           (type? FONTCLASS FONT2)
                           (EQUAL (fetch (FONTCLASS DISPLAYFD) of FONT1)
                                  (fetch (FONTCLASS DISPLAYFD) of FONT1))
                           (EQUAL (FONTCLASSUNPARSE FONT1)
                                  (FONTCLASSUNPARSE FONT2]
                  (EQ (FGETCLOOKS CLOOK1 CLPROTECTED)
                      (FGETCLOOKS CLOOK2 CLPROTECTED))
                  (EQ (FGETCLOOKS CLOOK1 CLINVISIBLE)
                      (FGETCLOOKS CLOOK2 CLINVISIBLE))
                  (EQ (FGETCLOOKS CLOOK1 CLSELAFTER)
                      (FGETCLOOKS CLOOK2 CLSELAFTER))
                  (EQ (FGETCLOOKS CLOOK1 CLSELBEFORE)
                      (FGETCLOOKS CLOOK2 CLSELBEFORE))
                  (EQ (FGETCLOOKS CLOOK1 CLCANCOPY)
                      (FGETCLOOKS CLOOK2 CLCANCOPY))
                  (EQ (FGETCLOOKS CLOOK1 CLULINE)
                      (FGETCLOOKS CLOOK2 CLULINE))
                  (EQ (FGETCLOOKS CLOOK1 CLOLINE)
                      (FGETCLOOKS CLOOK2 CLOLINE))
                  (EQ (FGETCLOOKS CLOOK1 CLINVERTED)
                      (FGETCLOOKS CLOOK2 CLINVERTED))
                  (EQ (FGETCLOOKS CLOOK1 CLSTRIKE)
                      (FGETCLOOKS CLOOK2 CLSTRIKE))
                  (EQ (FGETCLOOKS CLOOK1 CLOFFSET)
                      (FGETCLOOKS CLOOK2 CLOFFSET))
                  (EQ (FGETCLOOKS CLOOK1 CLSMALLCAP)
                      (FGETCLOOKS CLOOK2 CLSMALLCAP))
                  (EQ (FGETCLOOKS CLOOK1 CLSTYLE)
                      (FGETCLOOKS CLOOK2 CLSTYLE))
                  (EQ (FGETCLOOKS CLOOK1 CLUNBREAKABLE)
                      (FGETCLOOKS CLOOK2 CLUNBREAKABLE))
                  (EQ (FGETCLOOKS CLOOK1 CLUSERINFO)
                      (FGETCLOOKS CLOOK2 CLUSERINFO])

(\TEDIT.SAMECLOOKS
  [LAMBDA (CLOOK1 CLOOK2 FEATURES)                           (* ; "Edited 31-Jul-2024 00:06 by rmk")
                                                             (* ; "Edited 24-Jul-2023 17:17 by rmk")
                                                             (* ; "Edited 30-May-91 21:45 by jds")

    (* ;; "Predicate to determine if CLOOK1 and CLOOK2 are the same in all the characteristics listed in FEATURES")

    (for F in FEATURES always (SELECTQ F
                                  (FAMILY (EQ (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK1)
                                                     'FAMILY)
                                              (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK2)
                                                     'FAMILY)))
                                  (SIZE (EQ (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK1)
                                                   'SIZE)
                                            (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK2)
                                                   'SIZE)))
                                  (EXPANSION (EQ (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK1)
                                                        'EXPANSION)
                                                 (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK2)
                                                        'EXPANSION)))
                                  (SLOPE (EQ (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK1)
                                                    'SLOPE)
                                             (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK2)
                                                    'SLOPE)))
                                  (WEIGHT (EQ (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK1)
                                                     'WEIGHT)
                                              (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK2)
                                                     'WEIGHT)))
                                  (SUPERSCRIPT (EQ (fetch (CHARLOOKS CLOFFSET) of CLOOK1)
                                                   (fetch (CHARLOOKS CLOFFSET) of CLOOK2)))
                                  (INVISIBLE (EQ (fetch (CHARLOOKS CLINVISIBLE) of CLOOK1)
                                                 (fetch (CHARLOOKS CLINVISIBLE) of CLOOK2)))
                                  (SELECTPOINT (EQ (fetch (CHARLOOKS CLSELAFTER) of CLOOK1)
                                                   (fetch (CHARLOOKS CLSELAFTER) of CLOOK2)))
                                  (PROTECTED (EQ (fetch (CHARLOOKS CLPROTECTED) of CLOOK1)
                                                 (fetch (CHARLOOKS CLPROTECTED) of CLOOK2)))
                                  (OVERLINE (EQ (fetch (CHARLOOKS CLOLINE) of CLOOK1)
                                                (fetch (CHARLOOKS CLOLINE) of CLOOK2)))
                                  (STRIKEOUT (EQ (fetch (CHARLOOKS CLSTRIKE) of CLOOK1)
                                                 (fetch (CHARLOOKS CLSTRIKE) of CLOOK2)))
                                  (UNDERLINE (EQ (fetch (CHARLOOKS CLULINE) of CLOOK1)
                                                 (fetch (CHARLOOKS CLULINE) of CLOOK2)))
                                  (UNBREAKABLE (fetch (CHARLOOKS CLUNBREAKABLE) of CLOOK1)
                                               (fetch (CHARLOOKS CLUNBREAKABLE) of CLOOK2))
                                  (FACE (EQUAL (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK1)
                                                      'FACE)
                                               (FONTPROP (fetch (CHARLOOKS CLFONT) of CLOOK2)
                                                      'FACE)))
                                  (ERROR (CONCAT F 
                                 " is an unknown feature of character looks.  Detected in SAMECLOOKS"
                                                ])

(TEDIT.CARETLOOKS
  [LAMBDA (STREAM LOOKS)                                     (* ; "Edited 15-Oct-2023 17:12 by rmk")
                                                             (* ; "Edited 28-May-2023 14:15 by rmk")
                                                             (* ; "Edited  6-Apr-2023 21:42 by rmk")
                                                             (* ; "Edited  8-Sep-2022 11:25 by rmk")
                                                             (* ; "Edited 30-May-91 21:40 by jds")

    (* ;; "Set the 'Caret looks' for a TEdit document, i.e., the looks that will be applied to newly-typed characters from here on.")

    (LET ((TEXTOBJ (TEXTOBJ STREAM)))                        (* ; 
                              "Parse up the looks he gave us, to make sure they're a valid CHARLOOKS")
         (change (FGETTOBJ TEXTOBJ CARETLOOKS)
                (\TEDIT.CARETLOOKS.VERIFY TEXTOBJ (\TEDIT.PARSE.CHARLOOKS.LIST LOOKS DATUM TEXTOBJ])

(TEDIT.COPY.LOOKS
  [LAMBDA (STREAM SOURCE DEST)                               (* ; "Edited  2-Aug-2024 08:47 by rmk")
                                                             (* ; "Edited 13-Jul-2024 23:15 by rmk")
                                                             (* ; "Edited 12-Jul-2024 00:37 by rmk")
                                                             (* ; "Edited 29-Apr-2024 13:00 by rmk")
                                                             (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited  9-Feb-2024 11:42 by rmk")
                                                             (* ; "Edited 18-Apr-2023 23:53 by rmk")
                                                             (* ; "Edited 22-Oct-2022 15:27 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:14 by rmk")
                                                             (* ; "Edited 30-May-91 21:43 by jds")

    (* ;; "Copy the CHARACTER LOOKS of one piece of text (actually, the first selected character) to another piece of text.")

    (* ;; "According to (slightly wrong) documentation:")

    (* ;; "STREAM is the stream of the destination, no matter what.")

    (* ;; "STREAM is the stream of the source if SOURCE is an integer (or if it has no textstream). Otherwise, it provides its own stream")

    (* ;; "Not clear why the destination can't be in a different stream")

    (SETQ STREAM (TEXTSTREAM STREAM))
    (LET ((TEXTOBJ (fetch (TEXTSTREAM TEXTOBJ) of STREAM))
          SOURCESTREAM TOOBJ)                                (* ; 
                                           "get the character looks of the first character of SOURCE")
         (if (type? SELECTION SOURCE)
             then (SETQ SOURCESTREAM (OR (GETSEL SOURCE SELTEXTSTREAM)
                                         STREAM))
           elseif (FIXP SOURCE)
             then (SETQ SOURCESTREAM STREAM)
                  (SETQ SOURCE (\TEDIT.UPDATE.SEL (GETTOBJ TEXTOBJ SCRATCHSEL)
                                      SOURCE 1))
           else (\ILLEGAL.ARG SOURCE))
         (if (type? SELECTION DEST)
             then                                            (* ; 
                                      "make sure that the destination selection is in this document;")
                  (CL:UNLESS (OR (EQ STREAM (FGETSEL DEST SELTEXTSTREAM))
                                 (NULL (FGETSEL DEST SELTEXTSTREAM)))
                         (\LISPERROR "Destination selection is not in stream " STREAM))
           elseif (FIXP DEST)
             then (SETQ DEST (\TEDIT.UPDATE.SEL (FGETTOBJ TEXTOBJ SCRATCHSEL2)
                                    DEST 1))
           else (\ILLEGAL.ARG DEST))
         (\TEDIT.CHANGE.CHARLOOKS STREAM (PLOOKS (\TEDIT.CHTOPC (GETSEL SOURCE CH#)
                                                        SOURCESTREAM))
                DEST])

(\TEDIT.UNPARSE.CHARLOOKS.LIST
  [LAMBDA (LOOKS)                                            (* ; "Edited 31-Jul-2024 00:06 by rmk")
                                                             (* ; "Edited 24-Jul-2023 17:28 by rmk")
                                                             (* ; "Edited 11-Feb-2023 14:51 by rmk")
                                                             (* ; "Edited 30-May-91 21:45 by jds")

    (* ;; "Convert a CHARLOOKS into an equivalent PList-form for external consumption")

    (LET (NEWLOOKS OFFSET)
         (SETQ NEWLOOKS
          (for PROP in (LIST (fetch (CHARLOOKS CLSTYLE) of LOOKS)
                             (fetch (CHARLOOKS CLUSERINFO) of LOOKS)
                             (ONOFF (fetch (CHARLOOKS CLINVERTED) of LOOKS))
                             (FONTPROP (fetch (CHARLOOKS CLFONT) of LOOKS)
                                    'WEIGHT)
                             (FONTPROP (fetch (CHARLOOKS CLFONT) of LOOKS)
                                    'SLOPE)
                             (FONTPROP (fetch (CHARLOOKS CLFONT) of LOOKS)
                                    'EXPANSION)
                             (ONOFF (fetch (CHARLOOKS CLULINE) of LOOKS))
                             (ONOFF (fetch (CHARLOOKS CLSTRIKE) of LOOKS))
                             (ONOFF (fetch (CHARLOOKS CLOLINE) of LOOKS))
                             (ONOFF (fetch (CHARLOOKS CLUNBREAKABLE) of LOOKS))
                             (FONTPROP (fetch (CHARLOOKS CLFONT) of LOOKS)
                                    'FAMILY)
                             (FONTPROP (fetch (CHARLOOKS CLFONT) of LOOKS)
                                    'SIZE)
                             (ONOFF (fetch (CHARLOOKS CLPROTECTED) of LOOKS))
                             (ONOFF (fetch (CHARLOOKS CLSELAFTER) of LOOKS))
                             (ONOFF (fetch (CHARLOOKS CLINVISIBLE) of LOOKS))) as PROPNAME
             in '(STYLE USERINFO INVERTED WEIGHT SLOPE EXPANSION UNDERLINE STRIKEOUT OVERLINE 
                        UNBREAKABLE FAMILY SIZE PROTECTED SELECTPOINT INVISIBLE)
             join (LIST PROPNAME PROP)))
         (SETQ OFFSET (fetch (CHARLOOKS CLOFFSET) of LOOKS))
         (push NEWLOOKS (COND
                           ((IGREATERP OFFSET 0)
                            'SUPERSCRIPT)
                           ((ILESSP OFFSET 0)
                            'SUBSCRIPT)
                           (T 'SUPERSCRIPT))
               (IABS (OR OFFSET 0)))
         NEWLOOKS])

(\TEDIT.MODIFYLOOKS
  [LAMBDA (LINE STARTX DS LOOKS LINEBASEY)                   (* ; "Edited 20-Nov-2023 14:18 by rmk")
                                                             (* ; "Edited 27-May-2023 12:11 by rmk")
                                                             (* ; "Edited 24-Sep-2022 11:12 by rmk")
                                                             (* ; "Edited 30-May-91 21:45 by jds")

    (* ;; "Modify the screen to allow for underlining, etc.  Also, restore the vertical offset to the baseline.")

    (LET ((CURX (DSPXPOSITION NIL DS))
          (CURY (DSPYPOSITION NIL DS))
          (FONT (fetch (CHARLOOKS CLFONT) of LOOKS)))
         (CL:WHEN (fetch (CHARLOOKS CLULINE) of LOOKS)       (* ; "It's underlined.")
             (MOVETO STARTX (ADD1 (IDIFFERENCE (IPLUS CURY)
                                         (GETLD LINE LTRUEDESCENT)))
                    DS)
             (RELDRAWTO (IDIFFERENCE CURX STARTX)
                    0 1 'PAINT DS))
         (CL:WHEN (fetch (CHARLOOKS CLOLINE) of LOOKS)       (* ; "Over-line")
             (MOVETO STARTX [IPLUS CURY (SUB1 (FONTPROP FONT 'ASCENT]
                    DS)
             (RELDRAWTO (IDIFFERENCE CURX STARTX)
                    0 1 'PAINT DS))
         (CL:WHEN (fetch (CHARLOOKS CLSTRIKE) of LOOKS)      (* ; "Struck-thru")
             (MOVETO STARTX (IPLUS CURY (IQUOTIENT (FONTPROP FONT 'ASCENT)
                                               3))
                    DS)
             (RELDRAWTO (IDIFFERENCE CURX STARTX)
                    0 1 'PAINT DS))
         (CL:WHEN (fetch (CHARLOOKS CLINVERTED) of LOOKS)    (* ; "Inverse video")
             (BLTSHADE BLACKSHADE DS STARTX (IDIFFERENCE CURY (FONTPROP FONT 'DESCENT))
                    (IDIFFERENCE CURX STARTX)
                    (FONTPROP FONT 'HEIGHT)
                    'INVERT))
         (MOVETO CURX LINEBASEY DS])

(TEDIT.NEW.FONT
  [LAMBDA (TEXTOBJ)                                          (* ; "Edited 29-Jun-2024 16:31 by rmk")
                                                             (* jds " 8-Feb-85 11:27")
    (LET [(NAME (\TEDIT.MAKEFILENAME (TEDIT.GETINPUT TEXTOBJ "Name of font:  "]
         (CL:WHEN NAME
             [SETQ TEDIT.KNOWN.FONTS (NCONC1 TEDIT.KNOWN.FONTS (LIST NAME (KWOTE (U-CASE NAME]
             (U-CASE NAME))])

(\TEDIT.CARETLOOKS.VERIFY
  [LAMBDA (TEXTOBJ NEWLOOKS)                                 (* ; "Edited 15-Oct-2023 20:13 by rmk")
                                                             (* ; "Edited 30-May-91 21:41 by jds")

    (* ;; "Check with the user's CARETLOOKSFN to see if he wants to make changes")

    (LET ((CARETFN (GETTEXTPROP TEXTOBJ 'CARETLOOKSFN))
          LOOKS)
         (SETQ LOOKS (AND CARETFN (APPLY* CARETFN NEWLOOKS TEXTOBJ)))
         (if (EQ LOOKS 'DON'T)
             then                                            (* ; "He said not to change the looks.")
                  (OR (FGETTOBJ TEXTOBJ CARETLOOKS)
                      (FGETTOBJ TEXTOBJ DEFAULTCHARLOOKS))
           else (\TEDIT.UNIQUIFY.CHARLOOKS (OR LOOKS NEWLOOKS)
                       TEXTOBJ])

(\TEDIT.CARETPIECE
  [LAMBDA (TEXTOBJ)                                          (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited  6-Apr-2023 21:32 by rmk")
    (\TEDIT.CHTOPC (TEDIT.GETPOINT TEXTOBJ)
           TEXTOBJ])

(\TEDIT.GET.INSERT.CHARLOOKS
  [LAMBDA (TEXTOBJ SEL)                                      (* ; "Edited 23-Oct-2024 00:04 by rmk")
                                                             (* ; "Edited 31-Jul-2024 12:10 by rmk")
                                                             (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited 16-Feb-2024 22:48 by rmk")
                                                             (* ; "Edited 15-Dec-2023 08:40 by rmk")
                                                             (* ; "Edited  3-Aug-2023 22:39 by rmk")
                                                             (* ; "Edited  9-Oct-2022 13:57 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:21 by rmk")
                                                             (* ; "Edited 30-May-91 21:45 by jds")

    (* ;; "We want to get the looks of a selected character. If point is RIGHT, that's the last character of the selection.  If LEFT, the first character of the selection.")

    (* ;; "Return the looks at SEL, or defaults. Reset CLPROTECTED if need be.")

    (LET ((PC (\TEDIT.CHTOPC [IMAX 1 (IMIN (FGETTOBJ TEXTOBJ TEXTLEN)
                                           (SELECTQ (GETSEL SEL POINT)
                                               (LEFT (ADD1 (TEDIT.GETPOINT TEXTOBJ SEL)))
                                               (RIGHT (SUB1 (TEDIT.GETPOINT TEXTOBJ SEL)))
                                               (\TEDIT.THELP "BAD POINT"]
                     TEXTOBJ))
          LOOKS)
         (SETQ LOOKS (if PC
                         then (PLOOKS PC)
                       elseif (FGETTOBJ TEXTOBJ DEFAULTCHARLOOKS)
                       else (\TEDIT.CHARLOOKS.FROM.FONT DEFAULTFONT)))
         (CL:WHEN (fetch (CHARLOOKS CLPROTECTED) of LOOKS)   (* ; 
                                                           "Unprotect by copying to a new CHARLOOKS.")
             (SETQ LOOKS (create CHARLOOKS using LOOKS CLPROTECTED _ NIL CLSELAFTER _ NIL)))
         (\TEDIT.CARETLOOKS.VERIFY TEXTOBJ LOOKS])

(\TEDIT.GET.TERMSA.WIDTHS
  [LAMBDA (TERMSA FONT)                                      (* jds "22-OCT-83 21:36")

         (* If the guy is using a terminal table, get an updated set of widths to reflect 
         that.)

    (PROG ((NWIDTHS (ARRAY 256 'SMALLP 0 0)))
          (for I from 0 to 255 do (\WORDSETA NWIDTHS I (TEDIT.CHARWIDTH I FONT TERMSA)))
          (RETURN NWIDTHS])

(\TEDIT.PARSE.CHARLOOKS.LIST
  [LAMBDA (NEWLOOKS DEFAULTCLOOKS TEXTOBJ)                   (* ; "Edited 10-Aug-2024 23:52 by rmk")
                                                             (* ; "Edited 31-Jul-2024 12:10 by rmk")
                                                             (* ; "Edited 13-Nov-2023 01:08 by rmk")
                                                             (* ; "Edited 11-Nov-2023 16:09 by rmk")
                                                             (* ; "Edited 16-Oct-2023 09:02 by rmk")
                                                             (* ; "Edited 24-Jul-2023 17:24 by rmk")
                                                             (* ; "Edited 30-May-91 21:46 by jds")

    (* ;; "NEWLOOKS is either a CHARLOOKS, a FONTDESCRIPTOR, or a PLIST-format looks spec.  If NEWLOOKS is not already a CHARLOOKS, it is coerced into one.")

    (if (type? CHARLOOKS NEWLOOKS)
        then NEWLOOKS
      elseif (FONTP NEWLOOKS)
        then (\TEDIT.CHARLOOKS.FROM.FONT NEWLOOKS)
      else (\TEDIT.CHANGE.CHARLOOKS.NEW NEWLOOKS DEFAULTCLOOKS TEXTOBJ])

(\TEDIT.CHARLOOK.FEATURE
  [LAMBDA NARGS                                              (* ; "Edited 21-Oct-2024 00:26 by rmk")
                                                             (* ; "Edited 31-Jul-2024 00:06 by rmk")
                                                             (* ; "Edited 27-Jul-2024 20:36 by rmk")

    (* ;; "Returns the current value for the given FNAME in CHARLOOKS.  If 3 arguments, tries to set a new value.  Some of the font-related values are tricky:  setting e.g. the SIZE should not ony set the CLSIZE, but also change the font to be consistent.")

    (LET ((CHARLOOKS (ARG NARGS 1))
          (FNAME (ARG NARGS 2))
          (HASVALUE (EQ NARGS 3))
          (NEWVALUE (AND)
                 (EQ NARGS 3)
                 (ARG NARGS 3)))
         (CL:WHEN (EQ NEWVALUE 'OFF)
                (SETQ NEWVALUE NIL))
         (SELECTQ FNAME
             (BOLD (PROG1 (FGETCLOOKS CHARLOOKS CLBOLD)
                       (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLBOLD NEWVALUE))))
             (ITALIC (PROG1 (FGETCLOOKS CHARLOOKS CLITAL)
                         (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLITAL NEWVALUE))))
             ((FAMILY NAME) 
                  (PROG1 (FGETCLOOKS CHARLOOKS CLNAME)
                      (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLNAME NEWVALUE))))
             (FONT (PROG1 (FGETCLOOKS CHARLOOKS CLFONT)
                       (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLFONT NEWVALUE))))
             (INVERTED (PROG1 (FGETCLOOKS CHARLOOKS CLINVERTED)
                           (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLINVERTED NEWVALUE))))
             (INVISIBLE (PROG1 (FGETCLOOKS CHARLOOKS CLINVISIBLE)
                            (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLINVISIBLE NEWVALUE))))
             (OFFSET (PROG1 (FGETCLOOKS CHARLOOKS CLOFFSET)
                         (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLOFFSET NEWVALUE))))
             (OFFSETINCREMENT 
                  (PROG1 0                                   (* ; "What else?")
                      (CL:WHEN HASVALUE
                          (change (FGETCLOOKS CHARLOOKS CLOFFSET)
                                 (CL:IF (ILESSP DATUM 0)
                                     (IDIFFERENCE DATUM NEWVALUE)
                                     (IPLUS DATUM NEWVALUE))))))
             (OVERLINE (PROG1 (FGETCLOOKS CHARLOOKS CLOLINE)
                           (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLOLINE NEWVALUE))))
             (PROTECTED (PROG1 (FGETCLOOKS CHARLOOKS CLPROTECTED)
                            (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLPROTECTED NEWVALUE))))
             (SELECTPOINT (PROG1 (FGETCLOOKS CHARLOOKS CLSELAFTER)
                              (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLSELAFTER NEWVALUE))))
             (SIZE (PROG1 (FGETCLOOKS CHARLOOKS CLSIZE)
                       (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLSIZE NEWVALUE))))
             (SIZEINCREMENT '(PROG1 (FGETCLOOKS CHARLOOKS SIZEINCREMENT)
                                 (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS SIZEINCREMENT NEWVALUE))))
             (SMALLCAPS (PROG1 (FGETCLOOKS CHARLOOKS CLSMALLCAP)
                            (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLSMALLCAP NEWVALUE))))
             (STRIKEOUT (PROG1 (FGETCLOOKS CHARLOOKS CLSTRIKE)
                            (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLSTRIKE NEWVALUE))))
             (STYLE (PROG1 (FGETCLOOKS CHARLOOKS CLSTYLE)
                        (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLSTYLE NEWVALUE))))
             (SUBSCRIPT (PROG1 (FGETCLOOKS CHARLOOKS CLOFFSET)
                            (CL:WHEN HASVALUE
                                (FSETCLOOKS CHARLOOKS CLOFFSET (IMINUS NEWVALUE)))))
             (SUPERSCRIPT (PROG1 (FGETCLOOKS CHARLOOKS CLOFFSET)
                              (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLOFFSET NEWVALUE))))
             (UNBREAKABLE (PROG1 (FGETCLOOKS CHARLOOKS CLUNBREAKABLE)
                              (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLUNBREAKABLE NEWVALUE))))
             (UNDERLINE (PROG1 (FGETCLOOKS CHARLOOKS CLULINE)
                            (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLULINE NEWVALUE))))
             (USERINFO (PROG1 (FGETCLOOKS CHARLOOKS CLUSERINFO)
                           (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS CLUSERINFO NEWVALUE))))
             (PROGN                                          (* ; "These are alternative/overlays")
                    '(SELECTQ FNAME
                         (EXPANSION (PROG1 (FGETCLOOKS CHARLOOKS EXPANSION)
                                        (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS EXPANSION NEWVALUE))))
                         (FACE (PROG1 (FONTPROP (FGETCLOOKS CHARLOOKS CLFONT)
                                             FACE)
                                   (CL:WHEN HASVALUE         (* ; 
                                                            "Would have to reset the fields and font")
                                       (\TEDIT.THELP "CAN'T SET FACE"))))
                         (FAMILY (PROG1 (FONTPROP (FGETCLOOKS CHARLOOKS CLFONT)
                                               FAMILY)
                                     (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS FAMILY NEWVALUE))))
                         (SLOPE (PROG1 (FGETCLOOKS CHARLOOKS SLOPE)
                                    (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS SLOPE NEWVALUE))))
                         (WEIGHT (PROG1 (FGETCLOOKS CHARLOOKS WEIGHT)
                                     (CL:WHEN HASVALUE (FSETCLOOKS CHARLOOKS WEIGHT NEWVALUE)))])
)
(DEFINEQ

(\TEDIT.TRANSLATE.ASCIICHARS
  [LAMBDA (TEXTOBJ NOASCIIFONTS)                             (* ; "Edited 23-Sep-2024 00:50 by rmk")
                                                             (* ; "Edited 17-Mar-2024 00:25 by rmk")
                                                             (* ; "Edited  1-Dec-2023 22:28 by rmk")
                                                             (* ; "Edited 27-Nov-2023 16:13 by rmk")
                                                             (* ; "Edited 26-Nov-2023 11:19 by rmk")
                                                             (* ; "Edited 14-Nov-2023 19:21 by rmk")
                                                             (* ; "Edited  9-Nov-2023 23:56 by rmk")

    (* ;; "Converts characters in Alto/Ascii font pieces to their XCCS character and font (more or less) equivalents.  The affected characters are put in their own string pieces with their new CHARLOOKS.  Asciifont pieces are completely replaced if NOASCIIFONTS, otherwise untranslated characters remain in their Asciifonts.")

    (* ;; "It is tricky to mix the pieces iteration with the TEDIT.RPLCHARCODE, the within-piece indexing has to be adjusted to continue the iteration,because the replacement may split the piece. ")

    (* ;; "ASCIITONSTRANSLATIONS and the mapping arrays are from INTERPRESS.")

    (* ;; "\ASCIITOSTAR is the default translation array, for Gacha, Timesromand.  HIPPO, MATH ... have their own.")

    (DECLARE (GLOBALVARS ASCIITONSTRANSLATIONS \ASCIITOSTAR))
    (SETQ TEXTOBJ (TEXTOBJ TEXTOBJ))
    (CL:WHEN (thereis CL in (FGETTOBJ TEXTOBJ TXTCHARLOOKSLIST)
                unless (EQ 'CLASSIC (fetch (CHARLOOKS CLNAME) of CL))
                suchthat 

                      (* ;; "CLASSIC is in the list presumably to provide a coercion to MODERN for Interpress. We don't want to translate it.")

                      (ASSOC (fetch (CHARLOOKS CLNAME) of CL)
                             ASCIITONSTRANSLATIONS))
        (for PC CLOOKS TRANS MAPARRAY NEWFONTNAME STRING FAT CLOOKSLIST CLNAME TARRAYLAST
           inpieces (\TEDIT.FIRSTPIECE TEXTOBJ) eachtime (SETQ CLOOKS (PLOOKS PC))
                                                      (SETQ CLNAME (fetch (CHARLOOKS CLNAME)
                                                                      of CLOOKS))
           unless (OR (EQ OBJECT.PTYPE (PTYPE PC))
                      (EQ CLNAME 'CLASSIC)) when (SETQ TRANS (ASSOC CLNAME ASCIITONSTRANSLATIONS))
           do 
              (* ;; "PC needs some work.")

              (SETQ MAPARRAY (CADR TRANS))
              (SETQ NEWFONTNAME (CADDR TRANS))
              (CL:WHEN MAPARRAY                              (* ; 
                                                             "Idiosyncratic fonts (MATH, CYRILLIC). ")
                  (SETQ MAPARRAY (GETATOMVAL MAPARRAY))      (* ; "Global value")
                  (CL:WHEN (AND NOASCIIFONTS (PREVPIECE PC))

                      (* ;; " Look backward for NEWFONTNAME, since that piece has already been coerced.  The idea is to get Cyrillic to continue the previous looks (serif, san-serif)")

                      [SETQ NEWFONTNAME (fetch (CHARLOOKS CLNAME) of (PLOOKS (PREVPIECE PC]))
              (if (OR MAPARRAY NOASCIIFONTS)
                  then 
                       (* ;; "Translate all characters in idiosyncratic fonts, flush everything and change the looks even for Helvetica etc. if NO ALTOFONTS")

                       (CL:UNLESS MAPARRAY (SETQ MAPARRAY \ASCIITOSTAR))
                       (SETQ TARRAYLAST (SUB1 (ARRAYSIZE MAPARRAY))) 

                       (* ;; "Create a string with the translated codes, then convert the existing piece to a string piece holding that string.")

                       (SETQ STRING (ALLOCSTRING (PLEN PC)))
                       (for OFFSET CODE NEWCODE from 1 to (PLEN PC)
                          do 
                             (* ;; 
                        "Out-of-range alone and zero newcodes alone (some arrays are not filled in).")

                             (SETQ CODE (\TEDIT.PIECE.NTHCHARCODE TEXTOBJ PC OFFSET))
                             (RPLCHARCODE STRING OFFSET (if [OR (IGREATERP CODE TARRAYLAST)
                                                                (ZEROP (SETQ NEWCODE (ELT MAPARRAY 
                                                                                          CODE]
                                                            then CODE
                                                          else NEWCODE)))
                       (SETQ FAT (ffetch (STRINGP FATSTRINGP) of STRING))
                       (FSETPC PC PTYPE (CL:IF FAT
                                            FATSTRING.PTYPE
                                            THINSTRING.PTYPE))
                       (FSETPC PC PCONTENTS STRING)
                       (FSETPC PC PFPOS NIL)
                       (FSETPC PC PBINABLE (NOT FAT))
                       (FSETPC PC PBYTESPERCHAR (CL:IF FAT
                                                    2
                                                    1))
                       (FSETPC PC PBYTELEN (CL:IF FAT
                                               (UNFOLD (PLEN PC)
                                                      2)
                                               (PLEN PC)))
                       (FSETPC PC PLOOKS (\TEDIT.TRANSLATE.ASCII.CHARLOOKS TEXTOBJ CLOOKS NEWFONTNAME
                                                ))
                else 
                     (* ;; "Must be a text font (GACHA, TIMESROMAN, HELVETICA)  \ASCIITOSTAR is the translation array, mostly identities.")

                     (* ;; "TEDIT.RPLCHARCODE shortens our PC after each replacement so that it holds the suffix of characters after that.  So the offset for PIECES.NTHCHARCODE has to go back to 1 after each replacement (it is indexed starting at 1). CHNO for TEDIT.RPLCHARCODE doesn't need to be set before the first translation, after that it just marches along.")

                     (bind (OFFSET _ 0)
                           OLDCODE NEWCODE CHNO eachtime (add OFFSET 1)
                                                      (SETQ OLDCODE (\TEDIT.PIECE.NTHCHARCODE TEXTOBJ
                                                                           PC OFFSET))
                                                      (CL:WHEN CHNO (add CHNO 1)) while OLDCODE
                        when (ILEQ OLDCODE 255) unless (EQ OLDCODE (SETQ NEWCODE (ELT \ASCIITOSTAR 
                                                                                      OLDCODE)))
                        do (CL:UNLESS CHNO                   (* ; 
                                                             "First time, somewhere down the piece. ")
                               (SETQ CHNO (IPLUS OFFSET (\TEDIT.PCTOCH PC TEXTOBJ))))
                           (TEDIT.RPLCHARCODE TEXTOBJ CHNO NEWCODE (FSETPC PC PLOOKS
                                                                          (
                                                                     \TEDIT.TRANSLATE.ASCII.CHARLOOKS
                                                                           TEXTOBJ CLOOKS NEWFONTNAME
                                                                           ))) 

                           (* ;; "Set OFFSET back to the beginning of the now-shortened PC")

                           (SETQ OFFSET 0))) finally 

                                 (* ;; "Here we change the default and caret looks.  Perhaps this should be done only if NOASCIIFONTS.  But there is a risk that Ascii fonts and characters would slip in by future editing.  ")

                                                   (CL:WHEN NOASCIIFONTS
                                                       (SETQ CLOOKS (FGETTOBJ TEXTOBJ 
                                                                           DEFAULTCHARLOOKS))
                                                       (SETQ CLNAME (fetch (CHARLOOKS CLNAME)
                                                                       of CLOOKS))
                                                       (CL:WHEN (AND (NEQ CLNAME 'CLASSIC)
                                                                     (SETQ TRANS (ASSOC CLNAME 
                                                                                ASCIITONSTRANSLATIONS
                                                                                        )))
                                                           (FSETTOBJ TEXTOBJ DEFAULTCHARLOOKS
                                                                  (\TEDIT.TRANSLATE.ASCII.CHARLOOKS
                                                                   TEXTOBJ CLOOKS (CADDR TRANS))))
                                                       (SETQ CLOOKS (FGETTOBJ TEXTOBJ CARETLOOKS))
                                                       (SETQ CLNAME (fetch (CHARLOOKS CLNAME)
                                                                       of CLOOKS))
                                                       (CL:WHEN (AND (NEQ CLNAME 'CLASSIC)
                                                                     (SETQ TRANS (ASSOC CLNAME 
                                                                                ASCIITONSTRANSLATIONS
                                                                                        )))
                                                           (FSETTOBJ TEXTOBJ CARETLOOKS
                                                                  (\TEDIT.TRANSLATE.ASCII.CHARLOOKS
                                                                   TEXTOBJ CLOOKS (CADDR TRANS)))))
                                                   (CL:WHEN CLOOKSLIST

                                                       (* ;; 
                                             "Something happened, get rid of any lingering old looks")

                                                       (\TEDIT.UNIQUIFY.ALL TEXTOBJ))))])

(\TEDIT.CONVERT.TO.FORMATTED
  [LAMBDA (TSTREAM START END)                                (* ; "Edited  7-Jul-2024 09:06 by rmk")
                                                             (* ; "Edited 10-May-2024 22:42 by rmk")
                                                             (* ; "Edited  6-May-2024 23:49 by rmk")
                                                             (* ; "Edited 29-Apr-2024 10:42 by rmk")
                                                             (* ; "Edited 20-Mar-2024 11:00 by rmk")
                                                             (* ; "Edited 17-Mar-2024 12:06 by rmk")
                                                             (* ; "Edited 15-Mar-2024 13:53 by rmk")
                                                             (* ; "Edited  6-Jan-2024 15:10 by rmk")
                                                             (* ; "Edited 11-Dec-2023 10:02 by rmk")
                                                             (* ; "Edited  9-Nov-2023 15:37 by rmk")
                                                             (* ; "Edited  5-Nov-2023 11:22 by rmk")
                                                             (* ; "Edited 24-Sep-2023 23:30 by rmk")
                                                             (* ; "Edited 22-May-2023 22:50 by rmk")
                                                             (* ; "Edited 20-May-2023 16:44 by rmk")
                                                             (* ; "Edited  8-May-2023 08:44 by rmk")
                                                             (* ; "Edited 29-Apr-93 19:47 by jds")

    (* ;; "Turn an unformatted TEdit file into a formatted TEdit file, essentially simulating ANY.EOLC by ensuring that end-of-line indicators (CR, CRLF, LF) are canonicalized as EOL's and then interpreted as paragraph ends. Pieces are split so that EOLs are always at piece-end.  If it wasn't formatted before, it presumably didn't have any looks to worry about, just the defaults.")

    (* ;; "Using BIN for the main iteration is a little tricky when TEDIT.RPLCHARCODE is used to make the single-character change.  RPLCHARCODE can split the pieces and parameters in the TSTREAM that are used to drive the high-speed (BINABLE) operation.  It should perhaps figure out how to fix the stream internally, but for now the \TEXTSETFILEPTR gets things consistent again.")

    (LET [(TEXTOBJ (TEXTOBJ! (fetch (TEXTSTREAM TEXTOBJ) of TSTREAM]
         (CL:UNLESS (OR (FGETTOBJ TEXTOBJ FORMATTEDP)
                        (ZEROP (FGETTOBJ TEXTOBJ TEXTLEN)))
             (CL:UNLESS START (SETQ START 1))
             (CL:UNLESS END
                 (SETQ END (FGETTOBJ TEXTOBJ TEXTLEN)))
             (CL:WHEN (IGEQ END START)
                 [for CHNO CHANGED CRLF from START first 
                                                         (* ;; 
                                              "CHNO is in characters, one more than stream positions")

                                                         (\TEDIT.TEXTSETFILEPTR TSTREAM (SUB1 START))
                    do (SELCHARQ (BIN TSTREAM)
                            (LF 
                                (* ;; 
          "Linefeed not preceded by CR, replace by EOL and mark it paragraph-last.  What about FORM?")

                                (TEDIT.RPLCHARCODE TEXTOBJ CHNO (CHARCODE EOL))
                                (SETQ CHANGED T)
                                (FSETPC (\TEDIT.CHTOPC CHNO TEXTOBJ)
                                       PPARALAST T))
                            (CR 
                                (* ;; 
                    "Post-CR characters go to a separate piece, the CR piece is then paragraph-final")

                                (FSETPC (PREVPIECE (\TEDIT.ALIGNEDPIECE (ADD1 CHNO)
                                                          TEXTOBJ))
                                       PPARALAST T)
                                (CL:WHEN (EQ (CHARCODE LF)
                                             (\TEDIT.TEXTPEEKBIN TSTREAM T))

                                    (* ;; 
                     "Linefeed following CR.  Chop it off from whatever follows, and then delete it.")

                                    (SETQ CRLF T)
                                    (add END -1)             (* ; "One less char to do")
                                    (\TEDIT.DELETEPIECES (\TEDIT.SELPIECES (ADD1 CHNO)
                                                                (ADD1 CHNO)
                                                                TEXTOBJ)
                                           TEXTOBJ)

                                    (* ;; "We deleted the LF at CHNO, setting the fileptr there resynchronizes on the character just after it.")

                                    (\TEDIT.TEXTSETFILEPTR TSTREAM CHNO))
                                (SETQ CHANGED T))
                            NIL)                             (* ; 
                                                    "Test END explicitly, because it may get reduced")
                    repeatuntil (IGEQ CHNO END) finally (FSETTOBJ TEXTOBJ FORMATTEDP T)
                                                      (CL:WHEN CHANGED
                                                          (FSETTOBJ TEXTOBJ \DIRTY T)
                                                          (\TEDIT.UPDATE.LINES (CL:IF CRLF
                                                                                   'DELETION
                                                                                   'CHANGED)
                                                                 START
                                                                 (ADD1 (IDIFFERENCE END START))))]))])
)
(DECLARE%: EVAL@COMPILE 

(PUTPROPS \TEDIT.TRANSLATE.ASCII.CHARLOOKS MACRO
          [OPENLAMBDA (TEXTOBJ CLOOKS NEWFONTNAME)

            (* ;; "Macro because CLOOKSLIST is set.  The alist avoids creating and then uniquifying each time we want to make the same translation.")

            (CDR (OR (ASSOC CLOOKS CLOOKSLIST)
                     (CAR (PUSH CLOOKSLIST (CONS CLOOKS (\TEDIT.UNIQUIFY.CHARLOOKS
                                                         (create CHARLOOKS
                                                            using CLOOKS CLFONT _
                                                                  (\TEDIT.FONTCOPY
                                                                   (fetch (CHARLOOKS CLFONT)
                                                                      of CLOOKS)
                                                                   (LIST 'FAMILY NEWFONTNAME)
                                                                   TEXTOBJ)
                                                                  CLNAME _ NEWFONTNAME)
                                                         TEXTOBJ])
)
(DEFINEQ

(\TEDIT.UNIQUIFY.CHARLOOKS
  [LAMBDA (NEWLOOK TEXTOBJ)                                  (* ; "Edited 16-Mar-2024 00:32 by rmk")
                                                             (* ; "Edited 15-Oct-2023 17:17 by rmk")
                                                             (* ; "Edited 18-Aug-2023 21:47 by rmk")
                                                             (* ; "Edited 15-Aug-2023 20:57 by rmk")
                                                             (* ; "Edited  3-Aug-2023 17:52 by rmk")
                                                             (* ; "Edited 30-May-91 21:40 by jds")

    (* ;; "Assure that there is only ONE of a given CHARLOOKS in the document--so that all instances of that set of looks share structure. When we get a hit, we move it to the front, hopefully more frequent looks will come earlier in the list.")

    (CL:WHEN NEWLOOK
        (for LOOKTAIL LOOK PREVTAIL on (FGETTOBJ TEXTOBJ TXTCHARLOOKSLIST)
           do (SETQ LOOK (CAR LOOKTAIL))
              (CL:WHEN (\TEDIT.EQCLOOKS NEWLOOK LOOK)
                  (CL:WHEN PREVTAIL                          (* ; "Not already in first position")
                      (RPLACD PREVTAIL (CDR LOOKTAIL))
                      (push (FGETTOBJ TEXTOBJ TXTCHARLOOKSLIST)
                            LOOK))
                  (RETURN LOOK))
              (SETQ PREVTAIL LOOKTAIL) finally (push (FGETTOBJ TEXTOBJ TXTCHARLOOKSLIST)
                                                     NEWLOOK)
                                             (RETURN NEWLOOK)))])

(\TEDIT.UNIQUIFY.PARALOOKS
  [LAMBDA (NEWLOOK TEXTOBJ)                                  (* ; "Edited 16-Mar-2024 00:30 by rmk")
                                                             (* ; "Edited 18-Aug-2023 21:48 by rmk")
                                                             (* ; "Edited 30-May-91 21:41 by jds")

    (* ;; "Assure that there is only ONE of a given PARALOOKS in the document--so that all instances of that set of looks share structure. When we get a hit, we move it to the front, hopefully more frequent looks will come earlier in the list.")

    (for LOOKTAIL LOOK PREVTAIL on (GETTOBJ TEXTOBJ TXTPARALOOKSLIST)
       do (SETQ LOOK (CAR LOOKTAIL))
          (CL:WHEN (\TEDIT.EQFMTSPEC NEWLOOK LOOK)
              (CL:WHEN PREVTAIL                              (* ; "Not already in first position")
                  (RPLACD PREVTAIL (CDR LOOKTAIL))
                  (push (GETTOBJ TEXTOBJ TXTPARALOOKSLIST)
                        LOOK))
              (RETURN LOOK))
          (SETQ PREVTAIL LOOKTAIL) finally (push (GETTOBJ TEXTOBJ TXTPARALOOKSLIST)
                                                 NEWLOOK)
                                         (RETURN NEWLOOK])

(\TEDIT.UNIQUIFY.ALL
  [LAMBDA (TEXTOBJ)                                          (* ; "Edited 16-Mar-2024 10:03 by rmk")
                                                             (* ; "Edited 14-Nov-2023 16:20 by rmk")
                                                             (* ; "Edited 25-Aug-2023 08:57 by rmk")
                                                             (* ; "Edited 15-Aug-2023 22:04 by rmk")
                                                             (* ; "Edited  3-Aug-2023 18:44 by rmk")
                                                             (* ; "Edited  1-Aug-2023 11:43 by rmk")
                                                             (* ; "Edited 13-Jul-2022 22:56 by rmk")
    (SETTOBJ TEXTOBJ TXTCHARLOOKSLIST NIL)
    (SETTOBJ TEXTOBJ TXTPARALOOKSLIST NIL)
    (for PC inpieces (\TEDIT.FIRSTPIECE TEXTOBJ) do 
                                                    (* ;; 
                           "Assure that the CHARLOOKS and PARALOOKS of every piece are in the cache.")

                                                    (change (PLOOKS PC)
                                                           (\TEDIT.UNIQUIFY.CHARLOOKS DATUM TEXTOBJ))
                                                    (change (PPARALOOKS PC)
                                                           (\TEDIT.UNIQUIFY.PARALOOKS DATUM TEXTOBJ))
         )
    (CL:WHEN (GETTOBJ TEXTOBJ DEFAULTCHARLOOKS)
        (change (GETTOBJ TEXTOBJ DEFAULTCHARLOOKS)
               (\TEDIT.UNIQUIFY.CHARLOOKS DATUM TEXTOBJ)))
    (change (GETTOBJ TEXTOBJ CARETLOOKS)
           (\TEDIT.UNIQUIFY.CHARLOOKS DATUM TEXTOBJ))
    (change (GETTOBJ TEXTOBJ FMTSPEC)
           (\TEDIT.UNIQUIFY.PARALOOKS DATUM TEXTOBJ])

(\TEDIT.FLUSH.UNUSED.LOOKS
  [LAMBDA (TEXTOBJ)                                          (* ; "Edited 16-Mar-2024 10:03 by rmk")
                                                             (* ; "Edited 25-Aug-2023 08:03 by rmk")
                                                             (* ; "Edited 15-Aug-2023 22:11 by rmk")
                                                             (* ; "Edited 30-May-91 21:47 by jds")

    (* ;; "Run thru the CHARLOOKS and PARALOOKS lists for this document, and flush any looks that aren't being used in the document itself.")

    (LET ((CHARLOOKS (GETTOBJ TEXTOBJ TXTCHARLOOKSLIST))
          (PARALOOKS (GETTOBJ TEXTOBJ TXTPARALOOKSLIST)))

         (* ;; "Reset the in-use mark in all looks")

         (for LOOKS in CHARLOOKS do (replace (CHARLOOKS CLMARK) of LOOKS with NIL))
         (for LOOKS in PARALOOKS do (replace (FMTSPEC FMTMARK) of LOOKS with NIL))

         (* ;; "Run thru the pieces in the document, marking the looks that are really in use.")

         (for PC inpieces (\TEDIT.FIRSTPIECE TEXTOBJ) do (replace (CHARLOOKS CLMARK)
                                                            of (PLOOKS PC) with T)
                                                         (replace (FMTSPEC FMTMARK)
                                                            of (PPARALOOKS PC) with T))

         (* ;; "Keep only those char and para looks that ARE being used.")

         (SETTOBJ TEXTOBJ TXTCHARLOOKSLIST (for LOOKS in CHARLOOKS when (fetch (CHARLOOKS CLMARK)
                                                                           of LOOKS)
                                              collect (replace (CHARLOOKS CLMARK) of LOOKS
                                                         with NIL)
                                                    LOOKS))
         (SETTOBJ TEXTOBJ TXTPARALOOKSLIST (for LOOKS in PARALOOKS when (fetch (FMTSPEC FMTMARK)
                                                                           of LOOKS)
                                              collect (replace (FMTSPEC FMTMARK) of LOOKS
                                                         with NIL)
                                                    LOOKS])
)



(* ;; "Public entries")

(DEFINEQ

(TEDIT.LOOKS
  [LAMBDA (TSTREAM NEWLOOKS SELORCH# LEN)                    (* ; "Edited 11-Aug-2024 18:11 by rmk")
                                                             (* ; "Edited  2-Aug-2024 08:46 by rmk")
                                                             (* ; "Edited 27-Jul-2024 23:49 by rmk")
                                                             (* ; "Edited 25-Jul-2024 15:01 by rmk")
                                                             (* ; "Edited 13-Jul-2024 16:04 by rmk")
                                                             (* ; "Edited 22-May-2024 13:55 by rmk")
                                                             (* ; "Edited  9-Feb-2024 11:40 by rmk")
                                                             (* ; "Edited 23-Dec-2023 14:12 by rmk")
                                                             (* ; "Edited 28-May-2023 13:56 by rmk")
                                                             (* ; "Edited 24-May-2023 23:12 by rmk")
                                                             (* ; "Edited 30-May-91 21:41 by jds")

    (* ;; "Programmatic interface for character looks in TEdit.  Applies to the LEN characters starting at SELORCH#, or the characters selected by SELORCH# if it is a selection.  Nothing to do if the selection isn't set.  POINT is preserved and used only to set the caret looks.")

    (SETQ TSTREAM (TEXTSTREAM TSTREAM))

    (* ;; "Ignores LEN if SELORCH# is a selection")

    [\TEDIT.CHANGE.CHARLOOKS TSTREAM NEWLOOKS (if (type? SELECTION SELORCH#)
                                                  then SELORCH#
                                                elseif SELORCH#
                                                  then (TEDIT.SETSEL TSTREAM SELORCH# LEN
                                                              'LEFT)
                                                else (TEXTSEL (fetch (TEXTSTREAM TEXTOBJ)
                                                                 of TSTREAM]

    (* ;; "Out of bounds or maybe a point selection, no text to change. Punt out after setting the caret looks.  Old code did not set the history, should we?")

    (TEDIT.CARETLOOKS TSTREAM NEWLOOKS)
    TSTREAM])

(TEDIT.GET.LOOKS
  [LAMBDA (TEXTOBJ CH#ORCHARLOOKS)                           (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited 14-Dec-2023 21:00 by rmk")
                                                             (* ; "Edited 21-Jun-2023 11:10 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:14 by rmk")
                                                             (* ; "Edited 30-May-91 21:44 by jds")

    (* ;; "Returns as a property list the looks denoted by CH#ORCHARLOOKS.")

    (SETQ TEXTOBJ (TEXTOBJ TEXTOBJ))
    (\TEDIT.UNPARSE.CHARLOOKS.LIST (if (type? CHARLOOKS CH#ORCHARLOOKS)
                                       then                  (* ; "Unparse the given looks.")
                                            CH#ORCHARLOOKS
                                     elseif (ZEROP (TEXTLEN TEXTOBJ))
                                       then                  (* ; 
                                                            "Empty document, use extant caret looks.")
                                            (FGETTOBJ TEXTOBJ CARETLOOKS)
                                     else (PLOOKS (\TEDIT.CHTOPC
                                                   (OR (FIXP CH#ORCHARLOOKS)
                                                       (GETSEL (if (type? SELECTION CH#ORCHARLOOKS)
                                                                   then CH#ORCHARLOOKS
                                                                 elseif (NULL CH#ORCHARLOOKS)
                                                                   then (TEXTSEL TEXTOBJ)
                                                                 else (\ILLEGAL.ARG CH#ORCHARLOOKS))
                                                              CH#))
                                                   TEXTOBJ])

(TEDIT.SUBLOOKS
  [LAMBDA (TEXTSTREAM OLDLOOKSLIST NEWLOOKSLIST)             (* ; "Edited  5-Jul-2024 22:54 by rmk")
                                                             (* ; "Edited 25-Jun-2024 11:59 by rmk")
                                                             (* ; "Edited 18-May-2024 16:22 by rmk")
                                                             (* ; "Edited 10-May-2024 22:42 by rmk")
                                                             (* ; "Edited 17-Mar-2024 17:17 by rmk")
                                                             (* ; "Edited  6-May-2024 17:27 by rmk")
                                                             (* ; "Edited 16-Mar-2024 10:03 by rmk")
                                                             (* ; "Edited 13-Nov-2023 00:26 by rmk")
                                                             (* ; "Edited 18-Apr-2023 23:53 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:06 by rmk")
                                                             (* ; "Edited 26-Apr-93 14:53 by jds")

(* ;;; "User entry to substitute one set of looks for another.  Goes through the whole textstream and whenever the looks match the characteristics of OLDLOOKSLIST which are specified, the characteristics listed in NEWLOOKSLIST are substituted.")

    (LET ((TEXTOBJ (TEXTOBJ TEXTSTREAM)))                    (* ; "Turn off the selection, first.")
         (CL:UNLESS (ZEROP (FGETTOBJ TEXTOBJ TEXTLEN))
             (for PC CHANGEMADE SEL FIRSTCHANGEDCHNO (NCHARSCHANGED _ 0)
                  (OLDLOOKS _ (\TEDIT.PARSE.CHARLOOKS.LIST OLDLOOKSLIST NIL TEXTOBJ))
                  (NEWLOOKS _ (\TEDIT.PARSE.CHARLOOKS.LIST NEWLOOKSLIST NIL TEXTOBJ))
                  (FEATURELIST _ (for A on OLDLOOKSLIST by (CDDR A) collect (CAR A)))
                inpieces (\TEDIT.FIRSTPIECE TEXTOBJ) as CH# from 1 by (PLEN PC)
                when (\TEDIT.SAMECLOOKS OLDLOOKS (PLOOKS PC)
                            FEATURELIST) do (CL:UNLESS CHANGEMADE
                                                (SETQ CHANGEMADE T)
                                                (SETQ SEL (FGETTOBJ TEXTOBJ SEL))
                                                (\TEDIT.SHOWSEL SEL NIL TEXTOBJ)
                                                (FSETTOBJ TEXTOBJ \DIRTY T)) 

                                            (* ;; 
  "Note that we may be creating new looks each time, depending on what is there and what is changed.")

                                            (FSETPC PC PLOOKS (\TEDIT.UNIQUIFY.CHARLOOKS
                                                               (\TEDIT.PARSE.CHARLOOKS.LIST
                                                                NEWLOOKSLIST
                                                                (PLOOKS PC)
                                                                TEXTOBJ)
                                                               TEXTOBJ)) 

                                       (* ;; "This goes piece by piece, each one adding to the collection of dirty lines.  We keep track of the first and last changes")

                                            (CL:UNLESS FIRSTCHANGEDCHNO (SETQ FIRSTCHANGEDCHNO CH#))
                                            (add NCHARSCHANGED (PLEN PC))
                finally (CL:WHEN (AND CHANGEMADE (\TEDIT.PRIMARYPANE TEXTOBJ))
                                                             (* ; "Update the screen image")
                            (\TEDIT.UPDATE.LINES TEXTOBJ 'LOOKS FIRSTCHANGEDCHNO NCHARSCHANGED)
                            (\TEDIT.FIXSEL SEL TEXTOBJ)
                            (\TEDIT.SHOWSEL SEL T TEXTOBJ))
                      (RETURN CHANGEMADE)))])

(TEDIT.FINDLOOKS
  [LAMBDA (TEXTSTREAM OLDLOOKSLIST CH#)                      (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited  3-Dec-2023 00:09 by rmk")
                                                             (* ; "Edited 13-Nov-2023 00:26 by rmk")
                                                             (* ; "Edited 18-Apr-2023 23:53 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:06 by rmk")
                                                             (* ; "Edited 26-Apr-93 14:53 by jds")

(* ;;; "Finds and selects the next substring of the text whose looks are a superset of OLDLOOKSLIST.")

    (LET ((TEXTOBJ (TEXTOBJ TEXTSTREAM)))                    (* ; "Turn off the selection, first.")
         (if (AND (FIXP CH#)
                  (IGEQ CH# 1)
                  (ILEQ CH# (FGETTOBJ TEXTOBJ TEXTLEN)))
           elseif (type? SELECTION CH#)
             then (SETQ CH# (TEDIT.GETPOINT TEXTOBJ CH#))
           elseif (NULL CH#)
             then (SETQ CH# (TEDIT.GETPOINT TEXTOBJ (FGETTOBJ TEXTOBJ SEL)))
           else (\ILLEGAL.ARG CH#))
         (CL:UNLESS (ZEROP (FGETTOBJ TEXTOBJ TEXTLEN))
             [for PC PCLAST FOUNDCH# (OLDLOOKS _ (\TEDIT.PARSE.CHARLOOKS.LIST OLDLOOKSLIST NIL 
                                                        TEXTOBJ))
                  (FEATURELIST _ (for A on OLDLOOKSLIST by (CDDR A) collect (CAR A)))
                inpieces (\TEDIT.CHTOPC CH# TEXTOBJ) when (\TEDIT.SAMECLOOKS OLDLOOKS (PLOOKS PC)
                                                                 FEATURELIST)
                do [SETQ PCLAST (find PC1 inpieces (NEXTPIECE PC)
                                   suchthat (NOT (\TEDIT.SAMECLOOKS OLDLOOKS (PLOOKS PC1)
                                                        FEATURELIST]
                   (SETQ PCLAST (CL:IF PCLAST
                                    (PREVPIECE PCLAST)
                                    PC))
                   (SETQ FOUNDCH# (\TEDIT.PCTOCH PC TEXTOBJ))
                   (TEDIT.SETSEL TEXTOBJ FOUNDCH# (IDIFFERENCE (IPLUS (\TEDIT.PCTOCH PCLAST)
                                                                      (PLEN PCLAST))
                                                         FOUNDCH#)
                          'RIGHT)
                   (TEDIT.NORMALIZECARET TEXTOBJ)
                   (RETURN (\TEDIT.COPYSEL (FGETTOBJ TEXTOBJ SEL])])
)
(DEFINEQ

(\TEDIT.CHANGE.CHARLOOKS
  [LAMBDA (TSTREAM NEWLOOKS TARGETSEL)                       (* ; "Edited 22-Oct-2024 23:37 by rmk")
                                                             (* ; "Edited  2-Oct-2024 14:22 by rmk")
                                                             (* ; "Edited 28-Sep-2024 17:58 by rmk")
                                                             (* ; "Edited 16-Aug-2024 22:41 by rmk")
                                                             (* ; "Edited 11-Aug-2024 21:12 by rmk")
                                                             (* ; "Edited  6-Aug-2024 09:33 by rmk")
                                                             (* ; "Edited 31-Jul-2024 12:05 by rmk")
                                                             (* ; "Edited 25-Jun-2024 11:59 by rmk")
                                                             (* ; "Edited 15-Mar-2024 14:23 by rmk")
                                                             (* ; "Edited 23-Dec-2023 15:24 by rmk")
                                                             (* ; "Edited 31-Oct-2023 19:40 by rmk")
                                                             (* ; "Edited 24-Jul-2023 17:20 by rmk")
                                                             (* ; "Edited 28-May-2023 14:38 by rmk")
                                                             (* ; "Edited 19-Apr-93 14:08 by jds")

(* ;;; "Internal programmatic interface to changing character looks.  DOES NOT CHANGE the current selection (unless it's the TARGETSEL).")

    (PROG ((TEXTOBJ (TEXTOBJ TSTREAM))
           SELPIECES NEWLOOKSLIST)                           (* ; 
                                                           "Construct the set of new looks to apply:")
          (CL:UNLESS TARGETSEL
              (SETQ TARGETSEL (TEXTSEL TEXTOBJ)))
          (CL:UNLESS (AND NEWLOOKS (FGETSEL TARGETSEL SET)
                          (NOT (\TEDIT.READONLY TSTREAM NIL (GETSEL TARGETSEL CH#)))
                          (ILEQ (GETSEL TARGETSEL CH#)
                                (TEXTLEN TEXTOBJ))
                          (IGEQ (GETSEL TARGETSEL CH#)
                                1))
                 (RETURN NIL))
          (if (type? CHARLOOKS NEWLOOKS)
              then (SETQ NEWLOOKS (\TEDIT.UNIQUIFY.CHARLOOKS NEWLOOKS TEXTOBJ))
            elseif (FONTP NEWLOOKS)
              then (SETQ NEWLOOKS (\TEDIT.UNIQUIFY.CHARLOOKS (\TEDIT.CHARLOOKS.FROM.FONT NEWLOOKS)
                                         TEXTOBJ))
            elseif (for PTAIL on NEWLOOKS by (CDDR PTAIL) unless (OR (\TEDIT.CHARLOOK.FEATUREP
                                                                      (CAR PTAIL))
                                                                     (NULL (CADR PTAIL)))
                      do 
                         (* ;; 
                      "OK if a known property or NIL value.  Caller can delete temporary properties.")

                         (TEDIT.PROMPTPRINT TSTREAM (CONCAT (CAR PTAIL)
                                                           
                                                        " is not a valid character property--aborted"
                                                           )
                                T T)
                         (RETURN T))
              then (RETURN))
          (SETQ SELPIECES (\TEDIT.SELPIECES TARGETSEL NIL TEXTOBJ))

     (* ;; "Verify that all of the new looks are OK before we change anything")

          [SETQ NEWLOOKSLIST (for PC OLDCHARLOOKS inselpieces SELPIECES
                                collect (SETQ OLDCHARLOOKS (PLOOKS PC))
                                      (OR (CL:IF (type? CHARLOOKS NEWLOOKS)
                                              NEWLOOKS
                                              (\TEDIT.CHANGE.CHARLOOKS.NEW NEWLOOKS OLDCHARLOOKS 
                                                     TEXTOBJ))
                                          (RETURN NIL]
          (CL:UNLESS NEWLOOKSLIST                            (* ; "At least one bad font?")
              (RETURN NIL))
          (for PC UNDOLIST NEWCHARLOOKS DIRTY (FIRSTCHAR _ (fetch (SELPIECES SPFIRSTCHAR)
                                                              of SELPIECES))
               OLDCHARLOOKS inselpieces SELPIECES as NEWCHARLOOKS in NEWLOOKSLIST
             do (SETQ OLDCHARLOOKS (PLOOKS PC))
                (add FIRSTCHAR (PLEN PC))                    (* ; 
                              "Beginning of next piece--where to stop undoing if new pieces inserted")
                (if (\TEDIT.EQCLOOKS OLDCHARLOOKS NEWCHARLOOKS)
                    then (SETQ OLDCHARLOOKS NIL)             (* ; "Undo skips if NIL")
                  else (FSETPC PC PLOOKS (\TEDIT.UNIQUIFY.CHARLOOKS NEWCHARLOOKS TEXTOBJ))
                       (CL:UNLESS DIRTY                      (* ; 
                                                     "Resetting DIRTY is expensive, only do it once ")
                           (FSETTOBJ TEXTOBJ \DIRTY T)
                           (SETQ DIRTY T)))
                (push UNDOLIST (CONS FIRSTCHAR OLDCHARLOOKS))
             finally 

                   (* ;; 
                 "Create an event even if no change, so that NEWLOOKS is still available for REDO.  ")

                   [\TEDIT.HISTORYADD TEXTOBJ (\TEDIT.HISTORY.EVENT TEXTOBJ :CharLooks SELPIECES NIL
                                                     NIL NIL (CONS NEWLOOKS (AND DIRTY (DREVERSE
                                                                                        UNDOLIST]
                   (CL:WHEN DIRTY                            (* ; "Something changed")
                       (CL:WHEN (\TEDIT.PRIMARYPANE TEXTOBJ)
                           (\TEDIT.SHOWSEL NIL NIL TEXTOBJ)
                           (SELECTQ (LISTGET NEWLOOKS 'INVISIBLE)
                               (ON 
                                   (* ;; 
                      "Previously visible characters have disappeared, drop the selection to a point")

                                   (\TEDIT.UPDATE.SEL (TEXTSEL TEXTOBJ)
                                          0
                                          'LEFT))
                               (OFF 
                                    (* ;; 
                                "Previously invisible characters have appeared, expand the selection")

                                    (\TEDIT.UPDATE.SEL (TEXTSEL TEXTOBJ)
                                           (GETSEL TARGETSEL CH#)
                                           (GETSEL TARGETSEL DCH)
                                           'RIGHT))
                               NIL)

                           (* ;; "Set caret looks to the looks of the last selected character--the looks of that piece may have been only partially modified")

                           (FSETTOBJ TEXTOBJ CARETLOOKS (PLOOKS (\TEDIT.CHTOPC (SUB1 (TEDIT.GETPOINT
                                                                                      TEXTOBJ))
                                                                       TEXTOBJ)))
                           (\TEDIT.RESET.EXTEND.PENDING.DELETE (TEXTSEL TEXTOBJ)
                                  TEXTOBJ)
                           (\TEDIT.UPDATE.LINES TEXTOBJ 'LOOKS SELPIECES)
                           (\TEDIT.FIXSEL (TEXTSEL TEXTOBJ)
                                  TEXTOBJ)
                           (\TEDIT.SHOWSEL NIL T TEXTOBJ)))])

(\TEDIT.CHANGE.CHARLOOKS.NEW
  [LAMBDA (NEWLOOKS OLDCHARLOOKS TEXTOBJ)                    (* ; "Edited 29-Aug-2024 11:12 by rmk")
                                                             (* ; "Edited 22-Aug-2024 10:50 by rmk")
                                                             (* ; "Edited 16-Aug-2024 18:23 by rmk")
                                                             (* ; "Edited 11-Aug-2024 00:12 by rmk")

    (* ;; "Make a new CHARLOOKS reflecting the properties in NEWLOOKS, with defaults taken from OLDCHARLOOKS, if given, or the DEFAULTCHARLOOKS of TEXTOBJ, if given,;")

    (* ;; "OLDCHARLOOKS is also used as the base for increments.")

    (CL:UNLESS OLDCHARLOOKS
        (CL:WHEN TEXTOBJ
            (SETQ OLDCHARLOOKS (GETTOBJ TEXTOBJ DEFAULTCHARLOOKS))))
    (for NLTAIL NEWFONT VAL NEWCHARLOOKS on NEWLOOKS by (CDDR NLTAIL)
       first (SETQ NEWFONT (\TEDIT.CHARLOOKS.CHANGE.FONT NEWLOOKS OLDCHARLOOKS TEXTOBJ))
             (CL:UNLESS NEWFONT                              (* ; "Bad font specification")
                 (RETURN NIL))
             [SETQ NEWCHARLOOKS (create CHARLOOKS using (OR OLDCHARLOOKS (AND TEXTOBJ
                                                                              (FGETTOBJ TEXTOBJ 
                                                                                     DEFAULTCHARLOOKS
                                                                                     ]
             (FSETCLOOKS NEWCHARLOOKS CLFONT NEWFONT)
             (FSETCLOOKS NEWCHARLOOKS CLNAME (FONTPROP NEWFONT 'FAMILY))
             [FSETCLOOKS NEWCHARLOOKS CLBOLD (EQ 'BOLD (FONTPROP NEWFONT 'WEIGHT]
             [FSETCLOOKS NEWCHARLOOKS CLITAL (EQ 'ITALIC (FONTPROP NEWFONT 'SLOPE]
             (FSETCLOOKS NEWCHARLOOKS CLSIZE (FONTPROP NEWFONT 'SIZE))
       do (SETQ VAL (CADR NLTAIL))
          (CL:WHEN (MEMB VAL '(NEUTRAL OFF))                 (* ; "Off and NEUTRAL both turn off")
              (SETQ VAL NIL)) 

          (* ;; "Skip the font attributes here, they have already been interpreted")

          (SELECTQ (CAR NLTAIL)
              (OVERLINE (FSETCLOOKS NEWCHARLOOKS CLOLINE VAL))
              (SUPERSCRIPT (FSETCLOOKS NEWCHARLOOKS CLOFFSET VAL))
              (SUBSCRIPT (FSETCLOOKS NEWCHARLOOKS CLOFFSET (IMINUS VAL)))
              (PROTECTED (FSETCLOOKS NEWCHARLOOKS CLPROTECTED VAL))
              (UNDERLINE (FSETCLOOKS NEWCHARLOOKS CLULINE VAL))
              (STYLE (FSETCLOOKS NEWCHARLOOKS CLSTYLE VAL))
              (UNBREAKABLE (FSETCLOOKS NEWCHARLOOKS CLUNBREAKABLE VAL))
              (STRIKEOUT (FSETCLOOKS NEWCHARLOOKS CLSTRIKE VAL))
              (INVERTED (FSETCLOOKS NEWCHARLOOKS CLINVERTED VAL))
              ((SELECTPOINT SELAFTER) 
                   (FSETCLOOKS NEWCHARLOOKS CLSELAFTER VAL))
              (SELBEFORE (FSETCLOOKS NEWCHARLOOKS CLSELBEFORE VAL))
              (OFFSETINCREMENT 
                   (FSETCLOOKS NEWCHARLOOKS CLOFFSET (IPLUS VAL (OR (AND OLDCHARLOOKS
                                                                         (FGETCLOOKS OLDCHARLOOKS 
                                                                                CLOFFSET))
                                                                    0))))
              (INVISIBLE (FSETCLOOKS NEWCHARLOOKS CLINVISIBLE VAL))
              NIL) finally (RETURN NEWCHARLOOKS])

(\TEDIT.CHARLOOKS.CHANGE.FONT
  [LAMBDA (NEWLOOKS OLDCHARLOOKS TEXTOBJ)                    (* ; "Edited  7-Sep-2024 13:08 by rmk")
                                                             (* ; "Edited 16-Aug-2024 18:25 by rmk")
                                                             (* ; "Edited 11-Aug-2024 00:11 by rmk")
                                                             (* ; "Edited 30-Jul-2024 22:36 by rmk")
                                                             (* ; "Edited 26-Jul-2024 14:55 by rmk")

    (* ;; "Converts all the independent font properties into a final list of font properties and uses them to create a new font, with defaults taken from the newly specified FONT property, or the font of OLDCHARLOOKS.    ")

    (PROG ((BASEFONT (OR (LISTGET NEWLOOKS 'FONT)
                         (FGETCLOOKS OLDCHARLOOKS CLFONT)))
           [FAMILY (CL:UNLESS (EQ 'OFF (LISTGET NEWLOOKS 'FAMILY))
                       (LISTGET NEWLOOKS 'FAMILY))]
           (FACE (LISTGET NEWLOOKS 'FACE))
           (WEIGHT (LISTGET NEWLOOKS 'WEIGHT))
           (SLOPE (LISTGET NEWLOOKS 'SLOPE))
           (EXPANSION (LISTGET NEWLOOKS 'EXPANSION))
           (SIZE (LISTGET NEWLOOKS 'SIZE))
           (SIZEINCREMENT (LISTGET NEWLOOKS 'SIZEINCREMENT))
           FONTSPEC NEWFONT)
          (CL:WHEN BASEFONT
              (if (OR (type? FONTCLASS BASEFONT)
                      (type? FONTDESCRIPTOR BASEFONT))
                elseif (SETQ NEWFONT (FONTCREATE BASEFONT NIL NIL NIL NIL T))
                  then 
                       (* ;; "BASEFONT could be a font specification--no error.")

                       (SETQ BASEFONT NEWFONT)
                else (if TEXTOBJ
                         then (TEDIT.PROMPTPRINT TEXTOBJ (CONCAT BASEFONT 
                                                                " isn't a valid font descriptor.")
                                     T T)
                              (RETURN)
                       else (ERROR BASEFONT " isn't a valid font descriptor."))))
          (CL:UNLESS WEIGHT
              (SETQ WEIGHT (SELECTQ (LISTGET NEWLOOKS 'BOLD)
                               (ON 'BOLD)
                               (OFF 'REGULAR)
                               NIL)))
          (CL:UNLESS SLOPE
              (SETQ SLOPE (SELECTQ (LISTGET NEWLOOKS 'ITALIC)
                              (ON 'ITALIC)
                              (OFF 'REGULAR)
                              NIL)))
          (CL:IF FAMILY
              (push FONTSPEC 'FAMILY FAMILY))
          (if (OR WEIGHT SLOPE EXPANSION)
              then                                           (* ; 
                                                   "Setting one of these inhibits the FACE parameter")
                   (CL:IF WEIGHT
                       (push FONTSPEC 'WEIGHT WEIGHT))
                   (CL:IF SLOPE
                       (push FONTSPEC 'SLOPE SLOPE))
                   (CL:IF EXPANSION
                       (push FONTSPEC 'EXPANSION EXPANSION))
            elseif FACE
              then (push FONTSPEC 'FACE FACE))
          (if SIZE
              then (push FONTSPEC 'SIZE SIZE)
            elseif SIZEINCREMENT
              then 
                   (* ;; "If a size increment is specified, then add to the newspecs arg for fontcopy, the entry with the incremented size from the current font.")

                   (push FONTSPEC 'SIZE (IPLUS (FGETCLOOKS OLDCHARLOOKS CLSIZE)
                                               SIZEINCREMENT)))
          (RETURN (\TEDIT.FONTCOPY BASEFONT FONTSPEC TEXTOBJ])

(\TEDIT.LOOKS
  [LAMBDA (TEXTOBJ)                                          (* ; "Edited 28-Jun-2024 21:52 by rmk")
                                                             (* ; "Edited 13-Jun-2024 22:10 by rmk")
                                                             (* ; "Edited  8-May-2023 21:21 by rmk")
                                                             (* ; "Edited 30-May-91 21:41 by jds")

    (* ;; "Handler for the middle-button menu's LOOKS button.  Brings up 3 menus, for font, face, and size.  Then calls TEDIT.LOOKS to make the requested changes.")

    (RESETLST
        [RESETSAVE (\TEDIT.MARKACTIVE TEXTOBJ)
               '(PROGN (\TEDIT.MARKINACTIVE OLDVALUE]
        [LET* ((SEL (GETTOBJ TEXTOBJ SEL))
               (REGION (WINDOWPROP (FGETTOBJ TEXTOBJ PRIMARYPANE)
                              'REGION))
               (POS (create POSITION
                           XCOORD _ (fetch (REGION LEFT) of REGION)
                           YCOORD _ (fetch (REGION TOP) of REGION)))
               FONT FACE SIZE NEWLOOKS)
              (CL:WHEN (ILEQ (GETSEL SEL CH#)
                             (TEXTLEN TEXTOBJ))              (* ; "Otherwise, nothing to change")
                  (COND
                     ((FGETSEL SEL SET)
                      (CURSORPOSITION (CREATEPOSITION 0 (fetch HEIGHT of REGION))
                             (FGETTOBJ TEXTOBJ PRIMARYPANE))
                      (SETQ FONT (MENU (create MENU
                                              TITLE _ "Font:"
                                              ITEMS _ (NCONC1 (COPY TEDIT.KNOWN.FONTS)
                                                             (LIST 'Other
                                                                   (LIST (FUNCTION TEDIT.NEW.FONT)
                                                                         TEXTOBJ)))
                                              CENTERFLG _ T)
                                       POS))                 (* ; "Set the font for the new text.")
                      (SETQ FACE (SELECTQ (MENU TEDIT.FACE.MENU POS)
                                     (Bold 'BOLD)
                                     (Italic 'ITALIC)
                                     (Bold% Italic 'BOLDITALIC)
                                     (Regular 'STANDARD)
                                     NIL))                   (* ; "Set the face (bold, etc.)")
                      (SETQ SIZE (MENU TEDIT.SIZE.MENU POS)) (* ; "Set the type size")
                                                             (* ; 
                                                           "Construct the set of new looks to apply:")
                      (SETQ NEWLOOKS (AND FONT (LIST 'FAMILY FONT)))
                      (CL:WHEN FACE
                          (SETQ NEWLOOKS (CONS 'FACE (CONS FACE NEWLOOKS))))
                      (CL:WHEN SIZE
                          (SETQ NEWLOOKS (CONS 'SIZE (CONS SIZE NEWLOOKS))))
                      (CL:WHEN NEWLOOKS                      (* ; "There's something to do.")
                          (TEDIT.LOOKS TEXTOBJ NEWLOOKS SEL)))
                     (T (TEDIT.PROMPTPRINT TEXTOBJ "Please select some text to modify" T))))])])

(\TEDIT.FONTCOPY
  [LAMBDA (FONT NEWSPECS TEXTOBJ)                            (* ; "Edited 11-Aug-2024 00:01 by rmk")
                                                             (* ; "Edited 22-Feb-2024 15:35 by rmk")
                                                             (* ; "Edited 12-Nov-2023 23:24 by rmk")
                                                             (* jds "26-Dec-84 16:06")

    (* ;; "Cloak FONTCOPY in protection for the user from an unavailable font.")

    (if (NULL NEWSPECS)
        then                                                 (* ; "No changes specified.  Punt it.")
             FONT
      elseif (CAR (NLSETQ (FONTCOPY FONT NEWSPECS)))
      else (LET [(MSG (CONCAT "Can't find font " (OR (LISTGET NEWSPECS 'FAMILY)
                                                     (FONTPROP FONT 'FAMILY))
                             " "
                             (OR (LISTGET NEWSPECS 'SIZE)
                                 (FONTPROP FONT 'SIZE))
                             " "
                             (OR (LISTGET NEWSPECS 'FACE)
                                 (FONTPROP FONT 'FACE]
                (if TEXTOBJ
                    then (TEDIT.PROMPTPRINT TEXTOBJ MSG T T)
                  else (ERROR MSG)))
           NIL])
)



(* ; "Paragraph looks functions")

(DEFINEQ

(\TEDIT.EQFMTSPEC
  [LAMBDA (PARALOOK1 PARALOOK2)                              (* ; "Edited 28-Jul-2024 21:29 by rmk")
                                                             (* ; 
                                                        "Edited  2-Jul-93 21:32 by sybalskY:MV:ENVOS")

    (* ;; "Given two sets of FMTSPECS, are they effectively the same?")

    (OR (EQ PARALOOK1 PARALOOK2)
        (AND (EQ (fetch (FMTSPEC QUAD) of PARALOOK1)
                 (fetch (FMTSPEC QUAD) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTNEWPAGEBEFORE) of PARALOOK1)
                 (ffetch (FMTSPEC FMTNEWPAGEBEFORE) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTNEWPAGEAFTER) of PARALOOK1)
                 (ffetch (FMTSPEC FMTNEWPAGEAFTER) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTSTYLE) of PARALOOK1)
                 (ffetch (FMTSPEC FMTSTYLE) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTSPECIALX) of PARALOOK1)
                 (ffetch (FMTSPEC FMTSPECIALX) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTSPECIALY) of PARALOOK1)
                 (ffetch (FMTSPEC FMTSPECIALY) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTHEADINGKEEP) of PARALOOK1)
                 (ffetch (FMTSPEC FMTHEADINGKEEP) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTKEEP) of PARALOOK1)
                 (ffetch (FMTSPEC FMTKEEP) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTPARATYPE) of PARALOOK1)
                 (ffetch (FMTSPEC FMTPARATYPE) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTPARASUBTYPE) of PARALOOK1)
                 (ffetch (FMTSPEC FMTPARASUBTYPE) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTHARDCOPY) of PARALOOK1)
                 (ffetch (FMTSPEC FMTHARDCOPY) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTREVISED) of PARALOOK1)
                 (ffetch (FMTSPEC FMTREVISED) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTCOLUMN) of PARALOOK1)
                 (ffetch (FMTSPEC FMTCOLUMN) of PARALOOK2))
             (EQP (ffetch (FMTSPEC 1STLEFTMAR) of PARALOOK1)
                  (ffetch (FMTSPEC 1STLEFTMAR) of PARALOOK2))
             (EQP (ffetch (FMTSPEC LEFTMAR) of PARALOOK1)
                  (ffetch (FMTSPEC LEFTMAR) of PARALOOK2))
             (EQP (ffetch (FMTSPEC RIGHTMAR) of PARALOOK1)
                  (ffetch (FMTSPEC RIGHTMAR) of PARALOOK2))
             (EQP (ffetch (FMTSPEC LEADBEFORE) of PARALOOK1)
                  (ffetch (FMTSPEC LEADBEFORE) of PARALOOK2))
             (EQP (ffetch (FMTSPEC LEADAFTER) of PARALOOK1)
                  (ffetch (FMTSPEC LEADAFTER) of PARALOOK2))
             (EQP (ffetch (FMTSPEC LINELEAD) of PARALOOK1)
                  (ffetch (FMTSPEC LINELEAD) of PARALOOK2))
             (EQP (ffetch (FMTSPEC FMTBASETOBASE) of PARALOOK1)
                  (ffetch (FMTSPEC FMTBASETOBASE) of PARALOOK2))
             (EQUAL (ffetch (FMTSPEC FMTUSERINFO) of PARALOOK1)
                    (ffetch (FMTSPEC FMTUSERINFO) of PARALOOK2))
             (EQUAL (ffetch (FMTSPEC FMTCHARSTYLES) of PARALOOK1)
                    (ffetch (FMTSPEC FMTCHARSTYLES) of PARALOOK2))
             (EQ (ffetch (FMTSPEC FMTDEFAULTTAB) of PARALOOK1)
                 (ffetch (FMTSPEC FMTDEFAULTTAB) of PARALOOK2))
             (EQUAL (ffetch (FMTSPEC FMTTABS) of PARALOOK1)
                    (ffetch (FMTSPEC FMTTABS) of PARALOOK2])

(TEDIT.GET.PARALOOKS
  [LAMBDA (TSTREAM SELORCH#)                                 (* ; "Edited  4-Aug-2024 17:17 by rmk")
                                                             (* ; "Edited 28-Jul-2024 16:25 by rmk")
                                                             (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited 11-Dec-2023 10:12 by rmk")
                                                             (* ; "Edited 22-Jun-2023 00:02 by rmk")
                                                             (* ; "Edited 11-Feb-2023 14:55 by rmk")
                                                             (* ; "Edited 30-May-91 21:44 by jds")

    (* ;; "Return a proplist of paragraph formatting information about the characters specified.")

    (LET* [(TEXTOBJ (TEXTOBJ TSTREAM))
           (PC (if (type? PIECE SELORCH#)
                   then 
                        (* ;; "An internal call, if we already have the piece.")

                        SELORCH#
                 else (\TEDIT.CHTOPC (OR (FIXP SELORCH#)
                                         (GETSEL (if (type? SELECTION SELORCH#)
                                                     then SELORCH#
                                                   elseif (NULL SELORCH#)
                                                     then (TEXTSEL TEXTOBJ)
                                                   else (\ILLEGAL.ARG SELORCH#))
                                                CH#))
                             TEXTOBJ)))
           (FMTSPEC (CL:IF PC
                        (PPARALOOKS PC)
                        (fetch (TEXTOBJ FMTSPEC) of TEXTOBJ))]
          (for PROP in (LIST (FGETPARA FMTSPEC QUAD)
                             (FGETPARA FMTSPEC 1STLEFTMAR)
                             (FGETPARA FMTSPEC LEFTMAR)
                             (FGETPARA FMTSPEC RIGHTMAR)
                             (FGETPARA FMTSPEC LEADBEFORE)
                             (FGETPARA FMTSPEC LEADAFTER)
                             (FGETPARA FMTSPEC LINELEAD)
                             (FGETPARA FMTSPEC FMTBASETOBASE)
                             (create TABSPEC
                                    DEFAULTTAB _ (FGETPARA FMTSPEC FMTDEFAULTTAB)
                                    TABS _ (COPY (FGETPARA FMTSPEC FMTTABS)))
                             (FGETPARA FMTSPEC FMTSTYLE)
                             (FGETPARA FMTSPEC FMTCHARSTYLES)
                             (FGETPARA FMTSPEC FMTUSERINFO)
                             (FGETPARA FMTSPEC FMTSPECIALX)
                             (FGETPARA FMTSPEC FMTSPECIALY)
                             (FGETPARA FMTSPEC FMTPARATYPE)
                             (FGETPARA FMTSPEC FMTPARASUBTYPE)
                             (ONOFF (FGETPARA FMTSPEC FMTNEWPAGEBEFORE))
                             (ONOFF (FGETPARA FMTSPEC FMTNEWPAGEAFTER))
                             (ONOFF (FGETPARA FMTSPEC FMTHEADINGKEEP))
                             (FGETPARA FMTSPEC FMTKEEP)
                             (ONOFF (FGETPARA FMTSPEC FMTHARDCOPY))
                             (FGETPARA FMTSPEC FMTREVISED)
                             (FGETPARA FMTSPEC FMTCOLUMN)) as PROPNAME
             in '(QUAD 1STLEFTMARGIN LEFTMARGIN RIGHTMARGIN PARALEADING POSTPARALEADING LINELEADING 
                       BASETOBASE TABS STYLE CHARSTYLES USERINFO SPECIALX SPECIALY TYPE SUBTYPE 
                       NEWPAGEBEFORE NEWPAGEAFTER HEADINGKEEP KEEP HARDCOPY REVISED COLUMN)
             join (LIST PROPNAME PROP])

(\TEDIT.PARSE.PARALOOKS.LIST
  [LAMBDA (NEWLOOKS OLDLOOKS TEXTOBJ)                        (* ; "Edited 28-Jul-2024 22:14 by rmk")
                                                             (* ; "Edited 29-Apr-2024 11:03 by rmk")
                                                             (* ; "Edited 17-Oct-2023 12:08 by rmk")
                                                             (* ; "Edited  9-May-2023 13:20 by rmk")
                                                             (* ; "Edited  5-Sep-2022 15:39 by rmk")
                                                             (* ; 
                                                        "Edited  3-Jul-93 21:49 by sybalskY:MV:ENVOS")
                                                             (* ; 
                        "Apply a given format spec to the paragraphs which are included in this guy.")
    (if (type? FMTSPEC NEWLOOKS)
        then                                                 (* ; 
                           "if we were given a FMTSPEC it replace the FMTSPEC of all pieces affected")
             NEWLOOKS
      else (LET (NEWFMT 1STLEFT LEFT RIGHT LEADB LEADA LLEAD TABSPEC QUADD NLOOKSAVE TYPE SUBTYPE 
                       TYPESET SUBTYPESET NEWBEFORESET NEWBEFORE NEWAFTERSET NEWAFTER KEEP KEEPSET 
                       HEADINGKEEP BASETOBASE BASESET REVISED REVISEDSET COLUMN COLUMNSET USERINFO 
                       USERINFOSET SPECIALX SPECXSET SPECIALY SPECYSET STYLE STYLESET CHARSTYLES 
                       CHARSTYLESSET DEFTAB TABS)            (* ; "create an FMTSPEC from the Plist")
                (SETQ 1STLEFT (LISTGET NEWLOOKS '1STLEFTMARGIN))
                (SETQ LEFT (LISTGET NEWLOOKS 'LEFTMARGIN))
                (SETQ RIGHT (LISTGET NEWLOOKS 'RIGHTMARGIN))
                (SETQ LEADB (LISTGET NEWLOOKS 'PARALEADING))
                (SETQ LEADA (LISTGET NEWLOOKS 'POSTPARALEADING))
                (SETQ LLEAD (LISTGET NEWLOOKS 'LINELEADING))
                (SETQ TYPESET (FMEMB 'TYPE NEWLOOKS))
                (SETQ TYPE (LISTGET NEWLOOKS 'TYPE))
                (SETQ SUBTYPESET (FMEMB 'SUBTYPE NEWLOOKS))
                (SETQ SUBTYPE (LISTGET NEWLOOKS 'SUBTYPE))
                (SETQ NEWBEFORESET (FMEMB 'NEWPAGEBEFORE NEWLOOKS))
                (SETQ NEWBEFORE (LISTGET NEWLOOKS 'NEWPAGEBEFORE))
                (SETQ NEWAFTERSET (FMEMB 'NEWPAGEAFTER NEWLOOKS))
                (SETQ NEWAFTER (LISTGET NEWLOOKS 'NEWPAGEAFTER))
                (SETQ HEADINGKEEP (LISTGET NEWLOOKS 'HEADINGKEEP))
                                                             (* ; "Keep for headings")
                (SETQ KEEP (LISTGET NEWLOOKS 'KEEP))         (* ; 
                                       "More general `Keep-together' spec -- undefined as of 5/22/85")
                (SETQ KEEPSET (FMEMB 'KEEP NEWLOOKS))
                (SETQ BASETOBASE (LISTGET NEWLOOKS 'BASETOBASE))
                (SETQ BASESET (FMEMB 'BASETOBASE NEWLOOKS))
                (SETQ REVISED (LISTGET NEWLOOKS 'REVISED))
                (SETQ REVISEDSET (FMEMB 'REVISED NEWLOOKS))
                (SETQ QUADD (LISTGET NEWLOOKS 'QUAD))
                (SETQ COLUMN (LISTGET NEWLOOKS 'COLUMN))
                (SETQ COLUMNSET (FMEMB 'COLUMN NEWLOOKS))
                (SETQ USERINFO (LISTGET NEWLOOKS 'USERINFO))
                (SETQ USERINFOSET (FMEMB 'USERINFO NEWLOOKS))
                (SETQ SPECIALX (LISTGET NEWLOOKS 'SPECIALY))
                (SETQ SPECXSET (FMEMB 'SPECIALY NEWLOOKS))
                (SETQ SPECIALY (LISTGET NEWLOOKS 'SPECIALY))
                (SETQ SPECYSET (FMEMB 'SPECIALY NEWLOOKS))
                (SETQ STYLE (LISTGET NEWLOOKS 'STYLE))
                (SETQ STYLESET (FMEMB 'STYLE NEWLOOKS))
                (SETQ CHARSTYLES (LISTGET NEWLOOKS 'CHARSTYLES))
                (SETQ CHARSTYLESSET (FMEMB 'CHARSTYLES NEWLOOKS))
                (SETQ DEFTAB (LISTGET NEWLOOKS 'DEFAULTTAB))
                (SETQ TABS (LISTGET NEWLOOKS 'TABS))
                (SETQ TABSPEC (LISTGET NEWLOOKS 'TABSPEC))
                (CL:WHEN TABSPEC
                    (SETQ DEFTAB (fetch (TABSPEC DEFAULTTAB) of TABSPEC))
                    (SETQ TABS (fetch (TABSPEC TABS) of TABSPEC)))
                [SELECTQ QUADD
                    ((LEFT RIGHT CENTERED JUSTIFIED NIL)     (* ; 
                                                    "Do nothing -- we got a valid justification spec")
                         )
                    ((JUST J) 
                         (SETQ QUADD 'JUSTIFIED))
                    (L (SETQQ QUADD LEFT))
                    (R (SETQQ QUADD RIGHT))
                    ((C CENTER) 
                         (SETQQ QUADD CENTERED))
                    (PROGN                                   (* ; 
                                                           "We got an illegal QUAD value.  Use LEFT.")
                           (TEDIT.PROMPTPRINT TEXTOBJ (CONCAT "Illegal paragraph quad " QUADD 
                                                             ", replaced with LEFT.")
                                  T)
                           (SETQ QUADD 'LEFT]

                (* ;; "change from the users list to the real tabspec 

CONS pair of default width and LIST of TAB record instances")

                (SETQ NEWFMT (create FMTSPEC using (OR OLDLOOKS TEDIT.DEFAULT.FMTSPEC)))
                (AND 1STLEFT (FSETPARA NEWFMT 1STLEFTMAR 1STLEFT))
                (AND LEFT (FSETPARA NEWFMT LEFTMAR LEFT))
                (AND RIGHT (FSETPARA NEWFMT RIGHTMAR RIGHT))
                (AND LEADB (FSETPARA NEWFMT LEADBEFORE LEADB))
                (AND LEADA (FSETPARA NEWFMT LEADAFTER LEADA))
                (AND LLEAD (FSETPARA NEWFMT LINELEAD LLEAD))
                (AND TABS (FSETPARA NEWFMT FMTTABS TABS))
                (AND DEFTAB (FSETPARA NEWFMT FMTDEFAULTTAB DEFTAB))
                (AND QUADD (FSETPARA NEWFMT QUAD QUADD))
                (AND TYPESET (FSETPARA NEWFMT FMTPARATYPE TYPE))
                (AND SUBTYPESET (FSETPARA NEWFMT FMTPARASUBTYPE SUBTYPE))
                (AND NEWBEFORESET (FSETPARA NEWFMT FMTNEWPAGEBEFORE NEWBEFORE))
                (AND NEWAFTERSET (FSETPARA NEWFMT FMTNEWPAGEAFTER NEWAFTER))
                [AND HEADINGKEEP (FSETPARA NEWFMT FMTHEADINGKEEP (EQ HEADINGKEEP 'ON]
                (AND KEEPSET (FSETPARA NEWFMT FMTKEEP KEEP))
                (AND BASESET (FSETPARA NEWFMT FMTBASETOBASE BASETOBASE))
                (AND REVISEDSET (FSETPARA NEWFMT FMTREVISED REVISED))
                (AND COLUMNSET (FSETPARA NEWFMT FMTCOLUMN COLUMN))
                (AND SPECXSET (FSETPARA NEWFMT FMTSPECIALX SPECIALX))
                (AND SPECYSET (FSETPARA NEWFMT FMTSPECIALY SPECIALY))
                (AND STYLESET (FSETPARA NEWFMT FMTSTYLE STYLE))
                (AND CHARSTYLESSET (FSETPARA NEWFMT FMTCHARSTYLES CHARSTYLES))
                (AND USERINFOSET (FSETPARA NEWFMT FMTUSERINFO USERINFO))
                NEWFMT])

(TEDIT.PARALOOKS
  [LAMBDA (TSTREAM NEWLOOKS SELORCH# LEN)                    (* ; "Edited 10-Aug-2024 00:23 by rmk")
                                                             (* ; "Edited 13-Jul-2024 23:16 by rmk")
    (SETQ TSTREAM (TEXTSTREAM TSTREAM))
    (LET ((TEXTOBJ (fetch (TEXTSTREAM TEXTOBJ) of TSTREAM))
          TARGETSEL)

         (* ;; "Ignores LEN if SELORCH# is a selection")

         [SETQ TARGETSEL (COND
                            ((type? SELECTION SELORCH#)
                             SELORCH#)
                            (SELORCH# (TEDIT.SETSEL TSTREAM SELORCH# LEN 'RIGHT))
                            (T (TEXTSEL TEXTOBJ]
         (CL:WHEN (GETSEL TARGETSEL SET)
             (if (\TEDIT.READONLY TEXTOBJ NIL (GETSEL TARGETSEL CH#))
               elseif (AND (ILEQ (GETSEL TARGETSEL CH#)
                                 (TEXTLEN TEXTOBJ)))
                 then (\TEDIT.CHANGE.PARALOOKS TSTREAM NEWLOOKS TARGETSEL)))])

(\TEDIT.CHANGE.PARALOOKS
  [LAMBDA (TSTREAM NEWLOOKS TARGETSEL)                       (* ; "Edited 27-Sep-2024 16:06 by rmk")
                                                             (* ; "Edited 16-Aug-2024 14:21 by rmk")
                                                             (* ; "Edited 11-Aug-2024 21:59 by rmk")
                                                             (* ; "Edited  4-Aug-2024 23:19 by rmk")
                                                             (* ; "Edited  2-Aug-2024 00:39 by rmk")
                                                             (* ; "Edited  1-Aug-2024 00:12 by rmk")
                                                             (* ; "Edited 29-Jul-2024 11:20 by rmk")
                                                             (* ; "Edited 26-Jul-2024 16:17 by rmk")
                                                             (* ; "Edited 13-Jul-2024 22:55 by rmk")

    (* ;; "Apply new looks to the piece that begins the paragraph containing the first selected character, the piece that ends the paragraph containing the last piece of the selection, and all pieces in between. All the pieces within a paragraph have the same looks.")

    (* ;; "If we are given a FMTSPEC we replace the FMTSPEC of all pieces in all selected paragraphs.  Otherwise, we just override particular values in the selected-paragraph looks.")

    (PROG ((TEXTOBJ (TEXTOBJ TSTREAM))
           (PROPNAMES '(1STLEFTMARGIN LEFTMARGIN RIGHTMARGIN PARALEADING POSTPARALEADING LINELEADING
                              BASETOBASE QUAD TYPE SUBTYPE SPECIALX SPECIALY NEWPAGEBEFORE 
                              NEWPAGEAFTER HEADINGKEEP KEEP HARDCOPY USERINFO REVISED STYLE 
                              CHARSTYLES COLUMN TABS DEFAULTTAB MARGINBAR))
           PARAPIECES)
          (CL:UNLESS TARGETSEL
              (SETQ TARGETSEL (TEXTSEL TEXTOBJ)))
          (CL:UNLESS (AND NEWLOOKS (FGETSEL TARGETSEL SET)
                          (NOT (\TEDIT.READONLY TEXTOBJ NIL (GETSEL TARGETSEL CH#)))
                          (ILEQ (GETSEL TARGETSEL CH#)
                                (TEXTLEN TEXTOBJ))
                          (IGEQ (GETSEL TARGETSEL CH#)
                                1))
                 (RETURN NIL))
          (if (type? FMTSPEC NEWLOOKS)
              then (SETQ NEWLOOKS (\TEDIT.UNIQUIFY.PARALOOKS NEWLOOKS TEXTOBJ))
            elseif (for PTAIL on NEWLOOKS by (CDDR PTAIL) unless (OR (MEMB (CAR PTAIL)
                                                                           PROPNAMES)
                                                                     (NULL (CADR PTAIL)))
                      do 
                         (* ;; "Caller can set NIL to delete temporary properties")

                         (TEDIT.PROMPTPRINT TSTREAM (CONCAT (CAR PTAIL)
                                                           
                                                        " is not a valid paragraph property--aborted"
                                                           )
                                T T)
                         (RETURN T))
              then (RETURN))
          (SETQ PARAPIECES (\TEDIT.PARAPIECES TARGETSEL NIL TEXTOBJ))

     (* ;; "Testing LASTFMTSPEC will typically avoid repeated calculation of the same NEWFMTSPEC, given the uniquifying.")

     (* ;; "For each changed paragraph we keep track of its first character number and its prior looks, for history. That's because the number of pieces in a paragraph may change by the doing and doing of future actions, but their character positions will be restored if undoing gets back to this event. No need to record prior looks for unchanged pieces.")

          (for PC NEWFMTSPEC OLDFMTSPEC UNDOLIST (FIRSTPARAPIECE _ T)
               (FIRSTCHAR _ (fetch (SELPIECES SPFIRSTCHAR) of PARAPIECES)) inselpieces PARAPIECES
             do (CL:WHEN FIRSTPARAPIECE

                    (* ;; "First piece of a new paragraph, get the NEWFMTSPEC for all its pieces")

                    (SETQ OLDFMTSPEC (PPARALOOKS PC))
                    (SETQ NEWFMTSPEC (CL:IF (type? FMTSPEC NEWLOOKS)
                                         NEWLOOKS
                                         (\TEDIT.CHANGE.PARALOOKS.NEW NEWLOOKS OLDFMTSPEC TEXTOBJ)))
                    (CL:UNLESS (\TEDIT.EQFMTSPEC OLDFMTSPEC NEWFMTSPEC)
                                                             (* ; "Something changed")
                        (SETQ NEWFMTSPEC (\TEDIT.UNIQUIFY.PARALOOKS NEWFMTSPEC TEXTOBJ))
                        (CL:UNLESS UNDOLIST                  (* ; 
                                                     "Resetting DIRTY is expensive, only do it once ")
                            (FSETTOBJ TEXTOBJ \DIRTY T))
                        (push UNDOLIST (CONS FIRSTCHAR OLDFMTSPEC))))
                (FSETPC PC PPARALOOKS NEWFMTSPEC)
                (add FIRSTCHAR (PLEN PC))
                (SETQ FIRSTPARAPIECE (PPARALAST PC))
             finally 

                   (* ;; 
           "Create an event even if UNDOLIST is NIL, so that NEWLOOKS is still available for REDO.  ")

                   [\TEDIT.HISTORYADD TEXTOBJ (\TEDIT.HISTORY.EVENT TEXTOBJ :ParaLooks PARAPIECES NIL
                                                     NIL NIL (CONS NEWLOOKS (DREVERSE UNDOLIST]
                   (CL:WHEN UNDOLIST

                       (* ;; "Something changed, update any visible lines.")

                       (CL:WHEN (\TEDIT.PRIMARYPANE TEXTOBJ)
                           (\TEDIT.SHOWSEL (TEXTSEL TEXTOBJ)
                                  NIL TEXTOBJ)               (* ; 
                                                        "Turn off the sel before updating the screen")
                           (CL:UNLESS (AND (LISTP NEWLOOKS)
                                           (EQ 'HARDCOPY (CAR NEWLOOKS))
                                           (NULL (CDDR NEWLOOKS)))

                               (* ;; "The document is %"dirty%" for the titlebar and saving only if something other than hardcopy-display mode was changed")

                               (FSETTOBJ TEXTOBJ \DIRTY T))  (* ; "Save this action for undo/redo")
                           (\TEDIT.RESET.EXTEND.PENDING.DELETE (TEXTSEL TEXTOBJ)
                                  TEXTOBJ)
                           (\TEDIT.UPDATE.LINES TEXTOBJ 'LOOKS PARAPIECES)
                                                             (* ; 
                                            "Update the screen image, showing the original selection")
                           (\TEDIT.FIXSEL (TEXTSEL TEXTOBJ)
                                  TEXTOBJ)
                           (\TEDIT.SHOWSEL (TEXTSEL TEXTOBJ)
                                  T TEXTOBJ)))])

(\TEDIT.CHANGE.PARALOOKS.NEW
  [LAMBDA (NEWLOOKS OLDFMTSPEC TEXTOBJ)                      (* ; "Edited 31-Aug-2024 15:00 by rmk")
                                                             (* ; "Edited 29-Aug-2024 11:13 by rmk")
                                                             (* ; "Edited 23-Aug-2024 23:41 by rmk")
                                                             (* ; "Edited 11-Aug-2024 21:22 by rmk")

    (* ;; "Make a new FMTSPEC reflecting the properties in NEWLOOKS, with defaults taken from OLDCHARFMTSPEC, if given, or the DEFAULTFMTSPEC of TEXTOBJ, if given,;")

    (* ;; "OLDCHARLOOKS is also used as the base for increments.")

    (CL:UNLESS OLDFMTSPEC
        (CL:WHEN TEXTOBJ
            (SETQ OLDFMTSPEC (GETTOBJ TEXTOBJ FMTSPEC))))
    (for NLTAIL VAL NEWFMTSPEC on NEWLOOKS by (CDDR NLTAIL)
       first (SETQ NEWFMTSPEC (CL:IF OLDFMTSPEC
                                  (create FMTSPEC using OLDFMTSPEC)
                                  (create FMTSPEC)))
       do (SETQ VAL (CADR NLTAIL))
          (CL:WHEN (MEMB VAL '(NEUTRAL OFF))                 (* ; 
                                                             "NEUTRAL and OFF both turn off the flag")
              (SETQ VAL NIL))
          (SELECTQ (CAR NLTAIL)
              (1STLEFTMARGIN (FSETPARA NEWFMTSPEC 1STLEFTMAR VAL))
              (LEFTMARGIN (FSETPARA NEWFMTSPEC LEFTMAR VAL))
              (RIGHTMARGIN (FSETPARA NEWFMTSPEC RIGHTMAR VAL))
              (PARALEADING (FSETPARA NEWFMTSPEC LEADBEFORE VAL))
              (POSTPARALEADING 
                   (FSETPARA NEWFMTSPEC LEADAFTER VAL))
              (LINELEADING (FSETPARA NEWFMTSPEC LINELEAD VAL))
              (BASETOBASE (FSETPARA NEWFMTSPEC FMTBASETOBASE VAL))
              (QUAD (CL:WHEN VAL
                        (FSETPARA NEWFMTSPEC QUAD (U-CASE VAL))))
              (TYPE (FSETPARA NEWFMTSPEC FMTPARATYPE (CL:IF (EQ VAL 'ON)
                                                            'PAGEHEADING)))
              (SUBTYPE (FSETPARA NEWFMTSPEC FMTPARASUBTYPE VAL))
              (SPECIALX (FSETPARA NEWFMTSPEC FMTSPECIALX VAL))
              (SPECIALY (FSETPARA NEWFMTSPEC FMTSPECIALY VAL))
              (NEWPAGEBEFORE (FSETPARA NEWFMTSPEC FMTNEWPAGEBEFORE VAL))
              (NEWPAGEAFTER (FSETPARA NEWFMTSPEC FMTNEWPAGEAFTER VAL))
              (HEADINGKEEP (FSETPARA NEWFMTSPEC FMTHEADINGKEEP VAL))
              (KEEP (FSETPARA NEWFMTSPEC FMTKEEP VAL))
              (HARDCOPY (FSETPARA NEWFMTSPEC FMTHARDCOPY VAL))
              (USERINFO (FSETPARA NEWFMTSPEC FMTUSERINFO VAL))
              (REVISED (FSETPARA NEWFMTSPEC FMTREVISED VAL))
              (STYLE (FSETPARA NEWFMTSPEC FMTSTYLE VAL))
              (CHARSTYLES (FSETPARA NEWFMTSPEC FMTCHARSTYLES VAL))
              (COLUMN (FSETPARA NEWFMTSPEC FMTCOLUMN VAL))
              (TABS (FSETPARA NEWFMTSPEC FMTTABS VAL))
              (DEFAULTTAB (FSETPARA NEWFMTSPEC FMTDEFAULTTAB VAL))
              NIL) finally (RETURN NEWFMTSPEC])

(TEDIT.COPY.PARALOOKS
  [LAMBDA (TSTREAM SOURCE DEST)                              (* ; "Edited 13-Jul-2024 23:22 by rmk")
                                                             (* ; "Edited 29-Apr-2024 12:58 by rmk")
                                                             (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited  9-Feb-2024 11:39 by rmk")
                                                             (* ; "Edited 18-Apr-2023 23:53 by rmk")
                                                             (* ; "Edited 22-Oct-2022 15:29 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:15 by rmk")
                                                             (* ; "Edited 30-May-91 21:44 by jds")

    (* ;; "Copy the PARAGRAPH LOOKS from one place to another")

    (SETQ TSTREAM (TEXTSTREAM TSTREAM))
    (PROG ((TEXTOBJ (fetch (TEXTSTREAM TEXTOBJ) of TSTREAM))
           SOURCESTREAM LOOKS DESTOBJ)                       (* ; 
                                           "get the paragraph looks of the first character of SOURCE")
          (if (type? SELECTION SOURCE)
              then (SETQ SOURCESTREAM (OR (GETSEL SOURCE SELTEXTSTREAM)
                                          TSTREAM))
            elseif (FIXP SOURCE)
              then (SETQ SOURCESTREAM TSTREAM)
                   (SETQ SOURCE (\TEDIT.UPDATE.SEL (GETTOBJ TEXTOBJ SCRATCHSEL)
                                       SOURCE 1))
            else (\ILLEGAL.ARG SOURCE))
          (if (type? SELECTION DEST)
              then                                           (* ; 
                                      "make sure that the destination selection is in this document;")
                   (CL:UNLESS (OR (EQ TSTREAM (FGETSEL DEST SELTEXTSTREAM))
                                  (NULL (FGETSEL DEST SELTEXTSTREAM)))
                          (\LISPERROR "Destination selection is not in stream " TSTREAM))
            elseif (FIXP DEST)
              then (SETQ DEST (\TEDIT.UPDATE.SEL (FGETTOBJ TEXTOBJ SCRATCHSEL2)
                                     DEST 1))
            else (\ILLEGAL.ARG DEST))
          (\TEDIT.CHANGE.PARALOOKS TSTREAM (PPARALOOKS (\TEDIT.CHTOPC (GETSEL SOURCE CH#)
                                                              SOURCESTREAM))
                 DEST])

(\TEDIT.PARABOUNDS
  [LAMBDA (TEXTOBJ CH#)                                      (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited 26-Mar-2023 12:54 by rmk")
                                                             (* ; "Edited 20-Feb-2023 13:55 by rmk")
                                                             (* ; "Edited 25-Oct-2022 14:50 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:17 by rmk")
                                                             (* ; "Edited 21-Apr-93 18:22 by jds")

    (* ;; "Returns the first and last character number of the paragraph that brackets CH#")

    (if (ZEROP (TEXTLEN TEXTOBJ))
        then                                                 (* ; "Empty document")
             (CONS 0 0)
      else (LET (CHPIECE START-OF-PIECE START END)
                (DECLARE (SPECVARS START-OF-PIECE))
                (SETQ CHPIECE (\TEDIT.CHTOPC (IMIN CH# (TEXTLEN TEXTOBJ))
                                     TEXTOBJ T))
                (SETQ START START-OF-PIECE)                  (* ; "Find the paragraph's first char")
                [for PC backpieces (PREVPIECE CHPIECE) until (PPARALAST PC)
                   do (add START (IMINUS (PLEN PC]
                (SETQ END (SUB1 START-OF-PIECE))             (* ; "Find the paragraph's last char")
                (for PC inpieces CHPIECE do (add END (PLEN PC)) repeatuntil (PPARALAST PC))
                (CONS START END])
)



(* ;; "For making paragraph-looks substitutions.")

(DEFINEQ

(TEDIT.SUBPARALOOKS
  [LAMBDA (TEXTSTREAM OLDLOOKSLIST NEWLOOKSLIST)             (* ; "Edited  5-Jul-2024 22:54 by rmk")
                                                             (* ; "Edited 25-Jun-2024 11:59 by rmk")
                                                             (* ; "Edited 18-May-2024 16:22 by rmk")
                                                             (* ; "Edited 10-May-2024 22:42 by rmk")
                                                             (* ; "Edited 29-Apr-2024 11:06 by rmk")
                                                             (* ; "Edited  6-May-2024 17:28 by rmk")
                                                             (* ; "Edited 17-Mar-2024 00:27 by rmk")
                                                             (* ; "Edited 15-Mar-2024 14:23 by rmk")
                                                             (* ; "Edited 18-Apr-2023 23:54 by rmk")
                                                             (* ; "Edited 22-Aug-2022 13:13 by rmk")
                                                             (* ; "Edited 26-Apr-93 15:13 by jds")

(* ;;; "User entry to substitute one set of looks for another.  Goes through the whole textstream and whenever the looks match the characteristics of OLDLOOKSLIST which are specified, the characteristics listed in NEWLOOKSLIST are substituted.")

    (LET ((TEXTOBJ (TEXTOBJ TEXTSTREAM)))
         (for PC CHANGEMADE SEL FIRSTCHANGEDCHNO (NCHARSCHANGED _ 0)
              (OLDLOOKS _ (\TEDIT.PARSE.PARALOOKS.LIST OLDLOOKSLIST))
              (NEWLOOKS _ (\TEDIT.PARSE.PARALOOKS.LIST NEWLOOKSLIST))
              (FEATURELIST _ (for A on OLDLOOKSLIST by (CDDR A) collect (CAR A)))
            inpieces (\TEDIT.FIRSTPIECE TEXTOBJ) as CH# from 1 by (PLEN PC)
            when (SAMEPARALOOKS OLDLOOKS (PPARALOOKS PC PPARALOOKS)
                        FEATURELIST) do (CL:UNLESS CHANGEMADE(* ; 
                                                             "First change, turn off the selection")
                                            (SETQ CHANGEMADE T)
                                            (SETQ SEL (FGETTOBJ TEXTOBJ SEL))
                                            (\TEDIT.SHOWSEL SEL NIL TEXTOBJ)
                                            (FSETTOBJ TEXTOBJ \DIRTY T))
                                        (FSETPC PC PPARALOOKS (\TEDIT.UNIQUIFY.PARALOOKS
                                                               (\TEDIT.PARSE.PARALOOKS.LIST
                                                                NEWLOOKSLIST
                                                                (PPARALOOKS PC)
                                                                TEXTOBJ)
                                                               TEXTOBJ)) 

                                       (* ;; "This goes piece by piece, each one adding to the collection of dirty lines.  We keep track of the first and last changes")

                                        (CL:UNLESS FIRSTCHANGEDCHNO (SETQ FIRSTCHANGEDCHNO CH#))
                                        (add NCHARSCHANGED (PLEN PC))
            finally (CL:WHEN (AND CHANGEMADE (\TEDIT.PRIMARYPANE TEXTOBJ))
                                                             (* ; "Update the screen image")
                        (\TEDIT.UPDATE.LINES TEXTOBJ 'LOOKS FIRSTCHANGEDCHNO NCHARSCHANGED)
                        (\TEDIT.FIXSEL SEL TEXTOBJ)
                        (\TEDIT.SHOWSEL SEL T TEXTOBJ))
                  (RETURN CHANGEMADE])

(SAMEPARALOOKS
  [LAMBDA (PARALOOK1 PARALOOK2 FEATURES)                     (* ; "Edited 29-Jul-2024 23:34 by rmk")
                                                             (* ; "Edited 28-Jul-2024 16:27 by rmk")
                                                             (* ; "Edited  8-Dec-92 00:44 by jds")

    (* ;; "Predicate to determine if CLOOK1 and CLOOK2 are the same in all the characteristics listed in FEATURES")

    (for F in FEATURES always (SELECTQ F
                                  (STYLE (EQUAL (fetch (FMTSPEC FMTSTYLE) of PARALOOK1)
                                                (fetch (FMTSPEC FMTSTYLE) of PARALOOK2)))
                                  (LEFTMARGIN (IEQP (fetch (FMTSPEC LEFTMAR) of PARALOOK1)
                                                    (fetch (FMTSPEC LEFTMAR) of PARALOOK2)))
                                  (1STLEFTMARGIN (IEQP (fetch (FMTSPEC 1STLEFTMAR) of PARALOOK1)
                                                       (fetch (FMTSPEC 1STLEFTMAR) of PARALOOK2)))
                                  (RIGHTMARGIN (IEQP (fetch (FMTSPEC RIGHTMAR) of PARALOOK1)
                                                     (fetch (FMTSPEC RIGHTMAR) of PARALOOK2)))
                                  (QUAD (EQ (fetch (FMTSPEC QUAD) of PARALOOK1)
                                            (fetch (FMTSPEC QUAD) of PARALOOK2)))
                                  (POSTPARALEADING 
                                       (IEQP (fetch (FMTSPEC LEADBEFORE) of PARALOOK1)
                                             (fetch (FMTSPEC LEADBEFORE) of PARALOOK2)))
                                  (PARALEADING (IEQP (fetch (FMTSPEC LEADBEFORE) of PARALOOK1)
                                                     (fetch (FMTSPEC LEADBEFORE) of PARALOOK2)))
                                  (LINELEADING (IEQP (fetch (FMTSPEC LINELEAD) of PARALOOK1)
                                                     (fetch (FMTSPEC LINELEAD) of PARALOOK2)))
                                  (DEFAULTTAB (EQ (FGETPARA PARALOOK1 FMTDEFAULTTAB)
                                                  (FGETPARA PARALOOK2 FMTDEFAULTTAB)))
                                  (TABS (EQUAL (FGETPARA PARALOOK1 FMTTABS)
                                               (FGETPARA PARALOOK2 FMTTABS)))
                                  (NEWPAGEBEFORE (EQ (fetch (FMTSPEC FMTNEWPAGEBEFORE) of PARALOOK1)
                                                     (fetch (FMTSPEC FMTNEWPAGEBEFORE) of PARALOOK2)))
                                  (NEWPAGEAFTER (EQ (fetch (FMTSPEC FMTNEWPAGEAFTER) of PARALOOK1)
                                                    (fetch (FMTSPEC FMTNEWPAGEAFTER) of PARALOOK2)))
                                  (SPECIALX (IEQP (fetch (FMTSPEC FMTSPECIALX) of PARALOOK1)
                                                  (fetch (FMTSPEC FMTSPECIALX) of PARALOOK2)))
                                  (SPECIALY (IEQP (fetch (FMTSPEC FMTSPECIALY) of PARALOOK1)
                                                  (fetch (FMTSPEC FMTSPECIALY) of PARALOOK2)))
                                  (HEADINGKEEP (EQ (fetch (FMTSPEC FMTHEADINGKEEP) of PARALOOK1)
                                                   (fetch (FMTSPEC FMTHEADINGKEEP) of PARALOOK2)))
                                  (ERROR (CONCAT F 
                              " is an unknown feature of paragraph looks.  Detected in SAMEPARALOOKS"
                                                ])
)



(* ; "Revision-mark support")

(DEFINEQ

(\TEDIT.MARK.REVISION
  [LAMBDA (TEXTOBJ FMTSPEC IMAGESTREAM LINE)                 (* ; "Edited 27-May-2023 12:12 by rmk")
                                                             (* ; "Edited 30-May-91 21:38 by jds")
    (LET ((SCALE (DSPSCALE NIL IMAGESTREAM)))
         (BLTSHADE BLACKSHADE IMAGESTREAM (IPLUS (GETLD LINE RIGHTMARGIN LINE)
                                                 (FIXR (ITIMES 12 SCALE)))
                (GETLD LINE YBOT)
                (FIXR SCALE)
                (GETLD LINE LHEIGHT)
                'PAINT])
)



(* ; "Style-sheet support")

(DEFINEQ

(\TEDIT.APPLY.STYLES
  [LAMBDA (LOOKS PC TSTREAM)                                 (* ; "Edited 12-Nov-2023 16:08 by rmk")
                                                             (* ; "Edited 18-Mar-2023 21:45 by rmk")
                                                             (* ; "Edited 25-Sep-2022 13:28 by rmk")
                                                             (* ; "Edited 11-Sep-2022 14:45 by rmk")
                                                             (* ; 
                                                        "Edited  4-Jul-93 01:02 by sybalskY:MV:ENVOS")

    (* ;; "Given a set of looks, return the looks with the proper styles expanded out.")

    (SETQ TSTREAM (TEXTSTREAM TSTREAM))
    (OR (CDR (ASSOC LOOKS *TEDIT-CURRENTPARA-CACHE*))
        (CDR (ASSOC LOOKS *TEDIT-PARASTYLE-CACHE*))
        (LET* ((TEXTOBJ (TEXTOBJ TSTREAM))
               (STYLE (fetch (CHARLOOKS CLSTYLE) of LOOKS))
               (STYLE-SHEET (OR (FGETTOBJ TEXTOBJ TXTSTYLESHEET)
                                TEDIT.STYLES))
               NOSTYLE CHARSTYLES CHARSTYLE IN-PARA FMTSPEC)
              (SETQ STYLE (COND
                             ((NULL STYLE)                   (* ; 
                                       "STYLE of NIL means don't bother.  Just use the looks we got.")
                              (SETQ NOSTYLE T)
                              LOOKS)
                             ((AND [SETQ CHARSTYLES (AND (fetch (TEXTSTREAM CURRENTPARALOOKS)
                                                            of TSTREAM)
                                                         (fetch (FMTSPEC FMTCHARSTYLES)
                                                            of (fetch (TEXTSTREAM CURRENTPARALOOKS)
                                                                  of TSTREAM]
                                   (SETQ CHARSTYLE (FASSOC STYLE CHARSTYLES)))
                                                             (* ; 
                   "If the paragraph we're in has character styles, and this is one of them, use it.")
                              (SETQ IN-PARA T)
                              CHARSTYLE)
                             ((CDR (SASSOC STYLE STYLE-SHEET)))
                             ((AND (LITATOM STYLE)
                                   (DEFINEDP STYLE))         (* ; 
                                                      "Call the guy's function to find the new looks")
                              (APPLY* STYLE LOOKS PC TEXTOBJ))
                             (T                              (* ; 
                                                "If all else fails, return the original set of looks")
                                (SETQ NOSTYLE T)
                                LOOKS)))
              (SETQ STYLE (COND
                             ((LISTP STYLE)
                              (\TEDIT.PARSE.CHARLOOKS.LIST (APPEND STYLE '(STYLE NIL))
                                     LOOKS TEXTOBJ))
                             (T STYLE)))

              (* ;; "Cache the looks->styled-looks mapping, either in the cache for this kind of paragraph (which gets wiped when we hit a new para type), or in the global cache.")

              [OR NOSTYLE (CL:IF IN-PARA
                              (push *TEDIT-CURRENTPARA-CACHE* (CONS LOOKS STYLE))
                              (push *TEDIT-PARASTYLE-CACHE* (CONS LOOKS STYLE)))]
              STYLE])

(\TEDIT.APPLY.PARASTYLES
  [LAMBDA (PARALOOKS PC TEXTOBJ)                             (* ; "Edited  4-Aug-2024 14:48 by rmk")
                                                             (* ; "Edited 29-Apr-2024 11:06 by rmk")
                                                             (* ; "Edited  4-Mar-2023 22:23 by rmk")
                                                             (* ; "Edited 25-Sep-2022 13:26 by rmk")
                                                             (* ; 
                                                        "Edited  3-Jul-93 23:15 by sybalskY:MV:ENVOS")

    (* ;; "Given a set of looks, return the looks with the proper styles expanded out.")

    (\TEDIT.CHECK (type? FMTSPEC PARALOOKS))                 (* ; "Incoming thing has to be a LOOKS.")
    (OR (CDR (ASSOC PARALOOKS *TEDIT-PARASTYLE-CACHE*))
        (LET* [NOSTYLE (STYLE-SHEET (OR (fetch (TEXTOBJ TXTSTYLESHEET) of TEXTOBJ)
                                        TEDIT.STYLES))
                     (STYLE (COND
                               ((NULL (fetch (FMTSPEC FMTSTYLE) of PARALOOKS))
                                (SETQ NOSTYLE T)
                                PARALOOKS)
                               ((CDR (SASSOC (fetch (FMTSPEC FMTSTYLE) of PARALOOKS)
                                            STYLE-SHEET)))
                               ((AND (LITATOM (fetch (FMTSPEC FMTSTYLE) of PARALOOKS))
                                     (DEFINEDP (fetch (FMTSPEC FMTSTYLE) of PARALOOKS)))
                                                             (* ; 
                                                      "Call the guy's function to find the new looks")
                                (APPLY* (fetch (FMTSPEC FMTSTYLE) of PARALOOKS)
                                       PARALOOKS PC TEXTOBJ))
                               (T (SETQ NOSTYLE T)
                                  PARALOOKS]
              (CL:WHEN (LISTP STYLE)
                  (SETQ STYLE (\TEDIT.PARSE.PARALOOKS.LIST (APPEND STYLE '(STYLE NIL))
                                     PARALOOKS TEXTOBJ)))
              (CL:UNLESS NOSTYLE
                  (push *TEDIT-PARASTYLE-CACHE* (CONS PARALOOKS STYLE)))
              STYLE])

(TEDIT.STYLESHEET
  [LAMBDA (SHEET TEXTSTREAM)                                 (* ; 
                                                        "Edited  3-Jul-93 23:19 by sybalskY:MV:ENVOS")

    (* ;; "Put a new stylesheet into force.  This REPLACES any existing style sheets, and forgets any pushed sheets.")

    (LET [(TEXTOBJ (AND TEXTSTREAM (TEXTOBJ TEXTSTREAM]
         (COND
            (TEXTOBJ (SETQ *TEDIT-PARASTYLE-CACHE* NIL)      (* ; 
                                                             "Clear the cache, to force reformatting")
                   (replace (TEXTOBJ TXTSTYLESHEET) of TEXTOBJ with SHEET))
            (T 
               (* ;; "No specific document given; change the global style sheet TEDIT.STYLES")

               (SETQ *TEDIT-PARASTYLE-CACHE* NIL)            (* ; 
                                                             "Clear the cache, to force reformatting")
               (SETQ TEDIT.STYLES SHEET)
               (SETQ *TEDIT-STYLESHEET-SAVE-LIST* (LIST TEDIT.STYLES])

(TEDIT.POP.STYLESHEET
  [LAMBDA NIL                                                (* ; 
                                                        "Edited  3-Jul-93 17:42 by sybalskY:MV:ENVOS")

    (* ;; "Go back to an earlier stylesheet, by popping the stack of saved sheets.  You can't pop back to no sheet -- you'll always bottom out at the original style sheet.")

    (SETQ *TEDIT-PARASTYLE-CACHE* NIL)                       (* ; 
                                                             "Clear the cache, to force reformatting")
    (SETQ TEDIT.STYLES (OR (CL:POP *TEDIT-STYLESHEET-SAVE-LIST*)
                           TEDIT.STYLES])

(TEDIT.PUSH.STYLESHEET
  [LAMBDA (SHEET)                                            (* ; 
                                                        "Edited  3-Jul-93 17:40 by sybalskY:MV:ENVOS")

    (* ;; "Add more style definitions to the current style sheet, and remember how to get back to the old one.  Think of this as PUSHING onto a stack of stylesheets, with the new sheet being a composition of SHEET and the existing styles.  ")

    (SETQ *TEDIT-PARASTYLE-CACHE* NIL)                       (* ; 
                                                             "Clear the cache, to force reformatting")
    (SETQ TEDIT.STYLES (APPEND SHEET TEDIT.STYLES))
    (CL:PUSH TEDIT.STYLES *TEDIT-STYLESHEET-SAVE-LIST*])

(TEDIT.ADD.STYLESHEET
  [LAMBDA (SHEET)                                            (* ; 
                                                        "Edited  3-Jul-93 17:38 by sybalskY:MV:ENVOS")

    (* ;; "Add more style definitions to the current style sheet.  This ADDS entries, without remembering that there was an earlier sheet. ")

    (SETQ *TEDIT-PARASTYLE-CACHE* NIL)                       (* ; 
                                                             "Clear the cache, to force reformatting")
    (SETQ TEDIT.STYLES (APPEND SHEET TEDIT.STYLES))
    (SETQ *TEDIT-STYLESHEET-SAVE-LIST* (LIST TEDIT.STYLES])
)



(* ;; 
"*TEDIT-PARASTYLE-CACHE* is an ALIST of  original char/para looks to styled char/para looks.  It is used to cache stylings, and is reset when the main stylesheet changes, and when we change paragraph looks, given paras that have private char styles."
)




(* ;; 
"*TEDIT-CURRENTPARA-CACHE* is NIL if we're not in a para that has private char styles, or is the FMTSPEC (styled!) for that para, if we are.  Used to decide when we have to flush *TEDIT-PARASTYLE-CACHE* at paragraph boundaries.  Mostly, this'll be NIL and not interesting."
)




(* ;; 
"*TEDIT-STYLESHEET-SAVE-LIST* is a list of points inside TEDIT.STYLES, so we can %"push%" new style sheets on the front, and %"pop%" them off sensibly.  This is the push-stack, in effect.  Used by TEDIT.ADD.STYLESHEET, TEDIT.PUSH.STYLESHEET, and TEDIT.POP.STYLESHEET"
)


(RPAQ? TEDIT.STYLES )



(* ;; "RMK 2023: Maybe this should be one of the later ones? Only partly implemented")

(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS TEDIT.STYLES)
)

(RPAQ? *TEDIT-PARASTYLE-CACHE* )

(RPAQ? *TEDIT-CURRENTPARA-CACHE* )

(RPAQ? *TEDIT-STYLESHEET-SAVE-LIST* )
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS *TEDIT-PARASTYLE-CACHE* *TEDIT-CURRENTPARA-CACHE* *TEDIT-STYLESHEET-SAVE-LIST*)
)
(DECLARE%: DONTEVAL@LOAD DOEVAL@COMPILE DONTCOPY COMPILERVARS 

(ADDTOVAR NLAMA )

(ADDTOVAR NLAML )

(ADDTOVAR LAMA \TEDIT.CHARLOOK.FEATURE)
)
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (23390 25151 (\TEDIT.CHARLOOKS.DEFPRINT 23400 . 24531) (\TEDIT.FMTSPEC.DEFPRINT 24533 . 
25149)) (25609 26594 (\TEDIT.CREATE.DEFAULT.FMTSPEC 25619 . 26216) (\TEDIT.CREATE.FACE.MENU 26218 . 
26390) (\TEDIT.CREATE.SIZE.MENU 26392 . 26592)) (27218 27407 (\TEDIT.CHARLOOK.FEATUREP 27228 . 27405))
 (27822 56028 (\TEDIT.CHARLOOKS.FROM.FONT 27832 . 28671) (\TEDIT.EQCLOOKS 28673 . 31642) (
\TEDIT.SAMECLOOKS 31644 . 35914) (TEDIT.CARETLOOKS 35916 . 36958) (TEDIT.COPY.LOOKS 36960 . 40116) (
\TEDIT.UNPARSE.CHARLOOKS.LIST 40118 . 42831) (\TEDIT.MODIFYLOOKS 42833 . 44827) (TEDIT.NEW.FONT 44829
 . 45276) (\TEDIT.CARETLOOKS.VERIFY 45278 . 46115) (\TEDIT.CARETPIECE 46117 . 46422) (
\TEDIT.GET.INSERT.CHARLOOKS 46424 . 48714) (\TEDIT.GET.TERMSA.WIDTHS 48716 . 49132) (
\TEDIT.PARSE.CHARLOOKS.LIST 49134 . 50334) (\TEDIT.CHARLOOK.FEATURE 50336 . 56026)) (56029 72485 (
\TEDIT.TRANSLATE.ASCIICHARS 56039 . 66463) (\TEDIT.CONVERT.TO.FORMATTED 66465 . 72483)) (73675 80910 (
\TEDIT.UNIQUIFY.CHARLOOKS 73685 . 75345) (\TEDIT.UNIQUIFY.PARALOOKS 75347 . 76614) (
\TEDIT.UNIQUIFY.ALL 76616 . 78473) (\TEDIT.FLUSH.UNUSED.LOOKS 78475 . 80908)) (80943 91986 (
TEDIT.LOOKS 80953 . 83342) (TEDIT.GET.LOOKS 83344 . 85373) (TEDIT.SUBLOOKS 85375 . 89350) (
TEDIT.FINDLOOKS 89352 . 91984)) (91987 111753 (\TEDIT.CHANGE.CHARLOOKS 91997 . 99863) (
\TEDIT.CHANGE.CHARLOOKS.NEW 99865 . 103319) (\TEDIT.CHARLOOKS.CHANGE.FONT 103321 . 107071) (
\TEDIT.LOOKS 107073 . 110402) (\TEDIT.FONTCOPY 110404 . 111751)) (111796 141721 (\TEDIT.EQFMTSPEC 
111806 . 115563) (TEDIT.GET.PARALOOKS 115565 . 119302) (\TEDIT.PARSE.PARALOOKS.LIST 119304 . 126378) (
TEDIT.PARALOOKS 126380 . 127386) (\TEDIT.CHANGE.PARALOOKS 127388 . 134412) (
\TEDIT.CHANGE.PARALOOKS.NEW 134414 . 137498) (TEDIT.COPY.PARALOOKS 137500 . 140055) (\TEDIT.PARABOUNDS
 140057 . 141719)) (141781 149271 (TEDIT.SUBPARALOOKS 141791 . 145518) (SAMEPARALOOKS 145520 . 149269)
) (149310 149888 (\TEDIT.MARK.REVISION 149320 . 149886)) (149925 158977 (\TEDIT.APPLY.STYLES 149935 . 
153500) (\TEDIT.APPLY.PARASTYLES 153502 . 155851) (TEDIT.STYLESHEET 155853 . 156920) (
TEDIT.POP.STYLESHEET 156922 . 157590) (TEDIT.PUSH.STYLESHEET 157592 . 158332) (TEDIT.ADD.STYLESHEET 
158334 . 158975)))))
STOP
