(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED " 8-Dec-2023 21:32:41" {WMEDLEY}<lispusers>DSPSCALE.;3 52572  

      :EDIT-BY rmk

      :CHANGES-TO (FNS INITSCALEDIMAGESTREAM \CHARSET.SCALED)
                  (VARS DSPSCALECOMS)
                  (RECORDS SCALEDIMAGEDATA CONVERT)
                  (MACROS DSPUNSCALE.XPOSITION DSPUNSCALE.YPOSITION)

      :PREVIOUS-DATE "19-Jul-88 13:36:39" {WMEDLEY}<lispusers>DSPSCALE.;1)


(PRETTYCOMPRINT DSPSCALECOMS)

(RPAQQ DSPSCALECOMS
       ((LOCALVARS . T)
        (* * SCALED ImageStream ImageOp Functions)
        (FNS INITSCALEDIMAGESTREAM OPENIMAGESTREAM.SCALED)
        (FNS \BACKCOLOR.SCALED \BITBLT.SCALED \BLTSHADE.SCALED \BOTTOMMARGIN.SCALED \BOUT.SCALED 
             \CHARWIDTH.SCALED \CHARWIDTHY.SCALED \CLIPPINGREGION.SCALED \CLOSEFN.SCALED 
             \COLOR.SCALED \DEFAULTSTATE.SCALED \DRAWARC.SCALED \DRAWCIRCLE.SCALED \DRAWCURVE.SCALED
             \DRAWELLIPSE.SCALED \DRAWLINE.SCALED \DRAWPOINT.SCALED \DRAWPOLYGON.SCALED 
             \FILLCIRCLE.SCALED \FILLPOLYGON.SCALED \FONT.SCALED \LEFTMARGIN.SCALED \LINEFEED.SCALED
             \MOVETO.SCALED \NEWPAGE.SCALED \OPERATION.SCALED \POPSTATE.SCALED \PUSHSTATE.SCALED 
             \RESET.SCALED \RIGHTMARGIN.SCALED \ROTATE.SCALED \SCALE.SCALED \SCALEDBITBLT.SCALED 
             \SPACEFACTOR.SCALED \STRINGWIDTH.SCALED \TERPRI.SCALED \TOPMARGIN.SCALED 
             \TRANSLATE.SCALED \XPOSITION.SCALED \YPOSITION.SCALED \OUTCHAR.SCALED)
        (* * Self Scaling DSP* Functions)
        (FNS CENTERPRINTINREGION! CHARWIDTH! CHARWIDTHY! CURSORPOSITION! BITBLT! BITMAPBIT! BLTSHADE!
             DSPBACKUP! DSPBOTTOMMARGIN! DSPCLIPPINGREGION! DRAWBETWEEN! DRAWARC! DRAWCIRCLE! 
             DRAWCURVE! DRAWELLIPSE! DRAWLINE! DRAWPOINT! DRAWPOLYGON! DRAWTO! FILLCIRCLE! 
             FILLPOLYGON! FONTPROP! DSPLEFTMARGIN! DSPLINEFEED! GETPOSITION! MOVETO! MOVETOUPPERLEFT!
             DSPRIGHTMARGIN! DSPSCALE! RELDRAWTO! RELMOVETO! SCALEDBITBLT! STRINGREGION! STRINGWIDTH!
             DSPSPACEFACTOR! DSPTRANSLATE! DSPTOPMARGIN! DSPUNITS! DSPXOFFSET! DSPXPOSITION! 
             DSPYOFFSET! DSPYPOSITION!)
        (* * Low Level Scaling Functions)
        (FNS DSPSCALE.BRUSH DSPSCALE.DASHING DSPSCALE.POINTS DSPSCALE.REGION DSPSCALE.NUMBER 
             DSPSCALE.POSITION DSPSCALE.XPOSITION DSPSCALE.YPOSITION DSPSCALE.WIDTH DSPUNSCALE.REGION
             DSPUNSCALE.POSITION DSPUNSCALE.NUMBER DSPUNSCALE.CHARACTER)
        (MACROS DSPUNSCALE.XPOSITION DSPUNSCALE.YPOSITION)
        (* * etc.)
        (DECLARE%: DONTCOPY (RECORDS SCALEDIMAGEDATA CONVERT))
        [ADDVARS (IMAGESTREAMTYPES (SCALED (OPENSTREAM OPENIMAGESTREAM.SCALED]
        (INITVARS \SCALEDIMAGEOPS \NULLFDEV)
        (GLOBALVARS \SCALEDIMAGEOPS \NULLFDEV)
        [INITVARS (DSPSCALE.SCRATCHBRUSH '(ROUND 1 NIL))
               (DSPSCALE.SCRATCHREGION (create REGION))
               (DSPSCALE.SCRATCHPOSITION (create POSITION))
               (DSPSCALE.SCRATCHLIST (to 10 collect))
               (DSPSCALE.SCRATCHDASHING (to 10 collect))
               (DSPSCALE.SCRATCHPOINTS (to 10 collect (create POSITION]
        (GLOBALVARS DSPSCALE.SCRATCHBRUSH DSPSCALE.SCRATCHREGION DSPSCALE.SCRATCHPOSITION 
               DSPSCALE.SCRATCHLIST DSPSCALE.SCRATCHDASHING DSPSCALE.SCRATCHPOINTS)
        (P (MOVD? 'DSPUNITS! 'DSPUNITS)
           (INITSCALEDIMAGESTREAM))))
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(LOCALVARS . T)
)
(* * SCALED ImageStream ImageOp Functions)

(DEFINEQ

(INITSCALEDIMAGESTREAM
  [LAMBDA NIL                                                (* ; "Edited 19-Jul-88 10:59 by cdl")
    (DECLARE (GLOBALVARS \DISPLAYIMAGEOPS))
    [if (NULL \NULLFDEV)
        then (SETQ \NULLFDEV (create FDEV
                                    CLOSEFILE _ (FUNCTION NILL]
    (SETQ \SCALEDIMAGEOPS (create IMAGEOPS
                                 IMAGETYPE _ 'SCALED
                                 IMCLOSEFN _ (FUNCTION \CLOSEFN.SCALED)
                                 IMXPOSITION _ (FUNCTION \XPOSITION.SCALED)
                                 IMYPOSITION _ (FUNCTION \YPOSITION.SCALED)
                                 IMFONT _ (FUNCTION \FONT.SCALED)
                                 IMLEFTMARGIN _ (FUNCTION \LEFTMARGIN.SCALED)
                                 IMRIGHTMARGIN _ (FUNCTION \RIGHTMARGIN.SCALED)
                                 IMLINEFEED _ (FUNCTION \LINEFEED.SCALED)
                                 IMDRAWLINE _ (FUNCTION \DRAWLINE.SCALED)
                                 IMDRAWCURVE _ (FUNCTION \DRAWCURVE.SCALED)
                                 IMDRAWCIRCLE _ (FUNCTION \DRAWCIRCLE.SCALED)
                                 IMDRAWELLIPSE _ (FUNCTION \DRAWELLIPSE.SCALED)
                                 IMFILLCIRCLE _ (FUNCTION \FILLCIRCLE.SCALED)
                                 IMBLTSHADE _ (FUNCTION \BLTSHADE.SCALED)
                                 IMBITBLT _ (FUNCTION \BITBLT.SCALED)
                                 IMNEWPAGE _ (FUNCTION \NEWPAGE.SCALED)
                                 IMMOVETO _ (FUNCTION \MOVETO.SCALED)
                                 IMSCALE _ (FUNCTION \SCALE.SCALED)
                                 IMTERPRI _ (FUNCTION \TERPRI.SCALED)
                                 IMTOPMARGIN _ (FUNCTION \TOPMARGIN.SCALED)
                                 IMBOTTOMMARGIN _ (FUNCTION \BOTTOMMARGIN.SCALED)
                                 IMSPACEFACTOR _ (FUNCTION \SPACEFACTOR.SCALED)
                                 IMFONTCREATE _ 'DISPLAY
                                 IMOPERATION _ (FUNCTION \OPERATION.SCALED)
                                 IMCOLOR _ (FUNCTION \COLOR.SCALED)
                                 IMSTRINGWIDTH _ (FUNCTION \STRINGWIDTH.SCALED)
                                 IMCHARWIDTH _ (FUNCTION \CHARWIDTH.SCALED)
                                 IMCHARWIDTHY _ (FUNCTION \CHARWIDTHY.SCALED)
                                 IMBACKCOLOR _ (FUNCTION \BACKCOLOR.SCALED)
                                 IMCLIPPINGREGION _ (FUNCTION \CLIPPINGREGION.SCALED)
                                 IMRESET _ (FUNCTION \RESET.SCALED)
                                 IMDRAWPOLYGON _ (FUNCTION \DRAWPOLYGON.SCALED)
                                 IMFILLPOLYGON _ (FUNCTION \FILLPOLYGON.SCALED)
                                 IMSCALEDBITBLT _ (FUNCTION \SCALEDBITBLT.SCALED)
                                 IMROTATE _ (FUNCTION \ROTATE.SCALED)
                                 IMDRAWARC _ (FUNCTION \DRAWARC.SCALED)
                                 IMTRANSLATE _ (FUNCTION \TRANSLATE.SCALED)
                                 IMPUSHSTATE _ (FUNCTION \PUSHSTATE.SCALED)
                                 IMPOPSTATE _ (FUNCTION \POPSTATE.SCALED)
                                 IMDEFAULTSTATE _ (FUNCTION \DEFAULTSTATE.SCALED)
                                 IMDRAWPOINT _ (FUNCTION \DRAWPOINT.SCALED])

(OPENIMAGESTREAM.SCALED
  [LAMBDA (IMAGESTREAM OPTIONS)                          (* cdl "26-Jan-87 09:23")
                                                             (* DECLARATIONS%: (RECORD PAIR
                                                           (KEY VALUE)))
    (LET (STREAM SCALE)
         [SETQ OPTIONS (for PAIR on OPTIONS by (CDDR PAIR)
                          when (with PAIR PAIR (SELECTQ KEY
                                                           (SCALE (SETQ SCALE VALUE)
                                                                  NIL)
                                                           T)) join (with PAIR PAIR
                                                                               (LIST KEY VALUE]
         (with STREAM (SETQ STREAM (create STREAM
                                              IMAGEDATA _ (create SCALEDIMAGEDATA
                                                                 IMAGESTREAM _ IMAGESTREAM)
                                              IMAGEOPS _ (create IMAGEOPS
                                                                IMFONTCREATE _
                                                                (with IMAGEOPS
                                                                       (fetch (STREAM IMAGEOPS)
                                                                          of IMAGESTREAM)
                                                                       IMFONTCREATE) reusing
                                                                                     \SCALEDIMAGEOPS)
                                              OUTCHARFN _ (FUNCTION \OUTCHAR.SCALED)
                                              ACCESS _ 'OUTPUT
                                              DEVICE _ \NULLFDEV))
                (SETQ STRMBOUTFN (FUNCTION \BOUT.SCALED)))
         (if SCALE
             then (DSPSCALE! SCALE IMAGESTREAM))
         STREAM])
)
(DEFINEQ

(\BACKCOLOR.SCALED
  [LAMBDA (STREAM COLOR)                                 (* cdl "26-Jan-87 09:04")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMBACKCOLOR IMAGESTREAM IMAGESTREAM COLOR])

(\BITBLT.SCALED
  [LAMBDA (SOURCEBITMAP SOURCELEFT SOURCEBOTTOM STREAM DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION)
                                                             (* cdl "26-Jan-87 10:37")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (BITBLT SOURCEBITMAP SOURCELEFT SOURCEBOTTOM IMAGESTREAM (DSPSCALE.XPOSITION 
                                                                           DESTINATIONLEFT 
                                                                           IMAGESTREAM)
                  (DSPSCALE.YPOSITION DESTINATIONBOTTOM IMAGESTREAM)
                  WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION 
                                                                   IMAGESTREAM])

(\BLTSHADE.SCALED
  [LAMBDA (TEXTURE STREAM DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT OPERATION CLIPPINGREGION)
                                                             (* cdl "26-Jan-87 10:05")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMBLTSHADE IMAGESTREAM TEXTURE IMAGESTREAM (DSPSCALE.XPOSITION 
                                                                       DESTINATIONLEFT IMAGESTREAM)
                  (DSPSCALE.YPOSITION DESTINATIONBOTTOM IMAGESTREAM)
                  (DSPSCALE.NUMBER WIDTH IMAGESTREAM)
                  (DSPSCALE.NUMBER HEIGHT IMAGESTREAM)
                  OPERATION
                  (DSPSCALE.REGION CLIPPINGREGION IMAGESTREAM])

(\BOTTOMMARGIN.SCALED
  [LAMBDA (STREAM YPOSITION)                             (* cdl "26-Jan-87 08:55")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.YPOSITION (IMAGEOP 'IMBOTTOMMARGIN IMAGESTREAM IMAGESTREAM
                                        (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\BOUT.SCALED
  [LAMBDA (STREAM BYTE)                                  (* cdl "26-Jan-87 08:49")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (BOUT IMAGESTREAM BYTE])

(\CHARWIDTH.SCALED
  [LAMBDA (STREAM CHARCODE)                              (* cdl "26-Jan-87 09:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.CHARACTER (IMAGEOP 'IMCHARWIDTH IMAGESTREAM IMAGESTREAM CHARCODE)
                  (DSPFONT NIL IMAGESTREAM)
                  IMAGESTREAM])

(\CHARWIDTHY.SCALED
  [LAMBDA (STREAM CHARCODE)                              (* cdl "26-Jan-87 10:17")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.CHARACTER (IMAGEOP 'IMCHARWIDTHY IMAGESTREAM IMAGESTREAM CHARCODE)
                  (DSPFONT NIL IMAGESTREAM)
                  IMAGESTREAM])

(\CLIPPINGREGION.SCALED
  [LAMBDA (STREAM REGION)                                (* cdl "26-Jan-87 09:48")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.REGION (IMAGEOP 'IMCLIPPINGREGION IMAGESTREAM IMAGESTREAM
                                         (if REGION
                                             then (DSPSCALE.REGION REGION IMAGESTREAM)))
                  IMAGESTREAM])

(\CLOSEFN.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 08:49")
    (with STREAM STREAM (PROG1 (CLOSEF (with SCALEDIMAGEDATA IMAGEDATA IMAGESTREAM))
                                   (SETQ IMAGEDATA NIL])

(\COLOR.SCALED
  [LAMBDA (STREAM COLOR)                                 (* cdl "26-Jan-87 08:57")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMCOLOR IMAGESTREAM IMAGESTREAM COLOR])

(\DEFAULTSTATE.SCALED
  [LAMBDA (STREAM)                                       (* ; "Edited 19-Jul-88 08:34 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDEFAULTSTATE IMAGESTREAM IMAGESTREAM])

(\DRAWARC.SCALED
  [LAMBDA (STREAM CENTERX CENTERY RADIUS STARTANGLE NDEGREES BRUSH DASHING)
                                                             (* ; "Edited 14-Sep-87 14:30 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWARC IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX IMAGESTREAM)
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER RADIUS IMAGESTREAM)
                  STARTANGLE NDEGREES (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWCIRCLE.SCALED
  [LAMBDA (STREAM CENTERX CENTERY RADIUS BRUSH DASHING)  (* cdl "26-Jan-87 09:03")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWCIRCLE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX IMAGESTREAM
                                                                 )
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER RADIUS IMAGESTREAM)
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWCURVE.SCALED
  [LAMBDA (STREAM KNOTS CLOSED BRUSH DASHING)            (* cdl "26-Jan-87 09:36")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWCURVE IMAGESTREAM IMAGESTREAM (DSPSCALE.POINTS KNOTS IMAGESTREAM)
                  CLOSED
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWELLIPSE.SCALED
  [LAMBDA (STREAM CENTERX CENTERY SEMIMINORRADIUS SEMIMAJORRADIUS ORIENTATION BRUSH DASHING)
                                                             (* cdl "26-Jan-87 09:26")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWELLIPSE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX 
                                                                  IMAGESTREAM)
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER SEMIMINORRADIUS IMAGESTREAM)
                  (DSPSCALE.NUMBER SEMIMAJORRADIUS IMAGESTREAM)
                  ORIENTATION
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWLINE.SCALED
  [LAMBDA (STREAM X1 Y1 X2 Y2 WIDTH OPERATION COLOR DASHING)
                                                             (* cdl "26-Jan-87 09:41")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWLINE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION X1 IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y1 IMAGESTREAM)
                  (DSPSCALE.XPOSITION X2 IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y2 IMAGESTREAM)
                  (DSPSCALE.WIDTH WIDTH IMAGESTREAM)
                  OPERATION COLOR (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWPOINT.SCALED
  [LAMBDA (STREAM X Y BRUSH OPERATION)                   (* ; "Edited 14-Sep-87 14:30 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWPOINT IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION X IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y IMAGESTREAM)
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  OPERATION])

(\DRAWPOLYGON.SCALED
  [LAMBDA (STREAM KNOTS CLOSED BRUSH DASHING)            (* cdl "26-Jan-87 09:37")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWPOLYGON IMAGESTREAM IMAGESTREAM (DSPSCALE.POINTS KNOTS IMAGESTREAM)
                  CLOSED
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\FILLCIRCLE.SCALED
  [LAMBDA (STREAM CENTERX CENTERY RADIUS TEXTURE)        (* cdl "26-Jan-87 08:59")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMFILLCIRCLE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX IMAGESTREAM
                                                                 )
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER RADIUS IMAGESTREAM)
                  TEXTURE])

(\FILLPOLYGON.SCALED
  [LAMBDA (STREAM KNOTS TEXTURE OPERATION WINDNUMBER)    (* ; "Edited 19-Jul-88 10:30 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMFILLPOLYGON IMAGESTREAM IMAGESTREAM (DSPSCALE.POINTS KNOTS IMAGESTREAM)
                  TEXTURE OPERATION WINDNUMBER])

(\FONT.SCALED
  [LAMBDA (STREAM FONT)                                  (* cdl "26-Jan-87 09:13")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMFONT IMAGESTREAM IMAGESTREAM FONT])

(\LEFTMARGIN.SCALED
  [LAMBDA (STREAM XPOSITION)                             (* cdl "26-Jan-87 08:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.XPOSITION (IMAGEOP 'IMLEFTMARGIN IMAGESTREAM IMAGESTREAM
                                        (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\LINEFEED.SCALED
  [LAMBDA (STREAM DELTAY)                                (* cdl "26-Jan-87 09:28")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.NUMBER (IMAGEOP 'IMLINEFEED IMAGESTREAM IMAGESTREAM
                                         (if DELTAY
                                             then (DSPSCALE.NUMBER DELTAY IMAGESTREAM)))
                  IMAGESTREAM])

(\MOVETO.SCALED
  [LAMBDA (STREAM X Y)                                   (* cdl "26-Jan-87 09:30")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMMOVETO IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION X IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y IMAGESTREAM])

(\NEWPAGE.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 09:10")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMNEWPAGE IMAGESTREAM IMAGESTREAM])

(\OPERATION.SCALED
  [LAMBDA (STREAM OPERATION)                             (* cdl "26-Jan-87 08:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMOPERATION IMAGESTREAM IMAGESTREAM OPERATION])

(\POPSTATE.SCALED
  [LAMBDA (STREAM)                                       (* ; "Edited 19-Jul-88 08:32 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMPOPSTATE IMAGESTREAM IMAGESTREAM])

(\PUSHSTATE.SCALED
  [LAMBDA (STREAM)                                       (* ; "Edited 19-Jul-88 08:31 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMPUSHSTATE IMAGESTREAM IMAGESTREAM])

(\RESET.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 09:09")
    (with STREAM STREAM (SETQ CHARPOSITION 0)
           (with SCALEDIMAGEDATA IMAGEDATA (IMAGEOP 'IMRESET IMAGESTREAM IMAGESTREAM])

(\RIGHTMARGIN.SCALED
  [LAMBDA (STREAM XPOSITION)                             (* cdl "26-Jan-87 08:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.XPOSITION (IMAGEOP 'IMRIGHTMARGIN IMAGESTREAM IMAGESTREAM
                                        (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\ROTATE.SCALED
  [LAMBDA (STREAM ROTATION)                              (* ; "Edited 14-Sep-87 14:22 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMROTATE IMAGESTREAM IMAGESTREAM ROTATION])

(\SCALE.SCALED
  [LAMBDA (STREAM SCALE)                                 (* cdl "26-Jan-87 09:34")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (if SCALE
               then (DSPSCALE! SCALE IMAGESTREAM)
             else (IMAGEOP 'IMSCALE IMAGESTREAM IMAGESTREAM])

(\SCALEDBITBLT.SCALED
  [LAMBDA (SOURCEBITMAP SOURCELEFT SOURCEBOTTOM STREAM DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION SCALE)
                                                             (* cdl "26-Jan-87 10:38")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (SCALEDBITBLT SOURCEBITMAP SOURCELEFT SOURCEBOTTOM IMAGESTREAM (DSPSCALE.XPOSITION
                                                                           DESTINATIONLEFT 
                                                                           IMAGESTREAM)
                  (DSPSCALE.YPOSITION DESTINATIONBOTTOM IMAGESTREAM)
                  WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION 
                                                                   IMAGESTREAM)
                  SCALE])

(\SPACEFACTOR.SCALED
  [LAMBDA (STREAM FACTOR)                                (* cdl "26-Jan-87 09:46")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.NUMBER (IMAGEOP 'IMSPACEFACTOR IMAGESTREAM IMAGESTREAM
                                         (if FACTOR
                                             then (DSPSCALE.NUMBER FACTOR IMAGESTREAM)))
                  IMAGESTREAM])

(\STRINGWIDTH.SCALED
  [LAMBDA (STREAM STRING RDTBL)                          (* cdl "26-Jan-87 09:45")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.CHARACTER (IMAGEOP 'IMSTRINGWIDTH IMAGESTREAM IMAGESTREAM STRING RDTBL)
                  (DSPFONT NIL IMAGESTREAM)
                  IMAGESTREAM])

(\TERPRI.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 09:06")
    (with STREAM STREAM (SETQ CHARPOSITION 0)
           (with SCALEDIMAGEDATA IMAGEDATA (IMAGEOP 'IMTERPRI IMAGESTREAM IMAGESTREAM])

(\TOPMARGIN.SCALED
  [LAMBDA (STREAM YPOSITION)                             (* cdl "26-Jan-87 08:54")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.YPOSITION (IMAGEOP 'IMTOPMARGIN IMAGESTREAM IMAGESTREAM
                                        (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\TRANSLATE.SCALED
  [LAMBDA (STREAM Tx Ty)                                 (* ; "Edited 19-Jul-88 13:32 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (STREAMPROP IMAGESTREAM 'TRANSLATE (CREATEPOSITION (DSPSCALE.NUMBER Tx STREAM)
                                                     (DSPSCALE.NUMBER Ty STREAM])

(\XPOSITION.SCALED
  [LAMBDA (STREAM XPOSITION)                             (* cdl "26-Jan-87 08:51")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.XPOSITION (IMAGEOP 'IMXPOSITION IMAGESTREAM IMAGESTREAM
                                        (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\YPOSITION.SCALED
  [LAMBDA (STREAM YPOSITION)                             (* cdl "26-Jan-87 08:51")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.YPOSITION (IMAGEOP 'IMYPOSITION IMAGESTREAM IMAGESTREAM
                                        (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\OUTCHAR.SCALED
  [LAMBDA (STREAM CHARCODE)                              (* cdl "26-Jan-87 10:20")
    [if (EQ CHARCODE (CHARCODE EOL))
        then (with STREAM STREAM (SETQ CHARPOSITION 0))
      else (freplace CHARPOSITION of STREAM with (\LOLOC (\ADDBASE (ffetch 
                                                                                         CHARPOSITION
                                                                                      of STREAM)
                                                                                1]
    (BOUT STREAM CHARCODE])
)
(* * Self Scaling DSP* Functions)

(DEFINEQ

(CENTERPRINTINREGION!
  [LAMBDA (EXP REGION STREAM)                            (* cdl "29-Jul-85 12:09")
    (CENTERPRINTINREGION EXP (if REGION
                                 then (DSPSCALE.REGION REGION STREAM))
           STREAM])

(CHARWIDTH!
  [LAMBDA (CHARCODE FONT STREAM)                         (* ; "Edited 19-Jul-88 13:16 by cdl")
    (DSPUNSCALE.CHARACTER (CHARWIDTH CHARCODE FONT)
           FONT
           (OR STREAM (IMAGESTREAMP FONT])

(CHARWIDTHY!
  [LAMBDA (CHARCODE FONT STREAM)                         (* ; "Edited 19-Jul-88 13:16 by cdl")
    (DSPUNSCALE.CHARACTER (CHARWIDTHY CHARCODE FONT)
           FONT
           (OR STREAM (IMAGESTREAMP FONT])

(CURSORPOSITION!
  [LAMBDA (NEWPOSITION STREAM OLDPOSITION)               (* cdl "30-Oct-85 08:15")
    (DSPUNSCALE.POSITION (CURSORPOSITION (if NEWPOSITION
                                                 then (DSPSCALE.POSITION NEWPOSITION STREAM 
                                                                 OLDPOSITION))
                                    STREAM OLDPOSITION)
           STREAM OLDPOSITION])

(BITBLT!
  [LAMBDA (SOURCE SOURCELEFT SOURCEBOTTOM DESTINATION DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION)
                                                             (* cdl "29-Jul-85 12:09")
    (BITBLT SOURCE SOURCELEFT SOURCEBOTTOM DESTINATION (DSPSCALE.XPOSITION DESTINATIONLEFT 
                                                              DESTINATION)
           (DSPSCALE.YPOSITION DESTINATIONBOTTOM DESTINATION)
           WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION DESTINATION])

(BITMAPBIT!
  [LAMBDA (STREAM X Y NEWVALUE)                          (* cdl "29-Jul-85 12:01")
    (BITMAPBIT STREAM (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           NEWVALUE])

(BLTSHADE!
  [LAMBDA (TEXTURE DESTINATION DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT OPERATION 
                 CLIPPINGREGION)                         (* cdl "29-Jul-85 12:02")
    (BLTSHADE TEXTURE DESTINATION (DSPSCALE.XPOSITION DESTINATIONLEFT DESTINATION)
           (DSPSCALE.YPOSITION DESTINATIONBOTTOM DESTINATION)
           (DSPSCALE.NUMBER WIDTH DESTINATION)
           (DSPSCALE.NUMBER HEIGHT DESTINATION)
           OPERATION
           (DSPSCALE.REGION CLIPPINGREGION DESTINATION])

(DSPBACKUP!
  [LAMBDA (WIDTH DISPLAYSTREAM)                          (* cdl "29-Jul-85 12:02")
    (DSPBACKUP (if WIDTH
                   then (DSPSCALE.XPOSITION WIDTH DISPLAYSTREAM))
           DISPLAYSTREAM])

(DSPBOTTOMMARGIN!
  [LAMBDA (YPOSITION STREAM)                             (* cdl "29-Jul-85 12:02")
    (DSPUNSCALE.YPOSITION (DSPBOTTOMMARGIN (if YPOSITION
                                               then (DSPSCALE.YPOSITION YPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPCLIPPINGREGION!
  [LAMBDA (REGION STREAM)                                (* cdl "29-Jul-85 08:41")
    (DSPUNSCALE.REGION (DSPCLIPPINGREGION (if REGION
                                                  then (DSPSCALE.REGION REGION STREAM))
                                  STREAM)
           STREAM])

(DRAWBETWEEN!
  [LAMBDA (PT1 PT2 WIDTH OPERATION STREAM COLOR DASHING) (* cdl "29-Oct-85 15:30")
    (DRAWBETWEEN (DSPSCALE.POSITION PT1 STREAM (CAR DSPSCALE.SCRATCHPOINTS))
           (DSPSCALE.POSITION PT2 STREAM (CADR DSPSCALE.SCRATCHPOINTS))
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(DRAWARC!
  [LAMBDA (CENTERX CENTERY RADIUS STARTANGLE NDEGREES BRUSH DASHING STREAM)
                                                             (* ; "Edited 14-Sep-87 14:34 by cdl")
    (DRAWARC (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER RADIUS STREAM)
           STARTANGLE NDEGREES (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWCIRCLE!
  [LAMBDA (CENTERX CENTERY RADIUS BRUSH DASHING STREAM)  (* cdl "29-Jul-85 12:03")
    (DRAWCIRCLE (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER RADIUS STREAM)
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWCURVE!
  [LAMBDA (KNOTS CLOSED BRUSH DASHING STREAM)            (* cdl "29-Jul-85 10:04")
    (DRAWCURVE (DSPSCALE.POINTS KNOTS STREAM)
           CLOSED
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWELLIPSE!
  [LAMBDA (CENTERX CENTERY SEMIMINORRADIUS SEMIMAJORRADIUS ORIENTATION BRUSH DASHING STREAM)
                                                             (* cdl "29-Jul-85 12:03")
    (DRAWELLIPSE (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER SEMIMINORRADIUS STREAM)
           (DSPSCALE.NUMBER SEMIMAJORRADIUS STREAM)
           ORIENTATION
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWLINE!
  [LAMBDA (X1 Y1 X2 Y2 WIDTH OPERATION STREAM COLOR DASHING)
                                                             (* cdl "29-Oct-85 15:28")
    (DRAWLINE (DSPSCALE.XPOSITION X1 STREAM)
           (DSPSCALE.YPOSITION Y1 STREAM)
           (DSPSCALE.XPOSITION X2 STREAM)
           (DSPSCALE.YPOSITION Y2 STREAM)
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(DRAWPOINT!
  [LAMBDA (X Y BRUSH STREAM OPERATION)                   (* ; "Edited 14-Sep-87 14:36 by cdl")
    (DRAWPOINT (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           (DSPSCALE.BRUSH BRUSH STREAM)
           STREAM OPERATION])

(DRAWPOLYGON!
  [LAMBDA (POINTS CLOSED BRUSH DASHING STREAM)           (* cdl "29-Jul-85 10:05")
    (DRAWPOLYGON (DSPSCALE.POINTS POINTS STREAM)
           CLOSED
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWTO!
  [LAMBDA (X Y WIDTH OPERATION STREAM COLOR DASHING)     (* cdl "29-Oct-85 15:31")
    (DRAWTO (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(FILLCIRCLE!
  [LAMBDA (CENTERX CENTERY RADIUS TEXTURE STREAM)        (* cdl " 7-Feb-86 15:02")
    (FILLCIRCLE (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER RADIUS STREAM)
           TEXTURE STREAM])

(FILLPOLYGON!
  [LAMBDA (KNOTS TEXTURE STREAM)                         (* cdl "30-Oct-85 07:44")
    (FILLPOLYGON (DSPSCALE.POINTS KNOTS STREAM)
           TEXTURE STREAM])

(FONTPROP!
  [LAMBDA (FONT PROP STREAM)                             (* ; "Edited 19-Jul-88 13:18 by cdl")
    (SELECTQ PROP
        ((ASCENT DESCENT HEIGHT) 
             (DSPUNSCALE.CHARACTER (FONTPROP FONT PROP)
                    FONT
                    (OR STREAM (IMAGESTREAMP FONT))))
        (FONTPROP FONT PROP])

(DSPLEFTMARGIN!
  [LAMBDA (XPOSITION STREAM)                             (* cdl "29-Jul-85 12:05")
    (DSPUNSCALE.XPOSITION (DSPLEFTMARGIN (if XPOSITION
                                             then (DSPSCALE.XPOSITION XPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPLINEFEED!
  [LAMBDA (DELTAY STREAM)                                (* cdl "29-Jul-85 11:11")
    (DSPUNSCALE.NUMBER (DSPLINEFEED (if DELTAY
                                            then (DSPSCALE.NUMBER DELTAY STREAM))
                                  STREAM)
           STREAM])

(GETPOSITION!
  [LAMBDA (STREAM CURSOR)                                (* cdl "30-Oct-85 08:03")
    (DSPUNSCALE.POSITION (GETPOSITION STREAM CURSOR)
           STREAM])

(MOVETO!
  [LAMBDA (X Y STREAM)                                   (* cdl "29-Jul-85 12:06")
    (MOVETO (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           STREAM])

(MOVETOUPPERLEFT!
  [LAMBDA (WINDOW REGION)                                (* cdl "29-Jul-85 12:10")
    (MOVETOUPPERLEFT WINDOW (if REGION
                                then (DSPSCALE.REGION REGION WINDOW])

(DSPRIGHTMARGIN!
  [LAMBDA (XPOSITION STREAM)                             (* cdl "16-Oct-85 16:11")
    (DSPUNSCALE.XPOSITION (DSPRIGHTMARGIN (if XPOSITION
                                              then (DSPSCALE.XPOSITION XPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPSCALE!
  [LAMBDA (SCALE STREAM)                                 (* cdl "23-Apr-86 09:40")
    (if (NOT (type? STREAM STREAM))
        then (SETQ STREAM (GETSTREAM STREAM)))
    (PROG1 (OR (STREAMPROP STREAM 'SCALE)
               (DSPSCALE NIL STREAM))
        [if SCALE
            then (STREAMPROP STREAM 'SCALE SCALE)
                  (STREAMPROP STREAM 'SCALED T)
                  (LET [(RATIO (STREAMPROP STREAM 'RATIO]
                       [if (NULL RATIO)
                           then (STREAMPROP STREAM 'RATIO (SETQ RATIO (create CONVERT
                                                                                 SOURCE _ 1]
                       (with CONVERT RATIO (SETQ DESTINATION (TIMES SCALE (DSPSCALE NIL STREAM])])

(RELDRAWTO!
  [LAMBDA (DX DY WIDTH OPERATION STREAM COLOR DASHING)   (* cdl "29-Oct-85 15:31")
    (RELDRAWTO (DSPSCALE.NUMBER DX STREAM)
           (DSPSCALE.NUMBER DY STREAM)
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(RELMOVETO!
  [LAMBDA (DX DY STREAM)                                 (* cdl "30-Oct-85 07:43")
    (RELMOVETO (DSPSCALE.NUMBER DX STREAM)
           (DSPSCALE.NUMBER DY STREAM)
           STREAM])

(SCALEDBITBLT!
  [LAMBDA (SOURCE SOURCELEFT SOURCEBOTTOM DESTINATION DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION SCALE)
                                                             (* cdl "29-Jul-85 12:13")
    (SCALEDBITBLT SOURCELEFT SOURCEBOTTOM DESTINATION (DSPSCALE.XPOSITION DESTINATIONLEFT 
                                                             DESTINATION)
           (DSPSCALE.YPOSITION DESTINATIONBOTTOM DESTINATION)
           WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION DESTINATION)
           SCALE])

(STRINGREGION!
  [LAMBDA (STR STREAM PRIN2FLG RDTBL)                    (* cdl " 2-May-86 14:05")
    (LET ((REGION (STRINGREGION STR STREAM PRIN2FLG RDTBL)))
         (DSPUNSCALE.REGION REGION STREAM REGION])

(STRINGWIDTH!
  [LAMBDA (STR FONT FLG RDTBL STREAM)                    (* ; "Edited 19-Jul-88 13:18 by cdl")
    (DSPUNSCALE.CHARACTER (STRINGWIDTH STR FONT FLG RDTBL)
           FONT
           (OR STREAM (IMAGESTREAMP FONT])

(DSPSPACEFACTOR!
  [LAMBDA (FACTOR STREAM)                                (* cdl "29-Jul-85 11:12")
    (DSPUNSCALE.NUMBER (DSPSPACEFACTOR (if FACTOR
                                               then (DSPSCALE.NUMBER FACTOR STREAM))
                                  STREAM)
           STREAM])

(DSPTRANSLATE!
  [LAMBDA (Tx.OR.POSITION Ty.OR.STREAM STREAM.OR.NIL)    (* ; "Edited 19-Jul-88 09:03 by cdl")
    (if (POSITIONP Tx.OR.POSITION)
        then                                             (* Koto Compatibility)
              (STREAMPROP (GETSTREAM Ty.OR.STREAM)
                     'TRANSLATE Tx.OR.POSITION)
      else (STREAMPROP (GETSTREAM STREAM.OR.NIL)
                      'TRANSLATE
                      (CREATEPOSITION Tx.OR.POSITION Ty.OR.STREAM])

(DSPTOPMARGIN!
  [LAMBDA (YPOSITION STREAM)                             (* cdl "29-Jul-85 12:00")
    (DSPUNSCALE.YPOSITION (DSPTOPMARGIN (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPUNITS!
  [LAMBDA (UNITS STREAM)                                 (* cdl "23-Apr-86 09:40")
    (if (NOT (type? STREAM STREAM))
        then (SETQ STREAM (GETSTREAM STREAM)))
    (PROG1 (STREAMPROP STREAM 'UNITS)
        [if UNITS
            then (STREAMPROP STREAM 'UNITS UNITS)
                  (STREAMPROP STREAM 'SCALED T)
                  (LET [(RATIO (STREAMPROP STREAM 'RATIO]
                       [if (NULL RATIO)
                           then (STREAMPROP STREAM 'RATIO (SETQ RATIO (create CONVERT
                                                                                 DESTINATION _ 1]
                       (with CONVERT RATIO (SETQ SOURCE UNITS])])

(DSPXOFFSET!
  [LAMBDA (XOFFSET DISPLAYSTREAM)                        (* cdl "29-Jul-85 11:12")
    (DSPUNSCALE.NUMBER (DSPXOFFSET (if XOFFSET
                                           then (DSPSCALE.NUMBER XOFFSET DISPLAYSTREAM))
                                  DISPLAYSTREAM)
           DISPLAYSTREAM])

(DSPXPOSITION!
  [LAMBDA (XPOSITION STREAM)                             (* cdl "29-Jul-85 12:00")
    (DSPUNSCALE.XPOSITION (DSPXPOSITION (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPYOFFSET!
  [LAMBDA (YOFFSET DISPLAYSTREAM)                        (* cdl "29-Jul-85 11:59")
    (DSPUNSCALE.NUMBER (DSPYOFFSET (if YOFFSET
                                           then (DSPSCALE.NUMBER YOFFSET DISPLAYSTREAM))
                                  DISPLAYSTREAM)
           DISPLAYSTREAM])

(DSPYPOSITION!
  [LAMBDA (YPOSITION STREAM)                             (* cdl "29-Jul-85 11:59")
    (DSPUNSCALE.YPOSITION (DSPYPOSITION (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION STREAM))
                                 STREAM)
           STREAM])
)
(* * Low Level Scaling Functions)

(DEFINEQ

(DSPSCALE.BRUSH
  [LAMBDA (BRUSH STREAM)                                 (* cdl "29-Oct-85 15:29")
    (if (NULL BRUSH)
        then (create BRUSH
                        BRUSHSHAPE _ 'ROUND
                        BRUSHSIZE _ (DSPSCALE.WIDTH 1 STREAM) smashing DSPSCALE.SCRATCHBRUSH)
      elseif (LISTP BRUSH)
        then (with BRUSH BRUSH (create BRUSH
                                              BRUSHCOLOR _ BRUSHCOLOR
                                              BRUSHSHAPE _ BRUSHSHAPE
                                              BRUSHSIZE _ (DSPSCALE.WIDTH BRUSHSIZE STREAM)
                                          smashing DSPSCALE.SCRATCHBRUSH))
      elseif (NUMBERP BRUSH)
        then (DSPSCALE.WIDTH BRUSH STREAM)
      else BRUSH])

(DSPSCALE.DASHING
  [LAMBDA (DASHING STREAM)                               (* ; "Edited 19-Jul-88 10:21 by cdl")
    (if (LISTP DASHING)
        then [SCRATCHLIST DSPSCALE.SCRATCHDASHING (for WIDTH in DASHING
                                                         do (ADDTOSCRATCHLIST (DSPSCALE.WIDTH
                                                                                   WIDTH STREAM]
      elseif (NUMBERP DASHING)
        then (DSPSCALE.WIDTH DASHING STREAM)
      else DASHING])

(DSPSCALE.POINTS
  [LAMBDA (KNOTS STREAM)                                 (* ; "Edited 19-Jul-88 09:52 by cdl")
    (SCRATCHLIST DSPSCALE.SCRATCHLIST (bind (KNOTSLST _ DSPSCALE.SCRATCHPOINTS) for KNOT
                                         in KNOTS
                                         do (ADDTOSCRATCHLIST
                                                 (DSPSCALE.POSITION
                                                  KNOT STREAM (if KNOTSLST
                                                                  then (pop KNOTSLST)
                                                                else (push 
                                                                               DSPSCALE.SCRATCHPOINTS
                                                                                (create POSITION)
                                                                                )
                                                                      (CAR DSPSCALE.SCRATCHPOINTS])

(DSPSCALE.REGION
  [LAMBDA (REGION STREAM SMASH)                          (* cdl "28-Oct-85 09:00")
    (if (type? REGION REGION)
        then (with REGION REGION (create REGION
                                                LEFT _ (DSPSCALE.XPOSITION LEFT STREAM)
                                                BOTTOM _ (DSPSCALE.YPOSITION BOTTOM STREAM)
                                                WIDTH _ (DSPSCALE.NUMBER WIDTH STREAM)
                                                HEIGHT _ (DSPSCALE.NUMBER HEIGHT STREAM)
                                            smashing (OR SMASH DSPSCALE.SCRATCHREGION)))
      else REGION])

(DSPSCALE.NUMBER
  [LAMBDA (VALUE STREAM)                                 (* cdl "23-Apr-86 09:10")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              (if [FLOATP (SETQ VALUE (if (GETSTREAMPROP STREAM 'SCALED)
                                              then (with CONVERT (GETSTREAMPROP STREAM
                                                                                'RATIO)
                                                              (QUOTIENT (TIMES VALUE DESTINATION)
                                                                     SOURCE))
                                            else (TIMES (IMAGEOP 'IMSCALE STREAM STREAM)
                                                            VALUE]
                  then (FIXR VALUE)
                else VALUE)
      else VALUE])

(DSPSCALE.POSITION
  [LAMBDA (POSITION STREAM SMASH)                        (* cdl "29-Jul-85 11:57")
    (with POSITION POSITION (create POSITION
                                       XCOORD _ (DSPSCALE.XPOSITION XCOORD STREAM)
                                       YCOORD _ (DSPSCALE.YPOSITION YCOORD STREAM)
                                   smashing (OR SMASH DSPSCALE.SCRATCHPOSITION])

(DSPSCALE.XPOSITION
  [LAMBDA (VALUE STREAM)                                 (* cdl " 1-Nov-85 08:47")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              [LET [(TRANSLATE (GETSTREAMPROP STREAM 'TRANSLATE]
                   (if TRANSLATE
                       then (with POSITION TRANSLATE (add VALUE XCOORD]
              (DSPSCALE.NUMBER VALUE STREAM)
      else VALUE])

(DSPSCALE.YPOSITION
  [LAMBDA (VALUE STREAM)                                 (* cdl " 1-Nov-85 08:47")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              [LET [(TRANSLATE (GETSTREAMPROP STREAM 'TRANSLATE]
                   (if TRANSLATE
                       then (with POSITION TRANSLATE (add VALUE YCOORD]
              (DSPSCALE.NUMBER VALUE STREAM)
      else VALUE])

(DSPSCALE.WIDTH
  [LAMBDA (WIDTH STREAM)                                 (* cdl "29-Oct-85 15:27")
    (if (ZEROP (SETQ WIDTH (DSPSCALE.NUMBER WIDTH STREAM)))
        then 1
      else WIDTH])

(DSPUNSCALE.REGION
  [LAMBDA (REGION STREAM SMASH)                          (* cdl " 2-May-86 14:04")
    (if (type? REGION REGION)
        then (with REGION REGION (create REGION
                                                LEFT _ (DSPUNSCALE.XPOSITION LEFT STREAM)
                                                BOTTOM _ (DSPUNSCALE.YPOSITION BOTTOM STREAM)
                                                WIDTH _ (DSPUNSCALE.NUMBER WIDTH STREAM)
                                                HEIGHT _ (DSPUNSCALE.NUMBER HEIGHT STREAM)
                                            smashing (OR SMASH DSPSCALE.SCRATCHREGION)))
      else REGION])

(DSPUNSCALE.POSITION
  [LAMBDA (POSITION STREAM SMASH)                        (* cdl "17-Sep-85 14:21")
    (with POSITION POSITION (create POSITION
                                       XCOORD _ (DSPUNSCALE.XPOSITION XCOORD STREAM)
                                       YCOORD _ (DSPUNSCALE.YPOSITION YCOORD STREAM)
                                   smashing (OR SMASH DSPSCALE.SCRATCHPOSITION])

(DSPUNSCALE.NUMBER
  [LAMBDA (VALUE STREAM OFFSET)                          (* cdl "27-Jan-87 11:32")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              [SETQ VALUE (if (GETSTREAMPROP STREAM 'SCALED)
                              then (with CONVERT (GETSTREAMPROP STREAM 'RATIO)
                                              (QUOTIENT (TIMES VALUE SOURCE)
                                                     DESTINATION))
                            else (QUOTIENT VALUE (IMAGEOP 'IMSCALE STREAM STREAM]
              [if OFFSET
                  then (LET [(TRANSLATE (GETSTREAMPROP STREAM 'TRANSLATE]
                                (if TRANSLATE
                                    then (with POSITION TRANSLATE
                                                    (SELECTQ OFFSET
                                                        (X (SETQ VALUE (DIFFERENCE VALUE XCOORD)))
                                                        (Y (SETQ VALUE (DIFFERENCE VALUE YCOORD)))
                                                        NIL]
              (if (FLOATP VALUE)
                  then (FIXR VALUE)
                else VALUE)
      else VALUE])

(DSPUNSCALE.CHARACTER
  [LAMBDA (WIDTH FONT STREAM)                            (* cdl "23-Apr-86 09:11")
    (LET (CONVERT VALUE)
         (if (NUMBERP WIDTH)
             then (if [FLOATP (SETQ VALUE (if (AND STREAM (OR (type? STREAM STREAM)
                                                                          (SETQ STREAM (GETSTREAM
                                                                                        STREAM)))
                                                               (GETSTREAMPROP STREAM 'SCALED))
                                                      then (with CONVERT (GETSTREAMPROP
                                                                                  STREAM
                                                                                  'RATIO)
                                                                      (QUOTIENT (TIMES WIDTH SOURCE)
                                                                             DESTINATION))
                                                    else (QUOTIENT WIDTH
                                                                    (OR (with FONTDESCRIPTOR FONT
                                                                               FONTSCALE)
                                                                        (IMAGEOP 'IMSCALE STREAM 
                                                                               STREAM]
                          then (FIXR VALUE)
                        else VALUE)
           else WIDTH])
)
(DECLARE%: EVAL@COMPILE 

(PUTPROPS DSPUNSCALE.XPOSITION MACRO ((VALUE STREAM)
                                      (DSPUNSCALE.NUMBER VALUE STREAM 'X)))

(PUTPROPS DSPUNSCALE.YPOSITION MACRO ((VALUE STREAM)
                                      (DSPUNSCALE.NUMBER VALUE STREAM 'Y)))
)
(* * etc.)

(DECLARE%: DONTCOPY 
(DECLARE%: EVAL@COMPILE

(RECORD SCALEDIMAGEDATA (IMAGESTREAM))

(RECORD CONVERT (SOURCE . DESTINATION))
)
)

(ADDTOVAR IMAGESTREAMTYPES (SCALED (OPENSTREAM OPENIMAGESTREAM.SCALED)))

(RPAQ? \SCALEDIMAGEOPS NIL)

(RPAQ? \NULLFDEV NIL)
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS \SCALEDIMAGEOPS \NULLFDEV)
)

(RPAQ? DSPSCALE.SCRATCHBRUSH '(ROUND 1 NIL))

(RPAQ? DSPSCALE.SCRATCHREGION (create REGION))

(RPAQ? DSPSCALE.SCRATCHPOSITION (create POSITION))

(RPAQ? DSPSCALE.SCRATCHLIST (to 10 collect))

(RPAQ? DSPSCALE.SCRATCHDASHING (to 10 collect))

(RPAQ? DSPSCALE.SCRATCHPOINTS (to 10 collect (create POSITION)))
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS DSPSCALE.SCRATCHBRUSH DSPSCALE.SCRATCHREGION DSPSCALE.SCRATCHPOSITION 
       DSPSCALE.SCRATCHLIST DSPSCALE.SCRATCHDASHING DSPSCALE.SCRATCHPOINTS)
)

(MOVD? 'DSPUNITS! 'DSPUNITS)

(INITSCALEDIMAGESTREAM)
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (3514 8995 (INITSCALEDIMAGESTREAM 3524 . 6952) (OPENIMAGESTREAM.SCALED 6954 . 8993)) (
8996 26298 (\BACKCOLOR.SCALED 9006 . 9249) (\BITBLT.SCALED 9251 . 10118) (\BLTSHADE.SCALED 10120 . 
10875) (\BOTTOMMARGIN.SCALED 10877 . 11332) (\BOUT.SCALED 11334 . 11543) (\CHARWIDTH.SCALED 11545 . 
11892) (\CHARWIDTHY.SCALED 11894 . 12243) (\CLIPPINGREGION.SCALED 12245 . 12698) (\CLOSEFN.SCALED 
12700 . 12961) (\COLOR.SCALED 12963 . 13198) (\DEFAULTSTATE.SCALED 13200 . 13455) (\DRAWARC.SCALED 
13457 . 14086) (\DRAWCIRCLE.SCALED 14088 . 14677) (\DRAWCURVE.SCALED 14679 . 15098) (
\DRAWELLIPSE.SCALED 15100 . 15896) (\DRAWLINE.SCALED 15898 . 16545) (\DRAWPOINT.SCALED 16547 . 16977) 
(\DRAWPOLYGON.SCALED 16979 . 17402) (\FILLCIRCLE.SCALED 17404 . 17902) (\FILLPOLYGON.SCALED 17904 . 
18244) (\FONT.SCALED 18246 . 18478) (\LEFTMARGIN.SCALED 18480 . 18931) (\LINEFEED.SCALED 18933 . 19374
) (\MOVETO.SCALED 19376 . 19702) (\NEWPAGE.SCALED 19704 . 19937) (\OPERATION.SCALED 19939 . 20186) (
\POPSTATE.SCALED 20188 . 20435) (\PUSHSTATE.SCALED 20437 . 20686) (\RESET.SCALED 20688 . 20938) (
\RIGHTMARGIN.SCALED 20940 . 21393) (\ROTATE.SCALED 21395 . 21647) (\SCALE.SCALED 21649 . 21972) (
\SCALEDBITBLT.SCALED 21974 . 22883) (\SPACEFACTOR.SCALED 22885 . 23332) (\STRINGWIDTH.SCALED 23334 . 
23689) (\TERPRI.SCALED 23691 . 23943) (\TOPMARGIN.SCALED 23945 . 24394) (\TRANSLATE.SCALED 24396 . 
24766) (\XPOSITION.SCALED 24768 . 25217) (\YPOSITION.SCALED 25219 . 25668) (\OUTCHAR.SCALED 25670 . 
26296)) (26339 41376 (CENTERPRINTINREGION! 26349 . 26608) (CHARWIDTH! 26610 . 26843) (CHARWIDTHY! 
26845 . 27080) (CURSORPOSITION! 27082 . 27526) (BITBLT! 27528 . 28138) (BITMAPBIT! 28140 . 28369) (
BLTSHADE! 28371 . 28903) (DSPBACKUP! 28905 . 29141) (DSPBOTTOMMARGIN! 29143 . 29476) (
DSPCLIPPINGREGION! 29478 . 29811) (DRAWBETWEEN! 29813 . 30196) (DRAWARC! 30198 . 30679) (DRAWCIRCLE! 
30681 . 31056) (DRAWCURVE! 31058 . 31346) (DRAWELLIPSE! 31348 . 31910) (DRAWLINE! 31912 . 32387) (
DRAWPOINT! 32389 . 32676) (DRAWPOLYGON! 32678 . 32971) (DRAWTO! 32973 . 33285) (FILLCIRCLE! 33287 . 
33576) (FILLPOLYGON! 33578 . 33766) (FONTPROP! 33768 . 34106) (DSPLEFTMARGIN! 34108 . 34435) (
DSPLINEFEED! 34437 . 34752) (GETPOSITION! 34754 . 34939) (MOVETO! 34941 . 35155) (MOVETOUPPERLEFT! 
35157 . 35390) (DSPRIGHTMARGIN! 35392 . 35722) (DSPSCALE! 35724 . 36520) (RELDRAWTO! 36522 . 36836) (
RELMOVETO! 36838 . 37054) (SCALEDBITBLT! 37056 . 37694) (STRINGREGION! 37696 . 37921) (STRINGWIDTH! 
37923 . 38165) (DSPSPACEFACTOR! 38167 . 38491) (DSPTRANSLATE! 38493 . 38994) (DSPTOPMARGIN! 38996 . 
39320) (DSPUNITS! 39322 . 40048) (DSPXOFFSET! 40050 . 40385) (DSPXPOSITION! 40387 . 40711) (
DSPYOFFSET! 40713 . 41048) (DSPYPOSITION! 41050 . 41374)) (41417 51281 (DSPSCALE.BRUSH 41427 . 42253) 
(DSPSCALE.DASHING 42255 . 42803) (DSPSCALE.POINTS 42805 . 43860) (DSPSCALE.REGION 43862 . 44560) (
DSPSCALE.NUMBER 44562 . 45517) (DSPSCALE.POSITION 45519 . 45944) (DSPSCALE.XPOSITION 45946 . 46467) (
DSPSCALE.YPOSITION 46469 . 46990) (DSPSCALE.WIDTH 46992 . 47212) (DSPUNSCALE.REGION 47214 . 47914) (
DSPUNSCALE.POSITION 47916 . 48339) (DSPUNSCALE.NUMBER 48341 . 49675) (DSPUNSCALE.CHARACTER 49677 . 
51279)))))
STOP
