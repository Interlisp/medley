(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)
(FILECREATED "19-Jul-88 13:36:39" |{MCS:MCS:STANFORD}<LANE>DSPSCALE.;10| 55021  

      changes to%:  (FNS \TRANSLATE.SCALED CHARWIDTH! CHARWIDTHY! FONTPROP! STRINGWIDTH! 
                         INITSCALEDIMAGESTREAM \FILLPOLYGON.SCALED DSPSCALE.DASHING 
                         OPENIMAGESTREAM.SCALED \BACKCOLOR.SCALED \BITBLT.SCALED \BLTSHADE.SCALED 
                         \BOTTOMMARGIN.SCALED \BOUT.SCALED \CHARSET.SCALED \CHARWIDTH.SCALED 
                         \CHARWIDTHY.SCALED \CLIPPINGREGION.SCALED \CLOSEFN.SCALED \COLOR.SCALED 
                         \DEFAULTSTATE.SCALED \DRAWARC.SCALED \DRAWCIRCLE.SCALED \DRAWCURVE.SCALED 
                         \DRAWELLIPSE.SCALED \DRAWLINE.SCALED \DRAWPOINT.SCALED \DRAWPOLYGON.SCALED 
                         \FILLCIRCLE.SCALED \FONT.SCALED \LEFTMARGIN.SCALED \LINEFEED.SCALED 
                         \MOVETO.SCALED \NEWPAGE.SCALED \OPERATION.SCALED \POPSTATE.SCALED 
                         \PUSHSTATE.SCALED \RESET.SCALED \RIGHTMARGIN.SCALED \ROTATE.SCALED 
                         \SCALE.SCALED \SCALEDBITBLT.SCALED \SPACEFACTOR.SCALED \STRINGWIDTH.SCALED 
                         \TERPRI.SCALED \TOPMARGIN.SCALED \XPOSITION.SCALED \YPOSITION.SCALED 
                         \OUTCHAR.SCALED CENTERPRINTINREGION! CURSORPOSITION! BITBLT! BITMAPBIT! 
                         BLTSHADE! DSPBACKUP! DSPBOTTOMMARGIN! DSPCLIPPINGREGION! DRAWBETWEEN! 
                         DRAWARC! DRAWCIRCLE! DRAWCURVE! DRAWELLIPSE! DRAWLINE! DRAWPOINT! 
                         DRAWPOLYGON! DRAWTO! FILLCIRCLE! FILLPOLYGON! DSPLEFTMARGIN! DSPLINEFEED! 
                         GETPOSITION! MOVETO! MOVETOUPPERLEFT! DSPRIGHTMARGIN! DSPSCALE! RELDRAWTO! 
                         RELMOVETO! SCALEDBITBLT! STRINGREGION! DSPSPACEFACTOR! DSPTRANSLATE! 
                         DSPTOPMARGIN! DSPUNITS! DSPXOFFSET! DSPXPOSITION! DSPYOFFSET! DSPYPOSITION!
                         DSPSCALE.BRUSH DSPSCALE.POINTS DSPSCALE.REGION DSPSCALE.NUMBER 
                         DSPSCALE.POSITION DSPSCALE.XPOSITION DSPSCALE.YPOSITION DSPSCALE.WIDTH 
                         DSPUNSCALE.REGION DSPUNSCALE.POSITION DSPUNSCALE.NUMBER DSPUNSCALE.CHARACTER
                         )
                    (VARS DSPSCALECOMS)

      previous date%: "19-Jul-88 10:00:47" |{MCS:MCS:STANFORD}<LANE>DSPSCALE.;6|)


(* "
Copyright (c) 1985, 1986, 1987, 1988 by Stanford University.  All rights reserved.
")

(PRETTYCOMPRINT DSPSCALECOMS)

(RPAQQ DSPSCALECOMS 
       ((LOCALVARS . T)
        (* * SCALED ImageStream ImageOp Functions)
        (FNS INITSCALEDIMAGESTREAM OPENIMAGESTREAM.SCALED)
        (FNS \BACKCOLOR.SCALED \BITBLT.SCALED \BLTSHADE.SCALED \BOTTOMMARGIN.SCALED \BOUT.SCALED 
             \CHARSET.SCALED \CHARWIDTH.SCALED \CHARWIDTHY.SCALED \CLIPPINGREGION.SCALED 
             \CLOSEFN.SCALED \COLOR.SCALED \DEFAULTSTATE.SCALED \DRAWARC.SCALED \DRAWCIRCLE.SCALED 
             \DRAWCURVE.SCALED \DRAWELLIPSE.SCALED \DRAWLINE.SCALED \DRAWPOINT.SCALED 
             \DRAWPOLYGON.SCALED \FILLCIRCLE.SCALED \FILLPOLYGON.SCALED \FONT.SCALED 
             \LEFTMARGIN.SCALED \LINEFEED.SCALED \MOVETO.SCALED \NEWPAGE.SCALED \OPERATION.SCALED 
             \POPSTATE.SCALED \PUSHSTATE.SCALED \RESET.SCALED \RIGHTMARGIN.SCALED \ROTATE.SCALED 
             \SCALE.SCALED \SCALEDBITBLT.SCALED \SPACEFACTOR.SCALED \STRINGWIDTH.SCALED 
             \TERPRI.SCALED \TOPMARGIN.SCALED \TRANSLATE.SCALED \XPOSITION.SCALED \YPOSITION.SCALED 
             \OUTCHAR.SCALED)
        (* * Self Scaling DSP* Functions)
        (FNS CENTERPRINTINREGION! CHARWIDTH! CHARWIDTHY! CURSORPOSITION! BITBLT! BITMAPBIT! BLTSHADE!
             DSPBACKUP! DSPBOTTOMMARGIN! DSPCLIPPINGREGION! DRAWBETWEEN! DRAWARC! DRAWCIRCLE! 
             DRAWCURVE! DRAWELLIPSE! DRAWLINE! DRAWPOINT! DRAWPOLYGON! DRAWTO! FILLCIRCLE! 
             FILLPOLYGON! FONTPROP! DSPLEFTMARGIN! DSPLINEFEED! GETPOSITION! MOVETO! MOVETOUPPERLEFT!
             DSPRIGHTMARGIN! DSPSCALE! RELDRAWTO! RELMOVETO! SCALEDBITBLT! STRINGREGION! STRINGWIDTH!
             DSPSPACEFACTOR! DSPTRANSLATE! DSPTOPMARGIN! DSPUNITS! DSPXOFFSET! DSPXPOSITION! 
             DSPYOFFSET! DSPYPOSITION!)
        (* * Low Level Scaling Functions)
        (FNS DSPSCALE.BRUSH DSPSCALE.DASHING DSPSCALE.POINTS DSPSCALE.REGION DSPSCALE.NUMBER 
             DSPSCALE.POSITION DSPSCALE.XPOSITION DSPSCALE.YPOSITION DSPSCALE.WIDTH DSPUNSCALE.REGION
             DSPUNSCALE.POSITION DSPUNSCALE.NUMBER DSPUNSCALE.CHARACTER)
        (MACROS DSPUNSCALE.XPOSITION DSPUNSCALE.YPOSITION)
        (* * etc.)
        (DECLARE%: DONTCOPY (RECORDS SCALEDIMAGEDATA CONVERT))
        [ADDVARS (IMAGESTREAMTYPES (SCALED (OPENSTREAM OPENIMAGESTREAM.SCALED]
        (INITVARS \SCALEDIMAGEOPS \NULLFDEV)
        (GLOBALVARS \SCALEDIMAGEOPS \NULLFDEV)
        [INITVARS (DSPSCALE.SCRATCHBRUSH '(ROUND 1 NIL))
               (DSPSCALE.SCRATCHREGION (create REGION))
               (DSPSCALE.SCRATCHPOSITION (create POSITION))
               (DSPSCALE.SCRATCHLIST (to 10 collect))
               (DSPSCALE.SCRATCHDASHING (to 10 collect))
               (DSPSCALE.SCRATCHPOINTS (to 10 collect (create POSITION]
        (GLOBALVARS DSPSCALE.SCRATCHBRUSH DSPSCALE.SCRATCHREGION DSPSCALE.SCRATCHPOSITION 
               DSPSCALE.SCRATCHLIST DSPSCALE.SCRATCHDASHING DSPSCALE.SCRATCHPOINTS)
        (P (MOVD? 'DSPUNITS! 'DSPUNITS)
           (INITSCALEDIMAGESTREAM))))
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(LOCALVARS . T)
)
(* * SCALED ImageStream ImageOp Functions)

(DEFINEQ

(INITSCALEDIMAGESTREAM
  [LAMBDA NIL                                            (* ; "Edited 19-Jul-88 10:59 by cdl")
    (DECLARE (GLOBALVARS \DISPLAYIMAGEOPS))
    [if (NULL \NULLFDEV)
        then (SETQ \NULLFDEV (create FDEV
                                        CLOSEFILE _ (FUNCTION NILL]
    (SETQ \SCALEDIMAGEOPS (create IMAGEOPS
                                 IMAGETYPE _ 'SCALED
                                 IMCLOSEFN _ (FUNCTION \CLOSEFN.SCALED)
                                 IMXPOSITION _ (FUNCTION \XPOSITION.SCALED)
                                 IMYPOSITION _ (FUNCTION \YPOSITION.SCALED)
                                 IMFONT _ (FUNCTION \FONT.SCALED)
                                 IMLEFTMARGIN _ (FUNCTION \LEFTMARGIN.SCALED)
                                 IMRIGHTMARGIN _ (FUNCTION \RIGHTMARGIN.SCALED)
                                 IMLINEFEED _ (FUNCTION \LINEFEED.SCALED)
                                 IMDRAWLINE _ (FUNCTION \DRAWLINE.SCALED)
                                 IMDRAWCURVE _ (FUNCTION \DRAWCURVE.SCALED)
                                 IMDRAWCIRCLE _ (FUNCTION \DRAWCIRCLE.SCALED)
                                 IMDRAWELLIPSE _ (FUNCTION \DRAWELLIPSE.SCALED)
                                 IMFILLCIRCLE _ (FUNCTION \FILLCIRCLE.SCALED)
                                 IMBLTSHADE _ (FUNCTION \BLTSHADE.SCALED)
                                 IMBITBLT _ (FUNCTION \BITBLT.SCALED)
                                 IMNEWPAGE _ (FUNCTION \NEWPAGE.SCALED)
                                 IMMOVETO _ (FUNCTION \MOVETO.SCALED)
                                 IMSCALE _ (FUNCTION \SCALE.SCALED)
                                 IMTERPRI _ (FUNCTION \TERPRI.SCALED)
                                 IMTOPMARGIN _ (FUNCTION \TOPMARGIN.SCALED)
                                 IMBOTTOMMARGIN _ (FUNCTION \BOTTOMMARGIN.SCALED)
                                 IMSPACEFACTOR _ (FUNCTION \SPACEFACTOR.SCALED)
                                 IMFONTCREATE _ 'DISPLAY
                                 IMOPERATION _ (FUNCTION \OPERATION.SCALED)
                                 IMCOLOR _ (FUNCTION \COLOR.SCALED)
                                 IMSTRINGWIDTH _ (FUNCTION \STRINGWIDTH.SCALED)
                                 IMCHARWIDTH _ (FUNCTION \CHARWIDTH.SCALED)
                                 IMCHARWIDTHY _ (FUNCTION \CHARWIDTHY.SCALED)
                                 IMBACKCOLOR _ (FUNCTION \BACKCOLOR.SCALED)
                                 IMCLIPPINGREGION _ (FUNCTION \CLIPPINGREGION.SCALED)
                                 IMRESET _ (FUNCTION \RESET.SCALED)
                                 IMDRAWPOLYGON _ (FUNCTION \DRAWPOLYGON.SCALED)
                                 IMFILLPOLYGON _ (FUNCTION \FILLPOLYGON.SCALED)
                                 IMSCALEDBITBLT _ (FUNCTION \SCALEDBITBLT.SCALED)
                                 IMCHARSET _ (FUNCTION \CHARSET.SCALED)
                                 IMROTATE _ (FUNCTION \ROTATE.SCALED)
                                 IMDRAWARC _ (FUNCTION \DRAWARC.SCALED)
                                 IMTRANSLATE _ (FUNCTION \TRANSLATE.SCALED)
                                 IMPUSHSTATE _ (FUNCTION \PUSHSTATE.SCALED)
                                 IMPOPSTATE _ (FUNCTION \POPSTATE.SCALED)
                                 IMDEFAULTSTATE _ (FUNCTION \DEFAULTSTATE.SCALED)
                                 IMDRAWPOINT _ (FUNCTION \DRAWPOINT.SCALED])

(OPENIMAGESTREAM.SCALED
  [LAMBDA (IMAGESTREAM OPTIONS)                          (* cdl "26-Jan-87 09:23")
                                                             (* DECLARATIONS%: (RECORD PAIR
                                                           (KEY VALUE)))
    (LET (STREAM SCALE)
         [SETQ OPTIONS (for PAIR on OPTIONS by (CDDR PAIR)
                          when (with PAIR PAIR (SELECTQ KEY
                                                           (SCALE (SETQ SCALE VALUE)
                                                                  NIL)
                                                           T)) join (with PAIR PAIR
                                                                               (LIST KEY VALUE]
         (with STREAM (SETQ STREAM (create STREAM
                                              IMAGEDATA _ (create SCALEDIMAGEDATA
                                                                 IMAGESTREAM _ IMAGESTREAM)
                                              IMAGEOPS _ (create IMAGEOPS
                                                                IMFONTCREATE _
                                                                (with IMAGEOPS
                                                                       (fetch (STREAM IMAGEOPS)
                                                                          of IMAGESTREAM)
                                                                       IMFONTCREATE) reusing
                                                                                     \SCALEDIMAGEOPS)
                                              OUTCHARFN _ (FUNCTION \OUTCHAR.SCALED)
                                              ACCESS _ 'OUTPUT
                                              DEVICE _ \NULLFDEV))
                (SETQ STRMBOUTFN (FUNCTION \BOUT.SCALED)))
         (if SCALE
             then (DSPSCALE! SCALE IMAGESTREAM))
         STREAM])
)
(DEFINEQ

(\BACKCOLOR.SCALED
  [LAMBDA (STREAM COLOR)                                 (* cdl "26-Jan-87 09:04")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMBACKCOLOR IMAGESTREAM IMAGESTREAM COLOR])

(\BITBLT.SCALED
  [LAMBDA (SOURCEBITMAP SOURCELEFT SOURCEBOTTOM STREAM DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION)
                                                             (* cdl "26-Jan-87 10:37")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (BITBLT SOURCEBITMAP SOURCELEFT SOURCEBOTTOM IMAGESTREAM (DSPSCALE.XPOSITION 
                                                                           DESTINATIONLEFT 
                                                                           IMAGESTREAM)
                  (DSPSCALE.YPOSITION DESTINATIONBOTTOM IMAGESTREAM)
                  WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION 
                                                                   IMAGESTREAM])

(\BLTSHADE.SCALED
  [LAMBDA (TEXTURE STREAM DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT OPERATION CLIPPINGREGION)
                                                             (* cdl "26-Jan-87 10:05")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMBLTSHADE IMAGESTREAM TEXTURE IMAGESTREAM (DSPSCALE.XPOSITION 
                                                                       DESTINATIONLEFT IMAGESTREAM)
                  (DSPSCALE.YPOSITION DESTINATIONBOTTOM IMAGESTREAM)
                  (DSPSCALE.NUMBER WIDTH IMAGESTREAM)
                  (DSPSCALE.NUMBER HEIGHT IMAGESTREAM)
                  OPERATION
                  (DSPSCALE.REGION CLIPPINGREGION IMAGESTREAM])

(\BOTTOMMARGIN.SCALED
  [LAMBDA (STREAM YPOSITION)                             (* cdl "26-Jan-87 08:55")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.YPOSITION (IMAGEOP 'IMBOTTOMMARGIN IMAGESTREAM IMAGESTREAM
                                        (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\BOUT.SCALED
  [LAMBDA (STREAM BYTE)                                  (* cdl "26-Jan-87 08:49")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (BOUT IMAGESTREAM BYTE])

(\CHARSET.SCALED
  [LAMBDA (STREAM CHARACTERSET)                          (* cdl "26-Jan-87 08:49")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMCHARSET IMAGESTREAM IMAGESTREAM CHARACTERSET])

(\CHARWIDTH.SCALED
  [LAMBDA (STREAM CHARCODE)                              (* cdl "26-Jan-87 09:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.CHARACTER (IMAGEOP 'IMCHARWIDTH IMAGESTREAM IMAGESTREAM CHARCODE)
                  (DSPFONT NIL IMAGESTREAM)
                  IMAGESTREAM])

(\CHARWIDTHY.SCALED
  [LAMBDA (STREAM CHARCODE)                              (* cdl "26-Jan-87 10:17")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.CHARACTER (IMAGEOP 'IMCHARWIDTHY IMAGESTREAM IMAGESTREAM CHARCODE)
                  (DSPFONT NIL IMAGESTREAM)
                  IMAGESTREAM])

(\CLIPPINGREGION.SCALED
  [LAMBDA (STREAM REGION)                                (* cdl "26-Jan-87 09:48")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.REGION (IMAGEOP 'IMCLIPPINGREGION IMAGESTREAM IMAGESTREAM
                                         (if REGION
                                             then (DSPSCALE.REGION REGION IMAGESTREAM)))
                  IMAGESTREAM])

(\CLOSEFN.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 08:49")
    (with STREAM STREAM (PROG1 (CLOSEF (with SCALEDIMAGEDATA IMAGEDATA IMAGESTREAM))
                                   (SETQ IMAGEDATA NIL])

(\COLOR.SCALED
  [LAMBDA (STREAM COLOR)                                 (* cdl "26-Jan-87 08:57")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMCOLOR IMAGESTREAM IMAGESTREAM COLOR])

(\DEFAULTSTATE.SCALED
  [LAMBDA (STREAM)                                       (* ; "Edited 19-Jul-88 08:34 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDEFAULTSTATE IMAGESTREAM IMAGESTREAM])

(\DRAWARC.SCALED
  [LAMBDA (STREAM CENTERX CENTERY RADIUS STARTANGLE NDEGREES BRUSH DASHING)
                                                             (* ; "Edited 14-Sep-87 14:30 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWARC IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX IMAGESTREAM)
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER RADIUS IMAGESTREAM)
                  STARTANGLE NDEGREES (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWCIRCLE.SCALED
  [LAMBDA (STREAM CENTERX CENTERY RADIUS BRUSH DASHING)  (* cdl "26-Jan-87 09:03")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWCIRCLE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX IMAGESTREAM
                                                                 )
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER RADIUS IMAGESTREAM)
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWCURVE.SCALED
  [LAMBDA (STREAM KNOTS CLOSED BRUSH DASHING)            (* cdl "26-Jan-87 09:36")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWCURVE IMAGESTREAM IMAGESTREAM (DSPSCALE.POINTS KNOTS IMAGESTREAM)
                  CLOSED
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWELLIPSE.SCALED
  [LAMBDA (STREAM CENTERX CENTERY SEMIMINORRADIUS SEMIMAJORRADIUS ORIENTATION BRUSH DASHING)
                                                             (* cdl "26-Jan-87 09:26")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWELLIPSE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX 
                                                                  IMAGESTREAM)
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER SEMIMINORRADIUS IMAGESTREAM)
                  (DSPSCALE.NUMBER SEMIMAJORRADIUS IMAGESTREAM)
                  ORIENTATION
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWLINE.SCALED
  [LAMBDA (STREAM X1 Y1 X2 Y2 WIDTH OPERATION COLOR DASHING)
                                                             (* cdl "26-Jan-87 09:41")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWLINE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION X1 IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y1 IMAGESTREAM)
                  (DSPSCALE.XPOSITION X2 IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y2 IMAGESTREAM)
                  (DSPSCALE.WIDTH WIDTH IMAGESTREAM)
                  OPERATION COLOR (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\DRAWPOINT.SCALED
  [LAMBDA (STREAM X Y BRUSH OPERATION)                   (* ; "Edited 14-Sep-87 14:30 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWPOINT IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION X IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y IMAGESTREAM)
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  OPERATION])

(\DRAWPOLYGON.SCALED
  [LAMBDA (STREAM KNOTS CLOSED BRUSH DASHING)            (* cdl "26-Jan-87 09:37")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMDRAWPOLYGON IMAGESTREAM IMAGESTREAM (DSPSCALE.POINTS KNOTS IMAGESTREAM)
                  CLOSED
                  (DSPSCALE.BRUSH BRUSH IMAGESTREAM)
                  (DSPSCALE.DASHING DASHING IMAGESTREAM])

(\FILLCIRCLE.SCALED
  [LAMBDA (STREAM CENTERX CENTERY RADIUS TEXTURE)        (* cdl "26-Jan-87 08:59")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMFILLCIRCLE IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION CENTERX IMAGESTREAM
                                                                 )
                  (DSPSCALE.YPOSITION CENTERY IMAGESTREAM)
                  (DSPSCALE.NUMBER RADIUS IMAGESTREAM)
                  TEXTURE])

(\FILLPOLYGON.SCALED
  [LAMBDA (STREAM KNOTS TEXTURE OPERATION WINDNUMBER)    (* ; "Edited 19-Jul-88 10:30 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMFILLPOLYGON IMAGESTREAM IMAGESTREAM (DSPSCALE.POINTS KNOTS IMAGESTREAM)
                  TEXTURE OPERATION WINDNUMBER])

(\FONT.SCALED
  [LAMBDA (STREAM FONT)                                  (* cdl "26-Jan-87 09:13")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMFONT IMAGESTREAM IMAGESTREAM FONT])

(\LEFTMARGIN.SCALED
  [LAMBDA (STREAM XPOSITION)                             (* cdl "26-Jan-87 08:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.XPOSITION (IMAGEOP 'IMLEFTMARGIN IMAGESTREAM IMAGESTREAM
                                        (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\LINEFEED.SCALED
  [LAMBDA (STREAM DELTAY)                                (* cdl "26-Jan-87 09:28")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.NUMBER (IMAGEOP 'IMLINEFEED IMAGESTREAM IMAGESTREAM
                                         (if DELTAY
                                             then (DSPSCALE.NUMBER DELTAY IMAGESTREAM)))
                  IMAGESTREAM])

(\MOVETO.SCALED
  [LAMBDA (STREAM X Y)                                   (* cdl "26-Jan-87 09:30")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMMOVETO IMAGESTREAM IMAGESTREAM (DSPSCALE.XPOSITION X IMAGESTREAM)
                  (DSPSCALE.YPOSITION Y IMAGESTREAM])

(\NEWPAGE.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 09:10")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMNEWPAGE IMAGESTREAM IMAGESTREAM])

(\OPERATION.SCALED
  [LAMBDA (STREAM OPERATION)                             (* cdl "26-Jan-87 08:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMOPERATION IMAGESTREAM IMAGESTREAM OPERATION])

(\POPSTATE.SCALED
  [LAMBDA (STREAM)                                       (* ; "Edited 19-Jul-88 08:32 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMPOPSTATE IMAGESTREAM IMAGESTREAM])

(\PUSHSTATE.SCALED
  [LAMBDA (STREAM)                                       (* ; "Edited 19-Jul-88 08:31 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMPUSHSTATE IMAGESTREAM IMAGESTREAM])

(\RESET.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 09:09")
    (with STREAM STREAM (SETQ CHARPOSITION 0)
           (with SCALEDIMAGEDATA IMAGEDATA (IMAGEOP 'IMRESET IMAGESTREAM IMAGESTREAM])

(\RIGHTMARGIN.SCALED
  [LAMBDA (STREAM XPOSITION)                             (* cdl "26-Jan-87 08:50")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.XPOSITION (IMAGEOP 'IMRIGHTMARGIN IMAGESTREAM IMAGESTREAM
                                        (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\ROTATE.SCALED
  [LAMBDA (STREAM ROTATION)                              (* ; "Edited 14-Sep-87 14:22 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (IMAGEOP 'IMROTATE IMAGESTREAM IMAGESTREAM ROTATION])

(\SCALE.SCALED
  [LAMBDA (STREAM SCALE)                                 (* cdl "26-Jan-87 09:34")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (if SCALE
               then (DSPSCALE! SCALE IMAGESTREAM)
             else (IMAGEOP 'IMSCALE IMAGESTREAM IMAGESTREAM])

(\SCALEDBITBLT.SCALED
  [LAMBDA (SOURCEBITMAP SOURCELEFT SOURCEBOTTOM STREAM DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION SCALE)
                                                             (* cdl "26-Jan-87 10:38")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (SCALEDBITBLT SOURCEBITMAP SOURCELEFT SOURCEBOTTOM IMAGESTREAM (DSPSCALE.XPOSITION
                                                                           DESTINATIONLEFT 
                                                                           IMAGESTREAM)
                  (DSPSCALE.YPOSITION DESTINATIONBOTTOM IMAGESTREAM)
                  WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION 
                                                                   IMAGESTREAM)
                  SCALE])

(\SPACEFACTOR.SCALED
  [LAMBDA (STREAM FACTOR)                                (* cdl "26-Jan-87 09:46")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.NUMBER (IMAGEOP 'IMSPACEFACTOR IMAGESTREAM IMAGESTREAM
                                         (if FACTOR
                                             then (DSPSCALE.NUMBER FACTOR IMAGESTREAM)))
                  IMAGESTREAM])

(\STRINGWIDTH.SCALED
  [LAMBDA (STREAM STRING RDTBL)                          (* cdl "26-Jan-87 09:45")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.CHARACTER (IMAGEOP 'IMSTRINGWIDTH IMAGESTREAM IMAGESTREAM STRING RDTBL)
                  (DSPFONT NIL IMAGESTREAM)
                  IMAGESTREAM])

(\TERPRI.SCALED
  [LAMBDA (STREAM)                                       (* cdl "26-Jan-87 09:06")
    (with STREAM STREAM (SETQ CHARPOSITION 0)
           (with SCALEDIMAGEDATA IMAGEDATA (IMAGEOP 'IMTERPRI IMAGESTREAM IMAGESTREAM])

(\TOPMARGIN.SCALED
  [LAMBDA (STREAM YPOSITION)                             (* cdl "26-Jan-87 08:54")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.YPOSITION (IMAGEOP 'IMTOPMARGIN IMAGESTREAM IMAGESTREAM
                                        (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\TRANSLATE.SCALED
  [LAMBDA (STREAM Tx Ty)                                 (* ; "Edited 19-Jul-88 13:32 by cdl")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (STREAMPROP IMAGESTREAM 'TRANSLATE (CREATEPOSITION (DSPSCALE.NUMBER Tx STREAM)
                                                     (DSPSCALE.NUMBER Ty STREAM])

(\XPOSITION.SCALED
  [LAMBDA (STREAM XPOSITION)                             (* cdl "26-Jan-87 08:51")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.XPOSITION (IMAGEOP 'IMXPOSITION IMAGESTREAM IMAGESTREAM
                                        (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\YPOSITION.SCALED
  [LAMBDA (STREAM YPOSITION)                             (* cdl "26-Jan-87 08:51")
    (with SCALEDIMAGEDATA (with STREAM STREAM IMAGEDATA)
           (DSPUNSCALE.YPOSITION (IMAGEOP 'IMYPOSITION IMAGESTREAM IMAGESTREAM
                                        (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION IMAGESTREAM)))
                  IMAGESTREAM])

(\OUTCHAR.SCALED
  [LAMBDA (STREAM CHARCODE)                              (* cdl "26-Jan-87 10:20")
    [if (EQ CHARCODE (CHARCODE EOL))
        then (with STREAM STREAM (SETQ CHARPOSITION 0))
      else (freplace CHARPOSITION of STREAM with (\LOLOC (\ADDBASE (ffetch 
                                                                                         CHARPOSITION
                                                                                      of STREAM)
                                                                                1]
    (BOUT STREAM CHARCODE])
)
(* * Self Scaling DSP* Functions)

(DEFINEQ

(CENTERPRINTINREGION!
  [LAMBDA (EXP REGION STREAM)                            (* cdl "29-Jul-85 12:09")
    (CENTERPRINTINREGION EXP (if REGION
                                 then (DSPSCALE.REGION REGION STREAM))
           STREAM])

(CHARWIDTH!
  [LAMBDA (CHARCODE FONT STREAM)                         (* ; "Edited 19-Jul-88 13:16 by cdl")
    (DSPUNSCALE.CHARACTER (CHARWIDTH CHARCODE FONT)
           FONT
           (OR STREAM (IMAGESTREAMP FONT])

(CHARWIDTHY!
  [LAMBDA (CHARCODE FONT STREAM)                         (* ; "Edited 19-Jul-88 13:16 by cdl")
    (DSPUNSCALE.CHARACTER (CHARWIDTHY CHARCODE FONT)
           FONT
           (OR STREAM (IMAGESTREAMP FONT])

(CURSORPOSITION!
  [LAMBDA (NEWPOSITION STREAM OLDPOSITION)               (* cdl "30-Oct-85 08:15")
    (DSPUNSCALE.POSITION (CURSORPOSITION (if NEWPOSITION
                                                 then (DSPSCALE.POSITION NEWPOSITION STREAM 
                                                                 OLDPOSITION))
                                    STREAM OLDPOSITION)
           STREAM OLDPOSITION])

(BITBLT!
  [LAMBDA (SOURCE SOURCELEFT SOURCEBOTTOM DESTINATION DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION)
                                                             (* cdl "29-Jul-85 12:09")
    (BITBLT SOURCE SOURCELEFT SOURCEBOTTOM DESTINATION (DSPSCALE.XPOSITION DESTINATIONLEFT 
                                                              DESTINATION)
           (DSPSCALE.YPOSITION DESTINATIONBOTTOM DESTINATION)
           WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION DESTINATION])

(BITMAPBIT!
  [LAMBDA (STREAM X Y NEWVALUE)                          (* cdl "29-Jul-85 12:01")
    (BITMAPBIT STREAM (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           NEWVALUE])

(BLTSHADE!
  [LAMBDA (TEXTURE DESTINATION DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT OPERATION 
                 CLIPPINGREGION)                         (* cdl "29-Jul-85 12:02")
    (BLTSHADE TEXTURE DESTINATION (DSPSCALE.XPOSITION DESTINATIONLEFT DESTINATION)
           (DSPSCALE.YPOSITION DESTINATIONBOTTOM DESTINATION)
           (DSPSCALE.NUMBER WIDTH DESTINATION)
           (DSPSCALE.NUMBER HEIGHT DESTINATION)
           OPERATION
           (DSPSCALE.REGION CLIPPINGREGION DESTINATION])

(DSPBACKUP!
  [LAMBDA (WIDTH DISPLAYSTREAM)                          (* cdl "29-Jul-85 12:02")
    (DSPBACKUP (if WIDTH
                   then (DSPSCALE.XPOSITION WIDTH DISPLAYSTREAM))
           DISPLAYSTREAM])

(DSPBOTTOMMARGIN!
  [LAMBDA (YPOSITION STREAM)                             (* cdl "29-Jul-85 12:02")
    (DSPUNSCALE.YPOSITION (DSPBOTTOMMARGIN (if YPOSITION
                                               then (DSPSCALE.YPOSITION YPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPCLIPPINGREGION!
  [LAMBDA (REGION STREAM)                                (* cdl "29-Jul-85 08:41")
    (DSPUNSCALE.REGION (DSPCLIPPINGREGION (if REGION
                                                  then (DSPSCALE.REGION REGION STREAM))
                                  STREAM)
           STREAM])

(DRAWBETWEEN!
  [LAMBDA (PT1 PT2 WIDTH OPERATION STREAM COLOR DASHING) (* cdl "29-Oct-85 15:30")
    (DRAWBETWEEN (DSPSCALE.POSITION PT1 STREAM (CAR DSPSCALE.SCRATCHPOINTS))
           (DSPSCALE.POSITION PT2 STREAM (CADR DSPSCALE.SCRATCHPOINTS))
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(DRAWARC!
  [LAMBDA (CENTERX CENTERY RADIUS STARTANGLE NDEGREES BRUSH DASHING STREAM)
                                                             (* ; "Edited 14-Sep-87 14:34 by cdl")
    (DRAWARC (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER RADIUS STREAM)
           STARTANGLE NDEGREES (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWCIRCLE!
  [LAMBDA (CENTERX CENTERY RADIUS BRUSH DASHING STREAM)  (* cdl "29-Jul-85 12:03")
    (DRAWCIRCLE (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER RADIUS STREAM)
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWCURVE!
  [LAMBDA (KNOTS CLOSED BRUSH DASHING STREAM)            (* cdl "29-Jul-85 10:04")
    (DRAWCURVE (DSPSCALE.POINTS KNOTS STREAM)
           CLOSED
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWELLIPSE!
  [LAMBDA (CENTERX CENTERY SEMIMINORRADIUS SEMIMAJORRADIUS ORIENTATION BRUSH DASHING STREAM)
                                                             (* cdl "29-Jul-85 12:03")
    (DRAWELLIPSE (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER SEMIMINORRADIUS STREAM)
           (DSPSCALE.NUMBER SEMIMAJORRADIUS STREAM)
           ORIENTATION
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWLINE!
  [LAMBDA (X1 Y1 X2 Y2 WIDTH OPERATION STREAM COLOR DASHING)
                                                             (* cdl "29-Oct-85 15:28")
    (DRAWLINE (DSPSCALE.XPOSITION X1 STREAM)
           (DSPSCALE.YPOSITION Y1 STREAM)
           (DSPSCALE.XPOSITION X2 STREAM)
           (DSPSCALE.YPOSITION Y2 STREAM)
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(DRAWPOINT!
  [LAMBDA (X Y BRUSH STREAM OPERATION)                   (* ; "Edited 14-Sep-87 14:36 by cdl")
    (DRAWPOINT (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           (DSPSCALE.BRUSH BRUSH STREAM)
           STREAM OPERATION])

(DRAWPOLYGON!
  [LAMBDA (POINTS CLOSED BRUSH DASHING STREAM)           (* cdl "29-Jul-85 10:05")
    (DRAWPOLYGON (DSPSCALE.POINTS POINTS STREAM)
           CLOSED
           (DSPSCALE.BRUSH BRUSH STREAM)
           (DSPSCALE.DASHING DASHING STREAM)
           STREAM])

(DRAWTO!
  [LAMBDA (X Y WIDTH OPERATION STREAM COLOR DASHING)     (* cdl "29-Oct-85 15:31")
    (DRAWTO (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(FILLCIRCLE!
  [LAMBDA (CENTERX CENTERY RADIUS TEXTURE STREAM)        (* cdl " 7-Feb-86 15:02")
    (FILLCIRCLE (DSPSCALE.XPOSITION CENTERX STREAM)
           (DSPSCALE.YPOSITION CENTERY STREAM)
           (DSPSCALE.NUMBER RADIUS STREAM)
           TEXTURE STREAM])

(FILLPOLYGON!
  [LAMBDA (KNOTS TEXTURE STREAM)                         (* cdl "30-Oct-85 07:44")
    (FILLPOLYGON (DSPSCALE.POINTS KNOTS STREAM)
           TEXTURE STREAM])

(FONTPROP!
  [LAMBDA (FONT PROP STREAM)                             (* ; "Edited 19-Jul-88 13:18 by cdl")
    (SELECTQ PROP
        ((ASCENT DESCENT HEIGHT) 
             (DSPUNSCALE.CHARACTER (FONTPROP FONT PROP)
                    FONT
                    (OR STREAM (IMAGESTREAMP FONT))))
        (FONTPROP FONT PROP])

(DSPLEFTMARGIN!
  [LAMBDA (XPOSITION STREAM)                             (* cdl "29-Jul-85 12:05")
    (DSPUNSCALE.XPOSITION (DSPLEFTMARGIN (if XPOSITION
                                             then (DSPSCALE.XPOSITION XPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPLINEFEED!
  [LAMBDA (DELTAY STREAM)                                (* cdl "29-Jul-85 11:11")
    (DSPUNSCALE.NUMBER (DSPLINEFEED (if DELTAY
                                            then (DSPSCALE.NUMBER DELTAY STREAM))
                                  STREAM)
           STREAM])

(GETPOSITION!
  [LAMBDA (STREAM CURSOR)                                (* cdl "30-Oct-85 08:03")
    (DSPUNSCALE.POSITION (GETPOSITION STREAM CURSOR)
           STREAM])

(MOVETO!
  [LAMBDA (X Y STREAM)                                   (* cdl "29-Jul-85 12:06")
    (MOVETO (DSPSCALE.XPOSITION X STREAM)
           (DSPSCALE.YPOSITION Y STREAM)
           STREAM])

(MOVETOUPPERLEFT!
  [LAMBDA (WINDOW REGION)                                (* cdl "29-Jul-85 12:10")
    (MOVETOUPPERLEFT WINDOW (if REGION
                                then (DSPSCALE.REGION REGION WINDOW])

(DSPRIGHTMARGIN!
  [LAMBDA (XPOSITION STREAM)                             (* cdl "16-Oct-85 16:11")
    (DSPUNSCALE.XPOSITION (DSPRIGHTMARGIN (if XPOSITION
                                              then (DSPSCALE.XPOSITION XPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPSCALE!
  [LAMBDA (SCALE STREAM)                                 (* cdl "23-Apr-86 09:40")
    (if (NOT (type? STREAM STREAM))
        then (SETQ STREAM (GETSTREAM STREAM)))
    (PROG1 (OR (STREAMPROP STREAM 'SCALE)
               (DSPSCALE NIL STREAM))
        [if SCALE
            then (STREAMPROP STREAM 'SCALE SCALE)
                  (STREAMPROP STREAM 'SCALED T)
                  (LET [(RATIO (STREAMPROP STREAM 'RATIO]
                       [if (NULL RATIO)
                           then (STREAMPROP STREAM 'RATIO (SETQ RATIO (create CONVERT
                                                                                 SOURCE _ 1]
                       (with CONVERT RATIO (SETQ DESTINATION (TIMES SCALE (DSPSCALE NIL STREAM])])

(RELDRAWTO!
  [LAMBDA (DX DY WIDTH OPERATION STREAM COLOR DASHING)   (* cdl "29-Oct-85 15:31")
    (RELDRAWTO (DSPSCALE.NUMBER DX STREAM)
           (DSPSCALE.NUMBER DY STREAM)
           (DSPSCALE.WIDTH WIDTH STREAM)
           OPERATION STREAM COLOR (DSPSCALE.DASHING DASHING STREAM])

(RELMOVETO!
  [LAMBDA (DX DY STREAM)                                 (* cdl "30-Oct-85 07:43")
    (RELMOVETO (DSPSCALE.NUMBER DX STREAM)
           (DSPSCALE.NUMBER DY STREAM)
           STREAM])

(SCALEDBITBLT!
  [LAMBDA (SOURCE SOURCELEFT SOURCEBOTTOM DESTINATION DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT
                 SOURCETYPE OPERATION TEXTURE CLIPPINGREGION SCALE)
                                                             (* cdl "29-Jul-85 12:13")
    (SCALEDBITBLT SOURCELEFT SOURCEBOTTOM DESTINATION (DSPSCALE.XPOSITION DESTINATIONLEFT 
                                                             DESTINATION)
           (DSPSCALE.YPOSITION DESTINATIONBOTTOM DESTINATION)
           WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE (DSPSCALE.REGION CLIPPINGREGION DESTINATION)
           SCALE])

(STRINGREGION!
  [LAMBDA (STR STREAM PRIN2FLG RDTBL)                    (* cdl " 2-May-86 14:05")
    (LET ((REGION (STRINGREGION STR STREAM PRIN2FLG RDTBL)))
         (DSPUNSCALE.REGION REGION STREAM REGION])

(STRINGWIDTH!
  [LAMBDA (STR FONT FLG RDTBL STREAM)                    (* ; "Edited 19-Jul-88 13:18 by cdl")
    (DSPUNSCALE.CHARACTER (STRINGWIDTH STR FONT FLG RDTBL)
           FONT
           (OR STREAM (IMAGESTREAMP FONT])

(DSPSPACEFACTOR!
  [LAMBDA (FACTOR STREAM)                                (* cdl "29-Jul-85 11:12")
    (DSPUNSCALE.NUMBER (DSPSPACEFACTOR (if FACTOR
                                               then (DSPSCALE.NUMBER FACTOR STREAM))
                                  STREAM)
           STREAM])

(DSPTRANSLATE!
  [LAMBDA (Tx.OR.POSITION Ty.OR.STREAM STREAM.OR.NIL)    (* ; "Edited 19-Jul-88 09:03 by cdl")
    (if (POSITIONP Tx.OR.POSITION)
        then                                             (* Koto Compatibility)
              (STREAMPROP (GETSTREAM Ty.OR.STREAM)
                     'TRANSLATE Tx.OR.POSITION)
      else (STREAMPROP (GETSTREAM STREAM.OR.NIL)
                      'TRANSLATE
                      (CREATEPOSITION Tx.OR.POSITION Ty.OR.STREAM])

(DSPTOPMARGIN!
  [LAMBDA (YPOSITION STREAM)                             (* cdl "29-Jul-85 12:00")
    (DSPUNSCALE.YPOSITION (DSPTOPMARGIN (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPUNITS!
  [LAMBDA (UNITS STREAM)                                 (* cdl "23-Apr-86 09:40")
    (if (NOT (type? STREAM STREAM))
        then (SETQ STREAM (GETSTREAM STREAM)))
    (PROG1 (STREAMPROP STREAM 'UNITS)
        [if UNITS
            then (STREAMPROP STREAM 'UNITS UNITS)
                  (STREAMPROP STREAM 'SCALED T)
                  (LET [(RATIO (STREAMPROP STREAM 'RATIO]
                       [if (NULL RATIO)
                           then (STREAMPROP STREAM 'RATIO (SETQ RATIO (create CONVERT
                                                                                 DESTINATION _ 1]
                       (with CONVERT RATIO (SETQ SOURCE UNITS])])

(DSPXOFFSET!
  [LAMBDA (XOFFSET DISPLAYSTREAM)                        (* cdl "29-Jul-85 11:12")
    (DSPUNSCALE.NUMBER (DSPXOFFSET (if XOFFSET
                                           then (DSPSCALE.NUMBER XOFFSET DISPLAYSTREAM))
                                  DISPLAYSTREAM)
           DISPLAYSTREAM])

(DSPXPOSITION!
  [LAMBDA (XPOSITION STREAM)                             (* cdl "29-Jul-85 12:00")
    (DSPUNSCALE.XPOSITION (DSPXPOSITION (if XPOSITION
                                            then (DSPSCALE.XPOSITION XPOSITION STREAM))
                                 STREAM)
           STREAM])

(DSPYOFFSET!
  [LAMBDA (YOFFSET DISPLAYSTREAM)                        (* cdl "29-Jul-85 11:59")
    (DSPUNSCALE.NUMBER (DSPYOFFSET (if YOFFSET
                                           then (DSPSCALE.NUMBER YOFFSET DISPLAYSTREAM))
                                  DISPLAYSTREAM)
           DISPLAYSTREAM])

(DSPYPOSITION!
  [LAMBDA (YPOSITION STREAM)                             (* cdl "29-Jul-85 11:59")
    (DSPUNSCALE.YPOSITION (DSPYPOSITION (if YPOSITION
                                            then (DSPSCALE.YPOSITION YPOSITION STREAM))
                                 STREAM)
           STREAM])
)
(* * Low Level Scaling Functions)

(DEFINEQ

(DSPSCALE.BRUSH
  [LAMBDA (BRUSH STREAM)                                 (* cdl "29-Oct-85 15:29")
    (if (NULL BRUSH)
        then (create BRUSH
                        BRUSHSHAPE _ 'ROUND
                        BRUSHSIZE _ (DSPSCALE.WIDTH 1 STREAM) smashing DSPSCALE.SCRATCHBRUSH)
      elseif (LISTP BRUSH)
        then (with BRUSH BRUSH (create BRUSH
                                              BRUSHCOLOR _ BRUSHCOLOR
                                              BRUSHSHAPE _ BRUSHSHAPE
                                              BRUSHSIZE _ (DSPSCALE.WIDTH BRUSHSIZE STREAM)
                                          smashing DSPSCALE.SCRATCHBRUSH))
      elseif (NUMBERP BRUSH)
        then (DSPSCALE.WIDTH BRUSH STREAM)
      else BRUSH])

(DSPSCALE.DASHING
  [LAMBDA (DASHING STREAM)                               (* ; "Edited 19-Jul-88 10:21 by cdl")
    (if (LISTP DASHING)
        then [SCRATCHLIST DSPSCALE.SCRATCHDASHING (for WIDTH in DASHING
                                                         do (ADDTOSCRATCHLIST (DSPSCALE.WIDTH
                                                                                   WIDTH STREAM]
      elseif (NUMBERP DASHING)
        then (DSPSCALE.WIDTH DASHING STREAM)
      else DASHING])

(DSPSCALE.POINTS
  [LAMBDA (KNOTS STREAM)                                 (* ; "Edited 19-Jul-88 09:52 by cdl")
    (SCRATCHLIST DSPSCALE.SCRATCHLIST (bind (KNOTSLST _ DSPSCALE.SCRATCHPOINTS) for KNOT
                                         in KNOTS
                                         do (ADDTOSCRATCHLIST
                                                 (DSPSCALE.POSITION
                                                  KNOT STREAM (if KNOTSLST
                                                                  then (pop KNOTSLST)
                                                                else (push 
                                                                               DSPSCALE.SCRATCHPOINTS
                                                                                (create POSITION)
                                                                                )
                                                                      (CAR DSPSCALE.SCRATCHPOINTS])

(DSPSCALE.REGION
  [LAMBDA (REGION STREAM SMASH)                          (* cdl "28-Oct-85 09:00")
    (if (type? REGION REGION)
        then (with REGION REGION (create REGION
                                                LEFT _ (DSPSCALE.XPOSITION LEFT STREAM)
                                                BOTTOM _ (DSPSCALE.YPOSITION BOTTOM STREAM)
                                                WIDTH _ (DSPSCALE.NUMBER WIDTH STREAM)
                                                HEIGHT _ (DSPSCALE.NUMBER HEIGHT STREAM)
                                            smashing (OR SMASH DSPSCALE.SCRATCHREGION)))
      else REGION])

(DSPSCALE.NUMBER
  [LAMBDA (VALUE STREAM)                                 (* cdl "23-Apr-86 09:10")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              (if [FLOATP (SETQ VALUE (if (GETSTREAMPROP STREAM 'SCALED)
                                              then (with CONVERT (GETSTREAMPROP STREAM
                                                                                'RATIO)
                                                              (QUOTIENT (TIMES VALUE DESTINATION)
                                                                     SOURCE))
                                            else (TIMES (IMAGEOP 'IMSCALE STREAM STREAM)
                                                            VALUE]
                  then (FIXR VALUE)
                else VALUE)
      else VALUE])

(DSPSCALE.POSITION
  [LAMBDA (POSITION STREAM SMASH)                        (* cdl "29-Jul-85 11:57")
    (with POSITION POSITION (create POSITION
                                       XCOORD _ (DSPSCALE.XPOSITION XCOORD STREAM)
                                       YCOORD _ (DSPSCALE.YPOSITION YCOORD STREAM)
                                   smashing (OR SMASH DSPSCALE.SCRATCHPOSITION])

(DSPSCALE.XPOSITION
  [LAMBDA (VALUE STREAM)                                 (* cdl " 1-Nov-85 08:47")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              [LET [(TRANSLATE (GETSTREAMPROP STREAM 'TRANSLATE]
                   (if TRANSLATE
                       then (with POSITION TRANSLATE (add VALUE XCOORD]
              (DSPSCALE.NUMBER VALUE STREAM)
      else VALUE])

(DSPSCALE.YPOSITION
  [LAMBDA (VALUE STREAM)                                 (* cdl " 1-Nov-85 08:47")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              [LET [(TRANSLATE (GETSTREAMPROP STREAM 'TRANSLATE]
                   (if TRANSLATE
                       then (with POSITION TRANSLATE (add VALUE YCOORD]
              (DSPSCALE.NUMBER VALUE STREAM)
      else VALUE])

(DSPSCALE.WIDTH
  [LAMBDA (WIDTH STREAM)                                 (* cdl "29-Oct-85 15:27")
    (if (ZEROP (SETQ WIDTH (DSPSCALE.NUMBER WIDTH STREAM)))
        then 1
      else WIDTH])

(DSPUNSCALE.REGION
  [LAMBDA (REGION STREAM SMASH)                          (* cdl " 2-May-86 14:04")
    (if (type? REGION REGION)
        then (with REGION REGION (create REGION
                                                LEFT _ (DSPUNSCALE.XPOSITION LEFT STREAM)
                                                BOTTOM _ (DSPUNSCALE.YPOSITION BOTTOM STREAM)
                                                WIDTH _ (DSPUNSCALE.NUMBER WIDTH STREAM)
                                                HEIGHT _ (DSPUNSCALE.NUMBER HEIGHT STREAM)
                                            smashing (OR SMASH DSPSCALE.SCRATCHREGION)))
      else REGION])

(DSPUNSCALE.POSITION
  [LAMBDA (POSITION STREAM SMASH)                        (* cdl "17-Sep-85 14:21")
    (with POSITION POSITION (create POSITION
                                       XCOORD _ (DSPUNSCALE.XPOSITION XCOORD STREAM)
                                       YCOORD _ (DSPUNSCALE.YPOSITION YCOORD STREAM)
                                   smashing (OR SMASH DSPSCALE.SCRATCHPOSITION])

(DSPUNSCALE.NUMBER
  [LAMBDA (VALUE STREAM OFFSET)                          (* cdl "27-Jan-87 11:32")
    (if (NUMBERP VALUE)
        then (if (NOT (type? STREAM STREAM))
                     then (SETQ STREAM (GETSTREAM STREAM)))
              [SETQ VALUE (if (GETSTREAMPROP STREAM 'SCALED)
                              then (with CONVERT (GETSTREAMPROP STREAM 'RATIO)
                                              (QUOTIENT (TIMES VALUE SOURCE)
                                                     DESTINATION))
                            else (QUOTIENT VALUE (IMAGEOP 'IMSCALE STREAM STREAM]
              [if OFFSET
                  then (LET [(TRANSLATE (GETSTREAMPROP STREAM 'TRANSLATE]
                                (if TRANSLATE
                                    then (with POSITION TRANSLATE
                                                    (SELECTQ OFFSET
                                                        (X (SETQ VALUE (DIFFERENCE VALUE XCOORD)))
                                                        (Y (SETQ VALUE (DIFFERENCE VALUE YCOORD)))
                                                        NIL]
              (if (FLOATP VALUE)
                  then (FIXR VALUE)
                else VALUE)
      else VALUE])

(DSPUNSCALE.CHARACTER
  [LAMBDA (WIDTH FONT STREAM)                            (* cdl "23-Apr-86 09:11")
    (LET (CONVERT VALUE)
         (if (NUMBERP WIDTH)
             then (if [FLOATP (SETQ VALUE (if (AND STREAM (OR (type? STREAM STREAM)
                                                                          (SETQ STREAM (GETSTREAM
                                                                                        STREAM)))
                                                               (GETSTREAMPROP STREAM 'SCALED))
                                                      then (with CONVERT (GETSTREAMPROP
                                                                                  STREAM
                                                                                  'RATIO)
                                                                      (QUOTIENT (TIMES WIDTH SOURCE)
                                                                             DESTINATION))
                                                    else (QUOTIENT WIDTH
                                                                    (OR (with FONTDESCRIPTOR FONT
                                                                               FONTSCALE)
                                                                        (IMAGEOP 'IMSCALE STREAM 
                                                                               STREAM]
                          then (FIXR VALUE)
                        else VALUE)
           else WIDTH])
)
(DECLARE%: EVAL@COMPILE 

[PUTPROPS DSPUNSCALE.XPOSITION MACRO ((VALUE STREAM)
                                      (DSPUNSCALE.NUMBER VALUE STREAM 'X]

[PUTPROPS DSPUNSCALE.YPOSITION MACRO ((VALUE STREAM)
                                      (DSPUNSCALE.NUMBER VALUE STREAM 'Y]
)
(* * etc.)

(DECLARE%: DONTCOPY 
(DECLARE%: EVAL@COMPILE

(RECORD SCALEDIMAGEDATA (IMAGESTREAM))

(RECORD CONVERT (SOURCE . DESTINATION))
)
)

(ADDTOVAR IMAGESTREAMTYPES (SCALED (OPENSTREAM OPENIMAGESTREAM.SCALED)))

(RPAQ? \SCALEDIMAGEOPS NIL)

(RPAQ? \NULLFDEV NIL)
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS \SCALEDIMAGEOPS \NULLFDEV)
)

(RPAQ? DSPSCALE.SCRATCHBRUSH '(ROUND 1 NIL))

(RPAQ? DSPSCALE.SCRATCHREGION (create REGION))

(RPAQ? DSPSCALE.SCRATCHPOSITION (create POSITION))

(RPAQ? DSPSCALE.SCRATCHLIST (to 10 collect))

(RPAQ? DSPSCALE.SCRATCHDASHING (to 10 collect))

(RPAQ? DSPSCALE.SCRATCHPOINTS (to 10 collect (create POSITION)))
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS DSPSCALE.SCRATCHBRUSH DSPSCALE.SCRATCHREGION DSPSCALE.SCRATCHPOSITION 
       DSPSCALE.SCRATCHLIST DSPSCALE.SCRATCHDASHING DSPSCALE.SCRATCHPOINTS)
)

(MOVD? 'DSPUNITS! 'DSPUNITS)

(INITSCALEDIMAGESTREAM)
(PUTPROPS DSPSCALE COPYRIGHT ("Stanford University" 1985 1986 1987 1988))
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (5589 11142 (INITSCALEDIMAGESTREAM 5599 . 9099) (OPENIMAGESTREAM.SCALED 9101 . 11140)) (
11143 28693 (\BACKCOLOR.SCALED 11153 . 11396) (\BITBLT.SCALED 11398 . 12265) (\BLTSHADE.SCALED 12267
 . 13022) (\BOTTOMMARGIN.SCALED 13024 . 13479) (\BOUT.SCALED 13481 . 13690) (\CHARSET.SCALED 13692 . 
13938) (\CHARWIDTH.SCALED 13940 . 14287) (\CHARWIDTHY.SCALED 14289 . 14638) (\CLIPPINGREGION.SCALED 
14640 . 15093) (\CLOSEFN.SCALED 15095 . 15356) (\COLOR.SCALED 15358 . 15593) (\DEFAULTSTATE.SCALED 
15595 . 15850) (\DRAWARC.SCALED 15852 . 16481) (\DRAWCIRCLE.SCALED 16483 . 17072) (\DRAWCURVE.SCALED 
17074 . 17493) (\DRAWELLIPSE.SCALED 17495 . 18291) (\DRAWLINE.SCALED 18293 . 18940) (\DRAWPOINT.SCALED
 18942 . 19372) (\DRAWPOLYGON.SCALED 19374 . 19797) (\FILLCIRCLE.SCALED 19799 . 20297) (
\FILLPOLYGON.SCALED 20299 . 20639) (\FONT.SCALED 20641 . 20873) (\LEFTMARGIN.SCALED 20875 . 21326) (
\LINEFEED.SCALED 21328 . 21769) (\MOVETO.SCALED 21771 . 22097) (\NEWPAGE.SCALED 22099 . 22332) (
\OPERATION.SCALED 22334 . 22581) (\POPSTATE.SCALED 22583 . 22830) (\PUSHSTATE.SCALED 22832 . 23081) (
\RESET.SCALED 23083 . 23333) (\RIGHTMARGIN.SCALED 23335 . 23788) (\ROTATE.SCALED 23790 . 24042) (
\SCALE.SCALED 24044 . 24367) (\SCALEDBITBLT.SCALED 24369 . 25278) (\SPACEFACTOR.SCALED 25280 . 25727) 
(\STRINGWIDTH.SCALED 25729 . 26084) (\TERPRI.SCALED 26086 . 26338) (\TOPMARGIN.SCALED 26340 . 26789) (
\TRANSLATE.SCALED 26791 . 27161) (\XPOSITION.SCALED 27163 . 27612) (\YPOSITION.SCALED 27614 . 28063) (
\OUTCHAR.SCALED 28065 . 28691)) (28734 43771 (CENTERPRINTINREGION! 28744 . 29003) (CHARWIDTH! 29005 . 
29238) (CHARWIDTHY! 29240 . 29475) (CURSORPOSITION! 29477 . 29921) (BITBLT! 29923 . 30533) (BITMAPBIT!
 30535 . 30764) (BLTSHADE! 30766 . 31298) (DSPBACKUP! 31300 . 31536) (DSPBOTTOMMARGIN! 31538 . 31871) 
(DSPCLIPPINGREGION! 31873 . 32206) (DRAWBETWEEN! 32208 . 32591) (DRAWARC! 32593 . 33074) (DRAWCIRCLE! 
33076 . 33451) (DRAWCURVE! 33453 . 33741) (DRAWELLIPSE! 33743 . 34305) (DRAWLINE! 34307 . 34782) (
DRAWPOINT! 34784 . 35071) (DRAWPOLYGON! 35073 . 35366) (DRAWTO! 35368 . 35680) (FILLCIRCLE! 35682 . 
35971) (FILLPOLYGON! 35973 . 36161) (FONTPROP! 36163 . 36501) (DSPLEFTMARGIN! 36503 . 36830) (
DSPLINEFEED! 36832 . 37147) (GETPOSITION! 37149 . 37334) (MOVETO! 37336 . 37550) (MOVETOUPPERLEFT! 
37552 . 37785) (DSPRIGHTMARGIN! 37787 . 38117) (DSPSCALE! 38119 . 38915) (RELDRAWTO! 38917 . 39231) (
RELMOVETO! 39233 . 39449) (SCALEDBITBLT! 39451 . 40089) (STRINGREGION! 40091 . 40316) (STRINGWIDTH! 
40318 . 40560) (DSPSPACEFACTOR! 40562 . 40886) (DSPTRANSLATE! 40888 . 41389) (DSPTOPMARGIN! 41391 . 
41715) (DSPUNITS! 41717 . 42443) (DSPXOFFSET! 42445 . 42780) (DSPXPOSITION! 42782 . 43106) (
DSPYOFFSET! 43108 . 43443) (DSPYPOSITION! 43445 . 43769)) (43812 53676 (DSPSCALE.BRUSH 43822 . 44648) 
(DSPSCALE.DASHING 44650 . 45198) (DSPSCALE.POINTS 45200 . 46255) (DSPSCALE.REGION 46257 . 46955) (
DSPSCALE.NUMBER 46957 . 47912) (DSPSCALE.POSITION 47914 . 48339) (DSPSCALE.XPOSITION 48341 . 48862) (
DSPSCALE.YPOSITION 48864 . 49385) (DSPSCALE.WIDTH 49387 . 49607) (DSPUNSCALE.REGION 49609 . 50309) (
DSPUNSCALE.POSITION 50311 . 50734) (DSPUNSCALE.NUMBER 50736 . 52070) (DSPUNSCALE.CHARACTER 52072 . 
53674)))))
STOP
