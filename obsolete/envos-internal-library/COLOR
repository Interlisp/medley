(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)
(FILECREATED "15-Jun-90 12:08:41" {DSK}<usr>local>lde>lispcore>internal>library>COLOR.;2 61676  

      changes to%:  (VARS COLORCOMS)

      previous date%: "27-Jan-87 15:56:46" {DSK}<usr>local>lde>lispcore>internal>library>COLOR.;1)


(* ; "
Copyright (c) 1982, 1983, 1985, 1986, 1987, 1990 by Venue & Xerox Corporation.  All rights reserved.
")

(PRETTYCOMPRINT COLORCOMS)

(RPAQQ COLORCOMS
       [(FNS DISPLAYCOLORLEVELS DISPLAYHLSLEVELS HLSLEVEL HLSTORGB HLSVALUEFN HLSVALUEFROMLEVEL 
             LEVELFROMHLSVALUE RAINBOWMAP RGBTOHLS)
        (FNS OVERPAINT BITMAPFROMSTRING SHADEBITMAP)
        (INITVARS (EDITCOLORMAP.WINDOW NIL))
        (FNS EDITCOLORMAP EDITCOLORMAP.BUTTONEVENTFN EDITCOLORMAP.REDISPLAYFN EDITCOLORMAP.VALUELEVEL
             EDITCOLORMAP.WINDOWLEVEL CHANGECOLORLEVELS GETCOLOR#FROMUSER GETCOLOR#FROMSCREEN 
             DISPLAYCOLORLEVEL FILLINREGION AREAFILL CENTEREDLEFT OUTLINEAREA OUTLINEREGION)
        (FNS ADJUSTCOLORMAP SHOWCOLORBLOCKS MAPOFACOLOR COLORHEXPATTERN)
        (VARS EditColorMapHeight EditColorMapWidth (COLOR#MENUSAVE)
              (CONTROLMENUSAVE)
              (EDIT8BITCOLORMAPMENU)
              (EDIT8BITCOLORMAPNUMBERREADER))
        (GLOBALVARS COLOR#MENUSAVE CONTROLMENUSAVE EDIT8BITCOLORMAPMENU EDIT8BITCOLORMAPNUMBERREADER
               EditColorMapHeight EditColorMapWidth)
        (COMS 

(* ;;; "support for global naming and querying of colors.")

              (FNS CNSMENUINIT CNSTOCSL CNSTORGB CSLTOCNS DICOLOR.FROM.USER GETCNS HLSTOCSL CSLTOHLS
                   RGBTOCNS)
              (VARS DICOLOR.hueMapping DICOLOR.lightnessMapping DICOLOR.saturationMapping 
                    NEWCOLORITEM)
              (INITVARS (COLORNAMEMENU))
              (FNS DICOLOR.hueN DICOLOR.hueNvalue DICOLOR.hueNname DICOLOR.lightnessN 
                   DICOLOR.lightnessNvalue DICOLOR.lightnessNname DICOLOR.saturationN 
                   DICOLOR.saturationNvalue DICOLOR.saturationNname)
              (DECLARE%: EVAL@LOAD DONTCOPY (*)
                     (RECORDS hueRecord lightnessRecord saturationRecord)
                     (CONSTANTS * DICOLOR.hueConstants)
                     (CONSTANTS * DICOLOR.saturationConstants)
                     (CONSTANTS * DICOLOR.lightnessConstants))
              (P (CNSMENUINIT)))
        (FILES LLCOLOR READNUMBER)
        (P (SETQ EDITBMMENU NIL)
           (MOVD 'ARRAYP 'COLORMAPP])
(DEFINEQ

(DISPLAYCOLORLEVELS
  [LAMBDA (WINDOW RGB)                                       (* kbr%: " 3-Jun-86 19:45")
    (PROG (HLS)
          (DISPLAYCOLORLEVEL WINDOW 'RED (fetch (RGB RED) of RGB)
                 (fetch (RGB RED) of RGB))
          (DISPLAYCOLORLEVEL WINDOW 'GREEN (fetch (RGB GREEN) of RGB)
                 (fetch (RGB GREEN) of RGB))
          (DISPLAYCOLORLEVEL WINDOW 'BLUE (fetch (RGB BLUE) of RGB)
                 (fetch (RGB BLUE) of RGB))
          (SETQ HLS (RGBTOHLS RGB))
          (DISPLAYCOLORLEVEL WINDOW 'HUE (fetch (HLS HUE) of HLS)
                 (EDITCOLORMAP.WINDOWLEVEL 'HUE (fetch (HLS HUE) of HLS)))
          (DISPLAYCOLORLEVEL WINDOW 'LIGHTNESS (fetch (HLS LIGHTNESS) of HLS)
                 (EDITCOLORMAP.WINDOWLEVEL 'LIGHTNESS (fetch (HLS LIGHTNESS) of HLS)))
          (DISPLAYCOLORLEVEL WINDOW 'SATURATION (fetch (HLS SATURATION) of HLS)
                 (EDITCOLORMAP.WINDOWLEVEL 'SATURATION (fetch (HLS SATURATION) of HLS])

(DISPLAYHLSLEVELS
  [LAMBDA (HLS WIN)                                          (* rrb "25-OCT-82 14:08")
          
          (* displays a hue lightness saturation triple in the edit window.)

    (DISPLAYHLSLEVEL HLS 'HUE NIL WIN)
    (DISPLAYHLSLEVEL HLS 'LIGHTNESS NIL WIN)
    (DISPLAYHLSLEVEL HLS 'SATURATION NIL WIN])

(HLSLEVEL
  [LAMBDA (HLS FIELD NEWLEVEL)                               (* rrb "25-OCT-82 13:29")
          
          (* returns the value of the named field from a hue lightness saturation record.)

    (SELECTQ FIELD
        (HUE (PROG1 (fetch (HLS HUE) of HLS)
                    (AND NEWLEVEL (replace (HLS HUE) of HLS with NEWLEVEL))))
        (LIGHTNESS (PROG1 (fetch (HLS LIGHTNESS) of HLS)
                          (AND NEWLEVEL (replace (HLS LIGHTNESS) of HLS with NEWLEVEL))))
        (SATURATION (PROG1 (fetch (HLS SATURATION) of HLS)
                           (AND NEWLEVEL (replace (HLS SATURATION) of HLS with NEWLEVEL))))
        (SHOULDNT])

(HLSTORGB
  [LAMBDA (HLS LIGHTNESS SATURATION)                         (* kbr%: " 3-Jun-86 21:16")
          
          (* Converts from a hue saturation lightness triple into red green blue triple.
          HUE is in range 0 to 360, lightness and saturation are in the range 0 to 1.0 *)
          
          (* This algorithm was taken from siggraph vol 13 number 3 August 1979%: Status 
          report on graphics standards planning committee.
          *)

    (PROG (HUE M1 M2 RGB)
          (COND
             ((LISTP HLS)
              (SETQ HUE (fetch (HLS HUE) of HLS))
              (SETQ LIGHTNESS (fetch (HLS LIGHTNESS) of HLS))
              (SETQ SATURATION (fetch (HLS SATURATION) of HLS)))
             (T (SETQ HUE HLS)))
          [SETQ M1 (COND
                      ((FGREATERP 0.5 LIGHTNESS)
                       (FTIMES LIGHTNESS (FPLUS 1.0 SATURATION)))
                      (T (FDIFFERENCE (FPLUS LIGHTNESS SATURATION)
                                (FTIMES LIGHTNESS SATURATION]
          (SETQ M2 (FDIFFERENCE (FTIMES 2.0 LIGHTNESS)
                          M1))
          [SETQ RGB (create RGB
                           RED _ (HLSVALUEFN M1 M2 HUE)
                           GREEN _ (HLSVALUEFN M1 M2 (IDIFFERENCE HUE 120))
                           BLUE _ (HLSVALUEFN M1 M2 (IDIFFERENCE HUE 240]
          (RETURN RGB])

(HLSVALUEFN
  [LAMBDA (M1 M2 HUE)                                        (* kbr%: " 3-Jun-86 20:45")
          
          (* Internal value function for converting from HLS to RGB.
          *)

    (SETQ HUE (IMOD HUE 360))
    (FIX (FTIMES (COND
                    ((ILESSP HUE 60)
                     M1)
                    [(ILESSP HUE 120)
                     (FPLUS M1 (FTIMES (FQUOTIENT (FDIFFERENCE HUE 60)
                                              60)
                                      (FDIFFERENCE M2 M1]
                    ((ILESSP HUE 240)
                     M2)
                    [(ILESSP HUE 300)
                     (FPLUS M2 (FTIMES (FQUOTIENT (FDIFFERENCE HUE 240)
                                              60)
                                      (FDIFFERENCE M1 M2]
                    (T M1))
                255])

(HLSVALUEFROMLEVEL
  [LAMBDA (HLS LEVEL)                                        (* rrb "25-OCT-82 13:26")
          
          (* returns the scaled value of the hls marker on a scale from 0 to 255)

    (SELECTQ HLS
        (HUE (IQUOTIENT (ITIMES LEVEL 360)
                    255))
        (FQUOTIENT LEVEL 255])

(LEVELFROMHLSVALUE
  [LAMBDA (HLS LEVEL)                                        (* rrb "25-OCT-82 14:06")
          
          (* returns the level on a scale from 0 to 255 that this value would have.)

    (SELECTQ HLS
        (HUE (IQUOTIENT (ITIMES LEVEL 255)
                    360))
        (FIX (FTIMES LEVEL 255])

(RAINBOWMAP
  [LAMBDA (NBITS)                                            (* rrb "21-OCT-82 18:14")
    [OR NBITS (NULL (COLORDISPLAYP))
        (SETQ NBITS (COLORMAPBITS (SCREENCOLORMAP]
    (COLORMAPCREATE (COND
                       [(EQ NBITS 8)
                        (PROG (MAXINTENSITY MINVISIBLERED MINVISIBLEBLUE MINVISIBLEGREEN NSTEPS 
                                     REDSTEPSIZE GREENSTEPSIZE BLUESTEPSIZE)
                              (SETQ MAXINTENSITY 255)
                              (SETQ MINVISIBLERED 69)
                              (SETQ MINVISIBLEBLUE 38)
                              (SETQ MINVISIBLEGREEN 38)
                              (SETQ NSTEPS (IQUOTIENT (EXPT 2 NBITS)
                                                  8))
          
          (* determine how many steps are available for each transition from one color to 
          the next. There are 8 such transitions. red up, green up, red down, blue up, 
          green down, red up, green up, all down)
          
          (* minimum visible intensity values were emperically determined but will differ 
          depending upon the brightness setting of the individual display.
          They are also diddled to make the numer of steps come out right.)

                              (RETURN (NCONC (for I from MINVISIBLERED to MAXINTENSITY
                                                by (SETQ REDSTEPSIZE (IQUOTIENT (IPLUS (IDIFFERENCE
                                                                                        MAXINTENSITY 
                                                                                        MINVISIBLERED
                                                                                        )
                                                                                       NSTEPS -2)
                                                                            NSTEPS))
                                                collect      (* red up)
                                                      (LIST I 0 0))
                                             (for I from MINVISIBLEGREEN to MAXINTENSITY
                                                by (SETQ GREENSTEPSIZE (IQUOTIENT (IPLUS (IDIFFERENCE
                                                                                          
                                                                                         MAXINTENSITY 
                                                                                      MINVISIBLEGREEN
                                                                                          )
                                                                                         -1 NSTEPS)
                                                                              NSTEPS))
                                                collect      (* GREEN UP)
                                                      (LIST 255 I 0))
                                             (for I from REDSTEPSIZE to (IDIFFERENCE MAXINTENSITY 
                                                                               MINVISIBLERED)
                                                by REDSTEPSIZE collect 
                                                             (* red down)
                                                                     (LIST (IDIFFERENCE MAXINTENSITY 
                                                                                  I)
                                                                           255 0))
                                             (CONS '(0 255 0))
                                             (for I from MINVISIBLEBLUE to MAXINTENSITY
                                                by (SETQ BLUESTEPSIZE (IQUOTIENT (IPLUS (IDIFFERENCE
                                                                                         MAXINTENSITY 
                                                                                       MINVISIBLEBLUE
                                                                                         )
                                                                                        -1 NSTEPS)
                                                                             NSTEPS))
                                                collect      (* BLUE UP)
                                                      (LIST 0 255 I))
                                             (for I from GREENSTEPSIZE to (IDIFFERENCE MAXINTENSITY 
                                                                                 MINVISIBLEGREEN)
                                                by GREENSTEPSIZE collect 
                                                             (* GREEN down)
                                                                       (LIST 0 (IDIFFERENCE 
                                                                                      MAXINTENSITY I)
                                                                             255))
                                             (CONS '(0 0 255))
                                             (for I from MINVISIBLERED to MAXINTENSITY by REDSTEPSIZE
                                                collect      (* red up)
                                                      (LIST I 0 255))
                                             (for I from MINVISIBLEGREEN toQÙ¢u=˝ú®äú¶í˙Í£^w;æ´ÍSuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuÔ^hË^—ËP˙[ËZuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuu£^	.nÈ1Üø´Íuuuuu£æjCuÔ^hËﬁÎÖj£´ZuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuM}{—ÜÍ˜uˇÎ˜ooSuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuM£^„	˛æ´ÍˇÎ£^„H)æ´ÍÔ^hË^—ËP˙[ËÍ£^	æ´ÍMˇo˙ˇ~Ë^Ë^QÈÍEÎz˙ﬂË^Q˙˙ÍSuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuE˚ﬂzQ˙ﬂGi¯^hË81 PRIN1 672 PRIN1 668 FLENGTH 662 PRIN1 653 PRIN1 646 PRIN1 637 PRIN1 633 FLENGTH 627 PRIN1 618 PRIN1 612 PRIN1 603 PRIN1 599 FLENGTH 594 PRIN1 585 PRIN1 579 PRIN1 570 PRIN1 566 FLENGTH 561 PRIN1 552 PRIN1 546 PRIN1 537 PRIN1 533 FLENGTH 528 PRIN1 519 PRIN1 513 PRIN1 504 PRIN1 500 FLENGTH 495 PRIN1 486 PRIN1 480 PRIN1 471 PRIN1 467 FLENGTH 462 PRIN1 453 PRIN1 447 PRIN1 438 PRIN1 432 PRIN1 423 OPENTEXTSTREAM 401 CREATEW 382 \APPEND2 371 STRPOS 357 \APPEND2 346 STRPOS 334 \APPEND2 324 STRPOS 312 \APPEND2 302 STRPOS 290 \APPEND2 280 STRPOS 268 \APPEND2 258 STRPOS 245 \APPEND2 235 STRPOS 187 MEMB 141 IDATE 138 CONCAT 121 IDATE 118 CONCAT 49 SORT)(414 FONT 60 SUBMIT)( 677 " " 658 " NUMBER OF INCOMPLETE OLD ARS:" 642 " " 623 " NUMBER OF DECLINED OLD ARS:" 608 " " 590 " NUMBER OF OBSOLETE OLD ARS:" 575 " " 557 " NUMBER OF SUPERSEDED OLD ARS:" 542 " " 524 " NUMBER OF FIXED OLD ARS:" 509 " " 491 " NUMBER OF FEATURE REQUESTS SERVICED:" 476 " " 458 " NUMBER OF FEATURE OLD ARS:" 443 " ENDING DATE:" 428 "STARTING DATE:" 407 "" 398 (200 0 400 200) 366 "->Incomplete" 341 "->Declined" 319 "->Obsolete" 297 "->Superseded" 275 "->Fixed" 253 "Wish->Fixed" 230 "->Feature" 135 " 00:00:00" 115 " 00:00:00")(PRETTYCOMPRINT ARSREPORTCOMS)(RPAQQ ARSREPORTCOMS ((FNS AR.REPORT ARS.GET.NUM.LIST ARS.REPORT.DRIVER ARS.REPORT.GEN.AR.LIST ARS.REPORT.GEN.NEW ARS.REPORT.GET.NUM.LIST ARS.REPORT.GET.TDSINFO ARS.REPORT.PROCESS.TDSINFO) (VARS ARS.BUG.LASTMONTH.RELEASED.BACKLOG ARS.BUG.LASTMONTH.UNRELEASED.BACKLOG ARS.FEATURE.LASTMONTH.BACKLOG ARS.HACKERS ARS.TESTERS)))(RPAQQ ARS.BUG.LASTMONTH.RELEASED.BACKLOG 0)(RPAQQ ARS.BUG.LASTMONTH.UNRELEASED.BACKLOG 0)(RPAQQ ARS.FEATURE.LASTMONTH.BACKLOG -4)(RPAQQ ARS.HACKERS (Bane Burton Charnley Daniels Fischer Jellinek Lanning Masinter Murage Pavel Pedersen Santosa Shih Sybalsky vanMelle Woz))(RPAQQ ARS.TESTERS (Blum Cate3 Kelley Lew Rhoades Wilkie))(PUTPROPS ARSREPORT COPYRIGHT ("Venue & Xerox Corporation" 1986 1987 1990))NIL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 COND
                              †                              ((EQ M1 RED)
                                                   *          (FDIFFERENCE CB CG))
                                                             ((EQ M1 GREEN)
                                                              ,FPLUS 2.0 (FDIFFERENCE CR CB)))
                                                             (T (FPLUS 4.0 (FDIFFERENCE CG CR]
                                                         60.0))
                                             360)
                                 LIGHTNESS _ LIGHTNESS
                                 SATURATION _ (COND
                                                 ((FGREATERP 0.5 LIGHTNESS)
                                                  (FQUOTIENT (IDIFFERENCE M1 M2)
                                                         (IPLUS M1 M2)))
                                                 (T (FQUOTIENT (IDIFFERENCE M1 M2)
                                                           (IDIFFERENCE (ITIMES 2 255)
                                                                  (IPLUS M1 M2]
          (RETURN HLS])
)
(DEFINEQ

(OVERPAINT
  [LAMBDA (BM1 BMÚ X Y TXT SCR)                              (* kbr%: " 2-Sep-85 20:30")
         (
          (* Uses BM1 as a mask thru which it paints the INVERSE of texture onto BM2 at 
          position X Y)

    (PROG (BMW BMH)
          (SETQ BMW (BITMAPWIDTH BM1))
          (SETQ BMH (BITMAPHEIGHT BM1))
          (OR SCR (SETQ SCR                         (* |;;| "Big bitmaps provide light duty bitmap capabilities for applications which need large bitmaps (e.g. color).  Currently the only functions provided are BITBLT and BLTSHADE")

                           (FNS BIGBMCREATE BIGBMTEST BITBLT.BIGBM BLTSHADE.BIGBM)))
(DECLARE\: EVAL@COMPILE

(DATATYPE BIGBM (BIGBMWIDTH BIGBMHEIGHT BIGBMLIST))
)

(/DECLAREDATATYPE 'BIGBM '(POINTER POINTER POINTER)
       '((BIGBM 0 POINTER)
         (BIGBM 2 POINTER)
         (BIGBM 4 POINTER))
       '6)



(* |;;| 
"Big bitmaps provide light duty bitmap capabilities for applications which need large bitmaps (e.g. color).  Currently the only functions provided are BITBLT and BLTSHADE"
)

(DEFINEQ

(BIGBMCREATE
  (LAMBDA (WIDTH HEIGHT BITSPERPIXEL)                    (* \; "Edited 23-Feb-89 16:47 by shih")

    (* |;;| "Purely experimental for now")

    (LET (H HLEFT BM BIGBM)
         (SETQ H 16)                                         (* \; 
                              "slice should be a multiple of 16 so that textures tesselate nicely.")
         (SETQ HLEFT HEIGHT)
         (SETQ BIGBM (CREATE BIGBM))
         (FREPLACE (BIGBM BIGBMWIDTH) OF BIGBM WITH WIDTH)
         (FREPLACE (BIGBM BIGBMHEIGHT) OF BIGBM WITH HEIGHT)
         (FREPLACE (BIGBM BIGBMLIST) OF BIGBM WITH (WHILE (IGREATERP HLEFT 0)
                                                                  COLLECT (SETQ BM
                                                                               (BITMAPCREATE
                                                                                WIDTH
                                                                                (MIN H HLEFT)
                                                                                BITSPERPIXEL))
                                                                        (SETQ HLEFT (- HLEFT H))
                                                                        BM))
         BIGBM)))

(BIGBMTEST
  (LAMBDA (SWITCH ITERATIONS)                            (* \; "Edited 23-Feb-89 17:30 by shih")
    (LET NIL 

         (* |;;| "Initialization")

         (IF (NOT (WINDOWP SRCEW))
             THEN (PROMPTPRINT "Select a window for the source")
                   (SETQ SRCEW (WHICHW (GETPOSITION))))
         (IF (NOT (WINDOWP DESTW))
             THEN (PROMPTPRINT "Select a window for the source")
                   (SETQ DESTW (WHICHW (GETPOSITION))))

         (* |;;| "Real stuff below")

         (|if| (EQ SWITCH T)
             |then| (|for| I |from| 1 |to| ITERATIONS
                           |do| (CLEARW DESTW)
                                 (BITBLT SRCEW 50 50 DESTW 50 50 1000 600))
           |else| (BITBLT.BIGBM SRCEW 50 50 BIGBM 70 70 1000 600)
                 (|for| I |from| 1 |to| ITERATIONS
                    |do| (CLEARW DESTW)
                          (BITBLT.BIGBM BIGBM 70 70 DESTW 50 50 1000 600))))))

(BITBLT.BIGBM
  (LAMBDA (SRCE SRCELEFT SRCEBOTTOM DEST DESTLEFT DESTBOTTOM WIDTH HEIGHT SRCETYPE OPERATION TEXTURE
                CLIPPINGREGION)                          (* \; "Edited 23-Feb-89 17:21 by shih")

    (* |;;| "Just like bitblt, but do the right thing if dest is a big bitmap.  Sufficient?")

    (* |;;| "Clippingregion is handled incorrectly (at least in the Y direction).")

    (LET (BMLIST H SLITHEIGHT)
         (|if| (|type?| BIGBM SRCE)
             |then| (SETQ BMLIST (|fetch| (BIGBM BIGBMLIST) |of| SRCE))
                   (|for| BM |in| BMLIST
                      |do| 

                            (* |;;| 
                          "Run through bitmaps until we find the one that intersects sourcebottom")

                            (SETQ SLITHEIGHT (BITMAPHEIGHT BM)) 
                                                             (* \; 
                     "This could be faster (if known a bitmap, and if all slits are the same size.")
                            (|if| (NOT (AND (<= 0 SRCEBOTTOM)
                                                (<= SRCEBOTTOM SLITHEIGHT)))
                                |then| (SETQ SRCEBOTTOM (- SRCEBOTTOM SLITHEIGHT))
                              |else| 

                                    (* |;;| 
                              "Now handle normal bitmaps.  srcebottom is between 0 and sliceheight")

                                    (BITBLT.BIGBM BM SRCELEFT SRCEBOTTOM DEST DESTLEFT DESTBOTTOM
                                           WIDTH HEIGHT SRCETYPE OPERATION TEXTURE CLIPPINGREGION)
                                    (SETQ H (- SLITHEIGHT SRCEBOTTOM)) 
                                                             (* \; "Amount bltted")
                                    (SETQ HEIGHT (- HEIGHT H)) 
                                                             (* \; 
                                                           "Decrement height by amount bltted")
                                    (SETQ DESTBOTTOM (+ DESTBOTTOM H)) 
                                                             (* \; 
                                                           "Increment desty by amount bltted")
                                    (SETQ SRCEBOTTOM 0)))
           |elseif| (|type?| BIGBM DEST)
             |then| (SETQ BMLIST (|fetch| (BIGBM BIGBMLIST) |of| DEST))
                   (|for| BM |in| BMLIST
                      |do| 

                            (* |;;| 
                          "Run through bitmaps until we find the one that intersects destbottom")

                            (SETQ SLITHEIGHT (BITMAPHEIGHT BM)) 
                                                             (* \; 
                     "This could be faster (if known a bitmap, and if all slits are the same size.")
                            (|if| (NOT (AND (<= 0 DESTBOTTOM)
                                                (<= DESTBOTTOM SLITHEIGHT)))
                                |then| (SETQ DESTBOTTOM (- DESTBOTTOM SLITHEIGHT))
                              |else| (BITBLT.BIGBM SRCE SRCELEFT SRCEBOTTOM BM DESTLEFT 
                                                DESTBOTTOM WIDTH HEIGHT SRCETYPE OPERATION TEXTURE 
                                                CLIPPINGREGION)
                                    (SETQ H (- SLITHEIGHT DESTBOTTOM)) 
                                                            interactively adjust colormap.
                                                             *)
    (PROG (XPOS REDREGION GREENREGION BLUEREGION HUEREGION LIGHTNESSREGION SATURATIONREGION BOTTOM 
                COLORMAP COLOR)
          (CLEARW WINDOW)
          (PROGN (MOVETO 35 4 WINDOW)
                 (PRIN1 "RED" WINDOW)
                 (SETQ REDREGION '(40 16 10 256))
                 (OUTLINEREGION REDREGION 2 NIL WINDOW)
                 (WINDOWPROP WINDOW 'REDREGION REDREGION))
          (PROGN (MOVETO 70 4 WINDOW)
                 (PRIN1 "GREEN" WINDOW)
                 (SETQ GREENREGION '(82 16 10 256))
                 (OUTLINEREGION GREENREGION 2 NIL WINDOW)
                 (WINDOWPROP WINDOW 'GREENREGION GREENREGION))
          (PROGN (MOVETO 119 4 WINDOW)
                 (PRIN1 "BLUE" WINDOW)
                 (SETQ BLUEREGION '(128 16 10 256))
                 (OUTLINEREGION BLUEREGION 2 NIL WINDOW)
                 (WINDOWPROP WINDOW 'BLUEREGION BLUEREGION))
          (PROGN (MOVETO 181 4 WINDOW)
                 (PRIN1 "HUE" WâODOW)
                 (SETQ¿HUESEGION '(186 16 10 256))
                 (OUTLINEREgπÏÔﬂUıÆ t/4<ΩÏı˚º‡ü@ÆíúàûÆR@@@@@@@@@@@@@@@@@PÆíúàûÆ†§û†@ÆíúàûÆ@Nê™ä§äéíûú@ê™ä§äŒíûúRR@@@@@@@@@@P†§ûéú@Pöû¨ä®û@dbl@h@ÆíúàûÆR@@@@@@@@@@@@@@@@@P†§íúb@Dòíéê®úä¶¶D@ÆíúàûÆR@@@@@@@@@@@@@@@@@P¶ä®¢@òíéê®úä¶¶§äéíûú@NPdhd@bl@b`@djlRR@@@@@@@@@@@@@@@@@Pû™®òíúä§äéíûú@òíéê®úä¶¶§äéíûú@d@úíò@ÆíúàûÆR@@@@@@@@@@@@@@@@@PÓíúàûÆ†§û†@ÆíúàûÆ                                                          (* \; 
                     "This could be faster (if known a bitmap, and if all slits are the same size.")
                             (|if| (NOT (AND (<= 0 DESTBOTTOM)
                                                 (<= DESTBOTTOM SLITHEIGHT)))
                                 |then| (SETQ DESTBOTTOM (- DESTBOTTOM SLITHEIGHT))
                               |else| (BLTSHADE.BIGBM TEXTURE BM DESTLEFT DESTBOTTOM WIDTH 
                                                 HEIGHT OPERATION CLIPPINGREGION)
                                     (SETQ H (- SLITHEIGHT DESTBOTTOM)) 
                                                             (* \; "Amount bltted")
                                     (SETQ HEIGHT (- HEIGHT H)) 
                                                             (* \; 
                                                           "Decrement height by amount bltted")
                                     (SETQ DESTBOTTOM 0)))))))
)
(PUTPROPS BIGBITMAPS COPYRIGHT ("Venue & Xerox Corporation" 1989 1990))
(DECLARE\: DONTCOPY
  (FILEMAP (NIL (1228 9755 (BIGBMCREATE 1238 . 2568) (BIGBMTEST 2570 . 3609) (BITBLT.BIGBM 3611 . 8000) 
(BLTSHADE.BIGBM 8002 . 9753)))))
STOP
                                                                                                                                                                                                                                                            ),Q„        ˙œ  ‡Û  Íl:	≠Åº          
J),‚ ∫Ò&y(ê    (ï˘† W0 ;Â                                                               "9                                                                                                                                                                                                                                                                                                                                                                               (DEFINE-FILE-INFO READTABLE "XCL" PACKAGE "INTERLISP")(FILECREATED "15-Jun-90 11:42:36" ("compiled on " |{DSK}<usr>local>lde>lispcore>internal>library>BIGBITMAPS.;2|) "30-May-90 17:37:22" |brecompiled| |changes:| |nothing| |in| "Lispcore 30-May-90 ..." |dated| "30-May-90 18:01:43")(FILECREATED "15-Jun-90 11:42:23" |{DSK}<usr>local>lde>lispcore>internal>library>BIGBITMAPS.;2| 9850 |changes| |to:| (VARS BIGBITMAPSCOMS) |previous| |date:| "27-Feb-89 11:47:33" |{DSK}<usr>local>lde>lispcore>internal>library>BIGBITMAPS.;1|)BIGBMCREATE :D6(P 3 BIGBM P 2 BM P 1 HLEFT P 0 H I 2 BITSPERPIXEL I 1 HEIGHT I 0 WIDTH)  G  @lXAY`  [d@ KAK0IjÒ≤$@IdHÛëøHB  ∫IH’πJæMµ	Nh]º∞‡N&Ω∞€LK (41 BITMAPCREATE)(10 |BIGBMTYPE#|)()BIGBMTEST :D6(P 1 I I 1 ITERATIONS I 0 SWITCH F 2 DESTW F 3 SRCEW F 4 BIGBM)  ó S	  ≥o   	  ø  	  cøR	  ≥o   	  ø  	  cø@i≤+AkIHÛëhR	  øSl2dRl2dnËnX  øIk‘Y∞ﬂSl2dTlFdnËnX  AkIHÛ≥∆R	  øTlFdRl2dnËnX  øIk‘Y∞‡ (142 BITBLT.BIGBM 123 CLEARW 109 BITBLT.BIGBM 84 BITBLT 65 CLEARW 42 WHICHW 39 GETPOSITION 35 PROMPTPRINT 26 WINDOWP 19 WHICHW 16 GETPOSITION 12 PROMPTPRINT 3 WINDOWP)NIL( 32 "Select a window for the source" 9 "Select a window for the source")BITBLT.BIGBM :D6(P 3 BM P 2 SLITHEIGHT P 1 H P 0 BMLIST I 11 CLIPPINGREGION I 10 TEXTURE I 9 OPERATION I 8 SRCETYPE I 7 HEIGHT I 6 WIDTH I 5 DESTBOTTOM I 4 DESTLEFT I 3 DEST I 2 SRCEBOTTOM I 1 SRCELEFT I 0 SRCE)     0@√  ≤T@  …Xd∞EdK	  ∫jBÛ£BJÛîBJ’∞*KABCDEFGGGGG  øJB’πGI’bøEI‘b
øjbµºhC√  ≤TC  …Xd∞EdK	  ∫jEÛ£EJÛîEJ’∞*@ABKDEFGGGGG  øJE’πGI’bøBI‘bøjb
µºh@ABCDEFGGGGG   (199 BITBLT 150 BITBLT.BIGBM 115 BITMAPHEIGHT 62 BITBLT.BIGBM 27 BITMAPHEIGHT)(100 BIGBM 94 BIGBM 12 BIGBM 6 BIGBM)()BLTSHADE.BIGBM :D6(P 2 BM P 1 SLITHEIGHT P 0 H I 7 CLIPPINGREGION I 6 OPERATION I 5 HEIGHT I 4 WIDTH I 3 DESTBOTTOM I 2 DESTLEFT I 1 DESTINATION I 0 TEXTURE)  X   A√  ≠@ABCDEFG  A  …∞6dJ	  πjCÛ£CIÛîCI’∞@JBCDEFG  øIC’∏EH’b
øjbµÀh (65 BLTSHADE.BIGBM 38 BITMAPHEIGHT 20 BLTSHADE)(25 BIGBM 6 BIGBM)()(RPAQQ BIGBITMAPSCOMS ((RECORDS BIGBM) (* |;;| "Big bitmaps provide light duty bitmap capabilities for applications which need large bitmaps (e.g. color).  Currently the only functions provided are BITBLT and BLTSHADE") (FNS BIGBMCREATE BIGBMTEST BITBLT.BIGBM BLTSHADE.BIGBM)))(DATATYPE BIGBM (BIGBMWIDTH BIGBMHEIGHT BIGBMLIST))(/DECLAREDATATYPE (QUOTE BIGBM) (QUOTE (POINTER POINTER POINTER)) (QUOTE ((BIGBM 0 POINTER) (BIGBM 2 POINTER) (BIGBM 4 POINTER))) (QUOTE 6))(PUTPROPS BIGBITMAPS COPYRIGHT ("Venue & Xerox Corporation" 1989 1990))NIL                                                                                                                                                                                                                                                                                                                                                                                                                                                         ),Q„        ˙”  ‡Ù  ÍlËÿ!“Åº          ,),‚ •Q&y)\    (ï˘† •P =@ =H                                                           sff                                                                                                                                                                                                                                                                                                                                                                               NDOW)
          
          (* Overstrike extra digits in case the old value was larger.
          *)

                 (COND
                    ((FIXP NEWLEVEL)
                     (printout WINDOW " " |.I3| NEWLEVEL))
                    (T (printout WINDOW |.F5.3| NEWLEVEL]
          (FILLINREGION REGION WINDOWLEVEL GRAYSHADE WINDOW])

(FILLINREGION
  [LAMBDA (REGION HEIGHT GRAY WINDOW)                        (* rrb "23-FEB-82 12:26")
                                             (               (* fills part of a region with gray.)
    (DSPFILL REGION WHITESHADE 'REPLACE WINDOW)
    (AREAFILL (fetch (REGION LEFT) of REGION)
           (fetch (ZEGION BOTTOM) of REGION)
         †(®fetch (REGION WIDTH) of REGION)
           HEIGHT GRAY 'REPLACE WINDOW])

(AREAFILL
  [LAMBDA (LFT BTM WDTH HGTH SHADE OPERATION WINDOW)         (* Fills an area of a window with 
                                                             shade.)
    (BITBLT NI pages for calendars.")


(FILESLOAD CALENDAR)



(* |;;| "User level functions")

(DEFINEQ

(PRINT-LAND-MONTH
  (LAMBDA (MONTH YEAR STREAM)                                (* \; "Edited 17-Oct-87 17:45 by jds")
          
          (* |;;| "Print a single month's calendar landscape on letter paper.")

    (LET ((PRINTSTREAM (OR STREAM (OPENIMAGESTREAM "{LPT}" 'INTERPRESS '(LANDSCAPE T)))))
         (PRINT-SCALED-MONTH MONTH YEAR 635 635 1.0 1.0 PRINTSTREAM 12 18 6)
         (CLOSEF PRINTSTREAM))))

(PRINT-LAND-YEAR
  (LAMBDA (YEAR STREAM)                                      (* \; "Edited 17-Oct-87 17:49 by jds")
          
          (* |;;| "Print a single month's calendar landscape on letter paper.")

    (LET ((PRINTSTREAM (OR STREAM (OPENIMAGESTREAM "{LPT}" 'INTERPRESS '(LANDSCAPE T)))))
         (|for| MONTH |from| 1 |to| 12
            |do| (PRINT-SCALED-MONTH MONTH YEAR 635 635 1.0 1.0 PRINTSTREAM 12 18 6)
                 (DSPNEWPAGE PRINTSTREAM))
         (CLOSEF PRINTSTREAM))))

(PRINT-NOTEBOOK-MONTH
  (LAMBDA (MONTH YEAR STREAM)                                (* \; "Edited 17-Sep-87 21:55 by jds")
          
          (* |;;| "Print a single month's calendar on a half-sheet, suitable for punching and putting in a Time-Design notebook or a 5 1/2 x 8 1/2\" reminder book.")
          
          (* |;;| "If you leave STREAM NIL, you'll get one page on the printer.")

    (PRINT-SCALED-MONTH MONTH YEAR 0 0 0.75 0.6 STREAM)))

(PRINT-NOTEBOOK-YEAR
  (LAMBDA (YEAR STREAM)                                      (* \; "Edited 17-Sep-87 21:57 by jds")
          
          (* |;;| "Print a year's worth of month-calendar pages in half-sheet size.")

    (LET ((PRINTSTREAM (OR STREAM (OPENIMAGESTREAM "{LPT}" 'INTERPRESS))))
         (|for| MONTH |from| 1 |to| 12 |do| (PRINT-SCALED-MONTH MONTH YEAR 0 (COND
                                                                                ((EVENP MONTH 2)
                                                                                 13970)
                                                                                (T 0))
                                                   0.75 0.6 PRINTSTREAM)
                                            (COND
                                               ((EVENP MONTH 2)
                                                (DSPNEWPAGE PRINTSTREAM))))
         (CLOSEF PRINTSTREAM))))

(PRINT-SUMMARY-YEAR
  (LAMBDA (YEAR STREAM)                                      (* \; "Edited 17-Sep-87 22:25 by jds")
          
          (* |;;| "Print a year's worth of small months on 1 sheet of paper that will fit into a 8.25 x 10.5 format (for Time-Design books).")

    (LET ((PRINTSTREAM (OR STREAM (OPENIMAGESTREAM "{LPT}" 'INTERPRESS '(LANDSCAPE T)))))
         (|for| MONTH |from| 1 |to| 4 |as| YOFFSET |from| 15716 |by| -5241
            |do| (PRINT-SCALED-MONTH MONTH YEAR 80 YOFFSET 0.33 0.23 PRINTSTREAM 6 8 6))
         (|for| MONTH |from| 5 |to| 8 |as| YOFFSET |from| 15716 |by| -5241
            |do| (PRINT-SCALED-MONTH MONTH YEAR 8970 YOFFSET 0.33 0.23 PRINTSTREAM 6 8 6))
         (|for| MONTH |from| 9 |to| 12 |as| YOFFSET |from| 15716 |by| -5241
            |do| (PRINT-SCALED-MONTH MONTH YEAR 17860 YOFFSET 0.33 0.23 PRINTSTREAM 6 8 6))
         (CLOSEF PRINTSTREAM))))

(PRINT-NARROW-MONTH
  (LAMBDA (MONTH YEAR STREAM)                                (* \; "Edited 17-Sep-87 22:32 by jds")

    (PRINT-SCALED-MONTH MONTH YEAR 0 0 0.45 0.95 STREAM NIL NIL NIL '(LANDSCAPE T))))
)



(* |;;| "Internal functions and macros")

(DEFINEQ

(PRINT-SCALED-MONTH
  (LAMBDA (MONTH YEAR X-OFFSET Y-OFFSET X-SCALE Y-SCALE STREAM DAYSIZE DATESIZE TINYSIZE OPTIONS)
                                                             (* \; "Edited 17-Sep-87 22:08 by jds")
          
          (* |;;| 
        "Print a month's calendar on STREAM. MONTH is a number 1-12, Year is the year, 19-- and all.")

    (PROG ((STREAM-EXISTED STREAM)
           PBIGFONT PCALFONT PLITTLEFONT)
          (SETCURSOR WAITINGCURSOR)
          (PRINTOUT PROMPTWINDOW T "Formatting for print...")
          (SETQ STREAM (OR STREAM (OPENIMAGESTREAM "{LPT}" 'INTERPRESS OPTIONS)))
          (SETQ PBIGFONT (FONTCREATE 'MODERN (OR DAYSIZE 8)
                                NIL 0 'INTERPRESS))
          (SETQ PCALFONT (FONTCREATE 'CLASSIC (OR DATESIZE 12)
                                NIL 0 'INTERPRESS))
          (SETQ PLITTLEFONT (FONTCREATE 'MODERN (OR TINYSIZE 6)
                                   NIL 0 'INTERPRESS))
          (PRINTMONTHIMAGE MONTH YEAR STREAM X-OFFSET Y-OFFSET X-SCALE (OR Y-SCALE X-SCALE)
                 PBIGFONT PCALFONT PLITTLEFONT)              (* \; "Print horizontal lines")

          (OR STREAM-EXISTED (CLOSEF STREAM))
          (PRINTOUT PROMPTWINDOW "done." T)
          (CURSOR T))))

(PRINTMONTHIMAGE
  (LAMBDA (MONTH YEAR STREAM XOFFSET YOFFSET X-SCALE Y-SCALE DAYFONT DATEFONT TINYDATEFONT)
                                                             (* \; "Edited 17-Sep-87 22:18 by jds")
          
          (* |;;| 
        "Print a month's calendar on STREAM. MONTH is a number 1-12, Year is the year, 19-- and all.")
          
          (* |;;| 
          " X-SCALE & XOFFSET,  and Y-SCALE & YOFFSET are used in the CAL-X and CAL-Y macros, resp.")
          
          (* |;;| 
          "DAYFONT and DATEFONT are used for printing the day names and dates/month title resp.")

    (DSPRESET STREAM)
    (DSPRIGHTMARGIN 65535 STREAM)
    (LET ((TITLESTRING (CONCAT (MONTHNAME MONTH)
                              "   " YEAR)))
         (MOVETO (- (CAL-X 13250)
                    (IQUOTIENT (STRINGWIDTH TITLESTRING DATEFONT)
                           2))
                (CAL-Y 20400)
                STREAM))
    (DSPFONT DATEFONT STREAM)
    (PRINTOUT STREAM (MONTHNAME MONTH)
           "   " YEAR)
    (LET ((DAYLABELS (APPEND (|for| N |from| 1 |to| (DAYOF MONTH 1 YEAR) |collect| '\ )
                            (|for| N |from| 1 |to| (DAYSIN MONTH YEAR) |collect| N)))
          (X 550)
          (Y 16700)
          (CT 0))
         (|for| I |in| DAYLABELS |do| 
          
          (* |;;| "Print blanks up to the first day of the month (to allow for not starting on Sunday), then print the dates.")

                                      (MOVETO (CAL-X X)
                                             (CAL-Y Y)
                                             STREAM)
                                      (PRIN1 I STREAM)
                                      (|add| X 3750)
                                      (|add| CT 1)
                                      (COND
                                         ((EQ (IREMAINDER CT 7)
                                              0)
                                          (SETQ X 600)
                         J))
                (for I from 0 to MAXI
                   do (SETQ LEFT (IQUOTIENT (ITIMES (IPLUS (ITIMES 2 I)
                                                           J)
                                                   HEXWIDTH)
                                        2))
                      (SETQ COLOR (ADD1 COLOR))
                      (BLTSHADE COLOR DESTINATION LEFT BOTTOM HEXWIDTH HEXHEIGHT)
                      (SETQ JDIST (FQUOTIENT J N))
                      (SETQ IDIST (FDIFFERENCE (FTIMES 2.0 (FQUOTIENT I MAXI))
                                         1.0))
                      (SCREENCOLORMAPENTRY COLOR (HLSTORGB (ATAN JDIST IDIST)
                                                        LIGHTNESS
                                                        (SQRT (FQUOTIENT (FPLUS (FTIMES IDIST IDIST)
                                                                                (FTIMES JDIST JDIST))
                                                                     2.0]
          (for J from -1 to (IMINUS N) by -1
             do (SETQ BOTTOM (ITIMES (IPLUS J N)
                                    HEXHEIGHT))
                (SETQ MAXI (IPLUS (IPLUS (ITIMES 2 N)
                                         1)
                                  J))
                (for I from 0 to MAXI
                   do (SETQ LEFT (IQUOTIENT (ITIMES (IPLUS (ITIMES 2 I)
                                                           (IMINUS J))
                                                   HEXWIDTH)
                                        2))
                      (SETQ COLOR (ADD1 COLOR))
                      (BLTSHADE COLOR DESTINATION LEFT BOTTOM HEXWIDTH HEXHEIGHT)
                      (SETQ JDIST (FQUOTIENT J N))
                      (SETQ IDIST (FDIFFERENCE (FTIMES 2.0 (FQUOTIENT I MAXI))
                                         1.0))
                      (SCREENCOLORMAPENTRY COLOR (HLSTORGB (ATAN JDIST IDIST)
                                                        LIGHTNESS
                                                        (SQRT (FQUOTIENT (FPLUS (FTIMES IDIST IDIST)
                                                                                (FTIMES JDIST JDIST))
                                                                     2.0])
)

(RPAQQ EditColorMapHeight 315)

(RPAQQ EditColorMapWidth 380)

(RPAQQ COLOR#MENUSAVE NIL)

(RPAQQ CONTROLMENUSAVE NIL)

(RPAQQ EDIT8BITCOLORMAPMENU NIL)

(RPAQQ EDIT8BITCOLORMAPNUMBERREADER NIL)
(DECLARE%: DOEVAL@COMPILE DONTCOPY

(GLOBALVARS COLOR#MENUSAVE CONTROLMENUSAVE EDIT8BITCOLORMAPMENU EDIT8BITCOLORMAPNUMBERREADER 
       EditColorMapHeight EditColorMapWidth)
)



(* ;;; "support for global naming and querying of colors.")

(DEFINEQ

(CNSMENUINIT
  [LAMBDA NIL                                                (* gbn " 9-Aug-85 03:11")
    [SETQ CNSHUEMENU (create MENU
                            ITEMS _ (for I in DICOLOR.hueMapping collect (CAR I]
    [SETQ CNSSATURATIONMENU (create MENU
                                   ITEMS _ (for I in DICOLOR.saturationMapping
                                              collect (CAR I]
    (SETQ CNSLIGHTNESSMENU (create MENU
                                  ITEMS _ (for I in DICOLOR.lightnessMapping
                                             collect (CAR I])

(CNSTOCSL
  [LAMBDA (hue saturation lightness)                         (* hdj "12-Apr-85 19:01")
    (PROG ((hueAtom (MKATOM hue))
           (saturationAtom (MKATOM saturation))
           (lightnessAtom (MKATOM lightness))
           c s l)
          (if [NOT (SETQ c (fetch (hueRecord ordering) of (ASSOC hueAtom DICOLOR.hueMapping]
              then (SETQ c DICOLOR.achromatic))
          (if (EQ c DICOLOR.achromatic)
              then (SETQ s DICOLOR.noSaturation)
            else (if [NOT (SETQ s (fetch (saturationRecord ordering) of (ASSOC saturationAtom 
                                                                            DICOLOR.saturationMapping
                                                                               ]
                     then (SETQ s DICOLOR.vivid)))
          (SELECTQ hueAtom
              (Black (SETQ l DICOLOR.black))
              (White (SETQ l DICOLOR.white))
              (if [NOT (SETQ l (fetch (lightnessRecord ordering) of (ASSOC lightnessAtom 
                                                                           DICOLOR.lightnessMapping]
                  then (SETQ l DICOLOR.medium)))
          (RETURN (LIST c s l])

(CNSTORGB
  [LAMBDA (saturation lightness hue)                         (* hdj "15-Jul-85 12:33")
    (LET ((CSL (CNSTOCSL hue saturation lightness)))
         (HLSTORGB (APPLY (FUNCTION CSLTOHLS)
                          CSL])

(CSLTOCNS
  [LAMBDA (c s l)                                            (* hdj "15-Jul-85 12:37")
    (PROG (hue saturation lightness)
          [if (EQ c DICOLOR.achromatic)
              then (SETQ saturation "")
                   [SELECTC l
                       (DICOLOR.black (SETQ hue "Black")
                                      (SETQ lightness ""))
                       (DICOLOR.white (SETQ hue "White")
                                      (SETQ lightness ""))
                       (PROGN (SETQ hue "Gray")
                              (SETQ lightness (MKSTRING (fetch (lightnessRecord name)
                                                           of (DICOLOR.lightnessN l]
            else (SETQ hue (fetch (hueRecord name) of (DICOLOR.hueN c)))
                 (SETQ saturation (fetch (saturationRecord name) of (DICOLOR.saturationN s)))
                 (SETQ lightness (fetch (lightnessRecord name) of (DICOLOR.lightnessN l]
          (RETURN (LIST saturation lightness hue])

(DICOLOR.FROM.USER
  [LAMBDA NIL                                                (* gbn "30-Oct-85 11:28")
          
          (* * Returns a color, either by its name
          (which can then be looked up on colornames) or as an RGB triple if it is not 
          named. Prompts the user first with the global color name menu.
          She can then choose NEWCOLOR which can be specified as RGB or CNS)

    (PROG (NAME RGB)                                         (* first try to get a color name)
          [SETQ NAME (MENU (OR COLORNAMEMENU (SETQ COLORNAMEMENU
                                              (create MENU
                                                     ITEMS _ (CONS NEWCOLORITEM
                                                                   (for ENTRY in COLORNAMES
                                                                      collect (CAR ENTRY]
          (if (NOT NAME)
              then                                           (* the user clicked outside the menu)
                   (RETURN))
          (SETQ RGB (SELECTQ NAME
                        (RGB (READCOLOR1 "specify new color"))
                        (CNS (APPLY (FUNCTION CNSTORGB)
                                    (GETCNS)))
                        (RETURN NAME)))
          (if (NOT (SETQ NAME (TTYIN "New color name? ")))
              then 
          
          (* user decided that she didn't want to name the color)

                   (RETURN RGB))
          (push COLORNAMES (CONS (SETQ NAME (CAR NAME))
                                 RGB))
          (SETQ COLORNAMEMENU NIL)                           (* invalidate the menu)
          (RETURN NAME])

(GETCNS
  [LAMBDA NIL                                                (* gbn " 9-Aug-85 03:13")
    (LIST (MENU CNSLIGHTNESSMENU)
          (MENU CNSSATURATIONMENU)
          (MENU CNSHUEMENU])

(HLSTOCSL
  [LAMBDA (hue lightness saturation)                         (* hdj "15-Jul-85 12:14")
    (LET
     ((ISLHue (FQUOTIENT (MOD (PLUS hue 240)
                              360)
                     360)))
     (PROG (c s l)
           (for old s from DICOLOR.noSaturation to DICOLOR.vivid
              do (if (EQ s DICOLOR.vivid)
                     then (RETURN))
                 (if (LEQ saturation (PLUS (DICOLOR.saturationNvalue s)
                                           (QUOTIENT (DIFFERENCE (DICOLOR.saturationNvalue
                                                                  (ADD1 s))
                                                            (DICOLOR.saturationNvalue s))
                                                  2)))
                     then (RETURN)))
           [if (EQ s DICOLOR.noSaturation)
               then (SETQ c DICOLOR.achromatic)
                    (for old l from DICOLOR.black to DICOLOR.white
                       do (if (EQ l DICOLOR.white)
                              then (RETURN))
                          (if (LEQ lightness (PLUS (DICOLOR.lightnessNvalue l)
                                                   (QUOTIENT (DIFFERENCE (DICOLOR.lightnessNvalue
                                                                          (ADD1 l))
                                                                    (DICOLOR.lightnessNvalue l))
                                                          2)))
                              then (RETURN)))
             else (for old c from DICOLOR.red to DICOLOR.purplishRed
                     do                                      (* (HELP c))
                        (if (EQ c DICOLOR.purplishRed)
                            then (if (GREATERP ISLHue (PLUS (DICOLOR.hueNvalue c)
                                                            (QUOTIENT (DIFFERENCE 1 (
                                                                                    DICOLOR.hueNvalue
                                                                                     c))
                                                                   2)))
                                     then (SETQ c DICOLOR.red))
                                 (RETURN))
                        (if (LEQ ISLHue (PLUS (DICOLOR.hueNvalue c)
                                              (QUOTIENT (DIFFERENCE (DICOLOR.hueNvalue (ADD1 c))
                                                               (DICOLOR.hueNvalue c))
                                                     2)))
                            then (RETURN)))
                  (for old l from DICOLOR.veryDark to DICOLOR.veryLight
                     do (if (EQ l DICOLOR.veryLight)
                            then (RETURN))
                        (if (LEQ lightness (PLUS (DICOLOR.lightnessNvalue l)
                                                 (QUOTIENT (DIFFERENCE (DICOLOR.lightnessNvalue
                                                                        (ADD1 l))
                                                                  (DICOLOR.lightnessNvalue l))
                                                        2)))
                            then (RETURN]
           (RETURN (LIST c s l])

(CSLTOHLS
  [LAMBDA (c s l)                                            (* hdj "15-Jul-85 12:23")
    (PROG (hue saturation lightness)
          (if (EQ c DICOLOR.achromatic)
              then (SETQ hue 0.0)
                   (SETQ saturation 0.0)
                   (SETQ lightness (DICOLOR.lightnessNvalue l))
            else (SETQ hue (DICOLOR.hueNvalue c))
                 (SETQ saturation (DICOLOR.saturationNvalue s))
                 (SETQ lightness (DICOLOR.lightnessNvalue l)))
          (RETURN (LIST (MOD (FPLUS 120 (FTIMES hue 360))
                             360)
                        lightness saturation])

(RGBTOCNS
  [LAMBDA (Red Green Blue)                                   (* hdj "15-Jul-85 12:36")
    (APPLY (FUNCTION CSLTOCNS)
           (APPLY (FUNCTION HLSTOCSL)
                  (RGBTOHLS Red Green Blue])
)

(RPAQQ DICOLOR.hueMapping
       ((Achromatic 0.0 -1)
        (Red 0.0 0)
        (OrangishRed 0.01 1)
        (RedOrange 0.02 2)
        (ReddishOrange 0.03 3)
        (Orange 0.04 4)
        (YellowishOrange 0.07 5)
        (OrangeYellow 0.1 6)
        (OrangishYellow 0.13 7)
        (Yellow 0.1673 8)
        (GreenishYellow 0.2073 9)
        (YellowGreen 0.2473 10)
        (YellowishGreen 0.2873 11)
        (Green 0.3333 12)
        (BluishGreen 0.4133 13)
        (GreenBlue 0.4933 14)
        (GreenishBlue 0.5733 15)
        (Blue 0.6666 16)
        (PurplishBlue 0.6816 17)
        (BluePurple 0.6966 18)
        (BluishPurple 0.7116 19)
        (Purple 0.73 20)
        (ReddishPurple 0.8 21)
        (PurpleRed 0.87 22)
        (PurplishRed 0.94 23)
        (BrownishRed 0.01 24)
        (RedBrown 0.02 25)
        (ReddishBrown 0.03 26)
        (Brown 0.04 27)
        (YellowishBrown 0.07 28)
        (BrownYellow 0.1 29)
        (BrownishYellow 0.13 30)))

(RPAQQ DICOLOR.lightnessMapping ((Black 0.0 0)
                                     (VeryDark 0.1666 1)
                                     (Dark 0.3333 2)
                                     (Medium 0.5 3)
                                     (Light 0.6666 4)
                                     (VeryLight 0.8333 5)
                                     (White 1.0 6)))

(RPAQQ DICOLOR.saturationMapping ((NoSaturation 0.0 0)
                                      (Grayish 0.25 1)
                                      (Moderate 0.5 2)
                                      (Strong 0.75 3)
                                      (Vivid 1.0 4)))

(RPAQQ NEWCOLORITEM (New% Color 'CNS "Allows specification of a new color"
                               (SUBITEMS (RGB 'RGB 
                                              "Specify a new color using Red, Green, Blue sliders")
                                      (CNS 'CNS "Specify a new color using English"))))

(RPAQ? COLORNAMEMENU )
(DEFINEQ

(DICOLOR.hueN
  [LAMBDA (N)                                                (* hdj "17-Apr-85 13:38")
    (DECLARE (GLOBALVARS DICOLOR.hueMapping))
    (for ELT in DICOLOR.hueMapping suchthat (EQ (fetch (hueRecord ordering) of ELT)
                                                N])

(DICOLOR.hueNvalue
  [LAMBDA (N)                                                (* hdj "18-Apr-85 09:58")
    (fetch (hueRecord value) of (DICOLOR.hueN N])

(DICOLOR.hueNname
  [LAMBDA (N)                                                (* hdj "18-Apr-85 10:07")
    (fetch (hueRecord name) of (DICOLOR.hueN N])

(DICOLOR.lightnessN
  [LAMBDA (N)                                                (* hdj "17-Apr-85 13:40")
    (DECLARE (GLOBALVARS DICOLOR.lightnessMapping))
    (for ELT in DICOLOR.lightnessMapping suchthat (EQ (fetch (lightnessRecord ordering) of ELT)
                                                      N])

(DICOLOR.lightnessNvalue
  [LAMBDA (N)                                                (* hdj "17-Apr-85 13:36")
    (fetch (lightnessRecord value) of (DICOLOR.lightnessN N])

(DICOLOR.lightnessNname
  [LAMBDA (N)                                                (* hdj "17-Apr-85 14:02")
    (fetch (lightnessRecord name) of (DICOLOR.lightnessN N])

(DICOLOR.saturationN
  [LAMBDA (N)                                                (* hdj "17-Apr-85 13:39")
    (DECLARE (GLOBALVARS DICOLOR.saturationMapping))
    (for ELT in DICOLOR.saturationMapping suchthat (EQ (fetch (saturationRecord ordering)
                                                          of ELT)
                                                       N])

(DICOLOR.saturationNvalue
  [LAMBDA (N)                                                (* hdj "17-Apr-85 13:36")
    (fetch (saturationRecord value) of (DICOLOR.saturationN N])

(DICOLOR.saturationNname
  [LAMBDA (N)                                                (* hdj "17-Apr-85 14:02")
    (fetch (saturationRecord name) of (DICOLOR.saturationN N])
)
(DECLARE%: EVAL@LOAD DONTCOPY 
(DECLARE%: EVAL@COMPILE

(RECORD hueRecord (name value ordering))

(RECORD lightnessRecord (name value ordering))

(RECORD saturationRecord (name value ordering))
)


(RPAQQ DICOLOR.hueConstants
       (DICOLOR.achromatic DICOLOR.blue DICOLOR.bluePurple DICOLOR.bluishGreen DICOLOR.bluishPurple 
              DICOLOR.brown DICOLOR.brownYellow DICOLOR.brownishRed DICOLOR.brownishYellow 
              DICOLOR.green DICOLOR.greenBlue DICOLOR.greenishBlue DICOLOR.greenishYellow 
              DICOLOR.orange DICOLOR.orangeYellow DICOLOR.orangishRed DICOLOR.orangishYellow 
              DICOLOR.purple DICOLOR.purpleRed DICOLOR.purplishBlue DICOLOR.purplishRed DICOLOR.red 
              DICOLOR.redBrown DICOLOR.redOrange DICOLOR.reddishBrown DICOLOR.reddishOrange 
              DICOLOR.reddishPurple DICOLOR.yellow DICOLOR.yellowGreen DICOLOR.yellowishBrown 
              DICOLOR.yellowishGreen DICOLOR.yellowishOrange))
(DECLARE%: EVAL@COMPILE 

(RPAQQ DICOLOR.achromatic -1)

(RPAQQ DICOLOR.blue 16)

(RPAQQ DICOLOR.bluePurple 18)

(RPAQQ DICOLOR.bluishGreen 13)

(RPAQQ DICOLOR.bluishPurple 19)

(RPAQQ DICOLOR.brown 27)

(RPAQQ DICOLOR.brownYellow 29)

(RPAQQ DICOLOR.brownishRed 24)

(RPAQQ DICOLOR.brownishYellow 30)

(RPAQQ DICOLOR.green 12)

(RPAQQ DICOLOR.greenBlue 14)

(RPAQQ DICOLOR.greenishBlue 15)

(RPAQQ DICOLOR.greenishYellow 9)

(RPAQQ DICOLOR.orange 4)

(RPAQQ DICOLOR.orangeYellow 6)

(RPAQQ DICOLOR.orangishRed 1)

(RPAQQ DICOLOR.orangishYellow 7)

(RPAQQ DICOLOR.purple 20)

(RPAQQ DICOLOR.purpleRed 22)

(RPAQQ DICOLOR.purplishBlue 17)

(RPAQQ DICOLOR.purplishRed 23)

(RPAQQ DICOLOR.red 0)

(RPAQQ DICOLOR.redBrown 25)

(RPAQQ DICOLOR.redOrange 2)

(RPAQQ DICOLOR.reddishBrown 26)

(RPAQQ DICOLOR.reddishOrange 3)

(RPAQQ DICOLOR.reddishPurple 21)

(RPAQQ DICOLOR.yellow 8)

(RPAQQ DICOLOR.yellowGreen 10)

(RPAQQ DICOLOR.yellowishBrown 28)

(RPAQQ DICOLOR.yellowishGreen 11)

(RPAQQ DICOLOR.yellowishOrange 5)


(CONSTANTS DICOLOR.achromatic DICOLOR.blue DICOLOR.bluePurple DICOLOR.bluishGreen 
       DICOLOR.bluishPurple DICOLOR.brown DICOLOR.brownYellow DICOLOR.brownishRed 
       DICOLOR.brownishYellow DICOLOR.green DICOLOR.greenBlue DICOLOR.greenishBlue 
       DICOLOR.greenishYellow DICOLOR.orange DICOLOR.orangeYellow DICOLOR.orangishRed 
       DICOLOR.orangishYellow DICOLOR.purple DICOLOR.purpleRed DICOLOR.purplishBlue 
       DICOLOR.purplishRed DICOLOR.red DICOLOR.redBrown DICOLOR.redOrange DICOLOR.reddishBrown 
       DICOLOR.reddishOrange DICOLOR.reddishPurple DICOLOR.yellow DICOLOR.yellowGreen 
       DICOLOR.yellowishBrown DICOLOR.yellowishGreen DICOLOR.yellowishOrange)
)


(RPAQQ DICOLOR.saturationConstants (DICOLOR.noSaturation DICOLOR.grayish DICOLOR.moderate 
                                              DICOLOR.strong DICOLOR.vivid))
(DECLARE%: EVAL@COMPILE 

(RPAQQ DICOLOR.noSaturation 0)

(RPAQQ DICOLOR.grayish 1)

(RPAQQ DICOLOR.moderate 2)

(RPAQQ DICOLOR.strong 3)

(RPAQQ DICOLOR.vivid 4)


(CONSTANTS DICOLOR.noSaturation DICOLOR.grayish DICOLOR.moderate DICOLOR.strong DICOLOR.vivid)
)


(RPAQQ DICOLOR.lightnessConstants (DICOLOR.black DICOLOR.veryDark DICOLOR.dark DICOLOR.medium 
                                             DICOLOR.light DICOLOR.veryLight DICOLOR.white))
(DECLARE%: EVAL@COMPILE 

(RPAQQ DICOLOR.black 0)

(RPAQQ DICOLOR.veryDark 1)

(RPAQQ DICOLOR.dark 2)

(RPAQQ DICOLOR.medium 3)

(RPAQQ DICOLOR.light 4)

(RPAQQ DICOLOR.veryLight 5)

(RPAQQ DICOLOR.white 6)


(CONSTANTS DICOLOR.black DICOLOR.veryDark DICOLOR.dark DICOLOR.medium DICOLOR.light DICOLOR.veryLight
       DICOLOR.white)
)
)

(CNSMENUINIT)

(FILESLOAD LLCOLOR READNUMBER)

(SETQ EDITBMMENU NIL)

(MOVD 'ARRAYP 'COLORMAPP)
(PUTPROPS COLOR COPYRIGHT ("Venue & Xerox Corporation" 1982 1983 1985 1986 1987 1990))
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (2486 17538 (DISPLAYCOLORLEVELS 2496 . 3614) (DISPLAYHLSLEVELS 3616 . 3956) (HLSLEVEL 
3958 . 4693) (HLSTORGB 4695 . 6124) (HLSVALUEFN 6126 . 7003) (HLSVALUEFROMLEVEL 7005 . 7337) (
LEVELFROMHLSVALUE 7339 . 7676) (RAINBOWMAP 7678 . 14687) (RGBTOHLS 14689 . 17536)) (17539 19325 (
OVERPAINT 17549 . 18310) (BITMAPFROMSTRING 18312 . 18802) (SHADEBITMAP 18804 . 19323)) (19363 35973 (
EDITCOLORMAP 19373 . 20592) (EDITCOLORMAP.BUTTONEVENTFN 20594 . 24324) (EDITCOLORMAP.REDISPLAYFN 24326
 . 26685) (EDITCOLORMAP.VALUELEVEL 26687 . 27180) (EDITCOLORMAP.WINDOWLEVEL 27182 . 27685) (
CHANGECOLORLEVELS 27687 . 29814) (GETCOLOR#FROMUSER 29816 . 31134) (GETCOLOR#FROMSCREEN 31136 . 31694)
 (DISPLAYCOLORLEVEL 31696 . 33120) (FILLINREGION 33122 . 33589) (AREAFILL 33591 . 33853) (CENTEREDLEFT
 33855 . 34181) (OUTLINEAREA 34183 . 35412) (OUTLINEREGION 35414 . 35971)) (35974 43347 (
ADJUSTCOLORMAP 35984 . 36504) (SHOWCOLORBLOCKS 36506 . 37973) (MAPOFACOLOR 37975 . 39626) (
COLORHEXPATTERN 39628 . 43345)) (43813 53415 (CNSMENUINIT 43823 . 44458) (CNSTOCSL 44460 . 45722) (
CNSTORGB 45724 . 45971) (CSLTOCNS 45973 . 47046) (DICOLOR.FROM.USER 47048 . 48807) (GETCNS 48809 . 
49013) (HLSTOCSL 49015 . 52515) (CSLTOHLS 52517 . 53185) (RGBTOCNS 53187 . 53413)) (55398 57649 (
DICOLOR.hueN 55408 . 55726) (DICOLOR.hueNvalue 55728 . 55907) (DICOLOR.hueNname 55909 . 56086) (
DICOLOR.lightnessN 56088 . 56436) (DICOLOR.lightnessNvalue 56438 . 56635) (DICOLOR.lightnessNname 
56637 . 56832) (DICOLOR.saturationN 56834 . 57245) (DICOLOR.saturationNvalue 57247 . 57447) (
DICOLOR.saturationNname 57449 . 57647)))))
STOP
