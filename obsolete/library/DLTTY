(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)(FILECREATED "30-May-91 16:09:30" |{PELE:MV:ENVOS}<LISPCORE>LIBRARY>DLTTY.;2| 65774        changes to%:  (VARS DLTTYCOMS)      previous date%: " 6-Nov-87 12:19:04" |{PELE:MV:ENVOS}<LISPCORE>LIBRARY>DLTTY.;1|)(* ; "Copyright (c) 1985, 1986, 1987, 1991 by Xerox Corporation.  All rights reserved.")(PRETTYCOMPRINT DLTTYCOMS)(RPAQQ DLTTYCOMS       [(COMS               (* ;; "DLion TTY/Printer port head")              (DECLARE%: DONTCOPY (EXPORT (CONSTANTS * DLTTYCOMMANDS)                                         (CONSTANTS * DLTTYOUTCOMMANDS)                                         (CONSTANTS * DLTTYSETPARAMETERCOMMANDS)                                         (RECORDS DLTTY.IN.CSB DLTTY.OUT.COMMAND DLTTY.OUT.CSB                                                 DLTTY.SETPARAMETER.COMMAND)))              [INITVARS [\DLTTY.BAUD.RATES '((50 . 0)                                             (75 . 1)                                             (110 . 2)                                             (134.5 . 3)                                             (150 . 4)                                             (300 . 5)                                             (600 . 6)                                             (1200 . 7)                                             (1800 . 8)                                             (2000 . 9)                                             (2400 . 10)                                             (3600 . 11)                                             (4800 . 12)                                             (7200 . 13)                                             (9600 . 14]                     (\DLTTY.INVERSE.BAUD.RATES '((0 . 50)                                                  (1 . 75)                                                  (2 . 110)                                                  (3 . 134.5)                                                  (4 . 150)                                                  (5 . 300)                                                  (6 . 600)                                                  (7 . 1200)                                                  (8 . 1800)                                                  (9 . 2000)                                                  (10 . 2400)                                                  (11 . 3600)                                                  (12 . 4800)                                                  (13 . 7200)                                                  (14 . 9600]              (DECLARE%: DONTCOPY EVAL@COMPILE (FILES (LOADCOMP)                                                      DLRS232C))              (FNS \DLTTY.CREATE-INITIAL-FLOW-CONTROL)              (INITVARS (\DLTTY.STATE 0)                     (\DLTTY.FLOWCONTROL (\DLTTY.CREATE-INITIAL-FLOW-CONTROL)))              (ADDVARS (GLOBALVARS \DLTTY.BAUD.RATES \DLTTY.INVERSE.BAUD.RATES \DLTTY.STATE                               \DLTTY.FLOWCONTROL))              (FNS \DLTTY.BIN \DLTTY.BOUT \DLTTY.GET.PARAMETERS \DLTTY.INIT \DLTTY.READP                    \DLTTY.SET.PARAMETERS \DLTTY.SHUTDOWN))        (COMS               (* ;; "Daybreak head")              (DECLARE%: DONTCOPY (FILES (SOURCE)                                         DOVERS232C)                     (EXPORT (RECORDS Dove.TTYFCB)                            (CONSTANTS * DVTTYBITS)))              [INITVARS (\DoveTTY.FCBPointer)                     [\DVTTY.BAUD.RATES '((50 . 5000)                                          (75 . 3334)                                          (110 . 2272)                                          (150 . 1667)                                          (300 . 833)                                          (600 . 417)                                          (1200 . 208)                                          (1800 . 138)                                          (2000 . 126)                                          (2400 . 104)                                          (3600 . 69)                                          (4800 . 52)                                          (7200 . 35)                                          (9600 . 26]                     (\DVTTY.INVERSE.BAUD.RATES '((5000 . 50)                                                  (3334 . 75)                                                  (2272 . 110)                                                  (1667 . 150)                                                  (833 . 300)                                                  (417 . 600)                                                  (208 . 1200)                                                  (138 . 1800)                                                  (126 . 2000)                                                  (104 . 2400)                                                  (69 . 3600)                                                  (52 . 4800)                                                  (35 . 7200)                                                  (26 . 9600]              (GLOBALVARS \DoveTTY.FCBPointer \DVTTY.INVERSE.BAUD.RATES \DVTTY.BAUD.RATES)              (FNS \DVTTY.BIN \DVTTY.BOUT \DVTTY.INIT \DVTTY.SET.PARAMETERS \DVTTY.READP                    \DVTTY.GET.PARAMETERS \DVTTY.SHUTDOWN)              (FUNCTIONS \DVTTY.FLUSH.INPUT))        (COMS               (* ;; "Machine independent face;  for DLion and DayBreak")              (DECLARE%: DONTCOPY (FILES (LOADCOMP)                                         DLRS232C))              (INITVARS (\TTY.FDEV)                     (\TTYFLG)                     (\TTY.READY))              (ADDVARS (GLOBALVARS \TTY.FDEV \TTYFLG \TTY.READY))              (DECLARE%: DONTCOPY (EXPORT (RECORDS TTYSTREAM)))              (FNS \TTY.CREATE.FDEV \TTY.EVENTFN \TTY.BIN \TTY.BOUT \TTY.READP \TTY.CLOSEFILE                    \TTY.OPENFILE \TTY.PEEKBIN))        (COMS               (* ;; "Machine independent user face")              (FNS \DLTTY.CREATE-DEFAULT-INIT-INFO)              (INITVARS (TTY.DEFAULT.INIT.INFO (\DLTTY.CREATE-DEFAULT-INIT-INFO \DLTTY.FLOWCONTROL))                     (\TTY.CURRENT.INIT.INFO)                     (TTY.ERROR.STREAM PROMPTWINDOW))              (GLOBALVARS TTY.DEFAULT.INIT.INFO TTY.ERROR.STREAM)              (FNS TTY.INIT TTY.GET.PARAMETERS TTY.SET.PARAMETERS TTY.RESET.STREAMS TTY.SHUTDOWN)              (PROP FILETYPE DLTTY)              (P (TTY.INIT])(* ;; "DLion TTY/Printer port head")(DECLARE%: DONTCOPY (* "FOLLOWING DEFINITIONS EXPORTED")(RPAQQ DLTTYCOMMANDS ((TTY.GET.STATUS 33280)                          (TTY.ON 33536)                          (TTY.OFF 33792)                          (TTY.BREAK.ON 34304)                          (TTY.BREAK.OFF 34560)))(DECLARE%: EVAL@COMPILE (RPAQQ TTY.GET.STATUS 33280)(RPAQQ TTY.ON 33536)(RPAQQ TTY.OFF 33792)(RPAQQ TTY.BREAK.ON 34304)(RPAQQ TTY.BREAK.OFF 34560)(CONSTANTS (TTY.GET.STATUS 33280)       (TTY.ON 33536)       (TTY.OFF 33792)       (TTY.BREAK.ON 34304)       (TTY.BREAK.OFF 34560)))(RPAQQ DLTTYOUTCOMMANDS ((PUT.CHAR 128)                             (ABORT.PUT 133)))(DECLARE%: EVAL@COMPILE (RPAQQ PUT.CHAR 128)(RPAQQ ABORT.PUT 133)(CONSTANTS (PUT.CHAR 128)       (ABORT.PUT 133)))(RPAQQ DLTTYSETPARAMETERCOMMANDS ((SET.DSR 33025)                                      (SET.CTS 33026)                                      (SET.CHAR.LENGTH 33028)                                      (SET.PARITY 33032)                                      (SET.STOP.BITS 33040)                                      (SET.BAUD.RATE 33056)                                      (SET.ALL.PARAMETERS 33087)))(DECLARE%: EVAL@COMPILE (RPAQQ SET.DSR 33025)(RPAQQ SET.CTS 33026)(RPAQQ SET.CHAR.LENGTH 33028)(RPAQQ SET.PARITY 33032)(RPAQQ SET.STOP.BITS 33040)(RPAQQ SET.BAUD.RATE 33056)(RPAQQ SET.ALL.PARAMETERS 33087)(CONSTANTS (SET.DSR 33025)       (SET.CTS 33026)       (SET.CHAR.LENGTH 33028)       (SET.PARITY 33032)       (SET.STOP.BITS 33040)       (SET.BAUD.RATE 33056)       (SET.ALL.PARAMETERS 33087)))(DECLARE%: EVAL@COMPILE(ACCESSFNS DLTTY.IN.CSB [(TTYINBASE (LOCF (fetch (IOPAGE DLTTYIN) of DATUM]                            (BLOCKRECORD TTYINBASE ((IN.CONTROL WORD)                                                    (IN.DATA BYTE)                                                    (DATA.TERMINAL.READY FLAG)                                                    (NIL BITS 4)                                                    (REQUEST.TO.SEND FLAG)                                                    (RX.READY FLAG)                                                    (TX.READY FLAG)))                            (BLOCKRECORD TTYINBASE ((STATE FLAG)                                                    (NIL BITS 7)                                                    (SUCCESS FLAG)                                                    (BREAK.DETECTED FLAG)                                                    (FRAMING.ERROR FLAG)                                                    (DATA.LOST FLAG)                                                    (PARITY.ERROR FLAG)                                                    (NIL BITS 2)                                                    (NOT.READY FLAG))))(ACCESSFNS DLTTY.OUT.COMMAND [(COMMANDBASE (LOCF (fetch (IOPAGE DLTTYPORTCMD) of DATUM]                                 (BLOCKRECORD COMMANDBASE ((COMMAND BYTE)                                                           (OUTDATA BYTE))))(ACCESSFNS DLTTY.OUT.CSB [(TTYOUTBASE (LOCF (fetch (IOPAGE DLTTYOUT) of DATUM]                             (BLOCKRECORD TTYOUTBASE ((PARAMETER WORD)                                                      (NOTIFY.MASK WORD)))                             (BLOCKRECORD TTYOUTBASE ((ON.OFF BITS 4)                                                      (LINE.SPEED BITS 4)                                                      (STOP.BITS BITS 2)                                                      (PARITY BITS 2)                                                      (CHAR.LENGTH BITS 2)                                                      (CLEAR.TO.SEND FLAG)                                                      (DATA.SET.READY FLAG))))(ACCESSFNS DLTTY.SETPARAMETER.COMMAND [(COMMANDBASE (LOCF (fetch (IOPAGE DLTTYPORTCMD)                                                                 of DATUM]                                          (BLOCKRECORD COMMANDBASE ((COMMAND WORD)))))(* "END EXPORTED DEFINITIONS"))(RPAQ? \DLTTY.BAUD.RATES       '((50 . 0)         (75 . 1)         (110 . 2)         (134.5 . 3)         (150 . 4)         (300 . 5)         (600 . 6)         (1200 . 7)         (1800 . 8)         (2000 . 9)         (2400 . 10)         (3600 . 11)         (4800 . 12)         (7200 . 13)         (9600 . 14)))(RPAQ? \DLTTY.INVERSE.BAUD.RATES       '((0 . 50)         (1 . 75)         (2 . 110)         (3 . 134.5)         (4 . 150)         (5 . 300)         (6 . 600)         (7 . 1200)         (8 . 1800)         (9 . 2000)         (10 . 2400)         (11 . 3600)         (12 . 4800)         (13 . 7200)         (14 . 9600)))(DECLARE%: DONTCOPY EVAL@COMPILE (FILESLOAD (LOADCOMP)       DLRS232C))(DEFINEQ(\DLTTY.CREATE-INITIAL-FLOW-CONTROL  [LAMBDA NIL                                                (* ; "Edited  6-Jan-87 16:23 by hdj")    (create RS232C.XONXOFF           FLAG _ 1           XON.CHAR _ (CHARCODE ^Q)           XOFF.CHAR _ (CHARCODE ^S]))(RPAQ? \DLTTY.STATE 0)(RPAQ? \DLTTY.FLOWCONTROL (\DLTTY.CREATE-INITIAL-FLOW-CONTROL))(ADDTOVAR GLOBALVARS \DLTTY.BAUD.RATES \DLTTY.INVERSE.BAUD.RATES \DLTTY.STATE \DLTTY.FLOWCONTROL)(DEFINEQ(\DLTTY.BIN  [LAMBDA (STREAM PEEKING)                                   (* ejs%: "25-Mar-86 17:20")    (bind CHAR GOTCHAR NOTOPEN until GOTCHAR do (until [OR (fetch (DLTTY.IN.CSB STATE) of \IOPAGE)                                                           (SETQ NOTOPEN (NOT (READABLE STREAM]                                                   do (BLOCK))                                                [COND                                                   (NOTOPEN (RETURN (\EOF.ACTION STREAM]                                                (SETQ CHAR (fetch (DLTTY.IN.CSB IN.DATA) of \IOPAGE))                                                (OR PEEKING (replace (DLTTY.IN.CSB STATE)                                                               of \IOPAGE with NIL))                                                (COND                                                   [\DLTTY.FLOWCONTROL (COND                                                                          ((EQ CHAR                                                                               (fetch (RS232C.XONXOFF                                                                                       XOFF.CHAR)                                                                                  of                                                                                    \DLTTY.FLOWCONTROL                                                                                      ))                                                                           (replace (TTYSTREAM                                                                                            OUTPUTHELD                                                                                           )                                                                              of STREAM with T))                                                                          ((EQ CHAR                                                                               (fetch (RS232C.XONXOFF                                                                                       XON.CHAR)                                                                                  of                                                                                    \DLTTY.FLOWCONTROL                                                                                      ))                                                                           (replace (TTYSTREAM                                                                                            OUTPUTHELD                                                                                           )                                                                              of STREAM with NIL))                                                                          (T (SETQ GOTCHAR T]                                                   (T (SETQ GOTCHAR T))) finally (RETURN CHAR])(\DLTTY.BOUT  [LAMBDA (STREAM BYTE)                                      (* ejs%: "17-May-86 13:04")    (while (IGEQ (fetch (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE)                 PUT.CHAR) do (BLOCK))    [COND       ((fetch (TTYSTREAM OUTPUTHELD) of STREAM)        (do (COND               ((EQ (fetch (DLTTY.IN.CSB IN.DATA) of \IOPAGE)                    (fetch (RS232C.XONXOFF XON.CHAR) of \DLTTY.FLOWCONTROL))                (replace (TTYSTREAM OUTPUTHELD) of STREAM with NIL)                (replace (DLTTY.IN.CSB STATE) of \IOPAGE with NIL)                (RETURN)))            (replace (DLTTY.IN.CSB STATE) of \IOPAGE with NIL)            (BLOCK)))       (\DLTTY.FLOWCONTROL (COND                              ((EQ (fetch (DLTTY.IN.CSB IN.DATA) of \IOPAGE)                                   (fetch (RS232C.XONXOFF XOFF.CHAR) of \DLTTY.FLOWCONTROL))                               (replace (TTYSTREAM OUTPUTHELD) of STREAM with T)                               (replace (DLTTY.IN.CSB STATE) of \IOPAGE with NIL)                               (do (COND                                      ((EQ (fetch (DLTTY.IN.CSB IN.DATA) of \IOPAGE)                                           (fetch (RS232C.XONXOFF XON.CHAR) of \DLTTY.FLOWCONTROL))                                       (replace (TTYSTREAM OUTPUTHELD) of STREAM with NIL)                                       (replace (DLTTY.IN.CSB STATE) of \IOPAGE with NIL)                                       (RETURN)))                                   (replace (DLTTY.IN.CSB STATE) of \IOPAGE with NIL)                                   (BLOCK]    (replace (DLTTY.OUT.COMMAND OUTDATA) of \IOPAGE with (LOGAND BYTE (MASK.1'S 0 8)))    (replace (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE with PUT.CHAR)    T])(\DLTTY.GET.PARAMETERS  [LAMBDA (PARAMETERLIST)                                    (* ejs%: " 8-Sep-85 17:00")                    (* * Return requested parameters in ALIST format)    (for PARAMETER in PARAMETERLIST       collect (SELECTQ PARAMETER                   ((STOP.BITS NoOfStopBits)                         [CONS PARAMETER (CDR (FASSOC (fetch (DLTTY.OUT.CSB STOP.BITS) of \IOPAGE)                                                    '((0 . 0)                                                      (1 . 1)                                                      (2 . 1.5)                                                      (3 . 2])                   ((PARITY Parity)                         [CONS PARAMETER (CDR (FASSOC (fetch (DLTTY.OUT.CSB PARITY) of \IOPAGE)                                                    '((0 . NONE)                                                      (1 . ODD)                                                      (3 . EVEN])                   ((CHAR.LENGTH BitsPerSerialChar)                         (CONS PARAMETER (IPLUS 5 (fetch (DLTTY.OUT.CSB CHAR.LENGTH) of \IOPAGE))))                   ((LINE.SPEED BaudRate)                         (CONS PARAMETER (CDR (FASSOC (fetch (DLTTY.OUT.CSB LINE.SPEED) of \IOPAGE)                                                    \DLTTY.INVERSE.BAUD.RATES))))                   ((DATA.SET.READY DSR)                         (CONS PARAMETER (fetch (DLTTY.OUT.CSB DATA.SET.READY) of \IOPAGE)))                   ((CLEAR.TO.SEND CTS)                         (CONS PARAMETER (fetch (DLTTY.OUT.CSB CLEAR.TO.SEND) of \IOPAGE)))                   ((FLOW.CONTROL FlowControl)                         (CONS PARAMETER (COND                                           ([EQUAL \DLTTY.FLOWCONTROL                                                   (CONSTANT (create RS232C.XONXOFF                                                                    FLAG _ 1                                                                    XON.CHAR _ (CHARCODE ^Q)                                                                    XOFF.CHAR _ (CHARCODE ^S]                                            'XOnXOff)                                           (T \DLTTY.FLOWCONTROL))))                   NIL])(\DLTTY.INIT  [LAMBDA (BAUDRATE BITSPERCHAR PARITY STOPBITS FLOWCONTROL) (* ; "Edited  5-Nov-87 10:46 by FS")                    (* ;; "Initialize the TTY port controller.")    (SETQ \TTY.READY NIL)    (\TTY.CREATE.FDEV (create RS232C.INIT                             BaudRate _ BAUDRATE                             BitsPerSerialChar _ BITSPERCHAR                             Parity _ PARITY                             NoOfStopBits _ STOPBITS                             FlowControl _ FLOWCONTROL))    (replace (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE with ABORT.PUT)    (replace (DLTTY.OUT.CSB NOTIFY.MASK) of \IOPAGE with 0)    (replace (DLTTY.IN.CSB DATA.TERMINAL.READY) of \IOPAGE with NIL)    (replace (DLTTY.IN.CSB REQUEST.TO.SEND) of \IOPAGE with NIL)    (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE with TTY.ON)    (while (IGEQ (fetch (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE)                 PUT.CHAR) do (BLOCK))    (SETQ \DLTTY.STATE (replace (DLTTY.OUT.CSB PARAMETER) of \IOPAGE with 0))    (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE with SET.ALL.PARAMETERS)    [\DLTTY.SET.PARAMETERS `((LINE.SPEED %,@ BAUDRATE)                             (CHAR.LENGTH %,@ BITSPERCHAR)                             (PARITY %,@ PARITY)                             (STOP.BITS %,@ STOPBITS)                             (FLOW.CONTROL %,@ FLOWCONTROL]    (SETQ \TTYFLG T)    (SETQ \TTY.READY T])(\DLTTY.READP  [LAMBDA (STREAM)                                           (* ejs%: "27-Aug-85 16:21")    (fetch (DLTTY.IN.CSB STATE) of \IOPAGE])(\DLTTY.SET.PARAMETERS  [LAMBDA (PARAMETERLIST)                                    (* ; "Edited 18-Feb-87 18:58 by jds")                    (* ;; "Set the line speed, flow control, etc. for the TTY port.")                    (* ;; "PARAMETERLIST is an AList of parameters & values.")    (bind PARAMETER VALUE for PARAMPAIR in PARAMETERLIST       do (* ;; "Run thru the parameter list decoding them and setting up options.")          (while (IGEQ (fetch (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE)                       PUT.CHAR) do                          (* ; "Wait 'til the port is free.")                                    (BLOCK))          (SETQ PARAMETER (CAR PARAMPAIR))          (SETQ VALUE (CDR PARAMPAIR))          (SELECTQ PARAMETER              ((STOP.BITS NoOfStopBits)                      (* ; "# of stop bits")                   [LET [(SBVALUE (CDR (SASSOC VALUE '((0 . 0)                                                       (1 . 1)                                                       (1.5 . 2)                                                       (2 . 3]                        (COND                           (SBVALUE (replace (RS232C.INIT NoOfStopBits) of TTY.DEFAULT.INIT.INFO                                       with VALUE)                                  (replace (DLTTY.OUT.CSB STOP.BITS) of \IOPAGE with SBVALUE)                                  (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE                                     with SET.STOP.BITS])              ((PARITY Parity)                               (* ; "Parity")                   [LET [(PARVALUE (CDR (FASSOC VALUE '((NONE . 0)                                                        (ODD . 1)                                                        (EVEN . 3]                        (COND                           (PARVALUE (replace (RS232C.INIT Parity) of TTY.DEFAULT.INIT.INFO                                        with VALUE)                                  (replace (DLTTY.OUT.CSB PARITY) of \IOPAGE with PARVALUE)                                  (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE                                     with SET.PARITY])              ((CHAR.LENGTH BitsPerSerialChar)               (* ; "bits per character")                   [LET ((LVALUE (IDIFFERENCE VALUE 5)))                        (COND                           ((AND (IGEQ LVALUE 0)                                 (ILEQ LVALUE 3))                            (replace (RS232C.INIT BitsPerSerialChar) of TTY.DEFAULT.INIT.INFO                               with VALUE)                            (replace (DLTTY.OUT.CSB CHAR.LENGTH) of \IOPAGE with LVALUE)                            (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE with                                                                                       SET.CHAR.LENGTH                                   ])              ((LINE.SPEED BaudRate)                         (* ; "line speed")                   [LET [(BDVALUE (CDR (SASSOC VALUE \DLTTY.BAUD.RATES]                        (COND                           (BDVALUE (replace (RS232C.INIT BaudRate) of TTY.DEFAULT.INIT.INFO                                       with VALUE)                                  (replace (DLTTY.OUT.CSB LINE.SPEED) of \IOPAGE with BDVALUE)                                  (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE                                     with SET.BAUD.RATE])              ((DATA.SET.READY DSR)                          (* ; "data-set ready flag")                   (replace (DLTTY.OUT.CSB DATA.SET.READY) of \IOPAGE with (NOT (NULL VALUE)))                   (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE with SET.DSR))              ((CLEAR.TO.SEND CTS)                           (* ; "clear-to-send flag")                   (replace (DLTTY.OUT.CSB CLEAR.TO.SEND) of \IOPAGE with (NOT (NULL VALUE)))                   (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE with SET.CTS))              ((FLOW.CONTROL FlowControl)                    (* ; "Flow control")                   (replace (RS232C.INIT FlowControl) of TTY.DEFAULT.INIT.INFO with VALUE)                   [SETQ \DLTTY.FLOWCONTROL                    (COND                       [(AND (NOT (LISTP VALUE))                             (STRING-EQUAL VALUE 'XOnXOff))  (* ;                                                " He asked for XON-XOFF flow control.  Give it to him")                        (CONSTANT (create RS232C.XONXOFF                                         FLAG _ 1                                         XON.CHAR _ (CHARCODE ^Q)                                         XOFF.CHAR _ (CHARCODE ^S]                       ((AND VALUE (LISTP VALUE))            (* ;                                                  "He specified his own flow control.  Set up for it.")                        VALUE)                       (T                                    (* ; "No flow control.")                          (CONSTANT (create RS232C.XONXOFF                                           FLAG _ 0                                           XON.CHAR _ 0                                           XOFF.CHAR _ 0])              NIL))    (SETQ \DLTTY.STATE (fetch (DLTTY.OUT.CSB PARAMETER) of \IOPAGE])(\DLTTY.SHUTDOWN  [LAMBDA NIL                                            (* ; "Edited  6-Nov-87 11:26 by jds")                    (* ;; "Shut down the TTY port.  Try to let the current output character finish first; if that seems hung, try an orderly abort; if that doesn't work, hose it.")    (for I from 1 to 10 while (IGEQ (fetch (DLTTY.OUT.COMMAND COMMAND)                                                       of \IOPAGE)                                                    PUT.CHAR) do                     (* ;; "Wait for the output character to finish.  Give it 1 second.")                                                                    (BLOCK 100))    [COND       ((= (fetch (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE)           PUT.CHAR)                                         (* ;                     "Didn't finish the character put; must be hung, so let's try aborting the put.")        (PROMPTPRINT "TTY Output character in progress being aborted")        (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE with ABORT.PUT)        (for I from 1 to 10 while (= (fetch (DLTTY.OUT.COMMAND COMMAND)                                                        of \IOPAGE)                                                     ABORT.PUT) do                     (* ;; "Wait for the abort to take effect.  Give it 1 second.")                                                                      (BLOCK 100]    (COND       ((= (fetch (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE)           ABORT.PUT)                                        (* ;                                      "Didn't finish the abort; must be REALLY hung, so warn folks.")        (PROMPTPRINT "TTY port being forcibly shut down")))    (replace (DLTTY.SETPARAMETER.COMMAND COMMAND) of \IOPAGE with TTY.OFF)    (SETQ \DLTTY.STATE (fetch (DLTTY.OUT.CSB PARAMETER) of \IOPAGE))    (SETQ \TTYFLG (SETQ \TTY.READY NIL]))(* ;; "Daybreak head")(DECLARE%: DONTCOPY (FILESLOAD (SOURCE)       DOVERS232C)(* "FOLLOWING DEFINITIONS EXPORTED")(DECLARE%: EVAL@COMPILE(MESARECORD Dove.TTYFCB ((txTcb DoveIO.TaskContextBlock)                             (specRxTcb DoveIO.TaskContextBlock)                             (rxTaskChBTcb DoveIO.TaskContextBlock)                             (ttyLockMask WORD)                             (ttyWorkMask WORD)                             (ttyClientCondition DoveIO.ClientCondition)                             (ttyWorkCondition WORD)                             (txBuffer BYTE)                             (rxBuffer BYTE)                             (ttyWorkList WORD)                             (ttyBaudRate WORD)                             (wr1.waitEnable FLAG)                             (NIL BITS 1)                             (wr1.waitOnRxOrTx BITS 1)                             (wr1.interruptCondition BITS 2)                             (wr1.statusAffectsVector FLAG)                             (wr1.txIntDMAenable FLAG)                             (wr1.extInterruptEnable FLAG)                             (wr3.rxCharLength BITS 2)                             (wr3.autoEnable FLAG)                             (NIL BITS 4)                             (wr3.rxEnable FLAG)                             (wr4.clockRate BITS 2)                             (NIL BITS 2)                             (wr4.stopBits BITS 2)                             (wr4.parity BITS 2)                             (wr5.dataSetReady FLAG)                             (wr5.txCharLength BITS 2)                             (wr5.sendBreak FLAG)                             (wr5.txEnable FLAG)                             (NIL BITS 1)                             (wr5.clearToSend FLAG)                             (NIL BITS 1)                             (NIL BITS 7)                             (iopSystemInputPort.nDataTerminalReady FLAG)                             (rr0.breakDetected FLAG)                             (rr0.txUnderrun FLAG)                             (rr0.requestToSend FLAG)                             (rr0.syncDetected FLAG)                             (rr0.carrierDetect FLAG)                             (rr0.txBufferEmpty FLAG)                             (rr0.interruptPending FLAG)                             (rr0.rxCharAvailable FLAG)                             (NIL BITS 1)                             (rr1.asyncFramingError FLAG)                             (rr1.rxOverrun FLAG)                             (rr1.parityError FLAG)                             (NIL BITS 3)                             (rr1.txAllSent FLAG)                             (rr2 BYTE)                             (ttyStatusWord WORD)                             (eePromImage 4 WORD))))(RPAQQ DVTTYBITS       ((writeBaudRate 32768)        (writeReg3 16384)        (writeReg4 8192)        (writeReg5 4096)        (workToBeDone 2048)        (writeReg1 1024)        (ttyChnlBOn 16384)        (ttyTxBufEmpty 8192)        (ttyRxBufFull 4096)        (ttyInterruptFail 512)        (ttyDataLost 256)))(DECLARE%: EVAL@COMPILE (RPAQQ writeBaudRate 32768)(RPAQQ writeReg3 16384)(RPAQQ writeReg4 8192)(RPAQQ writeReg5 4096)(RPAQQ workToBeDone 2048)(RPAQQ writeReg1 1024)(RPAQQ ttyChnlBOn 16384)(RPAQQ ttyTxBufEmpty 8192)(RPAQQ ttyRxBufFull 4096)(RPAQQ ttyInterruptFail 512)(RPAQQ ttyDataLost 256)(CONSTANTS (writeBaudRate 32768)       (writeReg3 16384)       (writeReg4 8192)       (writeReg5 4096)       (workToBeDone 2048)       (writeReg1 1024)       (ttyChnlBOn 16384)       (ttyTxBufEmpty 8192)       (ttyRxBufFull 4096)       (ttyInterruptFail 512)       (ttyDataLost 256)))(* "END EXPORTED DEFINITIONS"))(RPAQ? \DoveTTY.FCBPointer )(RPAQ? \DVTTY.BAUD.RATES       '((50 . 5000)         (75 . 3334)         (110 . 2272)         (150 . 1667)         (300 . 833)         (600 . 417)         (1200 . 208)         (1800 . 138)         (2000 . 126)         (2400 . 104)         (3600 . 69)         (4800 . 52)         (7200 . 35)         (9600 . 26)))(RPAQ? \DVTTY.INVERSE.BAUD.RATES       '((5000 . 50)         (3334 . 75)         (2272 . 110)         (1667 . 150)         (833 . 300)         (417 . 600)         (208 . 1200)         (138 . 1800)         (126 . 2000)         (104 . 2400)         (69 . 3600)         (52 . 4800)         (35 . 7200)         (26 . 9600)))(DECLARE%: DOEVAL@COMPILE DONTCOPY(GLOBALVARS \DoveTTY.FCBPointer \DVTTY.INVERSE.BAUD.RATES \DVTTY.BAUD.RATES))(DEFINEQ(\DVTTY.BIN  [LAMBDA (STREAM PEEKING)                                   (* ejs%: "25-Mar-86 17:20")    (bind CHAR GOTCHAR NOTOPEN until GOTCHAR       do (until [OR (BITTEST (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord) of                                                                                   \DoveTTY.FCBPointer                                                       ))                            ttyRxBufFull)                     (SETQ NOTOPEN (NOT (READABLE STREAM] do (BLOCK))          [COND             (NOTOPEN (RETURN (\EOF.ACTION STREAM]          (SETQ CHAR (fetch (Dove.TTYFCB rxBuffer) of \DoveTTY.FCBPointer))          [replace (Dove.TTYFCB ttyStatusWord) of \DoveTTY.FCBPointer             with (\DoveIO.ByteSwap (BITCLEAR (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord)                                                                   of \DoveTTY.FCBPointer))                                           (LOGOR ttyDataLost (COND                                                                 (PEEKING 0)                                                                 (T ttyRxBufFull]          (COND             [\DLTTY.FLOWCONTROL (COND                                    ((EQ CHAR (fetch (RS232C.XONXOFF XOFF.CHAR) of \DLTTY.FLOWCONTROL                                                     ))                                     (replace (TTYSTREAM OUTPUTHELD) of STREAM with T))                                    ((EQ CHAR (fetch (RS232C.XONXOFF XON.CHAR) of \DLTTY.FLOWCONTROL)                                         )                                     (replace (TTYSTREAM OUTPUTHELD) of STREAM with NIL))                                    (T (SETQ GOTCHAR T]             (T (SETQ GOTCHAR T))) finally (RETURN CHAR])(\DVTTY.BOUT  [LAMBDA (STREAM BYTE)                                      (* ; "Edited 21-Jan-87 01:29 by jds")                    (* ;; "BOUT a character to the TTY port.  Takes account of flow control.")    (LET ((BLOCKCOUNT 100))                    (* ;; "Wait for the transmit buffer to empty, if a character is in progress.")         [while (NOT (BITTEST (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord) of                                                                                   \DoveTTY.FCBPointer                                                       ))                            ttyTxBufEmpty)) do (COND                                                  ((EQ (CL:DECF BLOCKCOUNT)                                                       0)                                                   (SETQ BLOCKCOUNT 100)                                                   (BLOCK]                    (* ;; "Now handle flow control, if any.")         [COND            ((fetch (TTYSTREAM OUTPUTHELD) of STREAM)                    (* ;; "We've been XOFF'ed, and we're holding output until we see an XON.")             (until (EQ (fetch (Dove.TTYFCB rxBuffer) of \DoveTTY.FCBPointer)                        (fetch (RS232C.XONXOFF XON.CHAR) of \DLTTY.FLOWCONTROL))                do                                           (* ;                                     "Keep clearing the receive buffer  and waiting until we see XON.")                   (\DVTTY.FLUSH.INPUT)                   (COND                      ((EQ (CL:DECF BLOCKCOUNT)                           0)                       (SETQ BLOCKCOUNT 100)                       (BLOCK))) finally                     (* ; "Saw the XON, turn off the hold.")                                       (replace (TTYSTREAM OUTPUTHELD) of STREAM with NIL)))            (\DLTTY.FLOWCONTROL                     (* ;; "Flow control is enabled.  Watch for XONs and XOFFs.")                   (COND                      ((EQ (fetch (Dove.TTYFCB rxBuffer) of \DoveTTY.FCBPointer)                           (fetch (RS232C.XONXOFF XOFF.CHAR) of \DLTTY.FLOWCONTROL))                    (* ;; "We just got an XOFF.  Hold all output.")                       (replace (TTYSTREAM OUTPUTHELD) of STREAM with T)                       (\DVTTY.FLUSH.INPUT)                       (until (EQ (fetch (Dove.TTYFCB rxBuffer) of \DoveTTY.FCBPointer)                                  (fetch (RS232C.XONXOFF XON.CHAR) of \DLTTY.FLOWCONTROL))                          do                                 (* ;                                     "Keep clearing the receive buffer  and waiting until we see XON.")                             (\DVTTY.FLUSH.INPUT)                             (COND                                ((EQ (CL:DECF BLOCKCOUNT)                                     0)                                 (SETQ BLOCKCOUNT 100)                                 (BLOCK))) finally           (* ; "Saw the XON, turn off the hold.")                                                 (replace (TTYSTREAM OUTPUTHELD) of STREAM                                                    with NIL)))                      ((EQ (fetch (Dove.TTYFCB rxBuffer) of \DoveTTY.FCBPointer)                           (fetch (RS232C.XONXOFF XON.CHAR) of \DLTTY.FLOWCONTROL))                    (* ;; "We received a spare XON.  Toss it away.")                       (\DVTTY.FLUSH.INPUT]         (replace (Dove.TTYFCB txBuffer) of \DoveTTY.FCBPointer with (LOGAND BYTE (MASK.1'S 0 8)))         (replace (Dove.TTYFCB ttyStatusWord) of \DoveTTY.FCBPointer            with (\DoveIO.ByteSwap (BITCLEAR (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord)                                                                  of \DoveTTY.FCBPointer))                                          ttyTxBufEmpty)))                    (* ;; "Tell the IOP there's work to do:")         (\DoveIO.NotifyIOP (fetch (Dove.TTYFCB ttyWorkMask) of \DoveTTY.FCBPointer)))    T])(\DVTTY.INIT  [LAMBDA (BAUDRATE BITSPERCHAR PARITY STOPBITS FLOWCONTROL) (* ejs%: "23-Oct-85 19:46")    (SETQ \TTY.READY NIL)    (SETQ \DoveTTY.FCBPointer (\DoveIO.GetHandlerIORegionPtr DoveIO.ttyHandler))    (\TTY.CREATE.FDEV (create RS232C.INIT                             BaudRate _ BAUDRATE                             BitsPerSerialChar _ BITSPERCHAR                             Parity _ PARITY                             NoOfStopBits _ STOPBITS                             FlowControl _ FLOWCONTROL))    (replace (Dove.TTYFCB wr1.interruptCondition) of \DoveTTY.FCBPointer with                                                                       intOnAllRxParityNotAffectVector           )    (replace (Dove.TTYFCB wr1.txIntDMAenable) of \DoveTTY.FCBPointer with T)    (replace (Dove.TTYFCB wr3.rxEnable) of \DoveTTY.FCBPointer with T)    (replace (Dove.TTYFCB wr5.txEnable) of \DoveTTY.FCBPointer with T)    [replace (Dove.TTYFCB ttyWorkList) of \DoveTTY.FCBPointer       with (\DoveIO.ByteSwap (BITSET (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyWorkList) of                                                                                   \DoveTTY.FCBPointer                                                               ))                                     (LOGOR writeReg1 writeReg3 writeReg5 workToBeDone]    [replace (Dove.TTYFCB ttyStatusWord) of \DoveTTY.FCBPointer       with (\DoveIO.ByteSwap (BITCLEAR (BITSET (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord)                                                                     of \DoveTTY.FCBPointer))                                               (LOGOR ttyChnlBOn ttyTxBufEmpty))                                     (LOGOR ttyRxBufFull ttyInterruptFail ttyDataLost]    (\DoveIO.NotifyIOP (fetch (Dove.TTYFCB ttyWorkMask) of \DoveTTY.FCBPointer))    [\DVTTY.SET.PARAMETERS `((LINE.SPEED %,@ BAUDRATE)                             (CHAR.LENGTH %,@ BITSPERCHAR)                             (PARITY %,@ PARITY)                             (STOP.BITS %,@ STOPBITS)                             (FLOW.CONTROL %,@ FLOWCONTROL]    (SETQ \TTYFLG T)    (SETQ \TTY.READY T])(\DVTTY.SET.PARAMETERS  [LAMBDA (PARAMETERLIST)                                    (* ; "Edited 19-Feb-87 17:26 by jds")    (bind PARAMETER VALUE (workListImage _ (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyWorkList)                                                                of \DoveTTY.FCBPointer)))       for PARAMPAIR in PARAMETERLIST       do (SETQ PARAMETER (CAR PARAMPAIR))          (SETQ VALUE (CDR PARAMPAIR))          (SELECTQ PARAMETER              ((STOP.BITS NoOfStopBits)                    [LET [(SBVALUE (CDR (SASSOC VALUE '((0 . 0)                                                       (1 . 1)                                                       (1.5 . 2)                                                       (2 . 3]                        (COND                           (SBVALUE (replace (RS232C.INIT NoOfStopBits) of TTY.DEFAULT.INIT.INFO                                       with VALUE)                                  (replace (Dove.TTYFCB wr4.stopBits) of \DoveTTY.FCBPointer                                     with SBVALUE)                                  (SETQ workListImage (BITSET workListImage writeReg4])              ((PARITY Parity)                    [LET [(PARVALUE (CDR (FASSOC VALUE '((NONE . 0)                                                        (ODD . 1)                                                        (EVEN . 3]                        (COND                           (PARVALUE (replace (RS232C.INIT Parity) of TTY.DEFAULT.INIT.INFO                                        with VALUE)                                  (replace (Dove.TTYFCB wr4.parity) of \DoveTTY.FCBPointer                                     with PARVALUE)                                  (SETQ workListImage (BITSET workListImage writeReg4])              ((CHAR.LENGTH BitsPerSerialChar)                    [LET [(LVALUE (SELECTQ VALUE                                     (8 3)                                     (7 1)                                     (6 2)                                     (5 0)                                     (\ILLEGAL.ARG VALUE]                        (replace (Dove.TTYFCB wr3.rxCharLength) of \DoveTTY.FCBPointer                           with (replace (Dove.TTYFCB wr5.txCharLength) of \DoveTTY.FCBPointer                                   with LVALUE))                        (SETQ workListImage (BITSET workListImage (LOGOR writeReg3 writeReg5])              ((LINE.SPEED BaudRate)                    [LET [(BDVALUE (CDR (SASSOC VALUE \DVTTY.BAUD.RATES]                        (COND                           (BDVALUE (replace (RS232C.INIT BaudRate) of TTY.DEFAULT.INIT.INFO                                       with VALUE)                                  (replace (Dove.TTYFCB ttyBaudRate) of \DoveTTY.FCBPointer                                     with (\DoveIO.ByteSwap BDVALUE))                                  (SETQ workListImage (BITSET workListImage writeBaudRate])              ((DATA.SET.READY DSR)                    (replace (Dove.TTYFCB wr5.dataSetReady) of \DoveTTY.FCBPointer                      with (NOT (NULL VALUE)))                   (SETQ workListImage (BITSET workListImage writeReg5)))              ((CLEAR.TO.SEND CTS)                    (replace (Dove.TTYFCB wr5.clearToSend) of \DoveTTY.FCBPointer                      with (NOT (NULL VALUE)))                   (SETQ workListImage (BITSET workListImage writeReg5)))              ((FLOW.CONTROL FlowControl)                    (replace (RS232C.INIT FlowControl) of TTY.DEFAULT.INIT.INFO with VALUE)                   [SETQ \DLTTY.FLOWCONTROL                    (COND                       [(AND (NOT (LISTP VALUE))                             (STRING-EQUAL VALUE 'XONXOFF))                        (CONSTANT (create RS232C.XONXOFF                                         FLAG _ 1                                         XON.CHAR _ (CHARCODE ^Q)                                         XOFF.CHAR _ (CHARCODE ^S]                       ((AND VALUE (LISTP VALUE))                        VALUE)                       (T (CONSTANT (create RS232C.XONXOFF                                           FLAG _ 0                                           XON.CHAR _ 0                                           XOFF.CHAR _ 0])              NIL) finally (replace (Dove.TTYFCB ttyWorkList) of \DoveTTY.FCBPointer                              with (\DoveIO.ByteSwap (BITSET workListImage workToBeDone)))                         (\DoveIO.NotifyIOP (fetch (Dove.TTYFCB ttyWorkMask) of \DoveTTY.FCBPointer])(\DVTTY.READP  [LAMBDA (STREAM)                                           (* ejs%: "23-Oct-85 19:19")    (BITTEST (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord) of \DoveTTY.FCBPointer))           ttyRxBufFull])(\DVTTY.GET.PARAMETERS  [LAMBDA (PARAMETERLIST)                                    (* ejs%: "25-Oct-85 21:49")                    (* * Return requested parameters in ALIST format)    (for PARAMETER in PARAMETERLIST       collect (SELECTQ PARAMETER                   ((STOP.BITS NoOfStopBits)                         [CONS PARAMETER (CDR (FASSOC (fetch (Dove.TTYFCB wr4.stopBits) of                                                                                   \DoveTTY.FCBPointer                                                            )                                                    (CONSTANT `((%, oneStopBit . 1)                                                                (%, oneAndHalfStopBit . 1.5)                                                                (%, twoStopBits . 2])                   ((PARITY Parity)                         [CONS PARAMETER (CDR (FASSOC (fetch (Dove.TTYFCB wr4.parity) of                                                                                   \DoveTTY.FCBPointer                                                            )                                                    '((0 . NONE)                                                      (1 . ODD)                                                      (3 . EVEN])                   ((CHAR.LENGTH BitsPerSerialChar)                         (CONS PARAMETER (IPLUS 5 (fetch (Dove.TTYFCB wr5.txCharLength) of                                                                                   \DoveTTY.FCBPointer                                                        ))))                   ((LINE.SPEED BaudRate)                         (CONS PARAMETER (CDR (FASSOC (\DoveIO.ByteSwap (fetch (Dove.TTYFCB                                                                                      ttyBaudRate)                                                                          of \DoveTTY.FCBPointer))                                                    \DVTTY.INVERSE.BAUD.RATES))))                   ((DATA.SET.READY DSR)                         (CONS PARAMETER (fetch (Dove.TTYFCB wr5.dataSetReady) of \DoveTTY.FCBPointer)                              ))                   ((CLEAR.TO.SEND CTS)                         (CONS PARAMETER (fetch (Dove.TTYFCB wr5.clearToSend) of \DoveTTY.FCBPointer)))                   ((FLOW.CONTROL FlowControl)                         (CONS PARAMETER (COND                                           ([EQUAL \DLTTY.FLOWCONTROL                                                   (CONSTANT (create RS232C.XONXOFF                                                                    FLAG _ 1                                                                    XON.CHAR _ (CHARCODE ^Q)                                                                    XOFF.CHAR _ (CHARCODE ^S]                                            'XOnXOff)                                           (T \DLTTY.FLOWCONTROL))))                   NIL])(\DVTTY.SHUTDOWN  [LAMBDA (FORCE)                                            (* ; "Edited  5-Nov-87 11:10 by FS")    (replace (Dove.TTYFCB wr1.txIntDMAenable) of \DoveTTY.FCBPointer with T)    (replace (Dove.TTYFCB wr3.rxEnable) of \DoveTTY.FCBPointer with T)    (replace (Dove.TTYFCB wr5.txEnable) of \DoveTTY.FCBPointer with T)    [replace (Dove.TTYFCB ttyWorkList) of \DoveTTY.FCBPointer       with (\DoveIO.ByteSwap (BITSET (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyWorkList) of                                                                                   \DoveTTY.FCBPointer                                                               ))                                     (LOGOR writeReg1 writeReg3 writeReg5 workToBeDone]    [replace (Dove.TTYFCB ttyStatusWord) of \DoveTTY.FCBPointer       with (\DoveIO.ByteSwap (BITCLEAR (BITSET (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord)                                                                     of \DoveTTY.FCBPointer))                                               (LOGOR ttyChnlBOn ttyTxBufEmpty))                                     (LOGOR ttyRxBufFull ttyInterruptFail ttyDataLost]    (\DoveIO.NotifyIOP (fetch (Dove.TTYFCB ttyWorkMask) of \DoveTTY.FCBPointer))    (SETQ \TTYFLG NIL)    (SETQ \TTY.READY NIL]))(DEFMACRO \DVTTY.FLUSH.INPUT ()   '[replace (Dove.TTYFCB ttyStatusWord) of \DoveTTY.FCBPointer       with (\DoveIO.ByteSwap (BITCLEAR (\DoveIO.ByteSwap (fetch (Dove.TTYFCB ttyStatusWord)                                                                 of \DoveTTY.FCBPointer))                                         (LOGOR ttyDataLost ttyRxBufFull])(* ;; "Machine independent face;  for DLion and DayBreak")(DECLARE%: DONTCOPY (FILESLOAD (LOADCOMP)       DLRS232C))(RPAQ? \TTY.FDEV )(RPAQ? \TTYFLG )(RPAQ? \TTY.READY )(ADDTOVAR GLOBALVARS \TTY.FDEV \TTYFLG \TTY.READY)(DECLARE%: DONTCOPY (* "FOLLOWING DEFINITIONS EXPORTED")(DECLARE%: EVAL@COMPILE(ACCESSFNS TTYSTREAM ((OUTPUTHELD (fetch (STREAM F1) of DATUM)                                 (replace (STREAM F1) of DATUM with NEWVALUE)))))(* "END EXPORTED DEFINITIONS"))(DEFINEQ(\TTY.CREATE.FDEV  [LAMBDA (INITINFO)                                         (* ; "Edited  5-Mar-87 12:55 by jds")                    (* ;; "Create the FDEV (File DEVice) for the TTY port, containing device-dependent operations dispatch vector.")    (COND       ((NOT (type? FDEV \TTY.FDEV))                         (* ;                                                    "Only create the FDEV if there isn't one already.")                    (* ;; "First, create the FDEV")        (SETQ \TTY.FDEV         (create FDEV                DEVICENAME _ 'TTY                RANDOMACCESSP _ NIL                PAGEMAPPED _ NIL                NODIRECTORIES _ T                FDBINABLE _ NIL                FDBOUTABLE _ NIL                FDEXTENDABLE _ NIL                HOSTNAMEP _ [FUNCTION (LAMBDA (DEVICE)                                        (STRING-EQUAL DEVICE "TTY"]                EVENTFN _ (FUNCTION \TTY.EVENTFN)                DIRECTORYNAMEP _ (FUNCTION NILL)                OPENFILE _ (FUNCTION \TTY.OPENFILE)                CLOSEFILE _ (FUNCTION \TTY.CLOSEFILE)                GENERATEFILES _ (FUNCTION \GENERATENOFILES)                GETFILEINFO _ (FUNCTION \TTY.GETFILEINFO)                SETFILEINFO _ (FUNCTION \TTY.SETFILEINFO)                REOPENFILE _ (FUNCTION NILL)                GETFILENAME _ (FUNCTION CL:IDENTITY)                TRUNCATEFILE _ (FUNCTION NILL)                BIN _ (FUNCTION \TTY.BIN)                BOUT _ (FUNCTION \TTY.BOUT)                PEEKBIN _ (FUNCTION \TTY.PEEKBIN)                READP _ (FUNCTION \TTY.READP)                OPENP _ (FUNCTION \GENERIC.OPENP)                REGISTERFILE _ (FUNCTION NILL)                DEVICEINFO _ (create RS232C.DEVICEINFO)))                    (* ;; "Then tell the system about the TTY device.")        (\DEFINEDEVICE 'TTY \TTY.FDEV)))                    (* ;; "Fill in the initialization parameters for the TTY port.")    (replace (RS232C.DEVICEINFO INIT) of (fetch (FDEV DEVICEINFO) of \TTY.FDEV) with INITINFO])(\TTY.EVENTFN  [LAMBDA (EVENT)                                            (* ; "Edited  5-Nov-87 11:02 by FS")    (SELECTQ EVENT        ((BEFORELOGOUT BEFORESAVEVM BEFOREMAKESYS BEFORESYSOUT)              (SELECTC \MACHINETYPE                 (\DANDELION (\DLTTY.SHUTDOWN))                 (\DAYBREAK (\DVTTY.SHUTDOWN))                 (\NOMACHINETYPE))             (SETQ \TTY.READY NIL))        ((AFTERLOGOUT AFTERMAKESYS AFTERSYSOUT AFTERSAVEVM)              (COND                (\TTYFLG (SELECTC \MACHINETYPE                             (\DANDELION (TTY.INIT \TTY.CURRENT.INIT.INFO))                             (\DAYBREAK (TTY.INIT \TTY.CURRENT.INIT.INFO))                             NIL))))        NIL])(\TTY.BIN  [LAMBDA (STREAM)                                           (* ejs%: "27-Aug-85 16:20")    (SELECTC \MACHINETYPE        (\DANDELION (\DLTTY.BIN STREAM))        (\DAYBREAK (\DVTTY.BIN STREAM))        (\NOMACHINETYPE])(\TTY.BOUT  [LAMBDA (STREAM BYTE)                                      (* ejs%: "27-Aug-85 16:21")    (SELECTC \MACHINETYPE        (\DANDELION (\DLTTY.BOUT STREAM BYTE))        (\DAYBREAK (\DVTTY.BOUT STREAM BYTE))        (\NOMACHINETYPE])(\TTY.READP  [LAMBDA (STREAM)                                           (* ejs%: "27-Aug-85 16:22")    (SELECTC \MACHINETYPE        (\DANDELION (\DLTTY.READP STREAM))        (\DAYBREAK (\DVTTY.READP STREAM))        (\NOMACHINETYPE])(\TTY.CLOSEFILE  [LAMBDA (STREAM)                                           (* hdj "25-Jun-86 17:56")    (LET ((TTYDEVICEINFO (fetch (FDEV DEVICEINFO) of \TTY.FDEV)))         (SELECTQ (fetch (STREAM ACCESS) of STREAM)             (INPUT (replace (RS232C.DEVICEINFO INSTREAM) of TTYDEVICEINFO with NIL))             (OUTPUT (replace (RS232C.DEVICEINFO OUTSTREAM) of TTYDEVICEINFO with NIL))             (BOTH (replace (RS232C.DEVICEINFO INSTREAM) of TTYDEVICEINFO with NIL)                   (replace (RS232C.DEVICEINFO OUTSTREAM) of TTYDEVICEINFO with NIL))             NIL)         (replace (STREAM ACCESS) of STREAM with NIL])(\TTY.OPENFILE  [LAMBDA (NAME ACCESS RECOG PARAMETERS)                     (* ejs%: "13-Jun-86 18:11")    (OR \TTY.FDEV (\TTY.CREATE.FDEV TTY.DEFAULT.INIT.INFO))                    (* * Set any parameters specified by the user)    [COND       (PARAMETERS (TTY.SET.PARAMETERS (for PAIR in PARAMETERS collect (CONS (CAR PAIR)                                                                             (CADR PAIR]                    (* * Check for conflicting access)    (SELECTQ ACCESS        (INPUT [COND                  ((fetch (RS232C.DEVICEINFO INSTREAM) of (fetch (FDEV DEVICEINFO) of \TTY.FDEV))                   (printout TTY.ERROR.STREAM T "TTY port is busy on input" T)                   (ERRORX '(9 {TTY}])        (OUTPUT [COND                   ((fetch (RS232C.DEVICEINFO OUTSTREAM) of (fetch (FDEV DEVICEINFO) of \TTY.FDEV))                    (printout TTY.ERROR.STREAM T "TTY port is busy on output" T)                    (ERRORX '(9 {TTY}])        (BOTH [COND                 ((OR (fetch (RS232C.DEVICEINFO INSTREAM) of (fetch (FDEV DEVICEINFO) of \TTY.FDEV))                      (fetch (RS232C.DEVICEINFO OUTSTREAM) of (fetch (FDEV DEVICEINFO) of \TTY.FDEV))                      )                  (printout TTY.ERROR.STREAM T "TTY port is busy on input or output" T)                  (ERRORX '(9 {TTY}])        (\ILLEGAL.ARG ACCESS))                    (* * If an output stream is being opened, make sure no XOFF chars are hanging           in the input latch)    (SELECTC \MACHINETYPE        (\DANDELION (COND                       ((OR (EQ ACCESS 'OUTPUT)                            (EQ ACCESS 'BOTH))                        (replace (DLTTY.OUT.COMMAND COMMAND) of \IOPAGE with 0)                        (replace (DLTTY.IN.CSB STATE) of \IOPAGE with NIL)                        (replace (DLTTY.IN.CSB IN.DATA) of \IOPAGE with 0))))        (\DAYBREAK (COND                      ((OR (EQ ACCESS 'OUTPUT)                           (EQ ACCESS 'BOTH))                       (\DVTTY.FLUSH.INPUT)                       (replace (Dove.TTYFCB ttyStatusWord) of \DoveTTY.FCBPointer                          with (\DoveIO.ByteSwap (BITSET (\DoveIO.ByteSwap (fetch (Dove.TTYFCB                                                                                         ttyStatusWord                                                                                         )                                                                              of \DoveTTY.FCBPointer)                                                                )                                                        ttyTxBufEmpty)))                       (replace (Dove.TTYFCB rxBuffer) of \DoveTTY.FCBPointer with 0))))        NIL)                    (* * Return the stream to the user)    (LET [(EOLCONVENTION (CADR (FASSOC 'EOLCONVENTION PARAMETERS]         (create STREAM                ACCESS _ ACCESS                EOLCONVENTION _ (SELECTQ EOLCONVENTION                                    (CR CR.EOLC)                                    (LF LF.EOLC)                                    (CRLF CRLF.EOLC)                                    (COND                                       ([AND (SMALLP EOLCONVENTION)                                             (IGEQ EOLCONVENTION 0)                                             (ILEQ EOLCONVENTION (CONSTANT (IMAX CR.EOLC LF.EOLC                                                                                  CRLF.EOLC]                                        EOLCONVENTION)                                       (T CRLF.EOLC)))                DEVICE _ \TTY.FDEV])(\TTY.PEEKBIN  [LAMBDA (STREAM)                                           (* ejs%: "25-Mar-86 17:19")    (SELECTC \MACHINETYPE        (\DANDELION (\DLTTY.BIN STREAM T))        (\DAYBREAK (\DVTTY.BIN STREAM T))        (\NOMACHINETYPE]))(* ;; "Machine independent user face")(DEFINEQ(\DLTTY.CREATE-DEFAULT-INIT-INFO  [LAMBDA (FLOW-CONTROL)                                     (* ; "Edited  6-Jan-87 16:25 by hdj")    (create RS232C.INIT           BaudRate _ 1200           BitsPerSerialChar _ 8           Parity _ 'NONE           NoOfStopBits _ 1           FlowControl _ FLOW-CONTROL]))(RPAQ? TTY.DEFAULT.INIT.INFO (\DLTTY.CREATE-DEFAULT-INIT-INFO \DLTTY.FLOWCONTROL))(RPAQ? \TTY.CURRENT.INIT.INFO )(RPAQ? TTY.ERROR.STREAM PROMPTWINDOW)(DECLARE%: DOEVAL@COMPILE DONTCOPY(GLOBALVARS TTY.DEFAULT.INIT.INFO TTY.ERROR.STREAM))(DEFINEQ(TTY.INIT  [LAMBDA (BaudRate BitsPerSerialChar Parity NoOfStopBits FlowControl)                                                             (* ; "Edited  5-Nov-87 10:58 by FS")(* ;;; "User interface to low level initialization")    (SELECTC \MACHINETYPE        (\DANDELION [COND                       ((NULL BaudRate)                        (APPLY (FUNCTION \DLTTY.INIT)                               TTY.DEFAULT.INIT.INFO))                       ((LISTP BaudRate)                        (APPLY (FUNCTION \DLTTY.INIT)                               BaudRate)                        (SETQ \TTY.CURRENT.INIT.INFO BaudRate))                       (T (\DLTTY.INIT BaudRate BitsPerSerialChar Parity NoOfStopBits FlowControl)                          (SETQ \TTY.CURRENT.INIT.INFO (LIST BaudRate BitsPerSerialChar Parity                                                              NoOfStopBits FlowControl])        (\DAYBREAK [COND                      ((NULL BaudRate)                       (APPLY (FUNCTION \DVTTY.INIT)                              TTY.DEFAULT.INIT.INFO))                      ((LISTP BaudRate)                       (APPLY (FUNCTION \DVTTY.INIT)                              BaudRate)                       (SETQ \TTY.CURRENT.INIT.INFO BaudRate))                      (T (\DVTTY.INIT BaudRate BitsPerSerialChar Parity NoOfStopBits FlowControl)                         (SETQ \TTY.CURRENT.INIT.INFO (LIST BaudRate BitsPerSerialChar Parity                                                             NoOfStopBits FlowControl])        (ERROR "The TTY/PrinterPort is currently not supported on " (MACHINETYPE])(TTY.GET.PARAMETERS  [LAMBDA (PARAMETERLIST)                                    (* ejs%: "25-Oct-85 21:59")    (SELECTC \MACHINETYPE        (\DANDELION (\DLTTY.GET.PARAMETERS PARAMETERLIST))        (\DAYBREAK (\DVTTY.GET.PARAMETERS PARAMETERLIST))        (ERROR "RS232C is currently not supported on " (MACHINETYPE])(TTY.SET.PARAMETERS  [LAMBDA (PARAMETERLIST)                                    (* ejs%: "27-Aug-85 18:45")    (SELECTC \MACHINETYPE        (\DANDELION (\DLTTY.SET.PARAMETERS PARAMETERLIST))        (\DAYBREAK (\DVTTY.SET.PARAMETERS PARAMETERLIST))        (\NOMACHINETYPE])(TTY.RESET.STREAMS  [LAMBDA NIL                                                (* ejs%: " 8-Sep-85 16:49")    (replace (RS232C.DEVICEINFO INSTREAM) of (fetch (FDEV DEVICEINFO) of \TTY.FDEV)       with (replace (RS232C.DEVICEINFO OUTSTREAM) of (fetch (FDEV DEVICEINFO) of \TTY.FDEV)               with NIL])(TTY.SHUTDOWN  [LAMBDA (FORCE)                                            (* ; "Edited  5-Nov-87 11:11 by FS")    (if (type? FDEV \TTY.FDEV)        then (LET* ((DEVICE-INFO (fetch (FDEV DEVICEINFO) of \TTY.FDEV))                    (INSTREAM (fetch (RS232C.DEVICEINFO INSTREAM) of DEVICE-INFO))                    (OUTSTREAM (fetch (RS232C.DEVICEINFO OUTSTREAM) of DEVICE-INFO)))                   (AND (STREAMP INSTREAM)                        (OPENP INSTREAM)                        (\CLOSEFILE INSTREAM))                   (REPLACE (RS232C.DEVICEINFO INSTREAM) of DEVICE-INFO WITH NIL)                   (AND (STREAMP OUTSTREAM)                        (OPENP OUTSTREAM)                        (\CLOSEFILE OUTSTREAM))                   (REPLACE (RS232C.DEVICEINFO OUTSTREAM) of DEVICE-INFO WITH NIL)))    (SELECTC \MACHINETYPE        (\DANDELION (\DLTTY.SHUTDOWN FORCE))        (\DAYBREAK (\DVTTY.SHUTDOWN FORCE))        (\NOMACHINETYPE]))(PUTPROPS DLTTY FILETYPE CL:COMPILE-FILE)(TTY.INIT)(PUTPROPS DLTTY COPYRIGHT ("Xerox Corporation" 1985 1986 1987 1991))(DECLARE%: DONTCOPY  (FILEMAP (NIL (11629 11913 (\DLTTY.CREATE-INITIAL-FLOW-CONTROL 11639 . 11911)) (12114 29075 (\DLTTY.BIN 12124 . 15226) (\DLTTY.BOUT 15228 . 17221) (\DLTTY.GET.PARAMETERS 17223 . 19580) (\DLTTY.INIT 19582 . 21146) (\DLTTY.READP 21148 . 21315) (\DLTTY.SET.PARAMETERS 21317 . 27011) (\DLTTY.SHUTDOWN 27013 . 29073)) (33772 51804 (\DVTTY.BIN 33782 . 35679) (\DVTTY.BOUT 35681 . 39977) (\DVTTY.INIT 39979 . 42269) (\DVTTY.SET.PARAMETERS 42271 . 47074) (\DVTTY.READP 47076 . 47315) (\DVTTY.GET.PARAMETERS 47317 . 50401) (\DVTTY.SHUTDOWN 50403 . 51802)) (52728 61241 (\TTY.CREATE.FDEV 52738 . 54858) (\TTY.EVENTFN 54860 . 55614) (\TTY.BIN 55616 . 55867) (\TTY.BOUT 55869 . 56133) (\TTY.READP 56135 . 56392) (\TTY.CLOSEFILE 56394 . 57119) (\TTY.OPENFILE 57121 . 60978) (\TTY.PEEKBIN 60980 . 61239)) (61289 61627 (\DLTTY.CREATE-DEFAULT-INIT-INFO 61299 . 61625)) (61886 65615 (TTY.INIT 61896 . 63567) (TTY.GET.PARAMETERS 63569 . 63910) (TTY.SET.PARAMETERS 63912 . 64209) (TTY.RESET.STREAMS 64211 . 64573) (TTY.SHUTDOWN 64575 . 65613)))))STOP