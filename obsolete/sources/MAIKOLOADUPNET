(DEFINE-FILE-INFO READTABLE "XCL" PACKAGE "INTERLISP")(FILECREATED " 5-Mar-2021 14:36:52" |{DSK}<home>larry>ilisp>medley>obsolete>sources>MAIKOLOADUPNET.;1| 9349         |changes| |to:|  (VARS MAIKOLOADUPNETCOMS)                       (FNS \\10MB.RESTART.ETHER))(PRETTYCOMPRINT MAIKOLOADUPNETCOMS)(RPAQQ MAIKOLOADUPNETCOMS       ((FNS \\10MB.RESTART.ETHER \\10MB.STARTDRIVER \\10MB.TURNOFFETHER \\10MB.TURNONETHER              \\10MBSENDPACKET \\10MBWATCHER)        (GLOBALVARS \\10MB.RCLK.BOX \\10MB.EXPECTED.RECEIVE.INTERVAL \\10MB.INPUT.TIMEOUT                \\10MBTYPE.TRANSLATIONS \\MY.NSADDRESS \\RAWTRACING \\MAXWATCHERGETS)        (DECLARE\: EVAL@COMPILE DONTCOPY (LOCALVARS . T)               (FILES (SOURCE)                      10MBDECLS LLNSDECLS TEDITDECLS))))(DEFINEQ(\\10MB.RESTART.ETHER  (LAMBDA NIL                                        (* \; "Edited 11-May-88 16:09 by MASINTER")    (SUBRCALL ETHER-RESUME)))(\\10MB.STARTDRIVER  (LAMBDA (NDB RESTARTFLG MYNSNUMBER)                    (* \; "Edited  5-Apr-89 15:03 by snow")    (DECLARE (GLOBALVARS \\MAIKO.INPUT.PACKET \\10MB.EXPECTED.RECEIVE.INTERVAL                         \\10MB.INPUT.TIMEOUT))    (SUBRCALL ETHER-SUSPEND)    (OR (\\INIT.ETHER.BUFFER.POOL)        (ERROR "Unable to create buffer pool"))    (|replace| NDBTQ |of| NDB |with| (|create| SYSQUEUE))    (SETQ \\10MB.RAWPACKETQ (|create| SYSQUEUE))    (SETQ \\10MB.INPUT.TIMEOUT (TIMES \\RCLKSECOND \\10MB.EXPECTED.RECEIVE.INTERVAL))    (\\10MB.TURNONETHER NDB NIL NIL (OR MYNSNUMBER T)           0 0)    (PROG ((CSB (|fetch| NDBCSB |of| NDB)))          (OR \\MAIKO.INPUT.PACKET (SETQ \\MAIKO.INPUT.PACKET (\\ALLOCATE.ETHERPACKET)))          (|replace| DLFIRSTICB |of| (|fetch| NDBCSB |of| NDB) |with|                                                                                      \\ES.PENDING)          (SUBRCALL ETHER-GET \\10MBPACKETLENGTH (|fetch| 10MBPACKETBASE |of|                                                                                  \\MAIKO.INPUT.PACKET                                                        ))          (|replace| NDBWATCHER |of| NDB |with| (ADD.PROCESS (LIST '\\10MBWATCHER                                                                               (KWOTE NDB))                                                                   'RESTARTABLE                                                                   'SYSTEM                                                                   'AFTEREXIT                                                                   'DELETE))          (RETURN NDB))))(\\10MB.TURNOFFETHER  (LAMBDA NIL                                        (* \; "Edited 11-May-88 16:11 by MASINTER")    (SUBRCALL ETHER-SUSPEND)))(\\10MB.TURNONETHER  (LAMBDA (NDB SMASHSTATE NEWSTATE NSHOSTNUMBER ININTERRUPT OUTINTERRUPT)                                                         (* \; "Edited 11-May-88 16:08 by MASINTER")(* |;;;| "Reset and activate ether associated with NDB.  If SMASHSTATE is given, it is a CSB-length block into which state is saved for later restoration by passing as the NEWSTATE arg.  If NEWSTATE is NIL, then the remaining non-NIL args give parameters for this activation: the host number for microcode to watch for, T meaning my own number;  and interrupt masks for when a packet arrives or finishes transmitting")    (* |;;| "For Daybreak, SMASHSTATE and NEWSTATE must be NIL")    (PROG ((CSB (|fetch| NDBCSB |of| NDB)))          (\\MAIKO.ETHERSUSPEND)          (OR CSB (|replace| NDBCSB |of| NDB |with| (SETQ CSB                                                                 (LOCF (|fetch| DLETHERNET                                                                          |of| \\IOPAGE)))))          (|replace| DLFIRSTOCB |of| CSB |with| 0)          (|replace| DLFIRSTICB |of| CSB |with| 0)          (AND NSHOSTNUMBER (COND                               ((EQ NSHOSTNUMBER T)                                (\\BLT (LOCF (|fetch| DLLOCALHOST0 |of| CSB))                                       (LOCF (|fetch| (IFPAGE |NSHost0|) |of|                                                                                    |\\InterfacePage|)                                             )                                       \\#WDS.NSHOSTNUMBER))                               (T (\\STORENSHOSTNUMBER (LOCF (|fetch| DLLOCALHOST0 |of|                                                                                       CSB))                                         NSHOSTNUMBER))))          (AND OUTINTERRUPT (|replace| DLOUTPUTMASK |of| CSB |with| OUTINTERRUPT))          (AND ININTERRUPT (|replace| DLINPUTMASK |of| CSB |with| ININTERRUPT))          (|replace| DLMISSEDPACKETS |of| CSB |with| 0)          (|replace| DLLASTICB |of| CSB |with| 0)          (|replace| DLLASTOCB |of| CSB |with| 0)          (SUBRCALL ETHER-RESET)          (SUBRCALL ETHER-RESUME)          (RETURN NDB))))(\\10MBSENDPACKET  (LAMBDA (NDB PACKET)                               (* \; "Edited 11-May-88 16:10 by MASINTER")    (PROG NIL          (COND             (\\RAWTRACING (\\MAYBEPRINTPACKET PACKET 'RAWPUT)))          (COND             ((OR (|fetch| 10MBMULTICASTP |of| PACKET)                  (EQNSADDRESS.HOST \\MY.NSADDRESS (|fetch| 10MBDESTHOSTBASE |of| PACKET)))                                                             (* \;                                 "We would hear this packet if our hardware let us, so fake receipt")              (PROG ((COPYPACKET (\\ALLOCATE.ETHERPACKET)))                    (\\BLT (LOCF (|fetch| 10MBLENGTH |of| COPYPACKET))                           (LOCF (|fetch| 10MBLENGTH |of| PACKET))                           (ADD1 (|fetch| 10MBLENGTH |of| PACKET)))                                                             (* \;                                                    "Copy all data that would have been transmitted")                    (|replace| EPNETWORK |of| COPYPACKET |with| NDB)                    (|replace| EPTYPE |of| COPYPACKET                       |with| (|for| PAIR |in| \\10MBTYPE.TRANSLATIONS                                     |bind| (TYPE _ (|fetch| 10MBTYPE |of| PACKET))                                     |when| (EQ TYPE (CAR PAIR)) |do|                                  (* |;;| "TYPE is the raw type of the etherpacket.  These do not always correspond one-to-one with the EPTYPE constants we use (in particular, for pups), so translate if necessary.")                                                                           (RETURN (CDR PAIR))                                     |finally| (RETURN TYPE)))                    (COND                       (\\RAWTRACING (\\MAYBEPRINTPACKET COPYPACKET 'RAWGET)))                    (\\HANDLE.RAW.PACKET COPYPACKET))))          (UNINTERRUPTABLY              (SUBRCALL ETHER-SEND (IMAX (|fetch| 10MBLENGTH |of| PACKET)                                         \\10MB.MINPACKETLENGTH)                     (|fetch| 10MBPACKETBASE |of| PACKET))              (|replace| EPNETWORK |of| PACKET |with| NIL)              (\\REQUEUE.ETHERPACKET PACKET))          (RETURN T))))(\\10MBWATCHER  (LAMBDA (NDB)                                      (* \; "Edited 16-May-88 22:24 by MASINTER")    (* |;;| "merge message and packet reading")    (PROG ((CNTR 0)           MESSAGE-BUFFER MESSAGE-LENGTH PACKET)      LP  (IF (SUBRCALL MESSAGE-READP)              THEN (PROMPTPRINT (IF (SETQ MESSAGE-LENGTH (SUBRCALL MESSAGE-READ                                                                        (OR MESSAGE-BUFFER                                                                            (SETQ MESSAGE-BUFFER                                                                             (ALLOCSTRING 1024)))                                                                        1024))                                        THEN (SUBSTRING MESSAGE-BUFFER 1 MESSAGE-LENGTH)                                      ELSE "?? system message: polling failed")))          (UNINTERRUPTABLY              (SUBRCALL ETHER-CHECK)              (SETQ PACKET (\\MAIKO.INPUT.INTERRUPT NDB)))          (COND             (PACKET (\\HANDLE.RAW.PACKET PACKET)                    (COND                       ((ILESSP (|add| CNTR 1)                               \\MAXWATCHERGETS)                        (GO LP)))))          (BLOCK)          (SETQ CNTR 0)          (GO LP)))))(DECLARE\: DOEVAL@COMPILE DONTCOPY(GLOBALVARS \\10MB.RCLK.BOX \\10MB.EXPECTED.RECEIVE.INTERVAL \\10MB.INPUT.TIMEOUT        \\10MBTYPE.TRANSLATIONS \\MY.NSADDRESS \\RAWTRACING \\MAXWATCHERGETS))(DECLARE\: EVAL@COMPILE DONTCOPY (DECLARE\: DOEVAL@COMPILE DONTCOPY(LOCALVARS . T))(FILESLOAD (SOURCE)       10MBDECLS LLNSDECLS TEDITDECLS))(DECLARE\: DONTCOPY  (FILEMAP (NIL (804 8977 (\\10MB.RESTART.ETHER 814 . 974) (\\10MB.STARTDRIVER 976 . 2735) (\\10MB.TURNOFFETHER 2737 . 2897) (\\10MB.TURNONETHER 2899 . 5265) (\\10MBSENDPACKET 5267 . 7638) (\\10MBWATCHER 7640 . 8975)))))STOP