(DEFINE-FILE-INFO PACKAGE "IL" READTABLE "INTERLISP")(FILECREATED "12-Jun-90 16:11:50" {DSK}<usr>local>lde>lispcore>library>TCPCONFIG.;2 18742        changes to%:  (VARS TCPCONFIGCOMS)      previous date%: "18-Apr-88 21:05:32" {DSK}<usr>local>lde>lispcore>library>TCPCONFIG.;1)(* ; "Copyright (c) 1985, 1986, 1987, 1988, 1990 by Venue & Xerox Corporation.  All rights reserved.")(PRETTYCOMPRINT TCPCONFIGCOMS)(RPAQQ TCPCONFIGCOMS       ((PROP MAKEFILE-ENVIRONMENT TCPCONFIG)        (DECLARE%: EVAL@COMPILE DONTCOPY (COMS (RECORDS IPINIT))               (GLOBALVARS \IP.LOCAL.NETWORKS \IP.DEFAULT.GATEWAY \IP.INIT.FILE \IP.SUBNET.MASKS                       \PROCESS.AFTEREXIT.EVENT \PROC.READY \AR.IP.TO.10MB.ALIST))        (COMS (* TCP configuration module)              (EXPORT (RECORDS IPINIT))              (INITVARS (\IP.DEFAULT.CONFIGURATION (create IPINIT))                     (\IPFLG NIL))              (FILES TCPLLIP)              (FNS TCP.CONFIGURE TCP.LIMITCHARS \TCPCONFIG.RESETFN \TCPCONFIG.QUITFN                    TCP.ALPHA.LIMITCHARS \TCPCONFIG.APPLYFN))))(PUTPROPS TCPCONFIG MAKEFILE-ENVIRONMENT (:PACKAGE "IL" :READTABLE "INTERLISP"))(DECLARE%: EVAL@COMPILE DONTCOPY (DECLARE%: EVAL@COMPILE(RECORD IPINIT (LOCAL.ADDRESSES LOCAL.NETWORKS DEFAULT.GATEWAY HTE.FILE HOSTNAME SUBNETMASK                           DOMAIN.SERVERS LOCAL.DOMAIN LOCAL.NSHOSTNUMBER)))(DECLARE%: DOEVAL@COMPILE DONTCOPY(GLOBALVARS \IP.LOCAL.NETWORKS \IP.DEFAULT.GATEWAY \IP.INIT.FILE \IP.SUBNET.MASKS        \PROCESS.AFTEREXIT.EVENT \PROC.READY \AR.IP.TO.10MB.ALIST)))(* TCP configuration module)(* "FOLLOWING DEFINITIONS EXPORTED")(DECLARE%: EVAL@COMPILE(RECORD IPINIT (LOCAL.ADDRESSES LOCAL.NETWORKS DEFAULT.GATEWAY HTE.FILE HOSTNAME SUBNETMASK                           DOMAIN.SERVERS LOCAL.DOMAIN LOCAL.NSHOSTNUMBER)))(* "END EXPORTED DEFINITIONS")(RPAQ? \IP.DEFAULT.CONFIGURATION (create IPINIT))(RPAQ? \IPFLG NIL)(FILESLOAD TCPLLIP)(DEFINEQ(TCP.CONFIGURE  [LAMBDA NIL    (DECLARE (GLOBALVARS \IP.DEFAULT.CONFIGURATION)) (* ; "Edited 18-Mar-88 15:41 by bvm")    (LET* ((CONFIG (OR (AND (INFILEP '{DSK}IP.INIT)                            (\IP.READ.INIT.FILE '{DSK}IP.INIT))                       \IP.DEFAULT.CONFIGURATION                       (create IPINIT)))           (TCP.FREEMENU            (FREEMENU `((PROPS FONT (GACHA 12 BOLD))                        ((PROPS BOX 2)                         (LABEL " " TYPE DISPLAY)                         (LABEL "Apply!" TYPE MOMENTARY SELECTEDFN \TCPCONFIG.APPLYFN)                         (LABEL "     " TYPE DISPLAY)                         (LABEL "Reset!" TYPE MOMENTARY SELECTEDFN \TCPCONFIG.RESETFN)                         (LABEL "     " TYPE DISPLAY)                         (LABEL "Quit!" TYPE MOMENTARY SELECTEDFN \TCPCONFIG.QUITFN)                         (LABEL " " TYPE DISPLAY))                        ((LABEL "" TYPE DISPLAY))                        ((LABEL "      Host Name:" TYPE EDITSTART MESSAGE                                 "Enter the name of this host" LINKS (EDIT HOST.NAME))                         (LABEL ,(OR (fetch (IPINIT HOSTNAME) of CONFIG)                                     "") FONT (GACHA 12)                                TYPE EDIT ID HOST.NAME LIMITCHARS TCP.ALPHA.LIMITCHARS))                        ((LABEL "   Host Address:" TYPE EDITSTART MESSAGE                                 "Enter the IP address of this host. Format: 13.0.10.5" LINKS                                (EDIT ADDRESS))                         (LABEL ,(OR (CAR (fetch (IPINIT LOCAL.ADDRESSES) of CONFIG))                                     "") FONT (GACHA 12)                                TYPE EDIT ID ADDRESS LIMITCHARS TCP.LIMITCHARS))                        ((LABEL "Network Address:" TYPE EDITSTART MESSAGE      "Enter the IP address of the local network.  Format: 13.0.0.0  Leave the host address fields 0."                                 LINKS (EDIT NETWORK.ADDRESS))                         (LABEL ,(OR (CAAR (fetch (IPINIT LOCAL.NETWORKS) of CONFIG))                                     "") FONT (GACHA 12)                                TYPE EDIT ID NETWORK.ADDRESS LIMITCHARS TCP.LIMITCHARS))                        ((LABEL "    Subnet mask:" TYPE EDITSTART MESSAGE "Enter the subnet mask.  Format: 13.255.252.0  If the bitwise-AND of this address and any destination IP address is not equal to the bitwise-AND of this address and the host's local IP address, the destination IP address will be considered to be on another (sub)network"                                 LINKS (EDIT SUBNET.MASK))                         (LABEL ,(OR (CAR (fetch (IPINIT SUBNETMASK) of CONFIG))                                     "") FONT (GACHA 12)                                TYPE EDIT ID SUBNET.MASK LIMITCHARS TCP.LIMITCHARS))                        ((LABEL "Default Gateway:" TYPE EDITSTART MESSAGE                       "Enter the IP address of the default gateway for this host.  Format 13.0.10.34"                                 LINKS (EDIT DEFAULT.GATEWAY))                         (LABEL ,(OR (fetch (IPINIT DEFAULT.GATEWAY) of CONFIG)                                     "") FONT (GACHA 12)                                TYPE EDIT ID DEFAULT.GATEWAY LIMITCHARS TCP.ALPHA.LIMITCHARS))                        ((LABEL "   Local Domain:" TYPE EDITSTART MESSAGE                                 "Enter the name of the Internet domain in which this host resides"                                 LINKS (EDIT LOCAL.DOMAIN))                         (LABEL ,(OR (fetch (IPINIT LOCAL.DOMAIN) of CONFIG)                                     "") FONT (GACHA 12)                                TYPE EDIT ID LOCAL.DOMAIN LIMITCHARS TCP.ALPHA.LIMITCHARS))                        ((LABEL " Domain servers:" TYPE EDITSTART MESSAGE               "Enter the IP addresses of the local domain servers.  Format 13.0.10.21 12.0.15.22 ..."                                 LINKS (EDIT DOMAIN.SERVERS))                         (LABEL ,(if (fetch (IPINIT DOMAIN.SERVERS) of CONFIG)                                     then (for ADDRESS in (fetch (IPINIT                                                                                        DOMAIN.SERVERS                                                                                        )                                                                         of CONFIG)                                                 bind (STRING _ "")                                                 do (SETQ STRING (CONCAT STRING ADDRESS " "))                                                 finally (RETURN (SUBSTRING STRING 1 -2)))                                   else "") FONT (GACHA 12)                                TYPE EDIT ID DOMAIN.SERVERS LIMITCHARS TCP.ALPHA.LIMITCHARS))                        ((LABEL " Hosts.txt file:" TYPE EDITSTART MESSAGE  "Enter the name of the Hosts.txt file to be used for translating IP hostnames to IP host addresses."                                 LINKS (EDIT HOSTS.FILE))                         (LABEL ,(OR (fetch (IPINIT HTE.FILE) of CONFIG)                                     "") FONT (GACHA 12)                                TYPE EDIT ID HOSTS.FILE LIMITCHARS TCP.ALPHA.LIMITCHARS)))                    "TCP Configuration"))           (REG (WINDOWPROP TCP.FREEMENU 'REGION))           (WIDTH (fetch (REGION WIDTH) of REG))           (HEIGHT (fetch (REGION HEIGHT) of REG)))          (WINDOWPROP TCP.FREEMENU 'MINSIZE (CONS WIDTH HEIGHT))          (WINDOWPROP TCP.FREEMENU 'MAXSIZE (CONS 65535 HEIGHT))          (MOVEW TCP.FREEMENU (GETBOXPOSITION WIDTH HEIGHT))          (OPENW TCP.FREEMENU)          NIL])(TCP.LIMITCHARS  [LAMBDA (ITEM WINDOW CHARACTER)                        (* ; "Edited 20-Jan-88 15:37 by Snow")                    (* ;; "allows numbers or periods until a CR then skips to the next item in the menu.")    (COND       ((FMEMB CHARACTER '(0 1 2 3 4 5 6 7 8 9 %.))        T)       ((EQ (CHARACTER (CHARCODE EOL))            CHARACTER)        (FM.SKIPNEXT WINDOW))       (T NIL])(\TCPCONFIG.RESETFN(LAMBDA (ITEM WINDOW BUTTONS) (* ; "Edited 18-Jan-88 18:32 by Briggs") (AND (GETPROMPTWINDOW WINDOW) (CLEARW (GETPROMPTWINDOW WINDOW))) (FM.RESETMENU WINDOW)))(\TCPCONFIG.QUITFN(LAMBDA (ITEM WINDOW BUTTONS) (* ; "Edited 18-Jan-88 15:40 by Briggs") (FM.ENDEDIT WINDOW) (CLOSEW WINDOW)))(TCP.ALPHA.LIMITCHARS  [LAMBDA (ITEM WINDOW CHAR)                             (* ; "Edited 20-Jan-88 15:32 by Snow")                    (* ;; "This function will allow all characters until a CR then call Fm.Skipnext to move on to the next entry in the table.")    (IF (EQ (CHARACTER (CHARCODE CR))                CHAR)        THEN (FM.SKIPNEXT WINDOW)      ELSE T])(\TCPCONFIG.APPLYFN  [LAMBDA (ITEM WINDOW BUTTONS)                          (* ; "Edited 18-Mar-88 18:37 by bvm")          (* ;; "Before reseting any of the parameters, verify their validity")    (FM.ENDEDIT WINDOW)    (PROG ((STATE (FM.GETSTATE WINDOW))           (FMPROMPTWINDOW (GETPROMPTWINDOW WINDOW 3))           (CONFIG (create IPINIT                          LOCAL.NSHOSTNUMBER _ \MY.NSHOSTNUMBER))           IPADDRESS SCRATCH)          (* ;; "Before reseting any of the parameters, verify their validity")          (CLEARW FMPROMPTWINDOW)          (* ;; "So we don't have to check later...")          (if (NOT (OR \10MBLOCALNDB \3MBLOCALNDB))              then (printout FMPROMPTWINDOW "This machine doesn't appear to be on any networks!")                    (RETURN))          (* ;; "")          (* ;; "Host name is required")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'HOST.NAME))          (if (STRING-EQUAL SCRATCH "")              then (printout FMPROMPTWINDOW "Host name is required!")                    (FM.EDITITEM (FM.GETITEM 'HOST.NAME NIL WINDOW)                           WINDOW)                    (RETURN))          (replace (IPINIT HOSTNAME) of CONFIG with SCRATCH)          (* ;; "")          (* ;; " Verify host address")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'ADDRESS))          (if (STRING-EQUAL SCRATCH "")              then (printout FMPROMPTWINDOW "Host address is required!")                    (FM.EDITITEM (FM.GETITEM 'ADDRESS NIL WINDOW)                           WINDOW)                    (RETURN)            elseif (OR (NULL (SETQ IPADDRESS (\IP.READ.STRING.ADDRESS SCRATCH)))                           (ZEROP (\IPNETADDRESS IPADDRESS)))              then (printout FMPROMPTWINDOW "Malformed host address: " SCRATCH)                    (FM.EDITITEM (FM.GETITEM 'ADDRESS NIL WINDOW)                           WINDOW)                    (RETURN))          (replace (IPINIT LOCAL.ADDRESSES) of CONFIG with (LIST (\IP.ADDRESS.TO.STRING                                                                              IPADDRESS)))          (* ;; "")          (* ;; "Verify network address.  The list is an alist keyed by network address, and containing the atom 10 or 3 indicating the kind of network.  We assume the host is only on one network.")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'NETWORK.ADDRESS))          (if (STRING-EQUAL SCRATCH "")              then (printout FMPROMPTWINDOW "Network address is required!")                    (FM.EDITITEM (FM.GETITEM 'NETWORK.ADDRESS NIL WINDOW)                           WINDOW)                    (RETURN)            elseif (OR (NULL (SETQ IPADDRESS (\IP.READ.STRING.ADDRESS SCRATCH)))                           (ZEROP (\IPNETADDRESS IPADDRESS)))              then (printout FMPROMPTWINDOW "Malformed network address: " SCRATCH)                    (FM.EDITITEM (FM.GETITEM 'NETWORK.ADDRESS NIL WINDOW)                           WINDOW)                    (RETURN))          [replace (IPINIT LOCAL.NETWORKS) of CONFIG             with (LIST (CONS (\IP.ADDRESS.TO.STRING IPADDRESS)                                  (if \10MBLOCALNDB                                      then 10                                    else 3]          (* ;; "")          (* ;; " Verify subnet mask")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'SUBNET.MASK))          (if (STRING-EQUAL SCRATCH "")              then (printout FMPROMPTWINDOW "Subnet mask is required!")                    (FM.EDITITEM (FM.GETITEM 'SUBNET.MASK NIL WINDOW)                           WINDOW)                    (RETURN)            elseif (OR (NULL (SETQ IPADDRESS (\IP.READ.STRING.ADDRESS SCRATCH)))                           (ZEROP (\IPNETADDRESS IPADDRESS)))              then (printout FMPROMPTWINDOW "Malformed subnet mask: " SCRATCH)                    (FM.EDITITEM (FM.GETITEM 'SUBNET.MASK NIL WINDOW)                           WINDOW)                    (RETURN))          (replace (IPINIT SUBNETMASK) of CONFIG with (LIST (\IP.ADDRESS.TO.STRING                                                                                IPADDRESS)))          (* ;; "")          (* ;; "Verify default gateway, may be empty if none.")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'DEFAULT.GATEWAY))          (if (STRING-EQUAL SCRATCH "")              then (SETQ IPADDRESS NIL)            elseif (NOT (SETQ IPADDRESS (\IP.READ.STRING.ADDRESS SCRATCH)))              then (printout FMPROMPTWINDOW "Malformed default gateway address: " SCRATCH)                    (FM.EDITITEM (FM.GETITEM 'DEFAULT.GATEWAY NIL WINDOW)                           WINDOW)                    (RETURN))          (replace (IPINIT DEFAULT.GATEWAY) of CONFIG with (AND IPADDRESS (                                                                                \IP.ADDRESS.TO.STRING                                                                                       IPADDRESS)))          (* ;; "")          (* ;; "Local domain.  May be empty.")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'LOCAL.DOMAIN))          (if (STRING-EQUAL SCRATCH "")              then (SETQ SCRATCH NIL))          (replace (IPINIT LOCAL.DOMAIN) of CONFIG with SCRATCH)          (* ;; "")          (* ;; "Verify domain server address(es) are well formed.")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'DOMAIN.SERVERS))          (if (STRING-EQUAL SCRATCH "")              then (SETQ IPADDRESS NIL)            else [SETQ IPADDRESS (bind (END _ 0)                                            (BITTABLE _ (MAKEBITTABLE (LIST (CHARCODE SPACE))                                                               T))                                            (START _ NIL)                                        eachtime [SETQ START (STRPOSL BITTABLE SCRATCH                                                                        (ADD1 (OR END 65534]                                              (SETQ END (STRPOS " " SCRATCH START))                                        until (NULL START)                                        collect (\IP.READ.STRING.ADDRESS (SUBSTRING SCRATCH                                                                                    (OR START 1)                                                                                    END]                  (if (FMEMB NIL IPADDRESS)                      then (printout FMPROMPTWINDOW "Malformed domain server addresses: " SCRATCH                                      )                            (FM.EDITITEM (FM.GETITEM 'DOMAIN.SERVERS NIL WINDOW)                                   WINDOW)                            (RETURN)))          [replace (IPINIT DOMAIN.SERVERS) of CONFIG with                                                             (AND IPADDRESS                                                                  (for ADDR in IPADDRESS                                                                     collect (                                                                                \IP.ADDRESS.TO.STRING                                                                                  ADDR]          (* ;; "")          (* ;; "Hosts.txt file (may not yet exist)")          (* ;; "")          (SETQ SCRATCH (LISTGET STATE 'HOSTS.FILE))          (if (if (NOT (STRING-EQUAL SCRATCH ""))                    elseif (NOT *IP-DEFAULT-HOSTS-FILE*)                      then                               (* ;                                "If there's a site default, we can leave this empty for flexibility")                            (FM.CHANGESTATE (FM.GETITEM 'HOSTS.FILE NIL WINDOW)                                   (SETQ SCRATCH "{DSK}HOSTS.TXT")                                   WINDOW)                            T)              then (replace (IPINIT HTE.FILE) of CONFIG with SCRATCH))          (* ;; "")          (* ;; "write the information back on the IP.INIT file")          (* ;; "")          (printout FMPROMPTWINDOW "Writing {dsk}ip.init... ")          [LET ((*UPPER-CASE-FILE-NAMES* NIL))               (CL:WITH-OPEN-FILE (STREAM '{DSK}IP.INIT :DIRECTION :OUTPUT :IF-EXISTS :NEW-VERSION)                      (PRIN2 CONFIG STREAM (FIND-READTABLE "INTERLISP"]          (printout FMPROMPTWINDOW "done.")          (* ;; "")          (* ;; "See if they want to restart TCP with the new configuration.")          (* ;; "")          (COND             ((AND \IPFLG (MOUSECONFIRM "Restart TCP with the new values?" NIL FMPROMPTWINDOW T))                                                             (* ;                                                        "tcp is running and they want it restarted.")              (PRINTOUT FMPROMPTWINDOW T "Restarting...")              (STOPIP)              (SETQ \IP.DEFAULT.CONFIGURATION NIL)              (\IPINIT)          (* ;; "let the user know we are done.")              (PRINTOUT FMPROMPTWINDOW "done."]))(PUTPROPS TCPCONFIG COPYRIGHT ("Venue & Xerox Corporation" 1985 1986 1987 1988 1990))(DECLARE%: DONTCOPY  (FILEMAP (NIL (2032 18633 (TCP.CONFIGURE 2042 . 7956) (TCP.LIMITCHARS 7958 . 8375) (\TCPCONFIG.RESETFN 8377 . 8561) (\TCPCONFIG.QUITFN 8563 . 8695) (TCP.ALPHA.LIMITCHARS 8697 . 9098) (\TCPCONFIG.APPLYFN 9100 . 18631)))))STOP